#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage', label='conary.rpath.com@rpl:devel')
class FireFox(RPMPackageRecipe, CPackageRecipe):
    name = 'firefox'
    version = '2.0'
    rpmRelease = '2.fc7'

    buildRequires = ['atk:devel', 'autoconf:runtime',
        'cairo:devel', 'desktop-file-utils:runtime', 'fontconfig:devel',
        'freetype:devel', 'gcc:devel', 'glib:devel', 'gtk:devel', 'nss:devel',
        'libIDL:devel', 'libjpeg:devel', 'libpng:devel', 'pango:devel',
        'perl:runtime', 'pkgconfig:devel', 'zip:runtime',
        'zlib:devel', 'libstdc++:devel', 'libgcc:devellib', 'nspr:devel',
        'krb5:devel', 'libXau:devel', 'libXdmcp:devel',
        'libICE:devel', 'libSM:devel', 'libX11:devel', 'libXext:devel',
        'libXft:devel', 'libXinerama:devellib', 'libXrender:devel',
        'libXt:devel', ]

    rpmPatches = [ 'firefox-2.0-link-layout.patch',
                   #'firefox-1.1-nss-system-nspr.patch',
                   #'firefox-1.5-with-system-nss.patch',
                   'firefox-2.0-visibility.patch' ]
    externalArchive = 'http://ftp.mozilla.org/pub/mozilla.org/%(name)s/releases/%(version)s/source/%(name)s-%(version)s-source.tar.bz2'

    if Use.gnome:
        buildRequires.extend(['GConf:devel', 'ORBit2:devel', 'gnome-vfs:devel',
            'libbonobo:devel', 'libgnome:devel', 'popt:devel',
            'gnome-keyring:devel', 'libart_lgpl:devel', 'libbonoboui:devel',
            'libgnomecanvas:devel', 'libgnomeui:devel', 'libxml2:devel' ])

    def setup(r):
        r.unpack()

        r.macros.cflags = '-Os -g -fPIC'
        r.macros.fflib = '%(libdir)s/firefox/'
        r.macros.ffinc = '%(includedir)s/firefox/'

        r.addSource('firefox.taghandler', macros=True,
                    dest='%(taghandlerdir)s/firefox', mode=0755)
        for descr in ('extension', 'xpt-component', 'chrome'):
            r.addSource('firefox-%s.tagdescription' %descr, macros=True,
                        dest='%(tagdescriptiondir)s/firefox-' + descr)
        r.addSource('firefox.desktop')
        r.Desktopfile('firefox.desktop')
        r.addSource('firefox.png', dest='%(datadir)s/pixmaps/firefox.png',
                    mode=0644)

        r.addPatch('firefox-use-running.patch')
        r.addPatch('firefox-nopangoxft.patch')

        # Set the default homepage and prefs"
        r.addSource('foresight-default-prefs.js')

        r.disableParallelMake()
        r.Replace(('%%MOZAPPDIR%%', '%(libdir)s/firefox'),
                  ('%%MREDIR%%', '%(libdir)s/mre/mre'),
                  'browser/app/mozilla.in')

        # This is due to a gcc bug in visibility on x86_64 and
        # should be removed when we update to gcc-4.2
        if Arch.x86_64:
            r.Replace('ac_cv_visibility_pragma=yes', 'ac_cv_visibility_pragma=no', 'configure')

        extraConf = ''

        if Use.gnome:
            extraConf += ' --enable-gnomevfs --enable-gnomeui'
        else:
            extraConf += ' --disable-gnomevfs --disable-gnomeui'

        r.Configure('--enable-official-branding --disable-debug --disable-debug-modules --disable-dtd-debug'
            ' --disable-freetype2 --disable-freetypetest --disable-gtktest'
            ' --disable-installer --disable-updater --disable-tests'
            ' --disable-xprint --enable-mathml --enable-optimize'
            ' --enable-reorder --enable-shared --disable-static --disable-strip'
            ' --disable-strip-libs --enable-xinerama --with-pthreads'
            ' --with-system-nspr --with-system-nss --enable-default-toolkit=gtk2'
            ' --enable-pango --enable-svg-renderer=cairo --enable-system-cairo'
            ' --enable-postscript --enable-canvas --enable-necko-protocols=all'
            ' --enable-ldap --enable-application=browser ' + extraConf)

        r.Make()
        r.MakeInstall()
        r.Move('%(libdir)s/firefox-%(version)s/*', '%(fflib)s/')
        r.Install('browser/app/%(name)s', '%(libdir)s/%(name)s-%(version)s/%(name)s', mode=0755)
        # files in this directory are dynamically generated by the
        # tag handler script.  They should always be replaced on update
        r.Transient('%(libdir)s/firefox/extensions/')

        r.Symlink('%(libdir)s/firefox/firefox', '%(bindir)s/firefox')

        # Set the default homepage and prefs"
        r.Install('foresight-default-prefs.js', '%(fflib)s/greprefs/all-foresight.js')
        r.Install('foresight-default-prefs.js', '%(fflib)s/defaults/pref/all-foresight.js')
