#
# Copyright (c) 2004-2007
# The Foresight Linux Project, rPath, Inc.
#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class GroupDesktopPlatform(GroupRecipe):
    name = 'group-desktop-platform'
    version = '1.9.0.0.2'

    autoResolve = True

    Flags.local_tools = True
    depCheck = True
    checkPathConflicts = True
    x86_64FlavorString = 'is: x86(i486,i586,i686) x86_64'
    rPathVersionStr = None

    unwantedComponents = [ 'supdoc', ] # ? 'devel', 'devellib']

    def startGroup(r, name, parentGroup, depCheck=False, byDefault=True, autoResolve = False):
        # creates group named "name", adds it to the toplevel group,
        # and sets the current group to that name.  calls to r.add()
        # will use the current group by default.

        # note: byDefault applies to whether the group is included by
        # default in its parent group, not whether the troves in
        # the group are added by default. (use the setByDefault() command
        # to get that)

        # get all the the default for the new group from its parent group.
        if parentGroup:
            r.setDefaultGroup(parentGroup)
        r.createGroup(name, autoResolve=autoResolve, depCheck=depCheck,
                      byDefault=True)
        if parentGroup:
            r.addNewGroup(name, groupName=parentGroup, byDefault=byDefault)
        r.setDefaultGroup(name)
        r.removeComponents(r.unwantedComponents)

    def flAddCopy(r, name, version, flavor=None):
        if not flavor:
            if Arch.x86_64:
                flavor = 'is: x86(i486,i586,i686) x86_64'
            else:
                flavor = 'is: x86(i486,i586,i686)'

        r.addCopy(name, version, flavor)

    # this allows us to 'derive' nicely upstream groups (rpl:devel), overwritting them with our own stuff
    def flAdd(r, name, source=None, groupName=None, flavor=None):
        if not flavor:
            if Arch.x86_64:
                flavor = 'is: x86_64'# (i486,i586,i686) x86_64'
            else:
                flavor = 'is: x86(i486,i586,i686)'

        #  first, we add the trove, normally
        r.add(name, source=source, groupName=groupName, flavor=flavor)

        # second, we check if that trove is already in any of the upstream, pre-built,
        # groups, we use, and - there - we replace it.
        if Arch.x86_64:
            r.replace(name, groupName='group-compat32', allowNoMatch=True,
                      newFlavor='is: x86(i486,i586,i686)')

            for g in ['group-devel', 'group-core', 'group-base', 'group-text-tools']:
                r.replace(name, groupName=g, newFlavor='is: x86_64',
                          allowNoMatch=True)
        else:
            for g in ['group-devel', 'group-core', 'group-base', 'group-text-tools']: # 'group-os-devel', 'group-printing', 
                r.replace(name, groupName=g, allowNoMatch=True,
                          newFlavor='is: x86(i486,i586,i686)')

    def setup(r):
        rplBranch = "conary.rpath.com@rpl:devel"
        groupOs = 'group-os=' + rplBranch + '[%s]'
        if Arch.x86_64:
            groupOs = groupOs % 'is: x86(i486,i586,i686) x86_64'
        else:
            groupOs = groupOs % 'is: x86(i486,i586,i686)'
        r.setSearchPath('foresight.rpath.org@fl:2-devel', groupOs)

        # stuff we reuse from upstream (rpl:devel)
        for groupName in ('base',
                          'core',
                          'devel',
                          # 'os-devel',
                          # 'printing',
                          'text-tools',):
            r.flAddCopy('group-'+groupName, rplBranch)

        if Arch.x86_64:
            r.flAddCopy('group-compat32', rplBranch)

        r.replace('distro-release', 'foresight.rpath.org@fl:2-devel',)

        # temp hacks (rpl:devel oddities)
        r.add('authconfig', groupName='group-core')

        r.startGroup('group-gnome', parentGroup='group-desktop-platform')


        #
        # foresight gnome stack
        #
        # the bits bellow are automatically generated from  gnome f.d.o jhbuild xml files
        # [http://ftp.gnome.org/pub/GNOME/teams/releng/...]
        # plz do not remove  them, or alter order if you don't know what you are doing ;)
        #
        # Note: 06/jun'07 we will be adding 2.18.x pkgs for now, but already with the 2.19.x
        # xml jhbuild's grouping layout
        #
        # FIXME: I need to script  a smart way of parse what is strict userland and what is
        # strict group-devel-gnome stuff

        # FIXME: make tests to check/handle handle pkgs listed bellow when they are pkgSpeced




        #  gnome external modules (xulrunner is in group-internet). the others for now remain here

#        for g in ['avahi', 'cairo', 'cairomm', 'dbus', 'dbus-glib', 'desktop-file-utils', 'enchant', 'fontconfig', 'gamin', 'gnutls', 'hal', 'hicolor-icon-theme', 'icon-naming-utils', 'iso-codes', 'libcolorblind', 'libcroco', 'libdaemon', 'libgpg-error', 'libgcrypt', 'libgsf', 'libmusicbrainz', 'liboil', 'libtasn1', 'libxklavier', 'opal', 'opencdk', 'poppler', 'pycairo', 'pwlib', 'shared-mime-info', 'startup-notification', 'system-tools-backends', ]:

        # FIXME: fontconfig won 't rMook ! (using rpl:devel one for now :( 

        for g in ['avahi', 'cairo', 'cairomm', 'dbus', 'dbus-glib', 'desktop-file-utils', 'enchant', 'fontconfig', 'gamin', 'gnutls', 'hal', 'hicolor-icon-theme', 'icon-naming-utils', 'iso-codes', 'libcroco', 'libdaemon', 'libgpg-error', 'libgcrypt', 'libmusicbrainz', 'liboil', 'libxklavier', 'shared-mime-info', 'poppler', 'pycairo', 'startup-notification' ]:
            r.flAdd(g, groupName='group-gnome')

        # avahi, hal  and dbus are PkgSpeced
        r.flAdd('hal-gnome', groupName='group-gnome')
        r.flAdd('dbus-x11', groupName='group-gnome')
        r.flAdd('avahi-tools', groupName='group-gnome')
        r.flAdd('avahi-glib', groupName='group-gnome')
        r.flAdd('avahi-sharp', groupName='group-gnome')

        # end of gnome external modules

        #  meta-gnome-devel-platform-upcoming-deprecations

        for g in ["ORBit2", "audiofile", "esound", "libIDL", "libart_lgpl", "libbonobo", "libbonoboui", "libgnome", "libgnomecanvas", "libgnomeui", ]:
              r.flAdd(g, groupName='group-gnome')

        #  meta-gnome-devel-platform

#        for g in [ "GConf", "at-spi", "atk", "gail", "glib", "gnome-mime-data", "gnome-vfs", "gtk", "gtk-doc", "intltool", "libglade", "libxml2", "libxslt", "pango", ]:
        for g in [ "GConf", "at-spi", "atk", "gail", "glib", "gnome-mime-data", "gtk", "gtk-doc", "intltool", "libglade", "libxml2", "libxslt", "pango", ]:
            r.flAdd(g, groupName='group-gnome')


        #  meta-gnome-desktop-upcoming-deprecations

        for g in ["libgnomeprint", "libgnomeprintui", ]:
            r.flAdd(g, groupName='group-gnome')

#         #  meta-gnome-desktop-suite

#          for g in [ "alacarte", "bug-buddy", "control-center", "dasher", "deskbar-applet", "eel", "ekiga", "eog", "epiphany", "evince", "evolution-data-server", "evolution", "evolution-exchange", "evolution-webcal", "fast-user-switch-applet", "file-roller", "gcalctool", "gconf-editor", "gdm", "gedit", "gnome-applets", "gnome-backgrounds", "gnome-desktop", "gnome-doc-utils", "gnome-games", "gnome-icon-theme", "gnome-keyring", "gnome-keyring-manager", "gnome-netstatus", "gnome-nettool", "gnome-mag", "gnome-media", "gnome-menus", "gnome-panel", "gnome-power-manager", "gnome-python-desktop", "gnome-screensaver", "gnome-session", "gnome-speech", "gnome-system-monitor", "gnome-system-tools", "gnome-terminal", "gnome-themes", "gnome-user-docs", "gnome-utils", "gnome-volume-manager", "gok", "gstreamer", "gst-plugins-base", "gst-plugins-good", "gtk-engines", "gtkhtml", "gtksourceview", "gucharmap", "libgail-gnome", "libgnomekbd", "libgtop", "liboobs", "librsvg", "libsoup", "libwnck", "metacity", "nautilus", "nautilus-cd-burner", "orca", "scrollkeeper", "seahorse", "sound-juicer", "tomboy", "totem", "vino", "vte", "yelp", "zenity", ]:
#              r.flAdd(g, groupName='group-gnome')

        r.flAdd('alacarte', groupName='group-gnome')
        r.flAdd('bug-buddy', groupName='group-gnome')
        r.flAdd('dasher', groupName='group-gnome')
        r.flAdd('eel', groupName='group-gnome')
        r.flAdd('eog', groupName='group-gnome')
        r.flAdd('evolution-exchange', groupName='group-gnome')
        r.flAdd('evolution-data-server', groupName='group-gnome')
        r.flAdd('evolution-webcal', groupName='group-gnome')
        r.flAdd('gcalctool', groupName='group-gnome')
        r.flAdd('gconf-editor', groupName='group-gnome')
        r.flAdd('gdm', groupName='group-gnome')
        r.flAdd('gnome-backgrounds', groupName='group-gnome')
        r.flAdd('gnome-desktop', groupName='group-gnome')
        r.flAdd('gnome-icon-theme', groupName='group-gnome')
        r.flAdd('gnome-keyring', groupName='group-gnome')
        r.flAdd('gnome-keyring-manager', groupName='group-gnome')
        r.flAdd('gnome-nettool', groupName='group-gnome')
        r.flAdd('gnome-mag', groupName='group-gnome')
        r.flAdd('gnome-menus', groupName='group-gnome')
        r.flAdd('gnome-screensaver', groupName='group-gnome')
        r.flAdd('gnome-speech', groupName='group-gnome')
        r.flAdd('gnome-system-monitor', groupName='group-gnome')
        r.flAdd('gnome-terminal', groupName='group-gnome')
        r.flAdd('gnome-themes', groupName='group-gnome')
        r.flAdd('gnome-user-docs', groupName='group-gnome')

        r.flAdd('gnome-doc-utils', groupName='group-gnome') # needs to be rMooked alone. triggers circular dep (x86_64 deps on x86...)
        r.flAdd('gok', groupName='group-gnome')
        r.flAdd('gstreamer', groupName='group-gnome')
        r.flAdd('gst-plugins-base', groupName='group-gnome')
        r.flAdd('gtk-engines', groupName='group-gnome')
        r.flAdd('gtkhtml', groupName='group-gnome')
        r.flAdd('gtksourceview', groupName='group-gnome')
        r.flAdd('gucharmap', groupName='group-gnome')
        r.flAdd('libgnomecups', groupName='group-gnome')
        r.flAdd('libgnomekbd', groupName='group-gnome')
        r.flAdd('libgtop', groupName='group-gnome')
        r.flAdd('liboobs', groupName='group-gnome')
        r.flAdd('librsvg', groupName='group-gnome')
        r.flAdd('libsoup', groupName='group-gnome')
        r.flAdd('libwnck', groupName='group-gnome')
        r.flAdd('metacity', groupName='group-gnome')
        r.flAdd('orca', groupName='group-gnome')
        r.flAdd('scrollkeeper', groupName='group-gnome')
        r.flAdd('vino', groupName='group-gnome')
        r.flAdd('vte', groupName='group-gnome')
        r.flAdd('yelp', groupName='group-gnome')
        r.flAdd('zenity', groupName='group-gnome')


        #  meta-gnome-bindings-c++

        for g in  [ "glibmm", "gtkmm", "libglademm", "gconfmm", "libgnomecanvasmm", "gnome-vfsmm", "libgnomemm",  "libgnomeuimm", "libxml++", ]:
            r.flAdd(g, groupName='group-gnome')

        #  meta-gnome-bindings-python

        for g in [ "pygobject", "pygtk", "pyorbit", "gnome-python", ]:

            r.flAdd(g, groupName='group-gnome')

        #  meta-gnome-admin

#         for g in[ "pessulus", "sabayon", ]:
#             r.flAdd(g, groupName='group-gnome')
        r.flAdd('sabayon', groupName='group-gnome')
        #  meta-gnome-devtools-suite

        for g in        [ "devhelp", "glade", ]:
            r.flAdd(g, groupName='group-gnome')

        # jhbuild's 'groups are not 'closed' so we get those two 'orfan' pkgs

        for g in  [ "libgnomecups", "gnome-common", ]:
            r.flAdd(g, groupName='group-gnome')


        #
        # end of 'default' f.d.o gnome stuff.
        #


        # needed at least by pygtk
        r.flAdd('python-numeric', groupName='group-gnome')

        # needed for hal
        r.flAdd('smbios', groupName='group-gnome')
        r.flAdd('hal-info', groupName='group-gnome')
        r.flAdd('ConsoleKit', groupName='group-gnome')

        # here for now
        r.flAdd('foresight-gdm-login-simple-green', groupName='group-gnome')




        # end of group-gnome
        #

        # we're jumping into python2.5
        # r.replace('python', 'foresight.rpath.org@fl:2-devel')
        # r.replace('idle', 'foresight.rpath.org@fl:2-devel')



        #
        # ruby stack

        r.flAdd('ruby')
        r.flAdd('rubygems')
        r.flAdd('rake', groupName='group-devel')

        # end of ruby stack

        #
        # our own xorg stack

        r.startGroup('group-xorg', parentGroup='group-desktop-platform')

        r.flAdd('xorg-server')

        ## packages built by xorg-utils

        utils = [ 'gccmakedep',
                  'imake',
                  'xorg-cf-files',
                  'lndir',
                  'makedepend',
                  ]

        for p in utils:
            r.flAdd(p, source='xorg-utils', groupName='group-devel')

        ## end of packages built by xorg-utils

        r.flAdd('xtrans', groupName='group-devel')

        ## packages built by xorg-proto
        proto  = [
            'applewmproto',
            'bigreqsproto',
            'compositeproto',
            'damageproto',
            'dmxproto',
            'evieext',
            'fixesproto',
            'fontcacheproto',
            'fontsproto',
            'glproto',
            'inputproto',
            'kbproto',
            'libpthread-stubs',
            'printproto',
            'randrproto',
            'recordproto',
            'renderproto',
            'resourceproto',
            'scrnsaverproto',
            'trapproto',
            'util-macros',
            'videoproto',
            'vncproto',
            'windowswmproto',
            'xcb-proto',
            'xcliplistproto',
            'xcmiscproto',
            'xextproto',
            'xf86bigfontproto',
            'xf86dgaproto',
            'xf86driproto',
            'xf86miscproto',
            'xf86rushproto',
            'xf86vidmodeproto',
            'xineramaproto',
            'xproto',
            'xproxymanagementprotocol',
            ]
        for p in proto:
            r.flAdd(p, source='xorg-proto')

        ## end of list of packages built by xorg-proto

        r.flAdd('xcursor-themes')
        r.flAdd('xkeyboard-config')
        r.flAdd('xorg-sgml-doctools')

        ## packages built by xorg-libs

        libs = [
            #            'libAppleWM',
            'libdmx',
            'libFS',
            'liblbxutil',
            'liboldX',
            'libvnc',
            #            'libWindowsWM',
            'libXaw',
            'libXcliplist',
            'libXcomposite',
            'libXcursor',
            'libXdamage',
            'libXevie',
            'libXfont',
            'libXfontcache',
            'libXft',
            'libXft1',
            'libXi',
            'libXinerama',
            'libxkbui',
            'libXprintAppUtil',
            'libXrandr',
            'libXres',
            'libXScrnSaver',
            'libXTrap',
            'libXtst',
            'libXvMC',
            'libXxf86dga',
            'libXxf86misc',
            'libXxf86vm',
            'xbitmaps',
            'xcb-util',
             ]

        for p in libs:
            r.flAdd(p, source='xorg-libs')


        ## end of packages built by xorg-libs

        r.flAdd('libfontenc')
        r.flAdd('libICE')
        r.flAdd('libSM')
        r.flAdd('libX11')
        r.flAdd('libXau')
        r.flAdd('libxcb')
        r.flAdd('libXdmcp')
        r.flAdd('libXext')
        r.flAdd('libXfixes')
        r.flAdd('libxkbfile')
        r.flAdd('libXmu')
        r.flAdd('libXp')
        r.flAdd('libXpm')
        r.flAdd('libXprintUtil')
        r.flAdd('libXrender')
        r.flAdd('libXt')
        r.flAdd('libXv')
        r.flAdd('Mesa')
        r.flAdd('glx-utils', source='Mesa')
        r.flAdd('libdrm')

        ## packages built by xorg-apps

        apps = [
            'appres',
            'bdftopcf',
            'beforelight',
            'bitmap',
            'editres',
            'fonttosfnt',
            'fslsfonts',
            'fstobdf',
            'iceauth',
            'ico',
            'lbxproxy',
            'listres',
            'luit',
            'mkcomposecache',
            'mkfontdir',
            'mkfontscale',
            'oclock',
            'proxymngr',
            'rendercheck',
            'rgb',
            'rstart',
            'scripts',
            'sessreg',
            'setxkbmap',
            'showfont',
            'smproxy',
            'twm',
            'viewres',
            'x11perf',
            'xauth',
            'xbiff',
            'xcalc',
            'xclipboard',
            'xclock',
            'xcmsdb',
            'xconsole',
            'xcursorgen',
            'xcursor-themes',
            'xdbedizzy',
            'xditview',
            'xdm',
            'xdpyinfo',
            # we do not ship it
            # 'xdriinfo',
            'xedit',
            'xev',
            'xeyes',
            'xf86dga',
            'xfd',
            'xfindproxy',
            'xfontsel',
            'xfs',
            'xfsinfo',
            'xfwp',
            'xgamma',
            'xgc',
            'xhost',
            'xinit',
            'xkbcomp',
            'xkbevd',
            'xkbprint',
            'xkbutils',
            'xkill',
            'xload',
            'xlogo',
            'xlsatoms',
            'xlsclients',
            'xlsfonts',
            'xmag',
            'xman',
            'xmessage',
            'xmh',
            'xmodmap',
            'xmore',
            # FIXME try to get 'xphelloworld' to behave when rMooked
            # 'xphelloworld',
            'xplsprinters',
            'xpr',
            'xprehashprinterlist',
            'xprop',
            'xrandr',
            'xrdb',
            'xrefresh',
            'xrx',
            'xset',
            'xsetmode',
            'xsetpointer',
            'xsetroot',
            'xsm',
            'xstdcmap',
            'xtrap',
            'xvidtune',
            'xvinfo',
            'xwd',
            'xwininfo',
            'xwud',
             ]

        for p in apps:
            r.flAdd(p, source='xorg-apps')

        ## end of packages built by xorg-apps

        r.startGroup('group-xorg-fonts', parentGroup='group-xorg', depCheck=False)
        ## packages built by xorg fonts
        fonts = [
            'encodings',
            'font-adobe-100dpi',
            'font-adobe-75dpi',
            'font-adobe-utopia-100dpi',
            'font-adobe-utopia-75dpi',
            'font-adobe-utopia-type1',
            'font-alias',
            'font-arabic-misc',
            'font-bh-100dpi',
            'font-bh-75dpi',
            'font-bh-lucidatypewriter-100dpi',
            'font-bh-lucidatypewriter-75dpi',
            'font-bh-ttf',
            'font-bh-type1',
            'font-bitstream-100dpi',
            'font-bitstream-75dpi',
            'font-bitstream-speedo',
            'font-bitstream-type1',
            'font-cronyx-cyrillic',
            'font-cursor-misc',
            'font-daewoo-misc',
            'font-dec-misc',
            'font-ibm-type1',
            'font-isas-misc',
            'font-jis-misc',
            'font-micro-misc',
            'font-misc-cyrillic',
            'font-misc-ethiopic',
            'font-misc-meltho',
            'font-misc-misc',
            'font-mutt-misc',
            'font-schumacher-misc',
            'font-screen-cyrillic',
            'font-sony-misc',
            'font-sun-misc',
            'font-winitzki-cyrillic',
            'font-xfree86-type1',
             ]

        for p in fonts:
            r.flAdd(p, source='xorg-fonts')

        ## end of packages built by xorg fonts

        #        r.startGroup('group-xorg-fonts-extra', parentGroup='group-xorg', depCheck=False)
        #         r.flAdd('scim')
        #         r.flAdd('scim-anthy')
        #         r.flAdd('anthy')
        #         r.flAdd('sazanami')

        r.startGroup('group-xorg-drivers', parentGroup='group-xorg', depCheck=False)

        ## packages built by xorg-drivers-input
        inputDrivers = [
            'xf86-input-jamstudio',
            'xf86-input-ur98',
            'xf86-input-citron',
            'xf86-input-elo2300',
            'xf86-input-dmc',
            'xf86-input-evdev',
            'xf86-input-digitaledge',
            'xf86-input-acecad',
            'xf86-input-mutouch',
            'xf86-input-mouse',
            'xf86-input-dynapro',
            'xf86-input-keyboard',
            'xf86-input-magellan',
            'xf86-input-void',
            'xf86-input-aiptek',
            'xf86-input-summa',
            'xf86-input-penmount',
            'xf86-input-elographics',
            'xf86-input-microtouch',
            'xf86-input-calcomp',
            'xf86-input-hyperpen',
            'xf86-input-magictouch',
            'xf86-input-tek4957',
            'xf86-input-fpit',
            'xf86-input-spaceorb',
            'xf86-input-vmmouse',
            'xf86-input-joystick',
            'xf86-input-palmax',
            ]

        for p in inputDrivers:
            r.flAdd(p, source='xorg-driver-input')
        ## end of packages built by xorg-drivers-input

        ## packages built by xorg-drivers-video

        videoDrivers = [
            'xf86-video-mga',
            'xf86-video-ati',
            'xf86-video-trident',
            'xf86-video-sisusb',
            'xf86-video-cirrus',
            'xf86-video-sis',
            'xf86-video-vesa',
            'xf86-video-suncg3',
            'xf86-video-neomagic',
            'xf86-video-i128',
            'xf86-video-s3',
            'xf86-video-v4l',
            'xf86-video-chips',
            'xf86-video-sunffb',
            'xf86-video-imstt',
            'xf86-video-savage',
            'xf86-video-tseng',
            'xf86-video-nsc',
            'xf86-video-vga',
            'xf86-video-via',
            'xf86-video-suncg6',
            'xf86-video-s3virge',
            'xf86-video-dummy',
            'xf86-video-newport',
            'xf86-video-voodoo',
            # 'xf86-video-impact',
            'xf86-video-ast',
            'xf86-video-intel',
            'xf86-video-i810',
            'xf86-video-sunbw2',
            'xf86-video-cyrix',
            'xf86-video-vmware',
            'xf86-video-suncg14',
            'xf86-video-tdfx',
            'xf86-video-tga',
            'xf86-video-suntcx',
            'xf86-video-glint',
            'xf86-video-nv',
            'xf86-video-apm',
            'xf86-video-sunleo',
            'xf86-video-ark',
            'xf86-video-rendition',
            'xf86-video-siliconmotion',
            'xf86-video-i740',
            'xf86-video-fbdev',
            ]

        for p in videoDrivers:
            r.flAdd(p, source='xorg-driver-video')

        ## end of packages built by xorg-drivers-video
        #
        #   end of our xorg stack
        #

        # final housekeeping
        # the r.replace in flAdd sadly doesn't allways replace **only** the components 
        # already in the original group-compat32, so we need a final cleanup there to avoid dups.
        if Arch.x86_64:
            r.removeComponents(['devel', 'doc', 'data', 'runtime', 'supdoc', 'locale', 'config'], groupName='group-compat32')

            r.add('avahi-glib:lib', flavor='is: x86(i486,i586,i686)', groupName='group-compat32')
            # libxcb is not used (yet) in rpl:devel, and libX11 needs it.
            r.add('libxcb:lib', flavor='is: x86(i486,i586,i686)', groupName='group-compat32')
            r.add('libXp:lib', flavor='is: x86(i486,i586,i686)', groupName='group-compat32')
            # FIXME: i think bellow we have a conary policy bug. if .py files land  in %(docdir)s they should  land in :doc or :supdoc
            # TODO: need to check with mkj if this is desired behaviour, and if not, file yet another bug
            r.remove('libxml2:python', groupName='group-compat32')

            r.remove('avahi:python', groupName='group-compat32')



