#
# Copyright (c) 2004-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Bind(RPMPackageRecipe,CPackageRecipe):
    name = 'bind'
    # we should keep this strange-looking version even when seemingly not
    # needed since bind versions often have -P1 or similar
    archive_version = '9.4-ESV-R4-P1'
    version = archive_version.replace('-', '_')
    rpmRelease = '6.fc7'
    rpmUpVer = '9.4.0'

    buildRequires = [ 'openssl:devel', 'libtool:runtime', 'pkgconfig:devel',
        'ctags:runtime', 'libxml2:runtime', 'libxslt:runtime', 'perl:runtime',
        'tetex-latex:runtime', 'tetex:runtime', ]

    def setup(r):
        srpm2 = 'http://download.fedora.redhat.com/pub/fedora/linux/core/4/SRPMS/caching-nameserver-7.3-3.src.rpm'

        r.disableParallelMake()
        r.macros.archive_version = r.version.replace('_', '-')
        r.macros.majorversion = r.version.split('.')[0]
        r.addArchive('ftp://ftp.isc.org/isc/bind%(majorversion)s/%(archive_version)s/', keyid='D811B53F0B7BAE00')
        r.addSource('named.sysconfig', rpm=r.srpm, dest='%(sysconfdir)s/sysconfig/named')
        r.addSource('named.init', dest='%(initdir)s/named', mode=0755, macros=True)
        r.addSource('named.logrotate', rpm=r.srpm, dest='%(sysconfdir)s/logrotate.d/named')
        r.addSource('keygen.c', rpm=r.srpm)
        r.addPatch('globals.h.pid_path.patch')
        r.addSource('ftp://ftp.internic.net/domain/named.root')
        r.addSource('named.broadcast', rpm=srpm2)
        r.addSource('named.zero', rpm=srpm2)
        r.addSource('named.local', rpm=srpm2)
        r.addSource('named.ip6.local', rpm=srpm2)
        r.addSource('localhost.zone', rpm=srpm2)
        r.addSource('localdomain.zone', rpm=srpm2)
        r.addSource('named.conf', rpm=srpm2)
        r.addSource('Copyright.caching-nameserver', rpm=srpm2)

        # CVE-2008-0122
        # r.addPatch('http://security.freebsd.org/patches/SA-08:02/libc.patch', dir='lib/bind')
        # r.addPatch('bind-9.3.4-CVE-2009-0025.patch') # RPL-2938
        # r.addPatch('CVE-2009-0696.patch') # RPL-3092

        # new openssl doesn't provide some things that bind thinks it does
        r.Replace('#if OPENSSL_VERSION_NUMBER > 0x00908000L',
                  '#ifdef USE_NEW_OPENSSL',
                  'lib/dns/opensslrsa_link.c')

        r.macros.cflags += ' $(pkg-config --cflags openssl)'
        r.macros.cppflags += ' $(pkg-config --cflags-only-I openssl)'
        r.macros.ldflags += ' $(pkg-config --libs-only-L openssl)'
        r.Configure('--with-libtool '
                    '--enable-threads --disable-openssl-version-check '
                    '--enable-libbind --enable-largefile --enable-ipv6 '
                    '--with-openssl=%(prefix)s '
                    # For named.pid file:
                    '--localstatedir=%(localstatedir)s ')
        r.Make()
        r.MakeInstall()
        r.Run('gcc %(cflags)s -o %(destdir)s/%(sbindir)s/dns-keygen keygen.c')

        # need to do this after the install so that we overwrite the default
        # with a more recent version
        r.Install('named.root', '%(servicedir)s/named/named.ca')
        r.Install('named.broadcast', '%(servicedir)s/named/named.broadcast')
        r.Install('named.zero', '%(servicedir)s/named/named.zero')
        r.Install('named.local', '%(servicedir)s/named/named.local')
        r.Install('named.ip6.local', '%(servicedir)s/named/named.ip6.local')
        r.Install('localhost.zone', '%(servicedir)s/named/localhost.zone')
        r.Install('localdomain.zone', '%(servicedir)s/named/localdomain.zone')
        r.Install('named.conf', '%(sysconfdir)s/named.conf')

        r.Doc('Copyright.caching-nameserver')

        r.Replace('%(localstatedir)s', '%(servicedir)s',
                  '%(sysconfdir)s/named.conf')
        r.Config('%(servicedir)s/named/')

        # glibc provides the following files
        r.Remove('%(includedir)s/arpa/inet.h',
                 '%(includedir)s/arpa/nameser.h',
                 '%(includedir)s/arpa/nameser_compat.h',
                 '%(includedir)s/net/route.h',
                 '%(includedir)s/netdb.h',
                 '%(includedir)s/hesiod.h',
                 '%(includedir)s/resolv.h')

        r.Install('bin/rndc/rndc.conf', '%(sysconfdir)s/', mode=0640)
        r.Install('contrib/named-bootconf/named-bootconf.sh',
            '%(sbindir)s/named-bootconf', mode=0755)

        r.Create('%(sysconfdir)s/rndc.key',
            contents='key "rndckey" {\n'
                     '  algorithm       hmac-md5;\n'
                     '  secret "@KEY@";\n'
                     '};\n',
            mode=0640)

        r.Doc('doc/*')

        r.MakeDirs('%(servicedir)s/named/slaves')
        r.MakeDirs('%(servicedir)s/named/data')
        r.MakeDirs('%(localstatedir)s/run/named')
        r.ExcludeDirectories(exceptions='%(servicedir)s/named')
        r.Ownership('root', 'named', '%(sysconfdir)s/rndc.key')
        r.Ownership('root', 'named', '%(servicedir)s/named')
        r.Ownership('root', 'named', '%(servicedir)s/named')
        r.Ownership('named', 'named', '%(servicedir)s/named/slaves')
        r.Ownership('named', 'named', '%(servicedir)s/named/data')
        r.Ownership('named', 'named', '%(localstatedir)s/run/named')

        r.PackageSpec('bind-utils', '%(bindir)s/(host|nslookup|nsupdate|dig)',
                                    '%(mandir)s/man1/(host|dig).1.*',
                                    '%(mandir)s/man5/resolver.5.*',
                                    '%(mandir)s/man8/nsupdate.8.*',
                                    '%(mandir)s/man8/nslookup.8.*')

        r.TagSpec('initscript', '%(initdir)s/')
        r.Requires('%(essentialbindir)s/kill', '%(initdir)s/named')
