#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Ppp(CPackageRecipe):
    name = 'ppp'
    version = '2.4.4'

    buildRequires = [ 'pam:devel', 'libpcap:devel']

    def setup(r):
        r.addArchive('ftp://ftp.samba.org/pub/ppp/ppp-%(version)s.tar.gz')
        srpm = 'http://download.fedora.redhat.com/pub/fedora/linux/core/5/source/SRPMS/ppp-2.4.3-6.2.1.src.rpm'
        r.addSource('ppp-2.3.5-pamd.conf', rpm=srpm)
        r.addSource('ppp.logrotate', rpm=srpm)

        r.addPatch('ppp-2.3.6-sample.patch', rpm=srpm)
        r.addPatch('ppp-2.4.1-varargs.patch', rpm=srpm)
        r.addPatch('ppp-2.4.3-lib64.patch', macros=True)
        r.addPatch('ppp-2.4.3-dontwriteetc.patch')
        # deal with new libpcap version
        r.Replace('#include <net/bpf.h>', '#include <pcap-bpf.h>',
                  'pppd/plugins/rp-pppoe/if.c')
        r.Replace('lib/', '%(lib)s/',
                  'pppd/{,plugins/{,radius/,pppoatm/,rp-pppoe/}}Makefile.linux')

        r.Configure('--prefix=%(destdir)s%(prefix)s')
        r.Make()
        r.MakeInstall('DESTDIR=%(destdir)s%(prefix)s'
                      ' ETCDIR=%(destdir)s/%(sysconfdir)s/ppp')

        # why upstream packages a setuid *library* I have no idea
        r.SetModes('%(libdir)s/pppd/%(version)s/rp-pppoe.so', 0755)
        r.SetModes('%(libdir)s/pppd/%(version)s/pppoatm.so', 0755)

        # ppp daemon needs to be setuid
        r.SetModes('%(sbindir)s/pppd', 04755)

        r.MakeDirs('%(localstatedir)s/log/ppp', mode=0700)
        r.Install('ppp-2.3.5-pamd.conf', '/etc/pam.d/ppp', mode=0644)
        r.Install('ppp.logrotate', '/etc/logrotate.d/ppp', mode=0644)

        # fixes runtime error about being unable to find this file
        r.Create('/var/log/ppp/connect-errors')
