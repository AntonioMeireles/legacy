#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Ppp(CPackageRecipe):
    name = 'ppp'
    version = '2.4.4'

    buildRequires = [ 'pam:devel', 'libpcap:devel']

    def setup(r):
        r.addArchive('ftp://ftp.samba.org/pub/ppp/ppp-%(version)s.tar.gz')
        srpm = 'http://ftp.linux.ncsu.edu/pub/fedora/linux/core/development/source/SRPMS/ppp-2.4.4-2.src.rpm'
        r.addPatch('ppp-2.4.4-no_strip.patch', level=1)
        for patch in [
            'ppp-2.3.6-sample.patch',
            'ppp-2.4.1-varargs.patch',
            'ppp-2.4.2-change_resolv_conf.patch',
            'ppp-2.4.2-libutil.patch',
            'ppp-2.4.2-pie.patch',
            'ppp-2.4.2-pppoatm-make.patch',
            'ppp-2.4.2-pppoatm-mtu.patch',
            'ppp-2.4.3-fix.patch',
            'ppp-2.4.3-fix64.patch',
            'ppp-2.4.3-ipv6-accept-remote.patch',
            'ppp-2.4.3-local.patch',
            'ppp-2.4.3-make.patch',
            'ppp-2.4.4-cbcp.patch',
            'ppp-2.4.4-lib64.patch']:
                r.addPatch(patch, rpm=srpm)

        r.addPatch('make.patch')
        r.addSource('ppp-2.3.5-pamd.conf', rpm=srpm)
        r.addSource('ppp.logrotate', rpm=srpm)

        # deal with new libpcap version
        r.Replace('#include <net/bpf.h>', '#include <pcap-bpf.h>',
                  'pppd/plugins/rp-pppoe/if.c')
        r.Replace('lib/', '%(lib)s/',
                  'pppd/{,plugins/{,radius/,pppoatm/,rp-pppoe/}}Makefile.linux')

        r.Configure('--prefix=%(prefix)s')
        r.Make()
        r.MakeInstall('INSTROOT=%(destdir)s', 'DESTDIR=%(prefix)s'
                      ' ETCDIR=%(sysconfdir)s/ppp')

        # why upstream packages a setuid *library* I have no idea
        r.SetModes('%(libdir)s/pppd/%(version)s/rp-pppoe.so', 0755)
        r.SetModes('%(libdir)s/pppd/%(version)s/pppoatm.so', 0755)

        # ppp daemon needs to be setuid
        r.SetModes('%(sbindir)s/pppd', 04755)

        r.MakeDirs('%(localstatedir)s/log/ppp', mode=0700)
        r.Install('ppp-2.3.5-pamd.conf', '/etc/pam.d/ppp', mode=0644)
        r.Install('ppp.logrotate', '/etc/logrotate.d/ppp', mode=0644)

        # fixes runtime error about being unable to find this file
        r.Create('/var/log/ppp/connect-errors')
