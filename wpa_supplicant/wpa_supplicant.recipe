# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class WpaSupplicant(RPMPackageRecipe, AutoPackageRecipe):
   name = 'wpa_supplicant'
   version = '0.5.7'
   rpmRelease = '19.fc8'

   rpmPatches = [ 'wpa_supplicant-assoc-timeout.patch',
                  'wpa_supplicant-driver-wext-debug.patch',
                  'wpa_supplicant-wep-key-fix.patch',
                  'wpa_supplicant-fix-deprecated-dbus-function.patch',
                  'wpa_supplicant-0.5.7-debug-file.patch',
                  'wpa_supplicant-0.5.7-qmake-location.patch',
                  'wpa_supplicant-0.5.7-flush-debug-output.patch',
                  'wpa_supplicant-0.5.7-sigusr1-changes-debuglevel.patch',
                  'wpa_supplicant-0.5.7-always-scan.patch',
                  'wpa_supplicant-0.5.7-dbus-iface-segfault-fix.patch',
                  'wpa_supplicant-0.5.7-dbus-blobs.patch',
                  'wpa_supplicant-0.5.7-dbus-permissions-fix.patch',
                  'wpa_supplicant-0.5.7-ignore-dup-ca-cert-addition.patch',
                  'wpa_supplicant-0.5.7-fix-dynamic-wep-with-mac80211.patch',
                  'wpa_supplicant-0.5.7-use-IW_ENCODE_TEMP.patch',
                  'wpa_supplicant-0.5.7-fix-signal-leaks.patch'
                  ]

   rpmArchives = ['madwifi-headers-r1475.tar.bz2']
   rpmSources = [
      '%(name)s.config',
      '%(name)s.conf',
      '%(name)s.init.d',
      '%(name)s.sysconfig',
      'fi.epitest.hostap.WPASupplicant.service',
      '%(name)s.logrotate'
      ]

   buildRequires = ['openssl:devel', 'glibc:devel', 'chkconfig:runtime', 'dbus:devel', 'pkgconfig:devel']

   def configure(r):
      r.Move('wpa_supplicant.config', '.config')

   def make(r):
      r.Make()

   def makeinstall(r):
      # No make install, so we copy manually

      # init scripts
      r.Replace('- 12 88', '345 12 88' ,'%(name)s.init.d')
      r.Install('%(name)s.init.d', '%(sysconfdir)s/init.d/%(name)s', mode=0755)
      r.Install('%(name)s.sysconfig', '%(sysconfdir)s/sysconfig/%(name)s', mode=0644)
      r.Install('%(name)s.logrotate', '%(sysconfdir)s/logrotate.d/%(name)s', mode=0644)

      # config 
      r.Install('%(name)s.conf', '%(sysconfdir)s/%(name)s/', mode=0600)

      # binary
      for x in ['wpa_cli', 'wpa_passphrase', 'wpa_supplicant']:
         r.Install(x, '%(sbindir)s/', mode=0755)

      r.Install('dbus-wpa_supplicant.conf', '%(sysconfdir)s/dbus-1/system.d/', mode=0644)
      r.Install('fi.epitest.hostap.WPASupplicant.service', '%(sysconfdir)s/dbus-1/system-services/', mode=0644)

      r.MakeDirs('%(localstatedir)s/run/wpa_supplicant')
      r.ExcludeDirectories(exceptions=['%(localstatedir)s/run/wpa_supplicant'])
      r.Install('doc/docbook/*.8','%(mandir)s/man8/')
      r.Install('doc/docbook/*.5','%(mandir)s/man5/')

