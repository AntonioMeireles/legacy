# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class WpaSupplicant(RPMPackageRecipe, AutoPackageRecipe):
   name = 'wpa_supplicant'
   version = '0.6.8'
   rpmRelease = '1.fc11'

   rpmPatches = [ 'wpa_supplicant-assoc-timeout.patch',
                  'wpa_supplicant-0.5.7-qmake-location.patch',
                  'wpa_supplicant-0.5.7-flush-debug-output.patch',
                  'wpa_supplicant-0.5.10-dbus-service-file.patch',
                  'wpa_supplicant-0.6.7-quiet-scan-results-message.patch',  
                  ]

   rpmSources = [
      '%(name)s.config',
      '%(name)s.conf',
      '%(name)s.init.d',
      '%(name)s.sysconfig',
      '%(name)s.logrotate'
      ]

   buildRequires = ['openssl:devel', 'glibc:devel', 'chkconfig:runtime', 'dbus:devel', 'pkgconfig:devel']

   def configure(r):
      r.Move('wpa_supplicant.config', '%(name)s/.config')
      r.Environment('CFLAGS', '%(cflags)s')
      r.Environment('CXXFLAGS', '%(cxxflags)s')

   def make(r):
      r.Make(dir = '%(name)s')

   def makeinstall(r):
      # No make install, so we copy manually

      # init scripts
      r.Install('%(name)s.init.d', '%(sysconfdir)s/init.d/%(name)s', mode=0755)
      r.Install('%(name)s.sysconfig', '%(sysconfdir)s/sysconfig/%(name)s', mode=0644)
      r.Install('%(name)s.logrotate', '%(sysconfdir)s/logrotate.d/%(name)s', mode=0644)

      # config 
      r.Install('%(name)s.conf', '%(sysconfdir)s/%(name)s/', mode=0600)

      # binary
      for x in ['wpa_cli', 'wpa_passphrase', 'wpa_supplicant']:
         r.Install('%(name)s/' + x, '%(sbindir)s/', mode=0755)

      r.Install('%(name)s/dbus-wpa_supplicant.conf', '%(sysconfdir)s/dbus-1/system.d/', mode=0644)
      r.Install('%(name)s/dbus-wpa_supplicant.service', '%(datadir)s/dbus-1/system-services/fi.epitest.hostap.WPASupplicant.service', mode=0644)

      r.MakeDirs('%(localstatedir)s/run/wpa_supplicant/')
      r.ExcludeDirectories(exceptions=['%(localstatedir)s/run/wpa_supplicant'])
      r.Install('%(name)s/doc/docbook/*.8','%(mandir)s/man8/')
      r.Install('%(name)s/doc/docbook/*.5','%(mandir)s/man5/')

