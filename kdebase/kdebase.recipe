#
# Copyright (c) 2006-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kdecorepackage')
class kdeBase(kdeCorePackageRecipe):

    name = 'kdebase'
    version = '3.5.9'

    verify = False
    buildAPIDox = False

    buildRequires = [
        'alsa-lib:devel', 'audiofile:devel', 'autoconf:runtime',
        'automake:runtime', 'avahi-qt3:devel', 'avahi:devel',
        'bdftopcf:runtime', 'ConsoleKit:devel', 'cups:devel',
        'cyrus-sasl:devel', 'dbus-qt3:devel', 'dbus:devel',
        'desktop-file-utils:runtime', 'e2fsprogs:devel', 'esound:devel',
        'expat:devel', 'fontconfig:runtime', 'glib:devel', 'hal:devel',
        'ilmbase:devel', 'imake:runtime', 'jack:devel', 'kdnssd-avahi:devel',
        'libmad:devel', 'libogg:devel', 'libraw1394:devel', 'libusb:devel',
        'libvorbis:devel', 'libxkbfile:devel', 'lm_sensors:devel',
        'mkfontdir:runtime', 'ncurses:devel', 'openexr:devel', 'openldap:devel',
        'openssl:devel', 'pam:devel', 'pcre:devel', 'samba:devel',
        'xorg-cf-files:lib', 'xorg-cf-files:data',
    ]

    extraConf = kdeCorePackageRecipe.extraConf
    extraConf += (' --without-java'
                  ' --with-sudo-kdesu-backend'
                  ' --with-pam'
                  ' --with-kdm-pam=kdm'
                  ' --with-kcp-pam=kcheckpass'
                  ' --with-kss-pam=kscreensaver')

    # This always should be installed
    modules = [
        ('kdebase', 'drkonqi'),
        ('kdebase', 'kdebugdialog'),
        ('kdebase', 'kdesu'),
        ('kdebase', 'kreadconfig'),
        ('kdebase', 'kstart'),
        ('kdebase', 'kioslave'),
        ('kdebase', 'l10n'),
    ]

    # This needed for KDE workspace
    modules.extend([
        ('kdebase-workspace', 'applnk'),
        ('kdebase-workspace', 'pics'),
        ('kdebase-workspace', 'kcontrol'),
        ('kdebase-workspace', 'kdesktop'),
        ('kdebase-workspace', 'kicker'),
        ('kdebase-workspace', 'klipper'),
        ('kdebase-workspace', 'kmenuedit'),
        ('kdebase-workspace', 'kpersonalizer'),
        ('kdebase-workspace', 'kscreensaver'),
        ('kdebase-workspace', 'ksmserver'),
        ('kdebase-workspace', 'ksplashml'),
        ('kdebase-workspace', 'ksysguard'),
        ('kdebase-workspace', 'ksystraycmd'),
        ('kdebase-workspace', 'ktip'),
        ('kdebase-workspace', 'kcminit'),
        ('kdebase-workspace', 'kcheckpass'),
        ('kdebase-workspace', 'kwin'),
        ('kdebase-workspace', 'doc/kompmgr'),
    ])

    modules.extend([
        'kappfinder', 'kate', 'libkonq', 'kdm', 'kdcop', 'kdeeject',
        'kdepasswd', 'kdeprint', 'kdialog', 'kfind', 'khelpcenter', 'khotkeys',
        'knetattach', 'konqueror', 'konsole', 'kpager', 'kxkb',
        ('konqueror-nsplugins', 'nsplugins'),
        ('kdm', 'kdmlib'),
        ('kate', 'doc/kwrite'),
        ('khelpcenter', 'doc/faq'),
        ('khelpcenter', 'doc/glossary'),
        ('khelpcenter', 'doc/kinfocenter'),
        ('khelpcenter', 'doc/quickstart'),
        ('khelpcenter', 'doc/userguide'),
        ('khelpcenter', 'doc/visualdict'),
    ])

    def postUnpack(r):

        r.addSource('kdm.pam')
        r.addSource('kcheckpass.pam')
        r.addSource('kscreensaver.pam')

        r.addPatch('kdebase-3.5.6-kdmrc.patch')
        r.addPatch('kdebase-3.5.9-use-xdm-startscripts.patch')
        r.addPatch('kdebase-3.5.9-96-dpi.patch')
        r.addPatch('kdebase-3.5.9-kdm-logo.patch')
        r.addPatch('kdebase-3.4.3-halt-poweroff.patch')
        r.addPatch('kdebase-3.5.9-startkde-pulseaudio.patch') # https://issues.foresightlinux.org/browse/KDE-26

        r.Replace(
            'applications-merged', 'kde-applications-merged',
            'applnk/Makefile.am'
        )

        # http://groups.google.com/group/linux.debian.bugs.dist/browse_thread/thread/dd83d03fb92adee1
        # Support for ConsoleKit in kdm
        r.addPatch('kdebase-3.5.9-kdm-consolekit-support.patch')

        r.Run('echo >> kate/data/katerc')

        #Need to re-generate configure since the consolekit patch above modifies configure.in
        r.Make('-f admin/Makefile.common')

    def postInstall(r):

        r.Install('kdm.pam', '%(sysconfdir)s/pam.d/kdm', package='kdm')
        r.Install('kcheckpass.pam', '%(sysconfdir)s/pam.d/kcheckpass',
                  package='kdebase-workspace')
        r.Install('kscreensaver.pam', '%(sysconfdir)s/pam.d/kscreensaver',
                  package='kdebase-workspace')

        # Setup configuration files.
        r.Install('kdm/kfrontend/sessions/kde.desktop',
                  '%(datadir)s/xsessions/', package='kdm')

        # Default face for KDM
        r.Copy('%(datadir)s/apps/kdm/pics/users/Penguin.png',
               '%(datadir)s/apps/kdm/pics/users/.default.face.icon',
               package='kdm')

        r.Ownership('root', 'nobody', '%(bindir)s/kdesud')
        r.SetModes('%(bindir)s/kdesud', 02755)
        r.SetModes('%(bindir)s/kcheckpass', 04755)

        r.Install('startkde', '%(bindir)s', mode=0755,
                  package='kdebase-workspace')

        #Apply our backgroundrc instead of the default
        r.Replace('^#?BackgroundCfg=.*', 'BackgroundCfg=%(datadir)s/kde3-profiles/default/share/apps/kdm/backgroundrc', '%(sysconfdir)s/kde3/kdm/kdmrc')

    def policy(r):

        r.ExcludeDirectories(exceptions='%(datadir)s/fonts/override')
        r.ExcludeDirectories(exceptions='%(datadir)s/applnk/Settings/Information')
        r.ExcludeDirectories(exceptions='%(datadir)s/templates/.source/emptydir')

        r.Requires('kde-settings:data', '%(sysconfdir)s/kde3/kdm/kdmrc')
