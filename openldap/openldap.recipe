#
# Copyright (c) 2004-2005 rpath, Inc.
# All rights reserved
#
# Based on http://www.gentoo.org/cgi-bin/viewcvs.cgi/net-nds/openldap/openldap-2.2.23.ebuild?rev=1.3&hideattic=1&content-type=text/vnd.viewcvs-markup

class Openldap(PackageRecipe):
    name = 'openldap'
    version = '2.2.26'

    buildRequires = [ 'cyrus-sasl:devel', 'gdbm:devel', 'krb5:devel',
                      'openssl:devel', 'pam:devel', 'perl:runtime',
                      'pkgconfig:devel', 'tcp_wrappers:devel',
                      'libtool:runtime', 'autoconf:runtime=:autoconf213',
                      'db:devel' ]

    def setup(r):
        r.disableParallelMake()

        r.addArchive('ftp://ftp.OpenLDAP.org/pub/OpenLDAP/openldap-release/openldap-%(version)s.tgz')

        r.addSource('ldap.init', dest='%(initdir)s/ldap', mode=0755, macros=True)
        r.addSource('http://www.openldap.org/doc/admin23/guide.html')

        r.Replace(r'\$\(SLAPD_LIBS\) \$\(SECURITY_LIBS\) \$\(LUTIL_LIBS\)',
                  '$(LUTIL_LIBS) $(SLAPD_LIBS) $(SECURITY_LIBS)',
                  'servers/slapd/Makefile.in')

        r.addPatch('openldap-2.2.14-db40.patch')
        r.addPatch('openldap-2.2.14-perlthreadsfix.patch')
	r.addPatch('openldap-ntlm.diff', level=0)

        r.Replace('(#define LDAPI_SOCK).*',
                  r'\1 "/var/run/openldap/slapd.sock"',
                  'include/ldap_defaults.h')

        r.Symlink('shtool', 'build/install')
        r.Symlink('shtool', 'build/install.sh')

        r.Run('autoconf-2.13')

        r.macros.ssl_cflags  = ' -I%(krbprefix)s/include'
        r.macros.ssl_ldflags = ' -L%(krbprefix)s/%(libdir)s'
        r.macros.cppflags += '%(ssl_cflags)s'
        r.macros.cflags += '%(ssl_cflags)s'
        r.macros.ldflags += '%(ssl_ldflags)s'
        r.macros.cflags += ' -pipe -D_REENTRANT -fPIC'

        extraConfigure = (' --with-slapd --with-slurpd'
            ' --enable-syslog --enable-dynamic --enable-modules'
            ' --enable-rewrite --enable-rlookups'
            ' --enable-passwd=mod --enable-phonetic=mod'
            ' --enable-dnssrv=mod --enable-ldap'
            ' --enable-meta=mod --enable-monitor=mod'
            ' --enable-null=mod --enable-shell=mod'
            ' --enable-local --enable-proctitle'
            ' --enable-dyngroup'
            ' --enable-aci --enable-proxycache'
            ' --enable-cleartext --enable-slapi'
            ' --enable-local --enable-cldap --with-tls'
            ' --enable-wrappers --enable-crypt --disable-sql --without-ldapd'
            ' --with-threads=posix'
            ' --localstatedir=%(localstatedir)s/run'
            ' --enable-static --enable-shared')

        if Use.sasl:
            extraConfigure += ' --with-cyrus-sasl'
        else:
            extraConfigure += ' --without-cyrus-sasl'

        r.Configure(extraConfigure)

        r.Make('LIBTOOL=%(bindir)s/libtool depend')
        r.Make('LIBTOOL=%(bindir)s/libtool')

        r.MakeInstall('LIBTOOL=%(bindir)s/libtool')

        r.SetModes('%(sysconfdir)s/openldap/slapd.conf', 0600)

        r.MakeDirs('%(localstatedir)s/%(lib)s/ldap')
        r.SetModes('%(localstatedir)s/%(lib)s/ldap', 0700,
                   component='openldap-servers:runtime')
        r.Ownership('ldap', 'ldap', '%(localstatedir)s/%(lib)s/ldap')
        r.User('ldap', 55, comment='LDAP User', homedir='/var/lib/ldap')

        r.Remove('%(libexecdir)s/openldap/*.a')

        r.PackageSpec('openldap-clients',
                      '%(bindir)s/.*', '%(mandir)s/man1/.*')

        r.PackageSpec('openldap-servers',
                      '%(initdir)s/ldap',
                      '%(sysconfdir)s/openldap/slapd\.conf',
                      '%(sysconfdir)s/openldap/schema/.*\.schema.*',
                      '%(sysconfdir)s/openldap/schema/redhat/.*\.schema.*',
                      '%(datadir)s/openldap/(go500gw|rcpt500).help',
                      '%(sbindir)s/.*',
                      '%(mandir)s/man8/.*',
                      '%(datadir)s/openldap/*.help',
                      '%(datadir)s/openldap/migration/README.*',
                      '%(datadir)s/openldap/migration/.*\.(ph|pl|sh|txt)',
                      '%(localstatedir)s/%(lib)s/ldap')
        r.TagSpec('initscript', '%(initdir)s/')
        r.AutoDoc('ANNOUNCEMENT', r'doc/rfc/.*\.txt')
        r.TagSpec('initscript', '%(initdir)s/')
