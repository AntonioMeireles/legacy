!/bin/bash

function runCompiz() {
	 LIBGL_ALWAYS_INDIRECT=1 exec compiz.real --ignore-desktop-hints glib gconf --replace & gtk-window-decorator
}

DIRECT=`glxinfo | grep "direct rendering: " | head -n 1 | cut -d " " -f 3`
ISSW=`glxinfo | grep "Software Rasterizer" -c`

# Try again with indirect rendering
export LIBGL_ALWAYS_INDIRECT=1

HAVETFP=`glxinfo | grep texture_from_pixmap -c`

if ( [ $DIRECT == "Yes" ] && [ $ISSW == 0 ] && [ $HAVETFP -gt 2 ] ); then 
   runCompiz $@
fi

# Fall back to metacity
exec metacity $@
