#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Grub(AutoPackageRecipe):
    name = 'grub'
    version = '0.97.24'
    buildRequires = [ 'texinfo:runtime', 'autoconf:runtime',
                      'automake:runtime', 'install-info:runtime',
                      'ncurses:devel' ]

    Flags.static = False

    def unpack(r):
        r.addGitSnapshot('git://git.kernel.org/pub/scm/boot/grub-fedora/grub-fedora.git', tag='grub-0.97-24')
        r.addPatch('build-id.patch', level=0)
        r.addPatch('grub-0.97-boot_image.patch')
        # Not using until safe (RPL-1282) (RPL-1306)
        # r.addPatch('grub-0.97-stage2-config.patch')
        # r.addSource('grub-stage2.tagdescription', macros=True,
        #             dest='%(tagdescriptiondir)s/grub-stage2')
        # r.addSource('grub-stage2.taghandler', macros=True, mode=0755,
        #             dest='%(taghandlerdir)s/grub-stage2')
        # r.addSource('grub-stage2-config.c', dest='util/')

    def configure(r):
        r.Run('autoreconf --install --force')
        r.macros.cflags = '-Os -g -fno-strict-aliasing -Wall -Wno-shadow -Wno-unused -Wno-pointer-sign -fno-PIE'
        if Flags.static:
            r.macros.cflags += ' -static'
        r.Configure(' --sbindir=%(essentialsbindir)s --disable-auto-linux-mem-opt --without-curses')

    def policy(r):
        # we hack this to remove the dependency of grub-install on diffutils
        r.Replace(re.escape('cmp $file $img_file'),
            '''[ "$(md5sum $file | awk '{ print $1 }')"  = "$(md5sum $img_file | awk '{ print $1 }')" ]''',
            '%(essentialsbindir)s/grub-install')

        for x in ('%(essentialbindir)s/cat', '%(bindir)s/test',
            '%(essentialbindir)s/grep', '/dev/null', '%(bindir)s/md5sum',
            '%(essentialbindir)s/awk'):
            r.Requires(x, '%(essentialsbindir)s/grub-install')


        #r.Requires('%(essentialbindir)s/cp', '%(taghandlerdir)s/grub-stage2')
        #r.Requires('%(essentialbindir)s/ln', '%(taghandlerdir)s/grub-stage2')
        #r.Requires('%(essentialbindir)s/rm', '%(taghandlerdir)s/grub-stage2')

