--- dnsmasq-2.26/rpm/dnsmasq.rh	2006-01-16 14:34:04.000000000 -0500
+++ dnsmasq-2.26/rpm/dnsmasq.rh	2005-12-26 10:51:19.000000000 -0500
@@ -10,6 +10,29 @@
 # Source function library.
 . /etc/rc.d/init.d/functions
 
+function setup_dhclient_enter_hooks() {
+    if [ -f /etc/dhclient-enter-hooks ]; then
+        . /etc/dhclient-enter-hooks
+        cp /etc/resolv.conf /etc/resolv.conf.dnsmasq
+        cp /etc/dhclient-enter-hooks /etc/dhclient-enter-hooks.dnsmasq
+        sed -e 's/resolv\.conf$/resolv.conf.dnsmasq/' /etc/dhclient-enter-hooks.dnsmasq > /etc/dhclient-enter-hooks
+        sed -e 's/\(nameserver[ tab]\+\)[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+$/\1127.0.0.1/' /etc/resolv.conf.dnsmasq > /etc/resolv.conf
+    fi
+}
+
+function teardown_dhclient_enter_hooks() {
+    if [ -f /etc/dhclient-enter-hooks -a -f /etc/dhclient-enter-hooks.dnsmasq ]; then
+        if [ -f /etc/resolv.conf.dnsmasq ]; then
+            mv /etc/resolv.conf.dnsmasq /etc/resolv.conf
+        fi
+	if [ -f /etc/dhclient-enter-hooks.dnsmasq ]; then
+            #Do the sed command to ensure we have a good dhclient-enter-hooks
+            sed -e 's/resolv\.conf\.dnsmasq$/resolv.conf/' /etc/dhclient-enter-hooks.dnsmasq > /etc/dhclient-enter-hooks
+	    rm /etc/dhclient-enter-hooks.dnsmasq
+	fi
+    fi
+}
+
 # Source networking configuration.
 . /etc/sysconfig/network
 
@@ -24,7 +47,7 @@
 MAILHOSTNAME=""
 # change this line if you want dns to get its upstream servers from
 # somewhere other that /etc/resolv.conf 
-RESOLV_CONF=""
+RESOLV_CONF="/etc/resolv.conf.dnsmasq"
 # change this if you want dnsmasq to cache any "hostname" or "client-hostname" from
 # a dhcpd's lease file
 DHCP_LEASE="/var/lib/dhcp/dhcpd.leases"
@@ -54,6 +77,9 @@
 case "$1" in
   start)
         echo -n "Starting dnsmasq: "
+        #Teardown in case of unclean shutdown
+        teardown_dhclient_enter_hooks
+        setup_dhclient_enter_hooks
         daemon $dnsmasq $OPTIONS
 	RETVAL=$?
         echo
@@ -62,6 +88,7 @@
   stop)
         if test "x`pidof dnsmasq`" != x; then
             echo -n "Shutting down dnsmasq: "
+            teardown_dhclient_enter_hooks
             killproc dnsmasq
         fi
 	RETVAL=$?
