#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Usermode(RPMPackageRecipe, AutoPackageRecipe):
    name = 'usermode'
    version = '1.85'
    rpmRelease = '2.2.1'

    buildRequires = [ 'desktop-file-utils:runtime', 'glib:devel', 'gtk:devel',
                      'libglade:devel', 'libuser:devel', 'pam:devel',
                      'util-linux:runtime', 'intltool:runtime', 'atk:devel',
                      'libxml2:devel', 'pango:devel',
                      'zlib:devel', 'cairo:devel', 'fontconfig:devel',
                      'freetype:devel', 'gettext:runtime', 'libpng:devel',
                      'perl:runtime', 'pkgconfig:devel',
                      'libX11:devel', 'libXt:devel', 'libXau:devel',
                      'libXdmcp:devel', ]

    def policy(r):
        r.addPatch('Makefile.in.desktops', level=0)
        r.MakeDirs('%(sysconfdir)s/pam.d')

        for wrappedapp in ('halt', 'reboot', 'poweroff'):
            r.Symlink('consolehelper', '%(bindir)s/' + wrappedapp)
            r.Install(wrappedapp, '%(sysconfdir)s/security/console.apps/')
            r.Run('cp shutdown.pamd %(destdir)s/%(sysconfdir)s/pam.d/' + wrappedapp)

        r.Remove('%(bindir)s/shutdown')

        r.SetModes('%(sbindir)s/userhelper', 04711)
        r.Provides('file', '%(bindir)s/consolehelper', '%(sbindir)s/userhelper')
        r.Requires('%(bindir)s/consolehelper'%r.macros,
                   '%(bindir)s/(halt|poweroff|reboot)')
        r.Requires('%(sbindir)s/userhelper'%r.macros,
                   '%(bindir)s/consolehelper')
        r.PackageSpec('%(name)s-gtk',
                      '%(datadir)s/pixmaps/.*',
                      '%(datadir)s/usermode/usermode.glade',
                      '%(mandir)s/man1/.*',
                      '%(datadir)s/applications/.*',
                      '%(bindir)s/consolehelper-gtk',
                      '%(bindir)s/pam-panel-icon',
                      '%(bindir)s/userinfo',
                      '%(bindir)s/usermount',
                      '%(bindir)s/userpasswd')
