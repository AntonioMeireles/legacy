#
# Copyright (c) 2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('gnomepackage')
loadSuperClass('rpmpackage')

class Gvfs(RPMPackageRecipe,GnomePackageRecipe):
    buildRequires = [ 'fuse:devel', 'openssh-client:runtime', 'glib:devel',
                      'gtk-doc:runtime', 'hal:devel', 'libsoup:devel',
                      'libxml2:devel', 'samba:devel', 'GConf:devel', 'ORBit2:devel',
                      'avahi-glib:devel', 'avahi:devel', 'gnome-keyring:devel',
                      'libexif:devel', 'libgphoto2:devel', 'libusb:devel',
                      'bluez:devel', 'samba-client:lib',
                      'automake:runtime', 'autoconf:runtime', 'libtool:runtime',
                      'PolicyKit:devel', 'gnome-disk-utility:devel',
                      'libcdio:devel',
                      ]

    name = 'gvfs'
    # FIXME don't bump until we get a newer gdu (blocked by polkit et ak.)  
    version = '1.2.3'
    rpmRelease = '12.fc11'
    rpmPatches = [ # http://bugzilla.gnome.org/show_bug.cgi?id=567235
                   'gvfs-0.99.2-archive-integration.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=573826
                   'gvfs-1.1.7-gdu-computer-expose-devices.patch',
                   # https://bugzilla.redhat.com/show_bug.cgi?id=497631
                   'gvfs-1.2.2-dnssd-deadlock.patch',
                   # Unable to Play Audio CDs 
                   # https://bugzilla.redhat.com/show_bug.cgi?id=499266 
                   'gvfs-1.2.3-cdda-allow-query-well-formed-filenames-only.patch',
                   # SFTP timeout too short
                   # https://bugzilla.redhat.com/show_bug.cgi?id=504339
                   'gvfs-1.2.3-sftp-40sec-timeout.patch',
                   # smb url don't work in the run application dialog 
                   # http://bugzilla.gnome.org/show_bug.cgi?id=573994 
                   'gvfs-1.3.4-smb-browse-fake-content-type.patch',
                   # nautilus can't create "unamed folder X" if it exist on the target via sftp
                   # https://bugzilla.redhat.com/show_bug.cgi?id=512611
                   'gvfs-1.3.5-mkdir-exists-error.patch',
                   # Gdu volume monitor patches, from http://cgit.freedesktop.org/~david/gvfs/log/?h=gdu-volume-monitor
                   #
                   # These are all in gvfs' master branch on git.gnome.org.
                   #
                   # http://bugzilla.gnome.org/show_bug.cgi?id=573826
                   'gdu-0001-Bug-573826-gdu-volume-monitor.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=573826
                   'gdu-0002-Fix-how-we-determine-if-a-volume-is-ignored.patch',
                   # https://bugzilla.redhat.com/show_bug.cgi?id=494144
                   'gdu-0003-Avoid-automounting-volumes-on-virtual-and-unknown-bu.patch',
                   'gdu-0004-Remove-debug-spew.patch',
                   # https://bugzilla.redhat.com/show_bug.cgi?id=495033
                   'gdu-0005-Don-t-add-a-volume-if-the-device-is-mounted-and-igno.patch',
                   'gdu-0006-Ignore-drives-if-all-volumes-of-the-drive-are-ignore.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=576587
                   # - Pending discussion + requires Nautilus patch',
                   'gdu-0007-Bug-576587-allow-eject-even-on-non-ejectable-vol.patch',
                   # https://bugzilla.redhat.com/show_bug.cgi?id=495152
                   'gdu-0008-ignore-drives-without-volumes.patch',
                   'gdu-0009-never-ignore-drives-without-media.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=536292
                   'gdu-0010-show-user-mountable-fstab-entries.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=576083
                   'gdu-0011-Bug-576083-pre-unmount-signals-not-being-trigger.patch',
                   # https://bugzilla.redhat.com/show_bug.cgi?id=495170
                   'gdu-0012-use-new-gnome-disk-utility-API-to-hide-unwanted-devi.patch',
                   'gdu-0013-pass-the-flush-mount-option-for-vfat.patch',
                   # Only automount when media has just been inserted
                   '0014-gvfs-use-device-media-detected.patch',
                   # https://bugzilla.redhat.com/show_bug.cgi?id=498649
                   '0015-gvfs-respect-presentation-hide-for-drives.patch',
                   # Better handling of PC floppy drives
                   'welcome-to-the-80s.patch',
                   # gvfsd-computer crashes with SEGSEV in recompute_files
                   # https://bugzilla.gnome.org/show_bug.cgi?id=582772
                   'gvfs-1.3.2-gdu-never-use-empty-names.patch',
                   # Audio CD isn't automounting when inserted
                   # http://bugzilla.gnome.org/show_bug.cgi?id=583494
                   'gvfs-1.3.1-audiocd-automount.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=582373
                   'webdav-username.patch',
                   'gvfs-1.2.4-fix-gphoto2-for-canon-5d.patch',
                   # Backported from master:
                   #  Bad mount prefix stripping in g_daemon_file_get_path()
                   #  http://bugzilla.gnome.org/show_bug.cgi?id=590862
                   'mount-prefix-0001-Include-mount-prefix-when-constructing-fuse-path.patch',
                   #  GDaemonMount calculates wrong root path when mount_prefix is set
                   #  http://bugzilla.gnome.org/show_bug.cgi?id=590730
                   'mount-prefix-0002-GDaemonMount-calculates-wrong-root-path-when-mount_p.patch',
                   'mount-prefix-0003-Canonicalize-mount-prefix-to-prevent-mountspec-match.patch',
        ]

    extraConfig  = ' --enable-samba --with-bash-completion-dir=%(sysconfdir)s/bash_completion.d/'
    extraConfig += ' --disable-gdu '
    def unpack(r):
        RPMPackageRecipe.unpack(r)
        r.Run('libtoolize --force; aclocal; autoheader; automake; autoconf')

    def policy(r):
        r.SetModes('%(sysconfdir)s/bash_completion.d/gvfs-bash-completion.sh', 0644)
        r.NonBinariesInBindirs(exceptions='%(sysconfdir)s/bash_completion.d/gvfs-bash-completion.sh')
