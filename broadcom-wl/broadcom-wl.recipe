#
# Copyright (c) 2008-2013 The Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class BroadcomWl(AutoPackageRecipe):
    name = 'broadcom-wl'
    version =  '5.100.82.112'
    buildRequires = ['b43-fwcutter:runtime']

    def setup(r):
        r.macros.version = r.version.replace('.', '_')
        r.macros.version = r.version.replace('.', '_')

        # driver fw for in-kernel b43
        r.addArchive('http://www.lwfinger.com/b43-firmware/broadcom-wl-5.100.138.tar.bz2')
        r.MakeDirs('/lib/firmware/')
        r.Run("b43-fwcutter -w %(destdir)s/lib/firmware/ linux/wl_apsta.o")
        r.PackageSpec('b43-firmware', '/lib/firmware/')
        r.SetModes('/lib/firmware/b43', 0755)
        r.Doc('README', package='b43-firmware')
        #
        r.Create('%(sysconfdir)s/modprobe.d/%(name)s-blacklist.conf', 
                 contents = """
# modules blacklisted for broadcom-wl
blacklist bcm43xx
blacklist ssb
blacklist b43
blacklist ndiswrapper

""", mode = 0644, component = 'runtime')
        
        # We want to make sure that the userspace code can require the
        # matching kernel-space code
        r.ComponentProvides('%(version)s')
        r.ComponentSpec('broadcom-wl:runtime', '/lib/modules/')

        # The kernel side is in %(name)s-kernel,
        r.Requires('%(name)s-kmod:runtime', 
                   '%(sysconfdir)s/')
