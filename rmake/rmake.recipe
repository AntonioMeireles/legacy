#
# Copyright (c) 2006-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class RmakeRecipe(CPackageRecipe):
    name = 'rmake'
    version = '1.0.28'

    buildRequires = [ 'conary:python', 'chkconfig:runtime', 'm2crypto:python',
                      'info-rmake:user',  'libcap:devel',
                      'pygtk:python', 'info-rmake-chroot:user',
                      'conary-repository:python', 'desktop-file-utils:runtime']


    def setup(r):
        r.packageProxy()
        r.packageRepos()
        # we reuse this code in a subclass where the name has changed.
        # r.addArchive('ftp://download.rpath.com/rmake/rmake-%(version)s.tar.bz2')
        # http://hg.rpath.com/rmake/rev/78e9361d4637 as no tarball atm 
        r.addMercurialSnapshot('http://hg.rpath.com/rmake', tag = '78e9361d4637')
        r.addSource('server.conf', dest='%(sysconfdir)s/rmake/serverrc',
                    macros=True)
        r.addSource('client.conf', dest='%(sysconfdir)s/rmake/rmakerc',
                    macros=True)

        r.InitialContents('%(sysconfdir)s/rmake/serverrc')
        r.InitialContents('%(sysconfdir)s/rmake/rmakerc')

        r.Make('libdir=%(libdir)s')
        r.MakeInstall('libdir=%(libdir)s')

        r.MakeDirs('%(localstatedir)s/lib/rmake')
        r.MakeDirs('%(localstatedir)s/log/rmake')
        r.MakeDirs('%(localstatedir)s/run/rmake')
        r.MakeDirs('%(localstatedir)s/rmake', mode=0700)
        r.MakeDirs('%(localstatedir)s/rmake/chroots', mode=0700)
        r.MakeDirs('%(localstatedir)s/rmake/archive', mode=0700)
        r.MakeDirs('%(localstatedir)s/rmake/chrootcache', mode=0700)
        r.MakeDirs('%(servicedir)s/rmake', mode=0700)
        r.MakeDirs('%(sysconfdir)s/rmake')
        r.MakeDirs('%(sysconfdir)s/rmake/server.d')
        r.MakeDirs('%(sysconfdir)s/rmake/client.d')
        r.Ownership('rmake', 'rmake',
                    '%(localstatedir)s/rmake',
                    '%(localstatedir)s/rmake/chroots',
                    '%(localstatedir)s/rmake/archive',
                    '%(localstatedir)s/rmake/chrootcache',
                    '%(localstatedir)s/(lib|log|run)/rmake',
                    '%(servicedir)s/rmake',
                    '%(libexecdir)s/rmake')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/(lib|log|run)/rmake')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake/chroots')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake/archive')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake/chrootcache')
        r.ExcludeDirectories(exceptions='%(servicedir)s/rmake')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/rmake')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/rmake/client.d')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/rmake/server.d')

        r.ComponentSpec('libexec', 'chroothelper')
        r.ComponentSpec('libexec', '%(localstatedir)s/rmake')
        r.ComponentSpec('libexec', '%(localstatedir)s/rmake/.*')
        r.ComponentSpec('libexec', '%(localstatedir)s/run/rmake')
        r.SetModes('%(libexecdir)s/rmake/chroothelper', 04755)
        r.Requires('rmake:libexec', 'rootfactory.py')
        r.Requires('busybox:runtime',
                   '%(libexecdir)s/rmake/chroothelper')
        r.Requires(exceptDeps='python: epdb')
        r.Requires(exceptDeps='python: rmake.cmdline.password')
        r.ComponentSpec('gtk', 'password.py(|c|o)')
        # make gtk require rmake:runtime
        r.ComponentRequires({'runtime' : ['gtk']})
        r.UtilizeUser('rmake-chroot', '%(libexecdir)s/rmake/chroothelper')
        r.UtilizeGroup('rmake-chroot', '%(libexecdir)s/rmake/chroothelper')
        r.Doc('extra/plugins/*.py')
        r.Doc('CPL')

    def packageProxy(r):
        r.macros.proxydir = '%(servicedir)s/rmake-proxy'
        r.macros.proxyport = '7778'
        r.addSource('rmake-proxy.conf',
                    dir = '/etc/httpd/conf.d/', macros=True,
                    package='rmake-proxy')
        r.addSource('rmake-proxy.cnr',
                    dir = '%(proxydir)s/config/', macros=True,
                    package='rmake-proxy')
        r.addSource('rmake-proxy-cleanup', dest = '/etc/cron.daily/',
                    macros=True,
                    package='rmake-proxy', mode=0755)
        r.Create('%(sysconfdir)s/rmake/server.d/proxy',
                 contents='proxy http://localhost:%(proxyport)s/',
                 package='rmake-proxy')
        for x in [ 'cscache', 'contents', 'tmp' ]:
            dir = '%%(proxydir)s/%s' % x
            r.MakeDirs(dir)
            r.Ownership('apache', 'apache', dir)
            r.SetModes(dir, 0700)
        r.PackageSpec('rmake-proxy', '%(proxydir)s/')
        r.PackageSpec('rmake-proxy', '/etc/httpd/conf.d/rmake-proxy.conf')
        r.PackageSpec('rmake-proxy', '/etc/cron.daily/rmake-proxy-cleanup')
        r.PackageSpec('rmake-proxy', '%(sysconfdir)s/rmake/server.d/proxy')
        r.ExcludeDirectories(exceptions='%(proxydir)s.*')

        # Runtime dependencies
        r.Requires('mod_python:runtime', '/etc/httpd/conf.d/rmake-proxy.conf')

    def packageRepos(r):
        r.macros.reposdir = '%(servicedir)s/rmake-repos'
        r.macros.reposport = '7777'
        r.addSource('rmake-repos.conf',
                    dir = '/etc/httpd/conf.d/', macros=True,
                    package='rmake-repos')
        r.addSource('rmake-repos.cnr',
                    dir = '%(reposdir)s/config/', macros=True,
                    package='rmake-repos')
        r.addSource('rmake-resetrepos', dir='%(sbindir)s', macros=True,
                    mode=0755)
        r.Create('%(sysconfdir)s/rmake/server.d/repos',
                 contents='''
serverUrl http://localhost:%(reposport)s/conary/
serverName localhost
''',
                 package='rmake-repos')
        for x in [ 'cscache', 'contents', 'tmp', 'db' ]:
            dir = '%%(reposdir)s/%s' % x
            r.MakeDirs(dir)
            r.Ownership('apache', 'apache', dir)
            r.SetModes(dir, 0700)
        r.PackageSpec('rmake-repos', '%(reposdir)s/')
        r.PackageSpec('rmake-repos', '/etc/httpd/conf.d/rmake-repos.conf')
        r.PackageSpec('rmake-repos', '%(sbindir)s/rmake-resetrepos')
        r.PackageSpec('rmake-repos', '%(sysconfdir)s/rmake/server.d/repos')

        # Runtime dependencies
        r.Requires('mod_python:runtime', '/etc/httpd/conf.d/rmake-repos.conf')
