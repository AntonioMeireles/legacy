#
# Copyright (c) 2006-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class UserspaceKernelHeaders(CPackageRecipe):
    name = 'userspace-kernel-headers'
    version = '2.6.29.1'

    keepBuildReqs = True
    if Use.bootstrap:
        clearBuildReqs(
        'binutils:runtime',
        'binutils:lib',
        'binutils:devellib',
        'gcc:runtime',
        'gcc:lib',
        'gcc:devel',
        'gcc:devellib',
        'libgcc:lib',
        'libgcc:devellib')
    buildRequires = [ 'unifdef:runtime', 'gcc[!cross]', 'binutils[!cross]', 'perl:runtime' ]

    def setup(r):

        # Cheap hack:
        # kernel headers are arch specific so we do need to flavor the build
        # even though we dont pass the traditional arch checks.
        if Arch.x86:
            pass

        r.addArchive('http://ftp.kernel.org/pub/linux/kernel/v2.6/linux-%(version)s.tar.bz2')

        if Use.bootstrap:
            r.Environment('PATH', '%(sysroot)s%(bindir)s:%(essentialbindir)s:%(bindir)s')

        r.Make('headers_install ARCH=i386 INSTALL_HDR_PATH=%(destdir)s/%(prefix)s')

        # Provided by glibc
        r.Remove('%(includedir)s/scsi/*', allowNoMatch=True)
        r.Remove('%(includedir)s/asm*/{atomic.h,io.h,irq.h}', allowNoMatch=True)

        # avoid clashes with libdrm:devel
        for i in [ 'drm.h',
                   'drm_mode.h',
                   'drm_sarea.h',
                   'i915_drm.h',
                   'mga_drm.h',
                   'r128_drm.h',
                   'radeon_drm.h',
                   'savage_drm.h',
                   'sis_drm.h',
                   'via_drm.h',
                   ]:
            r.Remove('%(includedir)s/drm/'+ i)

        # No need for autodoc here since it is the same docs which appear
        # in the kernel package
        r.AutoDoc(exceptions='.*')
