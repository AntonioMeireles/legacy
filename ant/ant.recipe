#
# Copyright (c) 2006-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('javapackage')
class Ant(JavaPackageRecipe):
    name = 'ant'
    version = '1.7.0'

    buildRequires = [ 'perl:lib', 'eclipse:java', ]

    def unpack(r):
        r.addArchive('http://www.apache.org/dist/%(name)s/source/apache-ant-%(version)s-src.tar.bz2', use=Use.gcj)

    def build(r):
        #if Use.bootstrap:
        #    r.Run('./bootstrap.sh -Ddist.dir=%(destdir)s/%(prefix)s jars -v')
        #else:
        #    r.Run('./build.sh -Ddist.dir=%(destdir)s/%(prefix)s dist -v -logfile antbuild.log')
        r.Replace('depends=\"jars,test-jar\"', 'depends="jars"', 'build.xml')
        r.Environment('BOOTJAVAC_OPTS', '-sourcepath %(builddir)s/src/main/')
        r.Run('./bootstrap.sh -Ddist.dir=%(destdir)s/%(prefix)s jars -v')

    def install(r):
        #if Use.bootstrap:
        #    r.Run('./bootstrap.sh -Ddist.dir=%(destdir)s/%(prefix)s install -v')
        #else:
        #    r.Run('./build.sh -Ddist.dir=%(destdir)s/%(prefix)s install -v')
        r.Run('./bootstrap.sh -Ddist.dir=%(destdir)s/%(prefix)s install -v')

        r.Remove('%(bindir)s/runrc.cmd')
        r.Remove('%(bindir)s/antenv.cmd')
        r.Remove('%(bindir)s/ant.bat')
        r.Remove('%(bindir)s/lcp.bat')
        r.Remove('%(bindir)s/ant.cmd')
        r.Remove('%(bindir)s/envset.cmd')
        r.Remove('%(bindir)s/antRun.bat')

    def upstreamUnpack(r):
        r.addArchive('http://mirror.candidhosting.com/pub/apache/ant/binaries/apache-ant-%(version)s-bin.tar.gz', use=(not Use.gcj))

    def upstreamSetup(r):
        r.Install('lib/*.jar', '%(libdir)s/')
        for bin in ('ant', 'antRun', 'antRun.pl', 'complete-ant-cmd.pl',
                    'runant.pl', 'runant.py'):
            r.Install('bin/%s' % bin, '%(bindir)s/')

        r.Requires(exceptDeps='java:.*')
