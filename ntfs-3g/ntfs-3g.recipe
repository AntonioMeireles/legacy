#
# Copyright (c) 2007 Paul Scott-Wilson <pscott>
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Ntfs3g(RPMPackageRecipe,AutoPackageRecipe):
    name = 'ntfs-3g'
    version = '2009.11.14'

    rpmRelease = '2.fc12'
    rpmPatches = ['ntfs-3g-1.2216-nomtab.patch']
    rpmSources = ['20-ntfs-config-write-policy.fdi']
    tarballName = 'ntfs-3g-%(version)s.tgz'

    buildRequires = [ 'fuse:devel', 'pkgconfig:devel' ]

    def unpack(r):
        RPMPackageRecipe.unpack(r)
        r.macros.cflags += ' -D_FILE_OFFSET_BITS=64'

    def configure(r):
        r.Configure(' --disable-static '
                    ' --disable-ldconfig '
                    ' --with-fuse=external '
                    ' --exec-prefix=/ '
                    ' --bindir=%(essentialbindir)s '
                    ' --sbindir=%(essentialsbindir)s '
                    ' --libdir=/%(lib)s' )

    def make(r):
        r.Make('LIBTOOL=%(bindir)s/libtool')

    def policy(r):
        r.Requires('fuse:runtime', '/usr/bin/ntfs-3g')

        # won't hurt make sure that fuse is _really_ loaded...
        r.Create('%(sysconfdir)s/sysconfig/modules/fuse.modules', mode = 0755,
                 contents = """
#!/bin/sh

modprobe fuse >/dev/null 2>&1

""")
        r.Remove('%(essentialsbindir)s/mount.ntfs-3g')
        r.Copy('%(essentialbindir)s/ntfs-3g', '%(essentialsbindir)s/mount.ntfs-3g')
        r.SetModes('%(essentialsbindir)s/mount.ntfs-3g', 0754)

        r.Symlink('%(essentialbindir)s/ntfs-3g', '%(essentialbindir)s/ntfsmount')
        r.Symlink('%(essentialsbindir)s/mount.ntfs-3g', '%(essentialsbindir)s/mount.ntfs-fuse')
        r.Symlink('%(essentialsbindir)s/mount.ntfs-3g', '%(essentialsbindir)s/mount.ntfs')

        r.Symlink('%(essentialbindir)s/ntfs-3g', '%(bindir)s/ntfs-3g')
        r.Symlink('%(essentialbindir)s/ntfsmount', '%(bindir)s/ntfsmount')

        r.Move('/%(lib)s/pkgconfig/libntfs-3g.pc', '%(libdir)s/pkgconfig/libntfs-3g.pc')
        r.Install('20-ntfs-config-write-policy.fdi', '%(datadir)s/hal/fdi/policy/10osvendor/')

