#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Rsync(AutoPackageRecipe):
    name = 'rsync'
    version = '2.6.9'
    buildRequires = [ 'popt:devel' ]

    def unpack(r):
        # disabling key until CNY-2439 is resolved
        r.addArchive('ftp://ftp.samba.org/pub/rsync/') #, keyid='4B96A8C5')
        r.addSource('rsync.xinetd', macros=True)
        # RPL-1647 CVE-2007-4091 Multiple off-by-one errors...
        r.addPatch('rsync-2.6.9-fname-obo.diff')
        # RPL-1989 CVE-2007-6199 CVE-2007-6200
        r.addPatch('http://rsync.samba.org/ftp/rsync/munge-symlinks-2.6.9.diff')

    def policy(r):
        r.Install('rsync.xinetd', '%(sysconfdir)s/xinetd.d/rsync',
                  mode=0644)
        r.Replace('#! /usr/bin/python2.2', '#!%(bindir)s/python',
                  'testhelp/maketree.py')
        r.AutoDoc('tech_report.tex')
        r.TestSuiteFiles('tls', 'getgroups', 'trimslash', 't_unsafe')
        r.TestSuiteFiles('.*\.c')
        r.TestSuite('.', 'make check')

