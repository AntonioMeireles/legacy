#
# Copyright (c) 2006-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Xemacs(CPackageRecipe):
    name = 'xemacs'
    version = '21.4.21'

    buildRequires = [ 'db:devel', 'libjpeg:devel',
                      'libpng:devel', 'install-info:runtime',
                      'libtiff:devel', 'ncurses:devel',
                      'perl:lib', 'zlib:devel', 'perl:runtime',
                      'bison:runtime', 'texinfo:runtime',
                      'elfutils:devel', 'xbitmaps:devel', 'gcc-java:java',
                      'libICE:devel', 'libSM:devel', 'libX11:devel',
                      'libXaw:devel', 'libXext:devel', 'libXmu:devel',
                      'libXpm:devel', 'libXt:devel', 'libXau:devel',
                      ]

    def setup(r):
        r.macros.sumo_version = '2007-04-27'
        
        r.addArchive('http://ftp.xemacs.org/pub/%(name)s/%(name)s-%(major_version)s/')
        r.addArchive('http://ftp.xemacs.org/pub/%(name)s/packages/xemacs-sumo-%(sumo_version)s.tar.gz', dir='%(datadir)s/%(name)s')
        r.addArchive('http://ftp.xemacs.org/pub/%(name)s/packages/xemacs-mule-sumo-%(sumo_version)s.tar.gz', dir='%(datadir)s/%(name)s')

        r.addPatch("xemacs-21.4.19-configure.patch", backup=".configure")
        r.addPatch("xemacs-21.4.19-archlibs.patch", backup=".archlibs")
        r.addPatch("xemacs-21.4.19-destdir.patch", backup=".destdir")
        r.addPatch("xemacs-21.4.20-mailcrypt-gpg2-pinentry.patch",
                   dir="%(datadir)s/%(name)s", level=3, backup='.pinentry')

        # This does some fix-ups for finding things under %(datadir).
        # FIXME: Need to re-implement this to eliminate later symlinks.
        # r.addPatch("xemacs-paths.patch", backup=".paths")

        r.Replace('"lib"', '"%(lib)s"', "lisp/find-paths.el")

        # Remove precompiled Lisp files.
        r.Run('find . -name "*.elc" -exec rm -f {} \;')

        # non-autoconf build programs...
        extraConf = ( ' --with-msw=no '
                      ' --with-postgresql=no '
                      ' --with-ldap=no --with-hesiod=no '
                      ' --with-gpm=no'
                      ' --with-gcc ' )
        extraConf += (' --with-x11 ')
        # Someday xemacs will support gtk properly....
        extraConf += (' --with-menubars=lucid '
                      ' --with-scrollbars=lucid '
                      ' --with-dialogs=athena ')

        # Specifying mandir to be foo/man1 is a bad idea overall,
        # but it needs to be done in this case.
        r.Configure("--mandir=%(mandir)s/man1 "  + extraConf)
        r.Make()
        r.MakeInstall()

        # Process mailcrypt/gpg2/pinentry passwd patch.
        emacsLoadPath = ''
        for loadPathElement in ('mailcrypt:', 'xemacs-base:', 'mail-lib'):
            emacsLoadPath += '%(destdir)s%(datadir)s/%(name)s/%(name)s-packages/lisp/' + loadPathElement
        r.Run('EMACSLOADPATH=' + emacsLoadPath + ' %(builddir)s/src/%(name)s -batch -vanilla -l update-elc-2.el -f batch-update-elc-2 %(destdir)s%(datadir)s/%(name)s/%(name)s-packages/lisp/mailcrypt')

        # Also compress .el files?  From build:
        # If you would like to save approximately 2M of disk space, do
        # make gzip-el
        # or you may run
        # .../build/xemacs/xemacs-21.4.19/lib-src/gzip-el.sh lispdir
        # from the command line.
        # Where lispdir is where the lisp files were installed, i.e.,
        # .../_ROOT_//usr/share/xemacs-21.4.19/lisp

        # This is the undump file xemacs needth to thart lithping.
        # Please do not remove this thinking it's a leftover temp file:
        # if you remove it, xemacs will think it's temacs and barf.
        r.NonBinariesInBindirs(exceptions='%(bindir)s/%(name)s-%(version)s-.*')

        # Clean up some archaic Perl paths.
        r.Replace('/usr/local/bin/perl5', '%(bindir)s/perl',
                  '%(datadir)s/%(name)s/xemacs-packages/etc/bbdb/bbdb-cid.pl')
        r.Replace('/usr/local/bin/perl', '%(bindir)s/perl',
                  '%(datadir)s/%(name)s/xemacs-packages/etc/bbdb/bbdb-srv.pl',
                  '%(datadir)s/%(name)s/xemacs-packages/etc/bbdb/bbdb-unlazy-lock.pl',
                  '%(datadir)s/%(name)s/xemacs-packages/lisp/hyperbole/file-newer')

        r.MakeDirs('%(datadir)s/%(name)s/site-packages')

        # Would be nice to get the binary to look under %(datadir) for these.
        # Should be doable once xemacs-paths.patch is re-implemented.
        # (Similar link needed for mule-packages?)
        r.Symlink('%(datadir)s/%(name)s/site-packages/',
                  '%(libdir)s/%(name)s/')
        r.Symlink('%(datadir)s/%(name)s/xemacs-packages/',
                  '%(libdir)s/%(name)s/')

        r.ExcludeDirectories(exceptions='%(libdir)s/%(name)s-%(version)s/modules')
        r.ExcludeDirectories(exceptions='%(libdir)s/%(name)s/site-modules')
        r.ExcludeDirectories(exceptions='%(datadir)s/%(name)s/site-packages')
        r.ExcludeDirectories(exceptions='%(datadir)s/%(name)s/site-lisp')

        # These complain about buildreqs.  Noisy...
        r.Requires(exceptions='%(datadir)s/%(name)s/xemacs-packages/etc/jde/')
        r.Requires(exceptions='%(datadir)s/%(name)s/xemacs-packages/etc/xslt-process/java/')

        # rPath uses root:mail ownership, mode 02775 for mail spool.
        # Make movemail able to handle that.
        # (XEmacs distribution provides blessmail.el to do this, but we can
        # short-circuit that and do it more cleanly in conary.)
        r.Ownership('root', 'mail', '%(libdir)s/%(name)s-%(version)s/movemail')
        r.SetModes('%(libdir)s/%(name)s-%(version)s/movemail', 02755)

        # Definitely packaging -mule separately.
        # FIXME: mule is untested, and there appear to be load-path issues.
        r.PackageSpec('%(name)s-mule',
                      '%(datadir)s/%(name)s/mule-packages/')

        # Conflicts with other packages
        # Organize these a bit better?
        r.PackageSpec('%(name)s-ctags',
                      '%(bindir)s/ctags',
                      '%(bindir)s/etags',
                      '%(mandir)s/man1/ctags.1.gz',
                      '%(mandir)s/man1/etags.1.gz')
        r.PackageSpec('%(name)s-conflicts',
                      '%(bindir)s/rcs-checkin',
                      '%(bindir)s/b2m',
                      '%(infodir)s/info.info.gz',
                      '%(infodir)s/standards.info.gz',
                      '%(infodir)s/termcap.info.gz')
