#
# Copyright (c) 2004-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Krb5(RPMPackageRecipe, CPackageRecipe):
    name = 'krb5'
    version = '1.6.3'

    buildRequires = [
        'bison:runtime', 'e2fsprogs:devel', 'flex:runtime',
        'libtermcap:devel', 'rsh:runtime', 'texinfo:runtime',
        'libtool:runtime', 'autoconf:runtime', 'install-info:runtime',
        'dejagnu:runtime', 'expect:runtime', 'ncurses:devel', 'perl:runtime',
        'chkconfig:runtime', 'e2fsprogs:runtime', ]

    externalArchive = 'http://web.mit.edu/kerberos/dist/krb5/%(major_version)s/krb5-%(version)s-signed.tar'
    # the only reason we use rpmpackage is for these files:
    rpmUpVer = '1.6.3'
    rpmRelease = '8.fc9'
    rpmSources = [ 'kpropd.init', 'krb524d.init', 'kadmind.init',
        'krb5kdc.init', 'krb5.conf', 'krb5.sh', 'kdc.conf', 'eklogin.xinetd',
        'klogin.xinetd', 'kshell.xinetd', 'krb5-telnet.xinetd',
        'gssftp.xinetd', ]

    def setup(r):
        r.disableParallelMake()

        # Fixup kerberos paths with libs in the standard libdir
        # everything else which might conflict in krbprefix
        r.macros.mandir = r.macros.krbprefix + '/man'
        r.macros.bindir = r.macros.krbprefix + '/bin'
        r.macros.sbindir = r.macros.krbprefix + '/sbin'
        r.macros.datadir = r.macros.krbprefix + '/share'

        # Avoid errors on some other packages...
        r.macros.cflags += " -fPIC"

        # krb5 is distributed as an archive in an archive...
        r.unpack()
        r.addAction('tar -C .. -zxf ../krb5-%(version)s.tar.gz')

        # these next 5 patches are all RPL-2012
        # CVE-2007-5972
        r.addPatch('http://anonsvn.mit.edu/cgi-bin/viewcvs.cgi/branches/krb5-1-6/src/lib/kdb/kdb_default.c?p2=%2Fbranches%2Fkrb5-1-6%2Fsrc%2Flib%2Fkdb%2Fkdb_default.c&p1=branches%2Fkrb5-1-6%2Fsrc%2Flib%2Fkdb%2Fkdb_default.c&r1=20187&r2=20186&rev=20187&view=diff&makepatch=1&diff_format=u'.replace('%', '%%'))
        # CVE-2007-5894
        r.addPatch('http://anonsvn.mit.edu/cgi-bin/viewcvs.cgi/branches/krb5-1-6/src/appl/gssftp/ftpd/ftpd.c?p2=%2Fbranches%2Fkrb5-1-6%2Fsrc%2Fappl%2Fgssftp%2Fftpd%2Fftpd.c&p1=branches%2Fkrb5-1-6%2Fsrc%2Fappl%2Fgssftp%2Fftpd%2Fftpd.c&r1=20183&r2=20182&rev=20183&view=diff&makepatch=1&diff_format=u'.replace('%', '%%'))
        # CVE-2007-5902
        r.addPatch('http://anonsvn.mit.edu/cgi-bin/viewcvs.cgi/branches/krb5-1-6/src/lib/rpc/svc_auth_gss.c?p2=%2Fbranches%2Fkrb5-1-6%2Fsrc%2Flib%2Frpc%2Fsvc_auth_gss.c&p1=branches%2Fkrb5-1-6%2Fsrc%2Flib%2Frpc%2Fsvc_auth_gss.c&r1=20185&r2=20184&rev=20185&view=diff&makepatch=1&diff_format=u'.replace('%', '%%'))
        # CVE-2007-5901
        r.addPatch('http://anonsvn.mit.edu/cgi-bin/viewcvs.cgi/branches/krb5-1-6/src/lib/gssapi/mechglue/g_initialize.c?p2=%2Fbranches%2Fkrb5-1-6%2Fsrc%2Flib%2Fgssapi%2Fmechglue%2Fg_initialize.c&p1=branches%2Fkrb5-1-6%2Fsrc%2Flib%2Fgssapi%2Fmechglue%2Fg_initialize.c&r1=20184&r2=20183&rev=20184&view=diff&makepatch=1&diff_format=u'.replace('%', '%%'))
        # CVE-2007-5971
        r.addPatch('http://anonsvn.mit.edu/cgi-bin/viewcvs.cgi/branches/krb5-1-6/src/lib/gssapi/krb5/k5sealv3.c?p2=%2Fbranches%2Fkrb5-1-6%2Fsrc%2Flib%2Fgssapi%2Fkrb5%2Fk5sealv3.c&p1=branches%2Fkrb5-1-6%2Fsrc%2Flib%2Fgssapi%2Fkrb5%2Fk5sealv3.c&r1=20186&r2=20185&rev=20186&view=diff&makepatch=1&diff_format=u'.replace('%', '%%'))


        # RPL-2318
        # CVE-2008-0947 CVE-2008-0948
        r.addPatch('krb-1.6.3-MITKRB5-SA-2008-002.patch')
        # still RPL-2318
        # CVE-2008-0062 CVE-2008-0063
        # note that we are not actually affected by this issue, since we build
        # without krb4 support (as seen below) in this branch. however, we
        # provide the fix in case anyone is shadowing and building krb4
        r.addPatch('krb-1.6.3-MITKRB5-SA-2008-001.patch')

        # CVE-2009-0844
        # CVE-2009-0845
        # CVE-2009-0847 RPL-3008
        r.addPatch('CVE-2009-084-457.patch')

        # CVE-2009-0846 RPL-3008
        r.addPatch('CVE-2009-0846.patch')

        r.Configure(
            '--with-cc=%(cc)s --with-ccopts="%(cflags)s"'
            ' --enable-dns-for-realm --enable-dns'
            ' --localstatedir=%(localstatedir)s/kerberos'
            ' --with-system-et --with-system-ss'
            ' --without-tcl --without-krb4 '
            ' %(target)s', dir='src')

        r.Make(dir='src')
        r.MakeInstall(dir='src')

        # packages are krb5-config, krb5-server, krb5-services, krb5-test,
        # krb5-workstation, and just plain krb5
        r.Install('doc/*.info*', '%(infodir)s/', mode=0644)
        r.Install('kdc.conf',
                  '%(localstatedir)s/kerberos/krb5kdc/', mode=0644)
        r.Install('krb5.conf', '%(sysconfdir)s/',
                  mode=0644, component=':data')
        r.Requires('krb5:data', r'%(prefix)s/%(lib)s/libkrb5\.so\.*')
        r.Install('krb5.sh', '%(sysconfdir)s/profile.d/',
                  mode=0755)
        for server in ('krb5kdc', 'kadmind', 'kpropd', 'krb524d'):
            r.Install(server+'.init', '%(initdir)s/'+server,
                      mode=0755, component='krb5-server:')
        for xinetd in ('eklogin', 'klogin', 'kshell', 'krb5-telnet', 'gssftp'):
            r.Install(xinetd+'.xinetd',
                      '%(sysconfdir)s/xinetd.d/'+xinetd,
                      mode=0644, component='krb5-services:')

        # These should be setuid only if someone wants them that way on
        # their system, as part of local configuration
        r.SetModes('%(bindir)s/ksu', 0755)

        # start initscripts by default: RPL-418
        r.Replace('chkconfig:   -', 'chkconfig:   345', '%(initdir)s/*')

        # owned by rsh, ftp, telnet packages
        for manpage in ( 'rcp', 'rlogin', 'rsh', 'ftp', 'telnet', ):
            r.Move('%(mandir)s/man1/'+manpage+'.1', '%(mandir)s/man1/'+manpage+'-krb5.1')
        for bin in ( 'ftp', 'telnet', 'rlogin', 'rcp', 'rsh', ):
            r.Move('%(bindir)s/'+bin, '%(krbprefix)s/bin/')
            r.Symlink('%(krbprefix)s/bin/', '%(bindir)s/'+bin+'-krb5')

        # classifying the files installed by make install
        r.PackageSpec('krb5-workstation',
            '%(infodir)s/krb5-user\.info*',
            '%(bindir)s/(ftp|gss-client|sim-client|telnet|uuclient|v5passwd)',
            '%(bindir)s/(k|)(rsh|rlogin)',
            '%(bindir)s/k(destroy|init|list|passwd|rb534init|su|vno)',
            '%(mandir)s/man1/v5passwd\.1.*',
            '%(mandir)s/k(destroy|erberos|init|list|passwd|rb5-send-pr|su|vno)\.1.*',
        )
        r.PackageSpec('krb5-services',
            '%(sbindir)s/(ftpd|gss-server|login.krb5|telnetd|uuserver)',
            '%(sbindir)s/k(admin|logind|rb5-send-pr|rshd|tutil)',
            '%(mandir)s/man1/krb5-send-pr\.1.*',
            '%(mandir)s/man5/(.k5login|krb5.conf)\.5.*',
            '%(mandir)s/man8/(ftpd|login.krb5|telnetd)\.8.*',
            '%(mandir)s/man8/k(admin|logind|shd|tutil)\.8.*',
        )
        r.PackageSpec('krb5-server',
            '%(infodir)s/krb5-(admin|install)\.info*',
            '%(infodir)s/krb425\.info*',
            '%(localstatedir)s/kerberos/krb5kdc/(kdc.conf|kadm5.acl)',
            '%(sbindir)s/k(admin(.local|d4?)|db5_util|propd?|rb5(d4d|kdc))',
            '%(sbindir)s/(sim_server|v5passwdd)',
            '%(mandir)s/man5/kdc5.conf\.5.*',
            '%(mandir)s/man8/k(admin(d|.local)|db5_util|propd?|rb5kdc)\.8.*',
        )
        r.PackageSpec('krb5-test',
            '%(bindir)s/sclient',
            '%(mandir)s/man1/sclient\.1.*',
            '%(sbindir)s/sserver',
            '%(mandir)s/man8/sserver\.8.*',
        )

        r.InitialContents('%(sysconfdir)s/krb5.conf')

        # e2fsprogs packgaes com_err.h, which is needed by virtually everything
        # which links against krb5
        r.Requires('e2fsprogs:devel', '%(includedir)s/(profile.h|krb5/krb5.h)')
