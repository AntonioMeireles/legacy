#
# Copyright (c) 2008 rPath, Inc.
#               2011 The Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class ConaryProxy(PackageRecipe):
    name = 'conary-proxy'
    version = '0.2'

    def setup(r):
        r.macros.proxydir = '%(servicedir)s/%(name)s'

        for f, l, p in [('cron',
                         '%(sysconfdir)s/cron.daily/%(name)s',
                         0755),
                        ('apache', 
                         '%(sysconfdir)s/httpd/conf.d/%(name)s.conf',
                         0644),
                        # ('wsgi',  '%(proxydir)s/config/%(name)s.wsgi', 0644),
                        ('config', '%(proxydir)s/config/%(name)s.cnr', 0644),
                        ('conary',
                         '%(sysconfdir)s/conary/config.d/%(name)s',
                         0644)]:
            
            r.addSource('%(name)s.' + f, dest = l, mode = p, macros = True)

        for dir in ('cscache', 'contents', 'tmp'):
            r.MakeDirs('%%(proxydir)s/%s' % dir)
            r.ExcludeDirectories(exceptions='%%(proxydir)s/%s' % dir)
            r.Ownership('apache', 'apache', '%%(proxydir)s/%s' % dir)

        r.Requires('memcached:runtime', '%(proxydir)s/')
        r.Requires('python-memcached:python', '%(proxydir)s/')
        r.Requires('mod_ssl:runtime', '%(proxydir)s/')
        # r.Requires('mod_wsgi:lib', '%(proxydir)s/')
