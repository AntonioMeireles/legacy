#
# Copyright (c) 2006-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Nspr(RPMPackageRecipe,CPackageRecipe):
    name = 'nspr'
    version = '4.7.1'
    rpmRelease = '0.9.1.fc9'
    distroVersion = "9"
    isUpdate = True

    buildRequires = [ 'libstdc++:devel',]


    if Arch.x86_64:
        extraConfig = ' --enable-64bit '
    else:
        extraConfig = ' '

    def setup(r):
        r.addArchive('%(name)s-%(version)s.tar.bz2', rpm=r.srpm)

        r.macros.subDir = 'mozilla/nsprpub'
        r.addAction('cp ./mozilla/nsprpub/config/nspr-config.in ./mozilla/nsprpub/config/nspr-config-pc.in')
        r.addPatch('nspr-config-pc.patch', rpm=r.srpm)
        r.addSource('nspr-config-vars.in', dest = 'mozilla/nsprpub/config/', rpm=r.srpm)

        r.Configure(r.extraConfig + '--includedir=%(includedir)s/nspr4 --prefix=%(prefix)s --libdir=%(libdir)s '
                    ' --includedir=%(includedir)s/nspr4 '
                    ' --disable-debug ',
                    dir='%(subDir)s')
        r.Make(dir='%(subDir)s')
        r.MakeInstall(dir='%(subDir)s')

        r.addSource('%(name)s.pc.in', dest='%(subDir)s/', rpm=r.srpm)
        r.Run("""
export NSPR_LIBS=`./config/nspr-config --libs`; 
export NSPR_CFLAGS=`./config/nspr-config --cflags`; 
export NSPR_VERSION=`./config/nspr-config --version`;  
mkdir %(destdir)s/%(libdir)s/pkgconfig;  
cat %(name)s.pc.in | sed -e "s,%%libdir%%,%(libdir)s,g" \
                     -e "s,%%prefix%%,%(prefix)s,g" \
                     -e "s,%%exec_prefix%%,%(prefix)s,g" \
                     -e "s,%%includedir%%,%(includedir)s/nspr4,g" \
                     -e "s,%%NSPR_VERSION%%,$NSPR_VERSION,g" \
                     -e "s,%%FULL_NSPR_LIBS%%,$NSPR_LIBS,g" \
                     -e "s,%%FULL_NSPR_CFLAGS%%,$NSPR_CFLAGS,g" >> \
                     %(destdir)s/%(libdir)s/pkgconfig/nspr.pc; 
""", dir = '%(subDir)s')

        r.Install('%(subDir)s/config/nspr-config-pc', '%(bindir)s/nspr-config', mode = 0755)

        # Get rid of the things we don't want installed (per upstream)
        r.Remove('%(bindir)s/{compile-et.pl,prerr.properties}')
        r.Remove('%(libdir)s/{libnspr4.a,libplc4.a,libplds4.a}')
        r.Remove('%(datadir)s/aclocal/nspr.m4')
        r.Remove('%(includedir)s/nspr4/md', recursive = True)

        for i in ['libnspr4.so', 'libplc4.so', 'libplds4.so']:
            r.Move('%(libdir)s/' + i, '/%(lib)s/' +i)
            r.Symlink('/%(lib)s/' +i, '%(libdir)s/' + i)
