#
# Copyright (c) 2004-2009 rPath, Inc.
#               2009-2011 The Foresight Linux Priject
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class MicrocodeCtl(CPackageRecipe):
    name = 'microcode_ctl'
    version = '1.17'

    def setup(r):
        r.addArchive('http://www.urbanmyth.org/microcode/')
        r.addSource('intel-microcode2ucode.c')
        r.addPatch('microcode_ctl.patch')
        r.addPatch('microcode_ctl-manpage-0.patch')

        r.addSource('microcode-20110428.dat')
        r.addSource('microcode_ctl.rules',
                    dest = '/lib/udev/rules.d/89-microcode.rules',
                    mode = 0644)
        r.addArchive('amd-ucode-2011-01-11.tar')

        r.Make(forceFlags=True)
        r.Run('%(cc)s -Wall -o intel-microcode2ucode intel-microcode2ucode.c')
        r.MakeInstall('PREFIX=%(prefix)s INSDIR=%(essentialsbindir)s '
                      'RCDIR=%(sysconfdir)s')

        r.Install('intel-microcode2ucode',
                  '%(essentialsbindir)s/',
                  mode = 0755)

        r.Run('chmod 755 intel-microcode2ucode; ./intel-microcode2ucode microcode-20110428.dat')

        r.Install('intel-ucode',
                  '/lib/firmware/',
                  mode = 0755)
        r.Remove('/lib/firmware/microcode.dat')

        r.Install('../amd-ucode-2011-01-11/microcode_amd.bin',
                  '/lib/firmware/amd-ucode/',
                  mode = 0644)
        # we rely on udev now...
        r.Remove('%(sysconfdir)s/init.d', recursive = True)
        # AMD lic
        for x in ['LICENSE', 'README', 'INSTALL']:
            r.Copy('../amd-ucode-2011-01-11/'+x, 
                   x + '.microcode.AMD')
            r.Doc(x + '.microcode.AMD')
