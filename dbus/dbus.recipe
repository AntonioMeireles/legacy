#
# Copyright (c) 2004 Specifix, Inc.
# All rights reserved
#
# XXX needs user id dbus:81

loadRecipe('python.recipe', label='conary.rpath.com@rpl:devel')
class Dbus(PackageRecipe):

    buildRequires = [ 'expat:devel', 'glib:devel', 'Pyrex:runtime', 'monodoc:devellib' ]

    name = 'dbus'
    version = '0.23.4'

    def setup(r):
	r.macros.dbus_uid = 'dbus'
	r.macros.python_version = Python.majversion

	r.addArchive('http://www.freedesktop.org/software/dbus/releases/%(name)s-%(version)s.tar.gz')

        r.addAction("sed -i 's@<user>.*</user>@<user>%(dbus_uid)s</user>@g' bus/system.conf*")
        r.addAction("sed -i '/# chkconfig:/s/ 97/ 08/g' bus/messagebus.in")

	r.Configure('--enable-glib=yes --enable-qt=no --disable-tests --with-init-scripts=redhat '
		    '--enable-mono --enable-mono-docs --disable-verbose-mode --disable-asserts '
		    '--with-system-pid-file=%(localstatedir)s/run/messagebus.pid')
	
	r.Make()
	r.MakeInstall()

	# doesn't seem to be a configure option for pythondir?
	r.Move('/usr/lib/python*/site-packages/*',
	       '%(libdir)s/python%(python_version)s/site-packages/')

	r.MakeDirs('%(localstatedir)s/run/dbus')
	r.MakeDirs('%(datadir)s/dbus-1/services')
	r.ExcludeDirectories(exceptions=['%(datadir)s/dbus-1/services'])
	r.ExcludeDirectories(exceptions=['%(localstatedir)s/run/dbus'])

	r.Doc('COPYING', 'ChangeLog', 'NEWS')

        r.PackageSpec('dbus-mono',
                      '%(libdir)s/mono.*',
                      '%(libdir)s/pkgconfig/dbus-sharp.pc')
        r.TagSpec('initscript', '%(initdir)s/') 
        r.Install('dbus.sh', '/etc/X11/xinit/xinitrc.d/dbus.sh')

