#
# Copyright (c) 2004 Specifix, Inc.
# All rights reserved
#
# XXX needs user id dbus:81

loadRecipe('python.recipe', label='conary.rpath.com@rpl:devel')
class Dbus(PackageRecipe):

    buildRequires = [ 'expat:devel', 'glib:devel', 'Pyrex:runtime', 
		'atk:devel', 'cairo:devel', 'fontconfig:devel', 'freetype:devel',
		'glibc:devel', 'gtk:devel', 'libpng:devel', 'pango:devel',
		'xorg-x11:devel', 'zlib:devel', 'libxml2:python' ]

    name = 'dbus'
    version = '0.60'

    def setup(r):
	r.macros.dbus_uid = 'dbus'
	r.macros.python_version = Python.majversion

	r.addArchive('http://www.freedesktop.org/software/dbus/releases/%(name)s-%(version)s.tar.gz')
	r.addSource('dbus.sh')

        r.addAction("sed -i 's@<user>.*</user>@<user>%(dbus_uid)s</user>@g' bus/system.conf*")
        r.addAction("sed -i '/# chkconfig:/s/ 97/ 08/g' bus/messagebus.in")

	r.Configure('--enable-glib=yes --enable-qt=no --disable-tests --with-init-scripts=redhat '
		    '--enable-mono --disable-verbose-mode --disable-asserts '
		    '--with-system-pid-file=%(localstatedir)s/run/messagebus.pid')
	
	r.Make()
	r.MakeInstall()

	# doesn't seem to be a configure option for pythondir?
	r.Move('/usr/lib/python*/site-packages/*',
	       '%(libdir)s/python%(python_version)s/site-packages/')

	r.MakeDirs('%(localstatedir)s/run/dbus')
	r.MakeDirs('%(datadir)s/dbus-1/services')
	r.ExcludeDirectories(exceptions=['%(datadir)s/dbus-1/services'])
	r.ExcludeDirectories(exceptions=['%(localstatedir)s/run/dbus'])

	r.Doc('COPYING', 'ChangeLog', 'NEWS')

        r.PackageSpec('dbus-mono',
                      '%(libdir)s/mono.*',
                      '%(libdir)s/pkgconfig/dbus-sharp.pc')
	r.PackageSpec('dbus-x11', '%(bindir)s/dbus-launch')
	r.PackageSpec('dbus-qt', '%(libdir)s/libdbus-qt-.*')
	r.PackageSpec('dbus-glib',
			'%(libdir)s/libdbus-glib-.*',
			'%(libdir)s/pkgconfig/dbus-glib-.*',
			'%(bindir)s/dbus-monitor',
			'%(bindir)s/dbus-viewer',
			'%(bindir)s/dbus-binding-tool')

        r.TagSpec('initscript', '%(initdir)s/') 
        r.Install('dbus.sh', '/etc/X11/xinit/xinitrc.d/dbus.sh')


	r.UtilizeUser('dbus', '%(sysconfdir)s/.*/system.conf')

