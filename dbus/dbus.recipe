#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Dbus(RPMPackageRecipe,AutoPackageRecipe):
    name = 'dbus'
    version = '1.2.16'
    rpmRelease = '8.fc12'
    rpmPatches = [ 'start-early.patch',
                   'dbus-1.0.1-generate-xml-docs.patch',
                   'fix-timeout-accounting.patch',
#                   'dbus-1.2.16-capability.patch' ,
                   ]

    rpmSources = ['00-start-message-bus.sh']

    buildRequires = [ 'doxygen:runtime', 'expat:devel', 'pkgconfig:devel',
                      'xmlto:runtime', 'libICE:devel', 'libSM:devel',
                      'libX11:devel' , 'audit:devel', 'libcap:devel',
                      'automake:runtime', 'linuxdoc-tools:runtime',
                      'autoconf:runtime', 'libtool:devel', 'libtool:runtime',
                      'util-macros:devel', 'filesystem:runtime']

    def unpack(r):
        r.macros.dbus_user = 'dbus'
        RPMPackageRecipe.unpack(r)
        r.Run('autoreconf -fi')

    def configure(r):
        r.Configure(' --enable-libaudit '
                    ' --disable-tests '
                    ' --with-dbus-user=%(dbus_user)s '
                    ' --disable-asserts '
                    ' --disable-verbose-mode '
                    ' --with-init-scripts=redhat '
                    ' --with-system-pid-file=%(localstatedir)s/run/messagebus.pid'
                    ' --libdir=/%(lib)s --bindir=%(essentialbindir)s --sysconfdir=%(sysconfdir)s  --libexecdir=/%(lib)s/dbus-1'
                    ' --exec-prefix=/')

    def policy(r):
        r.Ownership('root', '%(dbus_user)s', '%(essentiallibdir)s/dbus-1/dbus-daemon-launch-helper')
        r.SetModes('%(essentiallibdir)s/dbus-1/dbus-daemon-launch-helper', 04750)

        r.MakeDirs('%(datadir)s/dbus-1/interfaces')
        r.ExcludeDirectories(exceptions=[ '%(localstatedir)s/lib/dbus',
                                          '%(localstatedir)s/run/dbus',
                                          '%(datadir)s/dbus-1/services',
                                          '%(datadir)s/dbus-1/system-services',
                                          '%(sysconfdir)s/dbus-1/session.d',
                                          '%(sysconfdir)s/dbus-1/system.d',
                                          '%(datadir)s/dbus-1/interfaces',
                                          ])

        r.Move('/%(lib)s/pkgconfig/dbus-1.pc', '%(libdir)s/pkgconfig/dbus-1.pc')
        r.Replace('-I\$\{libdir\}', '-I${prefix}/%(lib)s', '%(libdir)s/pkgconfig/dbus-1.pc')

        r.Move('%(essentialbindir)s/dbus-launch', '%(bindir)s/dbus-launch')
        
        r.MakeDirs('%(libdir)s/dbus-1.0/include')
        r.Move('/%(lib)s/dbus-1.0/include/*', '%(libdir)s/dbus-1.0/include/')
        r.Remove('/%(lib)s/dbus-1.0/', recursive=True)
 
        r.TagSpec('initscript', '%(initdir)s/')
        r.UtilizeUser('dbus', '%(sysconfdir)s/.*/system.conf')

        r.PackageSpec('dbus-x11', '%(bindir)s/dbus-launch')

        r.Install('00-start-message-bus.sh', '%(sysconfdir)s/X11/xinit/xinitrc.d/', mode = 0755)
        
        
