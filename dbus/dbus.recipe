#
# Copyright (c) 2004 Specifix, Inc.
# All rights reserved
#
# XXX dbus user is not attached to any files, so will not apply

class Dbus(PackageRecipe):

    buildRequires = [ 'expat:devel', 'glib:devel', 'Pyrex:runtime' ]

    name = 'dbus'
    version = '0.22'

    def setup(r):
	r.macros.dbus_user = 'dbus'

	r.addArchive('http://www.freedesktop.org/software/dbus/releases/%(name)s-%(version)s.tar.gz')

        r.addAction("sed -i 's@<user>.*</user>@<user>%(dbus_user)s</user>@g' bus/system.conf*")
        r.addAction("sed -i '/# chkconfig:/s/ 97/ 08/g' bus/messagebus.in")

	r.Configure('--enable-glib=yes --enable-qt=no --disable-tests'
            ' --with-init-scripts=redhat --disable-mono --disable-mono-docs'
            ' --disable-verbose-mode --disable-asserts'
            ' --with-system-pid-file=%(localstatedir)s/run/messagebus.pid')
	
	r.Make()
	r.MakeInstall()

	r.MakeDirs('%(localstatedir)s/run/dbus/')
	r.ExcludeDirectories(exceptions=['%(localstatedir)s/run/dbus'])

	r.Doc('COPYING', 'ChangeLog', 'NEWS')
	r.PackageSpec('dbus-x11', '%(bindir)s/dbus-launch')
        r.TagSpec('initscript', '%(initdir)s/') 

        r.User('dbus', 81, homedir='/', comment='System message bus')
	
	#test
	#r.Configure('--enable-glib=yes --enable-qt=no --enable-tests=yes'
        #    ' --enable-verbose-mode=yes --enable-asserts=yes')
	#DBUS_VERBOSE=1 make check > dbus-check.log 2>&1 || (cat dbus-check.log && false)
