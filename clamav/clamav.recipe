#
# Copyright (c) 2011 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Clamav(AutoPackageRecipe):
    name = 'clamav'
    version = '0.97.3'
 
    buildRequires = ['bzip2:devel', 'chkconfig:runtime', 'dejagnu:runtime', 'doxygen:runtime', 'graphviz:runtime', 'groff:runtime', 'libstdc++:devel', 'libtool:devel', 'ncurses:devel', 'tcl:runtime', 'valgrind:devel', 'zip:runtime', 'zlib:devel']
 
    def configure(r):
        r.Configure( ' --disable-zlib-check'
                    ' --disable-clamav'
                    ) 
   
    def policy(r):
        r.MakeDirs('%(datadir)s/clamav', mode=0775)
        r.Ownership('clamav', 'clamav', '%(datadir)s/clamav')
        r.Ownership('clamav', 'clamav', '%(datadir)s/clamav/')
        r.Create('%(localstatedir)s/log/clamd.log', mode=0640)
        r.Ownership('clamav', 'clamav', '%(localstatedir)s/log/clamd.log')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/log/clamd.log')

        r.Create('%(localstatedir)s/log/freshclam.log', mode=0640)
        r.Ownership('clamav', 'clamav', '%(localstatedir)s/log/freshclam.log')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/log/freshclam.log')

        r.MakeDirs('%(localstatedir)s/run/clamav', mode=0770)
        r.Ownership('clamav', 'clamav', '%(localstatedir)s/run/clamav')
        
        r.UtilizeUser('clamav', '%(initdir)s/clamav')
        r.UtilizeGroup('clamav', '%(initdir)s/clamav')


    def unpack(r):
        r.addArchive(
           'http://downloads.sourceforge.net/project/clamav/clamav/%(version)s/clamav-%(version)s.tar.gz' )
        r.addSource('clamd.conf', dest='%(sysconfdir)s/clamd.conf', mode=0644)
        r.addSource('http://sial.org/howto/clamav/freshclam/freshclam.conf', dest='%(sysconfdir)s/freshclam.conf', mode=0644)
        r.addSource('clamd.init', dest='%(initdir)s/clamd', mode=0755)
        r.addSource('freshclam.init', dest='%(initdir)s/freshclam', mode=0755)
        r.addSource('clamassassin', dest='%(bindir)s/clamassassin', mode=0555)

