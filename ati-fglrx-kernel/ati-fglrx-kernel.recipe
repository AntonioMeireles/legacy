loadSuperClass('kernelmodulepackage.recipe')
class AtiFglrxKernel(KernelModulePackageRecipe):

    buildRequires = ['kernel:build-tree', 'mkinitrd:runtime',
                     'elfutils:runtime', 'binutils:runtime']

    name = 'ati-fglrx-kernel'
    version = '8.33.6'

    def unpack(r):
        installScriptName = \
            "ati-driver-installer-%(version)s-x86.x86_64.run" % r.macros

        r.addSource('http://www2.ati.com/drivers/linux/%s' % \
            installScriptName)
        r.Run('sh %s --extract archive_files' % installScriptName)
        r.Copy('archive_files/arch/x86/*', 'src/')
        r.Copy('archive_files/common/*', 'src/')
        r.Copy('archive_files/x710/*', 'src/')
        r.Copy('src/lib/modules/fglrx/build_mod/2.6.x/Makefile', 'src/lib/modules/fglrx/build_mod/')
        # XXX: this isn't necessary on Linux Kernel 2.6.19
        #r.Replace('linux/config.h','linux/autoconf.h',
        #          'src/lib/modules/fglrx/build_mod/firegl_public.c', 
        #          'src/lib/modules/fglrx/build_mod/drm.h',
        #          'src/lib/modules/fglrx/build_mod/drmP.h')
        r.Make(dir='src/lib/modules/fglrx/build_mod/')
        r.Install('src/lib/modules/fglrx/build_mod/fglrx.ko',
            '%(destdir)s/lib/modules/%(kver)s/video/fglrx.ko')

        r.addSource('fglrx.modules')
        r.Install('fglrx.modules', '%(sysconfdir)s/sysconfig/modules/')
