loadSuperClass('kernelmodulepackage.recipe', label='drivers.rpath.org@rpl:devel')
class AtiFglrxKernel(KernelModulePackageRecipe):

    buildRequires = ['kernel:build-tree', 'mkinitrd:runtime']

    name = 'ati-fglrx-kernel'
    version = '8.28.8'

    def unpack(r):
        r.addSource('http://www2.ati.com/drivers/linux/ati-driver-installer-%(version)s.run')
        r.Run('sh ./ati-driver-installer-%(version)s.run --extract archive_files')
        
        r.Copy('archive_files/arch/x86/*', 'src/')
        r.Copy('archive_files/common/*', 'src/')
        r.Copy('archive_files/x710/*', 'src/')
        r.Copy('src/lib/modules/fglrx/build_mod/2.6.x/Makefile', 'src/lib/modules/fglrx/build_mod/')

        r.Make(dir='src/lib/modules/fglrx/build_mod/')

        del r.AutoDoc
        r.macros.kver='%(kver)s'

    def setup(r):
        r.Install('src/lib/modules/fglrx/build_mod/fglrx.ko',
            '%(destdir)s/lib/modules/%(kver)s/video/fglrx.ko')
