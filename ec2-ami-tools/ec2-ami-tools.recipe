#
# Copyright (c) 2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('binarypackage=conary.rpath.com@rpl:devel')
class Ec2AmiTools(BinaryPackageRecipe):

    buildRequires = [  ]

    name = 'ec2-ami-tools'

    # Amazon doesn't use "versions" on their download page, so I went head and
    # dumped the version out of their RPM file (using strings -a | head).
    # Also, I feel better putting the RPM blob in the :source trove, since
    # what's out there may change without notice (i.e. an update will simply
    # replace the binary.
    version = '1.2_7221'

    def unpack(r):
        r.addArchive('ec2-ami-tools.noarch.rpm', dir='/')
        r.addPatch('workaround-rpl-1066.patch', dir='/', level=1)
        r.Move('/usr/local/bin','%(prefix)s')
        r.Move('/usr/lib/site_ruby','%(libdir)s/ruby/')
        r.Replace('\/usr\/local','%(prefix)s','%(libdir)s/ruby/site_ruby/aes/amiutil/make-fc4-image.rb')
        r.Replace('\/usr\/lib\/site_ruby','%(libdir)s/ruby/site_ruby','%(prefix)s/local/aes/amiutil/*')
        r.Run('echo "" >> %(destdir)s\/etc\/aes\/amiutil\/make-fc4-image.cfg')

    def policy(r):
        r.Requires('coreutils:runtime', '%(libdir)s/ruby/site_ruby/aes/.*')
        r.Requires('curl:runtime', '%(libdir)s/ruby/site_ruby/aes/.*')
        r.Requires('e2fsprogs:runtime', '%(libdir)s/ruby/site_ruby/aes/.*')
        r.Requires('lvm2:runtime', '%(libdir)s/ruby/site_ruby/aes/.*')
        r.Requires('openssl:runtime', '%(libdir)s/ruby/site_ruby/aes/.*')
        r.Requires('util-linux:runtime', '%(libdir)s/ruby/site_ruby/aes/.*')
