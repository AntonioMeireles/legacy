#
# Copyright (c) 2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('binarypackage=conary.rpath.com@rpl:devel')
class Ec2AmiTools(BinaryPackageRecipe):

    name = 'ec2-ami-tools'

    # Amazon doesn't use "versions" on their download page, so I went head and
    # dumped the version out of their RPM file (using strings -a | head).
    # Also, I feel better putting the RPM blob in the :source trove, since
    # what's out there may change without notice (i.e. an update will simply
    # replace the binary.
    version = '1.3_15586'

    buildRequires = [ 'ruby:runtime' ]

    def unpack(r):
        r.addArchive('ec2-ami-tools.noarch.rpm', dir='/')
        r.addPatch('workaround-rpl-1066.patch', dir='/', level=1)
        r.addPatch('ami-tools--private-method-fix.patch', dir='/', level=1)
        r.Remove('/usr/lib64', recursive=True) # duplicate copy of the one in /usr/lib
        r.Move('/usr/local/bin','%(prefix)s')
        r.Move('/usr/lib/site_ruby','%(libdir)s/ruby/')
        r.Replace('\/usr\/local','%(prefix)s','%(libdir)s/ruby/site_ruby/aes/amiutil/make-fc4-image.rb')
        r.Replace('\/usr\/lib\/site_ruby','%(libdir)s/ruby/site_ruby','%(prefix)s/local/aes/amiutil/*')
        r.Run('echo "" >> %(destdir)s\/etc\/aes\/amiutil\/make-fc4-image.cfg')

    def policy(r):
        # We have to synthesize deps because of the shellouts that are
        # done in all the Ruby scripts that are used to bundle the image.
        for t in [ 'coreutils:runtime', 'curl:runtime', 'e2fsprogs:runtime',
                   'lvm2:runtime', 'openssl:runtime', 'util-linux:runtime',
                   'ruby:runtime', 'MAKEDEV:runtime', 'rsync:runtime' ]:
            r.Requires(t, '%(libdir)s/ruby/site_ruby/aes/.*')
