#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Bzip2(CPackageRecipe):
    name = 'bzip2'
    version = '1.0.6'

    def setup(r):
        r.addArchive('http://www.bzip.org/%(version)s/')

        # change upstream's soname naming to match ours
        r.addPatch('bzip2-1.0.6-saneso.patch') 

        # this was submitted for upstream inclusion on 20 March 2008
        r.addPatch('makefile-sanity.patch')

        r.compile()
        r.install()

    def compile(r):
        if Use.bootstrap:
            # don't run 'make test' since we most likely can't execute the
            # new bzip2 binaries
            r.addAction('sed -i "s/bzip2recover test/bzip2recover/g" Makefile*')
            crosstools = 'CC=%(target)s-gcc AR=%(target)s-ar RANLIB=%(target)s-ranlib '
        else:
            crosstools = ''

        r.Make(crosstools + '-f Makefile-libbz2_so '
                  'CFLAGS="%(cflags)s -D_FILE_OFFSET_BITS=64 -fpic -fPIC" '
                  'all')
        r.Make(crosstools + 'CFLAGS="%(cflags)s -D_FILE_OFFSET_BITS=64" all')

    def install(r):
        r.MakeInstall('PREFIX=%(prefix)s DESTDIR=%(destdir)s')

        # Makefile-libbz2_so does not provide an install target
        r.Install('libbz2.so.%s' %r.version, '%(libdir)s/', mode=0755)
        r.Symlink('libbz2.so.1', '/%(libdir)s/libbz2.so')

        r.Doc('manual_*', 'manual.html', dir='html')
        r.Doc('manual.{pdf,ps}')

        # RPL-1178 - not needed for appliances
        r.PackageSpec('bzip2-extras', '.*bz(less|more).*')
