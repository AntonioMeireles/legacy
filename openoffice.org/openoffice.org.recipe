#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class OpenOffice(CPackageRecipe):

    name = 'openoffice.org'
    version = '3.1.0+m11'

    buildRequires = [
        'ant:java', 'ant:runtime', 'atk:devel', 'autoconf:runtime',
        'automake:runtime', 'bison:runtime', 'boost:devel', 'cups:devel',
        'curl:devel', 'db:devel', 'dbus-glib:devel', 'dbus:devel',
        'desktop-file-utils:runtime', 'doxygen:runtime', 'expat:devel',
        'flex:runtime', 'fontconfig:devel', 'freetype:devel', 'gcc-c++:runtime',
        'gettext:runtime', 'glib:devel', 'gmp:devel', 'gperf:runtime',
        'gst-plugins-base:devel', 'gstreamer:devel', 'gtk:devel',
        'icedtea-jdk:runtime', 'icedtea-jre:runtime', 'icu:devel',
        'icu:runtime', 'ImageMagick:runtime', 'imake:runtime',
        'intltool:runtime', 'libart_lgpl:devel', 'libICE:devel',
        'libjpeg:devel', 'libpng:devel', 'libSM:devel', 'libsndfile:devel',
        'libstdc++:devel', 'libtool:devel', 'libwpd:devel', 'libX11:devel',
        'libXau:devel', 'libXaw:devel', 'libXext:devel', 'libXinerama:devel',
        'libxml2:devel', 'libXrandr:devel', 'libXrender:devel', 'libxslt:devel',
        'libxslt:runtime', 'libXt:devel', 'libXtst:devel', 'man:runtime',
        'Mesa:devel', 'mono:cil', 'mono:devel', 'mono:runtime', 'mpfr:devel',
        'neon:devel', 'nspr:devel', 'nss:devel', 'openldap:devel',
        'openssl:devel', 'pam:devel', 'pango:devel', 'patch:runtime',
        'pcre:devel', 'perl-Archive-Zip:perl', 'perl-Compress-Zlib:perl',
        'perl:devel', 'perl:runtime', 'pkgconfig:devel', 'portaudio:devel',
        'python:devel', 'redland:devel', 'Sablot:devel', 'sane-backends:devel',
        'shared-mime-info:runtime', 'startup-notification:devel',
        'tcsh:runtime', 'unixODBC:devel', 'unzip:runtime',
        'userspace-kernel-headers:devel', 'util-linux:runtime',
        'w3c-libwww:devel', 'which:runtime', 'xalan-j:java', 'xerces-j:java',
        'xulrunner:devel', 'zip:runtime', 'zlib:devel', 'inputproto:devel',
    ]

    use_kde = False
    use_gnome = True

    def setup(r):

        r.macros.snapshot = r.version.split('+')[1]
        r.macros.fullName = 'OpenOffice.org-%(major_version)s'

        r.macros.tag = 'ooo%s' % r.version.split('+')[0].replace('.', '')
        r.macros.TAG = str(r.macros.tag).upper()

        # used in loadManifest
        r.manifest_files = {}

        # cd build/ooo300-m7
        # ../../bin/stat-localizations \
        #   `sed -n -e "s|^[[:space:]]*completelangiso=\(.*\)\(en-US \)\(.*\)$|\1\3|p" solenv/inc/postset.mk
        langs = (
            "af ar as-IN be-BY bg bn br bs ca cs cy da de dz el en-ZA eo es "
            "et fa fi fr ga gl gu gu-IN he hi-IN hr hu it ja ka km ko ku lt mk "
            "ml-IN mn mr-IN my nb ne nl nn nr ns or-IN pa-IN pl pt pt-BR ru rw "
            "sh sk sl sr ss st sv sw-TZ ta-IN te-IN tg th ti-ER tn tr ts uk ur-IN "
            "uz ve vi xh zh-CN zh-TW zu"
        )
        r.langs = langs.split()

        # help < 40%
        poor_help = (
            "af ar as-IN be-BY bn br bs cy el en-ZA eo fa fi ga gu gu-IN he hr "
            "ka ku lt ml-IN mn mr-IN my nb nn nr ns or-IN pa-IN rw sh sk sr ss "
            "st sw-TZ ta-IN te-IN th ti-ER tn tr ts uk ur-IN uz ve xh zu"
        )
        r.poor_help = poor_help.split()

        r.build_langs = [ 'en-US', ]
        r.build_langs.extend(r.langs)
        # Can be used to speed up test builds
        #r.build_langs.extend([
        #    'de', 'pt', 'pt-BR', 'ru', 'fr',
        #])
        r.macros.langs = ' '.join(r.build_langs)
        r.macros.poor_help = ' '.join(r.poor_help)

        r.default_lang = r.build_langs[0]

        # Saving only looks in /usr/lib/OpenOffice.org for some BASIC files
        # and does not respect --with-installed-ooo-dirname -- RPL-247
        r.macros.basedir = '%(libdir)s/%(fullName)s'
        r.macros.basisdir = '%(basedir)s/basis%(major_version)s'

        r.macros.cflags += ' -fno-strict-aliasing'

        # -------------------
        #
        # unpack the source
        #
        # -------------------

        r.macros.site = 'http://download.go-oo.org'
        #r.addGitSnapshot('git://anongit.freedesktop.org/git/ooo-build/ooo-build')
        r.addArchive('http://download.go-oo.org/OOO310/ooo-build-3.0.99.7.tar.gz')

        r.addSource(
            'openoffice-extension.tag-description',
            dest='%(tagdescriptiondir)s/openoffice-extension', macros=True
        )
        r.addSource(
            'openoffice-extension.tag-handler',
            dest='%(taghandlerdir)s/openoffice-extension', macros=True, mode=0755
        )

        oooModules = [
            'artwork',
            'base',
            'bootstrap',
            'calc',
            'components',
            'extensions',
            'extras',
            'filters',
            'help',
            'impress',
            'libs-core',
            'libs-extern-sys',
            'libs-extern',
            'libs-gui',
            'postprocess',
            'sdk',
            'testing',
            'ure',
            'writer',
        ]
        for x in oooModules:
            r.addSource('%(site)s/%(TAG)s/%(tag)s-%(snapshot)s-'+x+'.tar.bz2', dir='src/')

        oooSupport = [
            'biblio.tar.bz2',
            'extras-3.tar.bz2',
            'libwpg-0.1.3.tar.gz',
            'libwps-0.1.2.tar.gz',
            'mdbtools-0.6pre1.tar.gz',
        ]
        for file in oooSupport:
            r.addSource('%%(site)s/SRC680/%s' % file, dir='src/')

        for file in ('ooo-cli-prebuilt-3.0.tar.bz2', 'scsolver.2008-10-30.tar.bz2'):
            r.addSource('%%(site)s/DEV300/%s' % file, dir='src/')

        r.addSource('http://tools.openoffice.org/unowinreg_prebuild/680/unowinreg.dll', dir='src/')

        # Will use after patch.apply
        r.addSource('solenv-enable-soname.patch')

        # Fix typo in configure
        r.Replace('eval ./configure',
                  'sed -i "s/altlinuxyph/altlinuxhyph/g" configure; eval ./configure',
                  'bin/build-ooo')

        # from hsqldb_1_8_0_9.zip
        r.addSource('hsqldb.jar')

        # From RH .spec
        r.addSource('compact_templates.sh')

        # we don't have static mono lib
        #r.Replace('--static', '', 'patches/mono/*.diff', allowNoChange=True)

        # XXX
        r.Replace(
            '^rpl2:.*$',
            'Foresight: LinuxCommon, NotDebian, CalcSolver, Lockdown, BerkeleyDB43, CairoFonts, Shrink',
            'patches/dev300/apply'
        )
        r.Copy('distro-configs/rpl2.conf.in', 'distro-configs/Foresight.conf')

        #r.Run('echo -e "\nexit 0\n" >> autogen.sh')
        #r.Run('NOCONFIGURE=1 ./autogen.sh')

        # --------------------------
        #
        # configuration and install
        #
        # --------------------------

        if r.use_kde:
            r.Environment('QTINC', '%(includedir)s/qt4')

        r.Environment('MONO_SHARED_DIR', '/tmp')
        r.Environment('PKG_CONFIG', '%(bindir)s/pkg-config')

        # Packaging stuff

        extraConf = (
                       ' --with-tag=%(tag)s-%(snapshot)s'
                       ' --with-lang="%(langs)s" --with-dict=ALL'
                       ' --with-poor-help-localizations="%(poor_help)s"'
                       ' --with-binsuffix=%(major_version)s'
                       ' --with-installed-ooo-dirname="%(fullName)s"'
                       ' --with-docdir=%(thisdocdir)s'
                       ' --with-ant-home=%(prefix)s/'
                       ' --with-java'
                       ' --with-java-target-version=1.5'
                       ' --with-odk'
                       ' --with-num-cpus=2'
                       ' --with-use-shell=bash'
                       ' --enable-gtk'
                       ' --without-system-db'
                       ' --without-nas'
                       ' --with-system-libwpd'
                       ' --with-system-portaudio'
                       ' --with-system-xerces'
                       ' --with-system-xalan'
                       ' --enable-vba'
                       ' --with-vba-package-format="builtin"'
                       ' --disable-Xaw'
                       ' --enable-gstreamer'
                       ' --with-system-odbc-headers'
                       ' --with-system-boost'
                       ' --with-system-python'
                       ' --with-system-libs'
                       ' --enable-dbus'
                       ' --enable-symbols'
                       ' --disable-pasf'
                       ' --disable-ldap'
                       ' --disable-crashdump'
                       ' --disable-epm'
                       ' --disable-qadevooo'
                       ' --disable-fontooo'
                       ' --disable-mathmldtd'
                       ' --with-system-sane-header'
                       ' --with-system-xrender-headers'
                       ' --without-system-mspack'
                       ' --without-fonts'
                       ' --without-gpc'
                       ' --without-agg'
                       ' --without-ppds'
                       ' --without-afms'
                       ' --without-writer2latex'
                       ' --enable-cairo'
                       ' --with-system-cairo'
                       # Package mozilla-xpcom was not found in the pkg-config search path.
                       ' --with-system-mozilla=libxul'
                       # Probably we should add this
                       ' --without-system-libwps'
                       ' --without-system-libwpg'
                       ' --without-system-libsvg'
                       ' --without-system-icu'
                       ' --without-system-hunspell'
                       ' --without-system-lpsolve'
                       # I'm not sure if we need these in distro, but we should
                       # consider it
                       ' --without-system-xt'
                       ' --without-system-mdbtools'
                       ' --without-system-xml-apis'
                       # FIXME
                       ' --with-system-hsqldb'
                       ' --with-hsqldb-jar=%(builddir)s/hsqldb.jar'
                       ' --enable-openxml'
                       ' --with-jdk-home=$JAVA_HOME'
                       # <_rene_> even if the option existed it would build but simply crash on signing.
                       # so we shouldn't use system xmlsec
                       ' --without-system-xmlsec'
                       ' --enable-binfilter'
                       ' --disable-mono'
                       # lucene analayzer not found
                       ' --without-system-lucene'
                       ' --without-system-saxon'
                    )

        extraConf += ' --with-distro=Foresight'

        if r.use_kde:
            r.buildRequires.extend( [ 'kdelibs:devel', 'qt4:devel' ] )
            extraConf += ' --enable-kde'
        else:
            extraConf += ' --disable-kde'

        if r.use_gnome:
            r.buildRequires.extend([
                'GConf:devel', 'gnome-vfs:devel', 'libbonobo:devel',
                'ORBit2:devel'
            ])
            extraConf += ( ' --enable-lockdown'
                           ' --enable-gnome-vfs'
                           ' --enable-evolution2')
        else:
            extraConf += ( ' --disable-lockdown'
                           ' --disable-gnome-vfs'
                           ' --disable-evolution2')

        r.Configure(extraConf, preConfigure='PATH=$PATH:%(sbindir)s')

        # Unpack OO upstream sources, must be done after configure so that the
        # makefile is there
        r.Make('unpack')

        # apply upstream sources
        r.Make('patch.apply')

        r.Run('cat solenv-enable-soname.patch | patch -d build/%(tag)s-%(snapshot)s -p0')

        # compile the program
        r.Make()

        # -------------------------------
        #
        # install and policyesque things
        #
        # -------------------------------

        r.MakeInstall()

        # bad symlink
        r.Remove('%(bindir)s/soffice%(major_version)s')

        # deps fixes
        r.ComponentSpec(r.name+':runtime', '%(basisdir)s/program/libsclx.so')
        r.ComponentSpec(r.name+'-base:runtime', '%(basisdir)s/program/libdbaxmllx.so')

        # XXX
        r.Install('hsqldb.jar', '%(basedir)s/program/classes/')

        r.Run('bash compact_templates.sh "%(destdir)s/%(basedir)s/basis%(major_version)s"')

        # This is not a help document
        r.ComponentSpec('runtime', '%(basedir)s/basis%(major_version)s/help/main_transform.xsl')

        #r.loadManifest('mono_list.txt', r.name+'-mono')
        if r.use_kde:
            r.loadManifest('kde_list.txt', r.name+'-kde')
        if r.use_gnome:
            r.loadManifest('gnome_list.txt', r.name+'-gnome')
            r.loadManifest('gid_Module_Optional_Gnome', r.name+'-gnome')

        apps = [
            ('base', 'Base'),
            ('calc', 'Calc'),
            ('draw', 'Draw'),
            ('impress', 'Impress'),
            ('math', 'Math'),
            ('writer', 'Wrt'),
        ]

        for (app, d) in apps:
            pkg = '%s-%s:runtime' % (r.name, app)
            binFile = '%(bindir)s/oo'+app+'%(major_version)s'
            desktopFile = '%(datadir)s/applications/'+app+'%(major_version)s.desktop'
            r.loadManifest('gid_Module_Brand_Prg_'+d, pkg)
            r.loadManifest('gid_Module_Prg_'+d+'_Bin', pkg)
            r.ComponentSpec(pkg, desktopFile)
            r.ComponentSpec(pkg, binFile)
            # depend on openoffice.org:runtime
            r.Requires(r.name+':runtime', binFile)

        desktopFile = '%(datadir)s/applications/web%(major_version)s.desktop'
        r.ComponentSpec(pkg, desktopFile)
        r.ComponentSpec(pkg, '%(bindir)s/ooweb%(major_version)s')

        # Always install :java
        r.Requires(r.name+':java', '%(bindir)s/soffice')

        for lang in r.build_langs:

            pkg = r.name+':runtime'
            if lang != r.default_lang:
                pkg = r.name+'-locale-'+lang+':locale'

            r.loadManifest('lang_%s_list.txt' % lang.replace('-', '_'), pkg)

        # make sure basedir exists... we ran into this problem before. can't
        # use an assert since that would be run before everything else
        r.Run('test -d "%(destdir)s/%(basedir)s"')

        r.AutoDoc(exceptions='/.+/')

        r.ExcludeDirectories(exceptions='%(libdir)s/')

        r.TagSpec('desktop-file', '%(datadir)s/applications/')

        # flavor policy takes over 3.5 hours(!!) to run without this line. the
        # things in these directories are all data files which don't affect the
        # flavor anyway, and now we don't have to scan 23,000 of the 24,000
        # files in openoffice.org. Since all the libs and the executable is not
        # contained in these exceptions, the flavor is still set correctly.
        # If/when Flavor policy is sped up, this should be removed
        r.Flavor(exceptions='%(basedir)s/(share|program/resource)/.*')

        # These deps provided with OOO
        r.Requires(exceptDeps=r'java: org\.hsqldb\..*')
        r.Requires(exceptDeps=r'java: javax\.servlet\..*')

        # FIXME
        if Arch.x86_64:
            r.Requires(exceptDeps=r'soname\:\ ELF64\/libjawt\.so\(SUNWprivate\_1\.1\ SysV\ x86\_64\)')
        else:
            r.Requires(exceptDeps=r'soname\:\ ELF32\/libjawt\.so\(SUNWprivate\_1\.1\ SysV\ x86\)')

        arch = ('i386', 'amd64')[Arch.x86_64 == True]
        r.Requires(rpath='%(libdir)s/jvm/java-*-icedtea-*/jre/lib/'+arch)

    def loadManifest(r, file, package):

        # Hack, need better support from conary CNY-1502
        r.Run('/bin/true', package=package)

        if ':' in package:
            real_pkg = package.split(':')[0]
            pkg = (real_pkg, 'DEFAULT')[real_pkg == '']
        else:
            real_pkg = package
            pkg = package

        if not r.manifest_files.has_key(pkg):
            r.manifest_files[pkg] = 0
        else:
            r.manifest_files[pkg] += 1

        manifest = '%s.%d.manifest' % (real_pkg, r.manifest_files[pkg])

        r.Run('cat build/%s | grep "^/" > ../_MANIFESTS_/%s' % (file, manifest))

