#
# Copyright (c) 2010 Andy Grimm (https://issues.rpath.com/)
#                    Ant√≥nio Meireles The Foresight Linux Project


class LinuxFirmware(PackageRecipe):
    name = 'linux-firmware'
    version = '20100930'

    buildRequires = []

    def setup(r):
        r.addArchive('ftp://ftp.kernel.org/pub/linux/kernel/people/dwmw2/firmware/', dir='/lib/')
        r.addArchive('nouveau-firmware-1.tar.bz2')
        r.Move('/lib/%(name)s-%(version)s/*', '/lib/firmware/')
        r.MakeDirs('/lib/firmware/nouveau/')
        r.Move('../nouveau-firmware-1/*', '/lib/firmware/nouveau/')
        r.MakeDirs('%(thisdocdir)s/')
        r.Move('/lib/firmware/{WHENCE,LIC*}', '%(thisdocdir)s/')
        r.SetModes('/lib/*/*', 0644)

        r.ComponentSpec('lib', '/lib/.*')

        # trim
        # # Remove source files we don't need to install
        r.Remove('/lib/firmware/{usbdux/*dux,*/*.asm}')

        # this is a cheap hack to avoid redirects hell
        for p in ['userspace-kernel-firmware', 

                  'rt61pci-firmware',
                  'rt71pci-firmware',

                  'rt2860-firmware',
                  'rt2870-firmware',
                  'rtl8192se-firmware',

                  'ipw2100-fw',
                  'ipw2200-fw',
                  'iwlwifi-1000-ucode',
                  'iwlwifi-3945-ucode',
                  'iwlwifi-4965-ucode',
                  'iwlwifi-5000-ucode',
                  'iwlwifi-5150-ucode',
                  'iwlwifi-6000-ucode',
                  'iwlwifi-6050-ucode',

                  # this one had come rPL
                  'qla-firmware',]:
            obsolete = '%(datadir)s/%(name)s/obsoletes/' + p
            r.Create(obsolete, mode = 0644)
            r.PackageSpec(p, obsolete)
            r.Requires('%(name)s:lib', obsolete)
            
        # unflavor everything
        # firmware not arch specific
        r.Flavor(exceptions='/.*')
                    

