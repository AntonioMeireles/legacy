#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class AprUtil(CPackageRecipe):
    name = 'apr-util'
    version = '1.2.12'

    buildRequires = [ 'libtool:runtime', 'apr:devel', 'openldap:devel',
        'db:devel', 'e2fsprogs:devel', 'expat:devel', 'sqlite:devel', ]

    def setup(r):
        r.macros.apuver = '1'
        # FIXME: enable key checking
        r.addArchive('http://www.apache.org/dist/apr/') #,  keyid='10FDE075')
        # patch imported from FC5
        r.addPatch('apr-util-1.2.2-exports.patch')

        # CVE-2009-2412 RPL-3100
        r.addPatch('http://www.apache.org/dist/apr/patches/'
                   'apr-util-1.x-CVE-2009-2412.patch')

        # RPL-3108 (CVE-2009-1955)
        r.addPatch('http://svn.apache.org/viewvc/apr/apr/trunk/xml/'
                   'apr_xml.c?r1=781403&r2=781402&pathrev=781403&view=patch',
                   level=3)

        r.Configure('--with-apr=%(prefix)s '
                    '--includedir=%(includedir)s/apr-%(apuver)s '
                    '--with-ldap --without-gdbm --with-berkeley-db '
                    '--with-sqlite3 --without-sqlite2 '
                    '--without-mysql --without-pgsql ')

        r.Make()
        r.MakeInstall()

        r.Remove('%(libdir)s/aprutil.exp')

        # include libtool .la files, they are used by programs that
        # link with `apu-config --link-libtool`
        r.RemoveNonPackageFiles(exceptions=r'\.la$')
        r.ComponentProvides('berkeley-db')
