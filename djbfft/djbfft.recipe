#
# Copyright (c) 2009 Filip Brcic <brcha@gna.org>
# Distributed under the terms of the GNU General Public License v3
#

class Djbfft(CPackageRecipe):
    name = 'djbfft'
    version = '0.76'

    buildRequires = []

    def setup(r):
    	
        r.addArchive('http://cr.yp.to/djbfft/')
        r.addPatch('djbfft-0.76-glibc2.4-1.patch')
        r.addPatch('djbfft-0.76-testsuite-1.patch')

        r.Replace('/usr/local/djbfft', '%(destdir)s%(prefix)s', 'conf-home')

        r.Replace('auto', 'ppro', 'conf-opt') # optimize for pentium pro (valid for 64bit as well)
        r.Run("""
        echo "%(cc)s %(cflags)s -fPIC -DPIC" > conf-cc
        echo "%(cc)s %(ldflags)s" > conf-ld
""")
        makeOpts = (
            ' LIBDJBFFT="libdjbfft.so.%(version)s"'
            ' LIBPERMS="0755"'
            )
        if Arch.x86_64:
            r.Run("""sed -i 's@"lib@&64@' hier.c""") # prepare 64bit build

        r.Make(makeOpts)
        r.TestSuite('.', 'accuracy')
        r.TestSuite('.', 'accuracy2')
        r.TestSuite('.', 'speed')
	r.Make('setup check')
        r.Symlink('%(libdir)s/libdjbfft.so.%(version)s',
                  '%(libdir)s/libdjbfft.so.0')
        r.Symlink('%(libdir)s/libdjbfft.so.%(version)s',
                  '%(libdir)s/libdjbfft.so')
	r.FixupMultilibPaths(exceptions='.*')
