class Nvidia(CPackageRecipe):

    name = 'nvidia'
    version = '100.14.19'

    buildRequires = ['atk:devel', 'chkconfig:runtime', 'glib:devel',
                     'gtk:devel', 'libX11:devel', 'libXext:devel',
                     'pango:devel', 'desktop-file-utils:runtime',
                     ]
    if Arch.x86_64:
        # get rid of rMake warnings in x86_64
        buildRequires.extend([ 'libX11:lib[is: x86]', 'libXext:lib[is: x86]',])

    def setup(r):

        if Arch.x86:
            r.macros.arch = 'x86'
            r.macros.nvVersionSuffix = '1'
        else:
            r.macros.arch = 'x86_64'
            r.macros.lib32 = '/usr/lib'
            r.FixupMultilibPaths(exceptions='.*')
            r.macros.nvVersionSuffix = '2'

        r.macros.url = 'http://download.nvidia.com/XFree86/Linux-%(arch)s'
        r.addSource('%(url)s/%(version)s/NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s.run')

        r.addSource('nvidia.init')

        r.addAction('sh NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s.run -x') # Extract only

        # Copy the files we need
        r.macros.root = 'NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s/usr'

        r.Install('%(root)s/lib/libnvidia-{cfg,tls}.s*', '%(libdir)s/')
        r.Install('%(root)s/lib/tls/libnvidia-{cfg,tls}.s*', '%(libdir)s/tls/')

        if Arch.x86_64:
            r.Install('%(root)s/lib32/libnvidia-{cfg,tls}.s*', '%(lib32)s/')
            r.Install('%(root)s/lib32/tls/libnvidia-{cfg,tls}.s*', '%(lib32)s/tls/')

        r.Install('%(root)s/X11R6/lib/modules/libnvidia-wfb.s*', '%(libdir)s/xorg/modules/updates/')
        r.Install('%(root)s/X11R6/lib/modules/extensions/libglx.s*', '%(libdir)s/xorg/modules/updates/extensions/')
        r.Install('%(root)s/X11R6/lib/modules/drivers/nvidia_drv.s*', '%(libdir)s/xorg/modules/updates/drivers/')

        r.Install('%(root)s/X11R6/lib/libXvMCNVIDIA.so.*', '%(libdir)s/nvidia/')

        r.Install('%(root)s/lib/libGL*.so.*', '%(libdir)s/nvidia/')

        if Arch.x86_64:
            r.Install('%(root)s/lib32/libGL*.so.*', '%(lib32)s/nvidia/')

        r.Install('%(root)s/share/man/man1/*', '%(datadir)s/man/man1/')
        r.Remove('%(destdir)s/%(datadir)s/man/man1/nvidia-installer*')

        r.Install('%(root)s/share/doc/*', '%(datadir)s/doc/')

        # sanitize .desktop file
        r.Replace(('__PIXMAP_PATH__','%(datadir)s/pixmaps'),
                  ('__UTILS_PATH__','%(bindir)s'),
                  ('__DOCS_PATH__','%(datadir)s/pixmaps'),
                  '%(root)s/share/applications/nvidia-settings.desktop')
        r.Replace('Application;','GNOME;', '%(root)s/share/applications/nvidia-settings.desktop')

        r.Desktopfile('%(root)s/share/applications/nvidia-settings.desktop')

        r.Install('%(root)s/share/pixmaps/nvidia-settings.png', '%(datadir)s/pixmaps/')

        r.MakeDirs('%(bindir)s')
        r.Install('%(root)s/bin/nvidia-{settings,xconfig,bug-report.sh}', 
                  '%(bindir)s')

        # FIXME: do we ever  want to install headers ? 

        r.SharedLibrary(subtrees='%(libdir)s/xorg/modules/updates/')
        r.SharedLibrary(subtrees='%(libdir)s/xorg/modules/updates/extensions/')
        r.SharedLibrary(subtrees='%(libdir)s/xorg/modules/updates/drivers/')
        r.SharedLibrary(subtrees='%(libdir)s')

        r.SharedLibrary(subtrees='%(libdir)s/nvidia')
        r.SharedLibrary(subtrees='%(libdir)s/tls')

        if Arch.x86_64:
            r.SharedLibrary(subtrees='%(lib32)s')
            r.SharedLibrary(subtrees='%(lib32)s/nvidia')

        r.ComponentSpec('lib', 'libglx.so')
        r.ComponentSpec('lib', 'libXvMCNVIDIA.a')

        # The kernel side is in nvidia-kernel, and we need the kernel
        # modules that match this version exactly
        r.Requires('nvidia-kernel:runtime(%(version)s)', 
                   '%(libdir)s/xorg/modules/updates/drivers/nvidia_drv.so')

        # We want to make sure that the kernel module can require the
        # matching userspace code
        r.ComponentProvides('%(version)s')

        r.Install('nvidia.init', '%(initdir)s/nvidia')

        # conary some times it's too smart for its own good...
        r.Provides(exceptions='%(libdir)s/nvidia/')
        if Arch.x86_64:
            r.Provides(exceptions='%(lib32)s/nvidia/')

