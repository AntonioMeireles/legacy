loadInstalled('nvidia-kernel.recipe')
class Nvidia(CPackageRecipe):
    name = 'nvidia'
    version = NvidiaKernel.version

    buildRequires = ['atk:devel', 'chkconfig:runtime',
        'desktop-file-utils:runtime', 'glib:devel', 'gtk:devel',
        'pango:devel', 'xorg-x11:devel']

    def setup(r):
        r.macros.version = r.version.replace('_','-')
        r.macros.url = 'http://download.nvidia.com/XFree86/Linux-x86'
        r.addSource('%(url)s/%(version)s/NVIDIA-Linux-x86-%(version)s-pkg0.run')
        r.addSource('nvidia.init')
        r.Run('sh NVIDIA-Linux-x86-%(version)s-pkg0.run -x') # Extract only

        # Correct the paths in the .desktop
        r.Replace(('__UTILS_PATH__', '%(bindir)s'),
                  ('__DOCS_PATH__', '%(datadir)s'),
                  ('__PIXMAP_PATH__', '%(datadir)s/pixmaps'),
                  ('Application;', 'GNOME;'),
                  '%(root)s/share/applications/nvidia-settings.desktop')

        # Copy the files we need
        r.macros.root = 'NVIDIA-Linux-x86-%(version)s-pkg0/usr'
        r.Copy('%(root)s/bin/nvidia*', '%(bindir)s/')
        r.Copy('%(root)s/lib/', '%(libdir)s')
        r.Copy('%(root)s/X11R6/', '%(x11prefix)s')
        r.Copy('%(root)s/share/man', '%(docdir)s/man')
        r.Copy('%(root)s/share/', '%(thisdocdir)s')
        r.Copy('%(root)s/include/', '%(thisdocdir)s')

        # Put the files for nvidia-settings in the correct place
        r.Move('%(docdir)s/%(name)s-%(version)s/applications', '%(datadir)s')
        r.Move('%(docdir)s/%(name)s-%(version)s/pixmaps', '%(datadir)s')

        # Add missing symlinks
        r.SharedLibrary(subtrees='/usr/X11R6/lib/modules/extensions/')
        r.ComponentSpec('lib', 'libglx.so')
        r.ComponentSpec('lib', 'libXvMCNVIDIA.a')

        # We want to make sure that the kernel module can require the
        # matching userspace code
        r.ComponentProvides('%(version)s')

        r.Install('nvidia.init','%(initdir)s/nvidia')
