#
# Copyright (c) 2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class UtilLinuxNg(RPMPackageRecipe, AutoPackageRecipe):
    name = 'util-linux-ng'
    version = '2.14.1'
    rpmRelease = '2.fc10'

    rpmSources = [
        'util-linux-ng-login.pamd',
        'util-linux-ng-remote.pamd',
        'util-linux-ng-chsh-chfn.pamd',
        'nologin.c',
        'nologin.8',
    ]
    rpmPatches = [
        'util-linux-ng-2.13-login-pamstart.patch',
        'util-linux-ng-2.13-login-lastlog.patch',
        'util-linux-ng-2.13-fdisk-b-4096.patch',
        'util-linux-ng-2.14-blockdev-rmpart.patch',
    ]

    buildRequires = [
        'audit:devel', 'e2fsprogs:devel', 'e2fsprogs:runtime',
        'gettext:runtime', 'install-info:runtime', 'intltool:runtime',
        'libtermcap:devel', 'ncurses:devel', 'pam:devel', 'perl:runtime',
        'tcsh:runtime', 'udev:devel', 'zlib:devel',
    ]

    def configure(r):
        r.Configure('--enable-kill --enable-write --enable-raw'
                    ' --enable-login-utils --enable-partx'
                    ' --with-audit --disable-wall'
                    ' --disable-makeinstall-chown'
                    ' --bindir=%(essentialbindir)s'
                    ' --sbindir=%(essentialsbindir)s'
                    )

    def makeinstall(r):
        r.MakeInstall()

        r.Run('gcc %(cflags)s -o nologin nologin.c')
        r.Install('nologin', '%(essentialsbindir)s/', mode=0755)
        r.Install('nologin.8', '%(mandir)s/man8/', mode=0644)

        r.Symlink('%(essentialsbindir)s/clock', '%(sbindir)s/clock'),
        r.Symlink('hwclock', '%(essentialsbindir)s/clock'),
        r.Symlink('%(essentialbindir)s/kill', '%(bindir)s/kill'),

        # A few su/gid programs
        r.SetModes('%(bindir)s/{ch{fn,sh},newgrp}', 04755)
        r.SetModes('%(bindir)s/write', 02755)
        r.SetModes('%(essentialbindir)s/{mount,umount}', 04755)
        # marked "deprecated"
        r.Remove('%(bindir)s/{pg,line}', '%(mandir)s/man1/{pg,line}.1')
        # mkcramfs link needed for anaconda:
        r.Symlink('%(essentialsbindir)s/mkfs.cramfs', '%(bindir)s/mkcramfs')

        r.TagSpec('shell', '%(essentialsbindir)s/nologin')

        r.ComponentSpec('perl', '%(bindir)s/(scriptreplay|chkdupexe)')

        # RPL-1178
        r.RemoveNonPackageFiles('.*(ddate|ctrlaltdel).*')
        r.PackageSpec('util-linux-extras', '.*(ul|cfdisk|setfdperm|isosize|minix|bfs|write|talkf).*')
