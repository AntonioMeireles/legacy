#
# Copyright (c) 2004-2005 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Freetype(CPackageRecipe):

    # autoconf >= 2.59, symlinks (?)
    buildRequires = [ 'automake:runtime', 'autoconf:runtime',
                      'libtool:runtime', 'zlib:devel' ]

    name = 'freetype'
    version = '2.1.10'

    # If you have a license from Apple, you can turn this on and rebuild
    with_bytecode_interp = False

    def setup(r):
        r.disableParallelMake()

        r.addArchive('http://unc.dl.sourceforge.net/sourceforge/%(name)s/%(name)s-%(version)s.tar.bz2')
        r.addArchive('http://unc.dl.sourceforge.net/sourceforge/%(name)s/freetype-doc-%(version)s.tar.bz2')
        r.addArchive('http://unc.dl.sourceforge.net/sourceforge/%(name)s/ft2demos-%(version)s.tar.bz2',
                        dir=r.theMainDir)

        r.addPatch('freetype-2.1.3-enable-ft2-bci.patch',
                    rpm='ftp://ftp.linux.ncsu.edu/pub/fedora/linux/core/5/source/SRPMS/freetype-2.1.10-5.2.1.src.rpm',
                    use=r.with_bytecode_interp, level=0)
        r.addPatch('freetype-2.1.10-multivuln.patch')

        # https://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=118021
        r.macros.cflags += ' -fno-strict-aliasing'

        r.Configure()
        r.Make()

        if 0 and Use.X:
            r.Make('X11_LIB=%(x11prefix)s/%(lib)s X11_PATH="%(x11prefix)s"'
                      ' TOP_DIR="%(builddir)s"',
                      subDir='ft2demos-%(version)s')

        r.MakeInstall('gnulocaledir=%(destdir)s/%(datadir)s/locale')

        ftdemolist = ('ftdump', 'ftlint', 'ftmemchk', 'ftmulti', 'ftstring',
                      'fttimer', 'ftview')
        if 0 and Use.X:
            for ftdemo in ftdemolist:
                r.Run('libtool --mode=install install -m 755'
                            ' ft2demos-%(version)s/bin/' + ftdemo +
                            ' %(destdir)s/%(bindir)s/')

        if 0 and Use.X:
            demoexp = "|".join(ftdemolist)
            r.ComponentSpec('demos', '%(bindir)s/(' + demoexp + ')')
