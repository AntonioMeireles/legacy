#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Fetchmail(CPackageRecipe):
    name = 'fetchmail'
    version = '6.3.8'

    buildRequires = [ 'hesiod:devel', 'autoconf:runtime', 'openssl:devel',
                      'automake:runtime', 'libtool:runtime',
                      'gettext:runtime', 'gettext:devel',
                      'bison:runtime', 'flex:runtime', 'procmail:runtime',
                      'sendmail:runtime', 'e2fsprogs:devel',
                      # :runtime is needed to get the krb5 profile.d path
                      # extending file
                      'krb5:devel', 'krb5:runtime', ]

    fetchmailconf = False

    def setup(r):
        r.disableParallelMake()
        r.addArchive('http://download.berlios.de/fetchmail/')
        r.addSource('fetchmailconf.1', use=r.fetchmailconf)

        # RPL-1690 CVE-2007-4565
        r.addPatch('http://fetchmail.berlios.de/fetchmail-SA-2007-02.txt')

        r.Configure(' --enable-POP3 --enable-IMAP '
                    ' --enable-ETRN --enable-NTLM --enable-nls'
                    ' --with-hesiod=auto'
                    ' --enable-inet6'
                    ' --with-ssl'
                    # even if we are using krb, we're not using krb4, which
                    # is what is enabled by --with-kerberos
                    ' --without-kerberos --with-kerberos5 --with-gssapi',
                    preConfigure='LIBS=-ldl')

        r.Make(preMake='LIBS=-ldl')
        r.MakeInstall('mandir=%(mandir)s')
        if r.fetchmailconf:
            r.Install('fetchmailconf.1', '%(mandir)s/man1/', mode=0644)
        else:
            r.Remove('%(bindir)s/fetchmailconf*')
            r.Remove('%(mandir)s/man1/fetchmailconf.1*')

        r.AutoDoc('FEATURES', 'NOTES', r'.*\.html')
