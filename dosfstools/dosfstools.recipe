#
# Copyright (c) 2004-2005 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Dosfstools(RPMPackageRecipe, CPackageRecipe):
    name = 'dosfstools'
    version = '2.11'
    rpmRelease = '8.fc7'
    distroVersion = '8'

    tarballName = '%(name)s-%(version)s.src.tar.gz'

    rpmPatches = [ 'dosfstools-2.7-argfix.patch',
                   'dosfstools-2.11-assumeKernel26.patch',
                   'dosfstools-2.11-fortify.patch',
                   'dosfstools-2.11-label.patch', ]

    def setup(r):
        # Use source from rpm for now.
        # r.addArchive('ftp://ftp.uni-erlangen.de/pub/Linux/LOCAL/dosfstools/'
        #              '%(name)s-%(version)s.src.tar.gz')
        r.unpack()
        r.macros.cflags += ' -Dllseek=lseek64 -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64'
        r.Make()
        for long, short in (('mkdosfs', 'mkfs'), ('dosfsck', 'fsck')):
            r.Install('%s/%s' %(long, long),
                      '%%(essentialsbindir)s/%s' %long, mode=0755)
            r.Install('%s/%s.8' %(long, long),
                      '%%(mandir)s/man8/%s.8' %long, mode=0644)
            for fs in ('msdos', 'vfat'):
                r.Symlink(long, '%%(essentialsbindir)s/%s.%s' %(short, fs))
                r.Symlink('%s.8' %long,
                          '%%(mandir)s/man8/%s.%s.8' %(short, fs))
        r.Install('dosfsck/dosfslabel', '%(essentialsbindir)s/')
