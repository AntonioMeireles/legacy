#
# Copyright (c) 2009-2011 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class GobjectIntrospection(AutoPackageRecipe):

    name = 'gobject-introspection'
    # DO NOT BUMP to 0.10.x as it BREAKS API and we'd need everything 
    # that currently deps on this to be rebuilt and make to consume the
    # new API
    version = '0.9.12'

    buildRequires = [ 'flex:devel', 'libffi:devel',
                      'flex:runtime', 'python:devel', 'bison:runtime', 'Mesa:devel', 'libXfixes:devel',
                      'cairo:devel', 'glib:devel', 'gtk-doc:runtime', 'pkgconfig:devel']
    makeArgs = 'V=1'
    loadInstalled('python')

    def unpack(r):
        r.macros.majversion = '.'.join(r.version.split('.')[0:2])
        r.addArchive('mirror://gnome/%(name)s/%(majversion)s/')

    def policy(r):
        # Move the python modules to the correct location
        r.macros.pyver = Python.majversion
        r.Move('%(libdir)s/%(name)s/giscanner', 
               '%(libdir)s/python%(pyver)s/site-packages/')

        # bah! we do not want :runtime to fetch :devel... fattens groups
        for f in ['%(libdir)s/lib.*.so',
                  '%(bindir)s/g-ir-.*',
                  '%(datadir)s/gir.*',
                  '%(libdir)s/python%(pyver)s/site-packages/giscanner']:
            r.ComponentSpec('devellib', f)
            r.Requires('%(name)s:python', f)

        # overrides and obsoletes gir-repository...
        obsolete = '%(datadir)s/%(name)s/obsoletes/' + 'gir-repository'
        r.Create(obsolete, mode = 0644)
        r.PackageSpec('gir-repository', obsolete)
        r.Requires('%(name)s:lib', obsolete)
