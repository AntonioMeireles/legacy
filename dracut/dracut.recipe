#
# Copyright (c) 2006-2008 rPath, Inc.
#               2008-2013 The Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.foresightlinux.org/licenses/mit-license/
#
loadSuperClass('rpmpackage')
class Dracut(RPMPackageRecipe,AutoPackageRecipe):
    name = 'dracut'
    version = '024'
    rpmRelease = '29.git20130227.fc18'

    buildRequires = [ 'docbook-xsl', 'docbook-dtds', 'libxslt', 'make:runtime',
                      'dash:runtime', 'asciidoc:runtime', ]

    rpmPatches = [ '0001-dracut.sh-only-save-kernel_cmdline-if-set.patch',
                       '0002-dracut.conf.d-fedora.conf.example-s-kernelcmdline-ke.patch',
                       '0003-40network-ifup.sh-do_static-and-do_ipv6auto-return-0.patch',
                       '0004-dracut.sh-only-warn-not-error-if-we-don-t-strip.patch',
                       '0005-dracut.sh-do-not-strip-signed-kernel-modules.patch',
                       '0006-i18n-parse-i18n.sh-fix-locale.conf-caused-by-4dbc1d1.patch',
                       '0007-network-fixed-MAC-address-assignment.patch',
                       '0008-dmsquash-live-add-systemd-checkisomd5-service.patch',
                       '0009-crypt-crypt-run-generator.sh-do-not-timeout-for-LUKS.patch',
                       '0010-systemd-dracut-cmdline.service-run-before-systemd-vc.patch',
                       '0011-add-swapoff-to-initramfs-to-fix-shutdown-reboot.patch',
                       '0012-dracut.spec-add-iputils-and-iproute-requirement-for-.patch',
                       '0013-nfs-nfsroot-cleanup.sh-mount-bind-instead-of-move.patch',
                       '0014-iscsi-iscsiroot.sh-reload-rules-after-adding-99-iscs.patch',
                       '0015-dmsquash-live-fixed-checkisomd5-service-call.patch',
                       '0016-kernel-modules-create-etc-modprobe.d-if-it-does-not-.patch',
                       '0017-usrmount-mount-usr.sh-filter-subvol-from-root-rflags.patch',
                       '0018-dracut-functions.sh-add-pre-shutdown-hook.patch',
                       '0019-dracut-lib.sh-force-hide-plymouth-in-shutdown-emerge.patch',
                       '0020-shutdown-source-pre-shutdown-hook-and-force-quit-ply.patch',
                       '0021-mdraid-add-mdmon-offroot-.service-and-takeover-mdmon.patch',
                       '0022-shutdown-kill-all-processes-and-report-remaining-one.patch',
                       '0023-mdmon-renamed-mdmon-offroot-.service-to-mdmon-.servi.patch',
                       '0024-shutdown-call-losetup-D-on-shutdown.patch',
                       '0025-url-lib-url-lib.sh-turn-off-curl-globbing.patch',
                       '0026-url-lib-url-lib.sh-add-proxy-support-for-curl.patch',
                       '0027-url-lib-url-lib.sh-remove-bashism.patch',
                       '0028-url-lib.sh-fix-curl-globoff-arg.patch',  ]
    def setup(r):
        r.unpack()

        r.addSource('kernel.tagdescription', macros=True, dest='%(tagdescriptiondir)s/kernel')
        r.addSource('kernel.taghandler', macros=True, dest='%(taghandlerdir)s/kernel', mode=0755)
        if Use.xen and Use.domU:
            r.Replace('run_bommy add \$version \$pre \$initrd \$xenmultiboot',
                      'run_bommy add $version $pre $initrd',
                      '%(taghandlerdir)s/kernel')
 
        r.Make('sysconfdir=/etc sbindir=%(essentialsbindir)s')
        r.MakeInstall('sysconfdir=/etc sbindir=%(essentialsbindir)s')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/dracut.conf.d')
        r.Create('%(localstatedir)s/log/dracut.log', contents='')
        r.InitialContents('%(localstatedir)s/log/dracut.log')

        r.Install('dracut.logrotate', '%(sysconfdir)s/logrotate.d/dracut_log', mode = 0644)
        r.Create('%(sysconfdir)s/dracut.conf.d/01-dist.conf',
                 contents = """
# Dracut config file customized for Foresight Linux.

# i18n
i18n_vars="/etc/sysconfig/keyboard:KEYTABLE-KEYMAP /etc/sysconfig/i18n:SYSFONT-FONT,FONTACM-FONT_MAP,FONT_UNIMAP"
add_dracutmodules+=" "
stdloglvl=3
omit_drivers+=" .*/fs/ocfs/.*  i2o_scsi"
install_items+=" vi /etc/virc ps grep cat rm "
prefix="/"
kernel_cmdline+=" rd.auto=1 "


""",
                 mode = 0644)

        for req in ('%(essentialbindir)s/awk',
                    '%(essentialsbindir)s/dmsetup',
                    '%(essentialsbindir)s/ip',
                    '%(essentialsbindir)s/modprobe',
                    '%(essentialsbindir)s/lvm',
                    '%(essentialsbindir)s/ldconfig',
                    '/dev/null',
                    '%(bindir)s/head',
                    '%(bindir)s/tail',
                    '%(essentialbindir)s/cat',
                    '%(essentialbindir)s/chmod',
                    '%(bindir)s/cmp',
                    #'%(bindir)s/strip', # RPL-2413
                    '%(bindir)s/wc',
                    '%(bindir)s/bzgrep',
                    '%(bindir)s/bzip2',
                    '%(bindir)s/tr',
                    '%(bindir)s/find',
                    '%(essentialbindir)s/cp',
                    '%(essentialbindir)s/cpio',
                    '%(essentialbindir)s/df',
                    '%(essentialbindir)s/egrep',
                    '%(essentialbindir)s/grep',
                    '%(essentialbindir)s/zgrep',
                    '%(essentialbindir)s/gzip',
                    '%(essentialbindir)s/ln',
                    '%(essentialbindir)s/mkdir',
                    '%(essentialbindir)s/mknod',
                    '%(essentialbindir)s/mktemp',
                    '%(essentialbindir)s/rm',
                    '%(essentialbindir)s/mv',
                    '%(essentialbindir)s/sed',
                    '%(essentialbindir)s/cut',
                    '%(essentialbindir)s/basename',
                    '%(essentialbindir)s/sort',
                    '%(essentialbindir)s/loadkeys',
                    '%(essentialbindir)s/ash.static',
                    '%(essentialbindir)s/ls',
                    '%(essentialsbindir)s/ext3flush',
                    '%(essentialsbindir)s/lvm',
                    '%(essentialsbindir)s/modprobe',
                    '%(essentialsbindir)s/bootman',
                    '%(essentialsbindir)s/bommy',
                    '%(essentialsbindir)s/modinfo',
                    '%(essentialsbindir)s/depmod',
                    '%(essentialsbindir)s/kpartx',
                    'initscripts:runtime',
                    'plymouth:runtime'
                    ):
            r.Requires(req, '%(essentialsbindir)s/dracut')

        for req in ('%(essentialsbindir)s/bootman',
                    '%(essentialsbindir)s/bommy',
                    '%(bindir)s/grubtobootman',
                    '%(bindir)s/wc',
                    '%(essentialsbindir)s/ext3flush',
                    '%(essentialbindir)s/awk',
                    'bootman:runtime(bommy-get)',):
            r.Requires(req, '%(taghandlerdir)s/kernel')

        # rm modules specific to foreign distros. 
        for rm in [ # RH and / or rpm specific 
                '96securityfs',
                '97masterkey',
                '98integrity',
                '98selinux',
                    '10rpmversion',
                    # gentoo specific
                    '50gensplash',
                '00dash',
                    ]:
            r.Remove('/usr/lib/dracut/modules.d/' + rm, recursive=True)

        # dracut-fips
        r.Install('dracut.conf.d/fips.conf.example', '%(sysconfdir)s/dracut.conf.d/40-fips.conf',
                  mode = 0644)
        r.PackageSpec('dracut-fips', '/usr/lib/dracut/modules.d/01fips/',
                      '%(sysconfdir)s/dracut.conf.d/40-fips.conf')

        # compat symlink
        r.Symlink('%(bindir)s/dracut', '%(essentialsbindir)s/')
        
        r.MakeDirs('%(sharedstatedir)s/initramfs')
        r.ExcludeDirectories(exceptions = '%(sharedstatedir)s/initramfs')


        # XXX smooth upgrade path from mkinitrd 
        # XXX to be dropped in f3
        r.PackageSpec('mkinitrd',
                      '%(bindir)s/lsinitrd',
                      '%(bindir)s/mkinitrd')
        r.Requires('mkinitrd:runtime', 'dracut:runtime')
        r.Requires('dracut:runtime', 'mkinitrd:runtime')
        r.Requires('lvm2:runtime(DRACUT)', '%(essentialsbindir)s/dracut')

        # dracut-network
        for module in [ '40network', '95fcoe', '95iscsi', 
                        '95nbd', '45ifcfg', '95znet' ]:
            r.PackageSpec('dracut-network',
                          '/usr/lib/dracut/modules.d/' + module + '/.*' )

        # dracut-tools
        r.MakeDirs('%(localstatedir)s/lib/dracut/overlay')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/dracut/overlay')
        r.MakeDirs('/boot/dracut')
        r.ExcludeDirectories(exceptions='/boot/dracut')
        r.PackageSpec('dracut-tools',
                      '%(mandir)s/man8/dracut-gencmdline.8.*',
                      '%(mandir)s/man8/dracut-catimages.8.*',
                      '%(essentialsbindir)s/dracut-gencmdline',
                      '%(essentialsbindir)s/dracut-catimages',
                      '%(localstatedir)s/lib/dracut/overlay',
                      '/boot/dracut', 
                      )
        # 
#        r.Requires('dracut-fips:config',
#                   'dracut-fips:data')
#        r.Requires('dracut-fips:data',
#                   'dracut-fips:config')

        r.Requires('dracut:runtime',
                   '%(localstatedir)s/lib/dracut/overlay')
        r.Requires('dracut:runtime',
                   '/usr/lib/dracut/modules.d/')

        r.Requires('grubby:runtime',
                   'dracut:runtime')
        

