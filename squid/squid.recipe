#
# Copyright (c) 2006-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage=conary.rpath.com@rpl:devel')
class Squid(RPMPackageRecipe, CPackageRecipe):
    name = 'squid'
    version = '2.6.STABLE12'
    rpmRelease = '1.fc7'
    rpmPatches = [ 'squid-2.5.STABLE11-config.patch',
        'squid-2.5.STABLE12-smb-path.patch',
        'squid-2.5.STABLE4-location.patch', 'squid-2.5.STABLE4-perlpath.patch',
        'squid-2.6.STABLE2-build.patch', 'squid-2.6.STABLE5-fd-config.patch', ]
    rpmSources = [ 'squid.init', 'squid.logrotate', 'squid.pam', 'squid.spec',
        'squid.sysconfig', ]

    buildRequires = [ 'cyrus-sasl:devel', 'glibc:devel',
        'krb5:devel', 'openldap:devel', 'openssl:devel',
        'pam:devel', 'zlib:devel', 'perl:runtime', 'pkgconfig:devel', ]

    def setup(r):
        r.unpack()

        r.Configure('--exec_prefix=%(prefix)s'
                    ' --bindir=%(sbindir)s'
                    ' --libexecdir=%(libdir)s/squid'
                    ' --localstatedir=/var'
                    ' --datadir=%(datadir)s'
                    ' --sysconfdir=%(sysconfdir)s/squid'
                    ' --enable-poll'
                    ' --enable-snmp'
                    ' --enable-removal-policies="heap,lru"'
                    ' --enable-storeio="aufs,coss,diskd,null,ufs"'
                    ' --enable-ssl'
                    ' --with-openssl=%(prefix)s/kerberos'
                    ' --enable-delay-pools'
                    ' --enable-linux-netfilter'
                    ' --with-pthreads'
                    ' --enable-ntlm-auth-helpers="SMB,fakeauth"'
                    ' --enable-external-acl-helpers="ip_user,ldap_group,unix_group,wbinfo_group"'
                    ' --enable-auth="basic,digest,ntlm"'
                    ' --enable-digest-auth-helpers="password"'
                    ' --enable-useragent-log'
                    ' --enable-referer-log'
                    ' --disable-dependency-tracking'
                    ' --enable-cachemgr-hostname=localhost'
                    ' --enable-underscores'
                    ' --enable-basic-auth-helpers="LDAP,MSNT,NCSA,PAM,SMB,YP,getpwnam,multi-domain-NTLM,SASL"'
                    ' --enable-cache-digests'
                    ' --enable-ident-lookups'
                    ' --with-large-files'
                    ' --enable-fd-config'
                    ' --enable-follow-x-forwarded-for')

        r.Make()
        r.MakeInstall()
        r.Install('squid.init','%(initdir)s/squid', mode=0755)
        r.Install('squid.logrotate','%(sysconfdir)s/logrotate.d/squid')
        r.Install('squid.sysconfig','%(sysconfdir)s/sysconfig/squid')
        r.Install('squid.pam','%(sysconfdir)s/pam.d/squid')
        r.MakeDirs('%(localstatedir)s/log/squid',
            '%(localstatedir)s/spool/squid', mode=0750)
        r.Ownership('squid','squid',
            '%(localstatedir)s/log/squid','%(localstatedir)s/spool/squid')
        r.ExcludeDirectories(exceptions=['%(localstatedir)s/log/squid',
            '%(localstatedir)s/spool/squid'])
