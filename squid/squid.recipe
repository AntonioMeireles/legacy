#
# Copyright (c) 2011 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage=conary.rpath.com@rpl:devel')
class Squid(RPMPackageRecipe, CPackageRecipe):
    name = 'squid'
    version = '3.1.10'

    firstver = version.split('.')[0]
    externalArchive = 'http://www.squid-cache.org/Versions/v'+firstver+'/%(major_version)s/'

    rpmUpVer = '3.1.10'
    rpmRelease = '1.fc15'
    rpmPatches = [
        'squid-3.1.0.9-config.patch',
        'squid-3.1.0.9-location.patch',
        'squid-3.0.STABLE1-perlpath.patch',
        'squid-3.1.0.15-smb-path.patch',
        'squid-3.0.STABLE7-from_manpg.patch',
        #'squid-3.1.9-ltdl.patch',
        ]
    rpmSources = [
        'squid.init',
        'squid.logrotate',
        'squid.pam',
        'squid.sysconfig',
        ]

    buildRequires = [
        'bind:devel',
        'chkconfig:runtime',
        'cyrus-sasl:devel',
        'db:devel',
        'expat:devel',
        'glibc:devel',
        'krb5:devel',
        'libcap:devel',
        'libstdc++:devel',
        'libtool:devel',
        'libxml2:devel',
        'openldap:devel',
        'openssl:devel',
        'pam:devel',
        'perl-DBD-MySQL:perl',
        'perl-DBD-Pg:perl',
        'perl-DBD-SQLite:perl',
        'perl-DBI:perl',
        'perl:devel',
        'perl:runtime',
        'pkgconfig:devel',
        'w3c-libwww:devel',
        'zlib:devel',
        ]

    def setup(r):
        r.macros.cflags += " -fPIE"
        r.macros.cxxflags += " -fPIE"
        r.unpack()

        r.Configure(
            ' --libexecdir=%(libdir)s/squid'
            ' --datadir=%(datadir)s/squid'
            ' --sysconfdir=%(sysconfdir)s/squid'
            " --with-logdir='%(localstatedir)s/log/squid'"
            " --with-pidfile='%(localstatedir)s/run/squid.pid'"
            ' --disable-dependency-tracking'
            ' --enable-arp-acl'
            ' --enable-follow-x-forwarded-for'
            ' --enable-auth="basic,digest,ntlm,negotiate"'
            ' --enable-basic-auth-helpers="LDAP,MSNT,NCSA,PAM,SMB,YP,getpwnam,multi-domain-NTLM,SASL,DB,POP3,squid_radius_auth"'
            ' --enable-ntlm-auth-helpers="smb_lm,no_check,fakeauth"'
            ' --enable-digest-auth-helpers="password,ldap,eDirectory"'
            ' --enable-negotiate-auth-helpers="squid_kerb_auth"'
            ' --enable-external-acl-helpers="ip_user,ldap_group,session,unix_group,wbinfo_group"'
            ' --enable-cache-digests'
            ' --enable-cachemgr-hostname=localhost'
            ' --enable-delay-pools'
            ' --enable-epoll'
            ' --enable-icap-client'
            ' --enable-ident-lookups'
            ' --with-large-files'
            ' --enable-linux-netfilter'
            ' --enable-referer-log'
            ' --enable-removal-policies="heap,lru"'
            ' --enable-snmp'
            ' --enable-ssl'
            ' --enable-storeio="aufs,diskd,ufs"'
            ' --enable-useragent-log'
            ' --enable-wccpv2'
            ' --enable-esi'
            ' --with-aio'
            ' --with-default-user="squid"'
            ' --with-filedescriptors=16384'
            ' --with-dl'
            ' --with-openssl'
            ' --with-pthreads'
            )

        r.Make()
        r.MakeInstall()
        r.Install('squid.init','%(initdir)s/squid', mode=0755)
        r.Install('squid.logrotate','%(sysconfdir)s/logrotate.d/squid')
        r.Install('squid.sysconfig','%(sysconfdir)s/sysconfig/squid')
        r.Install('squid.pam','%(sysconfdir)s/pam.d/squid')
        r.MakeDirs('%(localstatedir)s/log/squid',
            '%(localstatedir)s/spool/squid', mode=0750)
        r.Ownership('squid','squid',
            '%(localstatedir)s/log/squid','%(localstatedir)s/spool/squid')
        r.ExcludeDirectories(exceptions=['%(localstatedir)s/log/squid',
            '%(localstatedir)s/spool/squid'])
