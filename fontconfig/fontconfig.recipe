#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadSuperClass('rpmpackage')
class Fontconfig(RPMPackageRecipe,AutoPackageRecipe):
    name = 'fontconfig'
    version = '2.4.2'
    isOPENsuse = True
    rpmRelease = '26'

    rpmSources = ['suse-generic-names.conf',
                  'suse-pre-user.conf',
                  'suse-post-user.conf',
                  'suse-hinting.conf',
                  'suse-bitmaps.conf',
                  'suse-font-dirs.conf',
                  ]
    rpmPatches = [
        ['Patch5', 'AppleRoman-DynaFont.patch', 0 ,],
        ['Patch6', 'fontconfig-minmaxabs.patch',0 ,],
        ['Patch10', 'conf.patch', 1 ,],
        ['Patch16', 'make-check.patch',1 ,],
        ['Patch17', 'change-magic.patch',1 ,],
        ['Patch28', 'bugzilla-158573-turn-off-hinting-when-embolden.patch', 1 ,],
        ['Patch31', 'bugzilla-246783-do-not-crash-when-config-files-contain-broken-stuff.patch',1 ,],
        ['Patch32', 'fix-pattern-duplicate.diff', 1 ,],
        ]


    buildRequires = [ 'freetype:devel', 'lynx:runtime', 'expat:devel', 'perl:runtime',
                      'zlib:devel', 'pkgconfig:devel', 'docbook-utils:runtime',
                      'docbook-utils-pdf:runtime', 'docbook-dtds:data', 
                      'opensp:runtime', 'perl-SGMLS:runtime',]

    def unpack(r):

        r.addArchive('%(name)s-%(version)s.tar.bz2', rpm=r.srpm)

        for x in r.rpmSources:
            r.addSource(x, dir='%(sysconfdir)s/fonts/', rpm=r.srpm)

        for n, p, l in r.rpmPatches:
            if l <> -1:
                r.addPatch(p, level = l, rpm= r.srpm )
            else:
                r.addPatch(p, rpm= r.srpm )

        r.addSource('cacheable-font.tagdescription', macros=True,
                        dest='%(tagdescriptiondir)s/cacheable-font')
        r.addSource('cacheable-font.taghandler', macros=True,
                        dest='%(taghandlerdir)s/cacheable-font', mode=0755)

        extraConfig = ' --enable-libxml2=no --disable-docs --with-pic --with-x'

        r.Configure(' --with-add-fonts=%(datadir)s/fonts '
                    ' --with-freetype-lib=%(libdir)s ' +extraConfig)

        r.Make()
        r.MakeInstall()

        r.addSource('local.conf.instsys', rpm=r.srpm,
                    dest='%(sysconfdir)s/fonts/local.conf.instsys')

        r.Move('%(docdir)s/%(name)s/*', '%(thisdocdir)s/')
        r.Requires('%(name)s:runtime', '%(libdir)s/.*')

        r.Remove('/etc/fonts/conf.d/50-user.conf')
        r.Remove('/etc/fonts/conf.d/51-local.conf')

        # XXX suse-font-dirs.conf needs heavy tunning

        r.Symlink('/etc/fonts/suse-font-dirs.conf',
                  '/etc/fonts/conf.d/05-fl-font-dirs.conf')
        r.Symlink('/etc/fonts/suse-pre-user.conf',
                  '/etc/fonts/conf.d/50-fl-pre-user.conf')
        r.Symlink('/etc/fonts/conf.avail/51-local.conf',
                  '/etc/fonts/conf.d/55-local.conf')
        r.Symlink('/etc/fonts/conf.avail/50-user.conf',
                  '/etc/fonts/conf.d/56-user.conf')
        r.Symlink('/etc/fonts/suse-post-user.conf',
                  '/etc/fonts/conf.d/58-fl-post-user.conf')

        # FIXME: remove when/if RPL-1077 is implemented
        for req in ('%(essentialbindir)s/cat', '%(bindir)s/fc-cache',
                    '/dev/null'):
            r.Requires(req, '%(taghandlerdir)s/cacheable-font')


