#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadSuperClass('rpmpackage')
class Fontconfig(RPMPackageRecipe,AutoPackageRecipe):
    name = 'fontconfig'
    version = '2.4.2'

    rpmRelease = '2.fc7'

    rpmSources = ['25-no-hint-fedora.conf',
                  '30-aliases-fedora.conf',
                  '40-generic-fedora.conf',
                  '64-nonlatin-fedora.conf',
                  '75-blacklist-fedora.conf']  

    buildRequires = [ 'freetype:devel', 'lynx:runtime', 'expat:devel', 'perl:runtime', 
                      'zlib:devel', 'pkgconfig:devel','docbook-utils:runtime', 'docbook-utils-pdf:runtime', 
                      'opensp:runtime', 'perl-SGMLS:runtime', 'libxml2:devel']
    if Use.builddocs:
        buildRequires.extend([
                'docbook-utils-pdf:runtime'])

        def unpack(r):

            for x in r.rpmSources:
                r.addSource(x, dir='%(sysconfdir)s/fonts/conf.d', rpm=r.srpm)


            r.addArchive('http://www.fontconfig.org/release/')
            r.addSource('cacheable-font.tagdescription', macros=True,
                        dest='%(tagdescriptiondir)s/cacheable-font')
            r.addSource('cacheable-font.taghandler', macros=True,
                        dest='%(taghandlerdir)s/cacheable-font', mode=0755)

            extraConfig = ' --enable-libxml2 '
            if not Use.builddocs:
                extraConfig += ' --disable-docs'
            # --disable-docs doesn't do what you'd think, so we have to fix
            r.Replace(r'  enable_docs=\$default_docs',
                      '  enable_docs=no',
                      'configure')


            r.Configure('--with-add-fonts=%(datadir)s/fonts '+extraConfig)
            if not Use.builddocs:
            # unfortunately, fc-cache and fc-list do not honor --disable-docs
                r.Replace(('^DOC2MAN = docbook2man',
                           'DOC2MAN = echo'),
                          ('install-man: install-man1',
                           'install-man:'), 'fc-{cache,list}/Makefile')
                r.Make()

                if not Use.builddocs:
                    # these aren't installed by Makefile if !builddocs
                    r.Install('doc/*.3', '%(mandir)s/man3/')
                    r.Install('doc/*.5', '%(mandir)s/man5/')
                    r.MakeInstall()





                r.Move('%(docdir)s/%(name)s/*', '%(thisdocdir)s/')
                r.Requires('%(name)s:runtime', '%(libdir)s/.*')




                # FIXME: remove when/if RPL-1077 is implemented
        #for req in ('/bin/cat', '/usr/bin/fc-cache'): << coreutils is rpl:1 cooked with old conary
        # r.Requires(req, '%(taghandlerdir)s/cacheable-font')
                
                # does not seem to be needed anymore...
                # r.Config(exceptions='/etc/fonts/conf.d/10LohitGujarati.conf')
