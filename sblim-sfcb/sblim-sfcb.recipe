#
# Copyright (c) 2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class SblimSfcb(AutoPackageRecipe):
    name = 'sblim-sfcb'
    version = '1.3.0'

    buildRequires = [
        'chkconfig:runtime',
        'curl:devel',
        'flex:runtime',
        'pam:devel',
        'perl:devel',
        'perl:runtime',
        'unzip:runtime',
        'zlib:devel',
    ]

    cimSchema = "cimv217Final-MOFs.zip"
    cimSchemaUrl = "http://www.dmtf.org/standards/cim/cim_schema_v217/%(cimSchema)s"

    def unpack(r):
        r.macros.cimSchema = r.cimSchema
        r.addArchive('mirror://sourceforge/sblim/')
        r.addSource(r.cimSchemaUrl)

    def configure(r):
        r.Configure("--enable-ssl --enable-pam")

    def makeinstall(r):
        r.MakeInstall()
        r.Install('sfcb.init-redhat', "%(initdir)s/sfcb", mode=0755)
        r.Environment("CIMSCHEMA_SOURCE", r.cimSchema)
        r.Environment("CIMSCHEMA_SUBDIRS", "yes")
        r.Run("sh getSchema.sh -f %(destdir)s%(datadir)s/sfcb")
        r.Install('%(localstatedir)s/lib/sfcb/stage/default.reg',
                  '%(localstatedir)s/lib/sfcb/registration/providerRegister')

        # Get rid of DESTDIR in sfcbrepos, it's confusing the file wrapper
        r.Copy("sfcbrepos", "sfcbrepos.local")
        r.Replace("\$\{DESTDIR\}", "", "sfcbrepos.local")
        # Use filewrap to make the script run in place
        r.Run("sh sfcbrepos.local -f", filewrap = True)

    def policy(r):
        r.ExcludeDirectories(exceptions="%(localstatedir)s/lib/sfcb/registration/repository/root/cimv2")
