#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kdecorepackage')
class kdeLibs(kdeCorePackageRecipe):

    name = 'kdelibs'
    version = '4.8.3'

    buildRequires = [
        'acl:devel', 'aspell:devel', 'attica:devel', 'attr:devel',
        'automoc:runtime', 'avahi-qt4:devel', 'avahi:devel', 'bison:runtime',
        'bzip2:devel', 'dbusmenu-qt', 'dbusmenu-qt:devel', 'enchant:devel',
        'flex:devel', 'flex:runtime', 'gamin:devel', 'giflib:devel',
        'icedtea-jre:runtime', 'ilmbase:devel', 'inputproto:devel',
        'jasper:devel', 'krb5:devel', 'libjpeg:devel', 'libstdc++:devel',
        'libXcursor:devel', 'libXfixes:devel', 'libXi:devel', 'libxml2:devel',
        'libxml2:runtime', 'libXpm:devel', 'libXScrnSaver:devel',
        'libxslt:devel', 'libXtst:devel', 'Mesa:devel', 'OpenEXR:devel',
        'openssl:devel', 'pcre:devel', 'perl:devel', 'perl:perl',
        'phonon:devel', 'polkit-qt-1:devel', 'PyQt4:python', 'python:devel',
        'qca2:devel', 'shared-desktop-ontologies:devellib',
        'shared-mime-info:runtime', 'sip:python', 'strigi:devel', 'udev:devel',
        'utempter:devel', 'bzr:runtime', 'cvs:runtime', 'dbus:devel', 'git:runtime', 'libXv:devel', 'libXxf86misc:devel', 'libxkbfile:devel', 'libxslt:runtime', 'mercurial:runtime', 'openssh:runtime', 'soprano:runtime', 'subversion:runtime', 'valgrind:runtime', 'xz:devel', 'xz:runtime']

    clearBuildReqs('kdelibs:devel', 'kdepimlibs:devel')

    def postUnpack(r):

        r.cmakeArgs += ' -DKAUTH_BACKEND=PolkitQt-1 -DHTML_INSTALL_DIR=%(docdir)s/HTML '

       # avoids a runtime dep in openssl:devellib
        r.addPatches('kdelibs-4.0.0-openssl.patch')

        r.addPatches(
            'kdelibs-4.5.80-parallel_devel.patch',
            'kdelibs-4.2.85-kde149705.patch',
            'kdelibs-4.3.90-install_all_css.patch',
            #'kdelibs-4.6.80-branding.patch',
            #'kdelibs-4.1.72-no-cache-kdeglobals-paths.patch',
            #'kdelibs-4.1.0-xdg-menu.patch',
            'kdelibs-4.8.0-libexecdir.patch',
            'kdelibs-4.6.90-kstandarddirs.patch',
            'kdelibs-4.1.70-cmake.patch',
            'kdelibs-4.5.80-no_rpath.patch',
            '0001-Add-an-API-currently-private-for-installing-missing-.patch',
            '0002-Trigger-installation-of-missing-components-when-inst.patch',
            '0003-Implement-automatic-scanning-of-source-code-for-requ.patch',
            'kdelibs-4.7.0-knewstuff2_gpg2.patch',
            'kdelibs-4.6.2-uri_mimetypes.patch',
            'kdelibs-4.7.4-SOLID_UPNP.patch',
            'kdelibs-4.7.2-kjs-s390.patch',
            #'kdelibs-4.8.0-cmake_cxx_implicit_link_directories.patch',
            'kdelibs-4.3.1-CVE-2009-2702.patch',
            'kdelibs-4.7.3-halectomy.patch',
            )

      #  r.Replace(
      #      '/opt/local/bin', '/usr/kerberos/bin', 'cmake/modules/FindGSSAPI.cmake'
      #  )

    def policy(r):

        # develtools that startkde uses
        # put it into :config b/c x86 and x86_64 kdelibs:lib must be co-installable
        r.ComponentSpec('config', '%(bindir)s/kde4-config')
        r.ComponentSpec('config', '%(bindir)s/buildsycoca4')

        develTools = [
            'checkXML', 'kconfig_compiler', 'kde4automoc', 'kunittestmodrunner',
            'makekdewidgets', 'meinproc4', 'nepomuk-rcgen', 'preparetips'
        ]
        for x in develTools:
            r.ComponentSpec('devel', '%(bindir)s/' + x)

        # common deps that must be installed:
        commonDeps = [
            'openssl:lib',
            'qca2-ossl:lib',
            'qca2:lib',
            'qimageblitz:lib'
        ]
        for package in commonDeps:
            r.Requires(package, '%(libdir)s/libkdecore.so.5')

