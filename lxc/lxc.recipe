#
# Copyright (c) 2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Lxc(AutoPackageRecipe):
    name = 'lxc'
    version = '0.6.0'

    buildRequires = [
        'docbook-utils:runtime',
        'opensp:runtime',
        'libcap:devel',
      ]

    def unpack(r):
        r.addArchive('http://lxc.sourceforge.net/download/lxc/')
        # rPL kernel headers are missing PR_CAPBSET_DROP due to age
        r.addPatch('lxc.oldkernelheaders.patch')
        # rPL glibc does not implement signalfd()
        r.addPatch('signalfd4.patch')
        # unfortunately, the configure option appears to have been
        # removed, on the unfortunate assumption that the build
        # kernel is always the deploy kernel.  Use a heavy hammer
        # to work around this
        r.Replace('NETWORK_DESTROY', '0', 'src/lxc/lxc_conf.c')

    def configure(r):
        # We are not necessarily building on the kernel we are
        # deploying on, so specify new kernel behavior for net devs
        # We will hope the configuration option comes back some day
        r.Configure('--disable-network-destroy')
