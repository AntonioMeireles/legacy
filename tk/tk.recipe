#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Tk(RPMPackageRecipe,CPackageRecipe):
    name = 'tk'
    version = '8.4.15'

    rpmUpVer = '8.4.13'
    rpmRelease = '3.fc6'
    externalArchive = 'mirror://sourceforge/tcl/%(name)s%(version)s-src.tar.gz'

    buildRequires = [ 'autoconf:runtime', 'tcl:devel', 'libX11:devel' ]

    rpmPatches = [ 'tk-8.4-no_rpath.patch',
                   'tk-8.4.13-autoconf.patch', ]

    def setup(r):
        RPMPackageRecipe.unpack(r)

        r.addPatch('tk-8.4.15-tclm4-soname.patch')

        r.Run('cd unix && autoconf')

        r.Configure(dir='unix')
        r.Make('TK_LIBRARY=%(datadir)s/%(name)s%(major_version)s', dir='unix')

        r.MakeInstall('INSTALL_ROOT=%(destdir)s'
                      ' TK_LIBRARY=%(datadir)s/%(name)s%(major_version)s',
                      dir='unix')
        r.Symlink('%(bindir)s/wish%(major_version)s', '%(bindir)s/wish')
        r.Symlink('%(libdir)s/lib%(name)s%(major_version)s.so',
                  '%(libdir)s/lib%(name)s.so')

        # backward compatible symlink for legacy tcl packages that hardcode
        # lib path to prefix/lib/%(name)s%(major_version)s
        r.Symlink('%(datadir)s/%(name)s%(major_version)s',
                  '%(prefix)s/%(lib)s/%(name)s%(major_version)s')

        # some really ugly header manipulation - required
        r.Run('''mkdir -p %(destdir)s/%(includedir)s/%(name)s-private/{generic,unix}
                 find generic unix -name "*.h" -exec cp -p '{}' %(destdir)s/%(includedir)s/%(name)s-private/'{}' ';'
                 ( cd %(destdir)s/%(includedir)s
                   for i in *.h ; do
                     [ -f %(destdir)s/%(includedir)s/%(name)s-private/generic/$i ] && ln -sf ../../$i %(destdir)s/%(includedir)s/%(name)s-private/generic ;
                   done
                 )''')

        r.Replace(('%(builddir)s/unix', '%(libdir)s'),
                  ('%(builddir)s', '%(includedir)s/%(name)s-private'),
                  '%(destdir)s/%(libdir)s/%(name)sConfig.sh')
        r.AutoDoc('changes', 'license.terms')
        r.Requires('tcl:devel', '%(includedir)s/tk.h')
        r.Requires('libX11:devel', '%(includedir)s/tk.h')
