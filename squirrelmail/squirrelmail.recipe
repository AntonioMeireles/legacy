#
# Copyright (c) 2004-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Squirrelmail(PackageRecipe):
    name = 'squirrelmail'
    version = '1.4.19'

    buildRequires = [ 'perl:runtime', 'perl:lib', 'perl:devel' ]

    def setup(r):
        r.macros.contentdir = '/var/www'
        r.macros.sqdir = '%(datadir)s/squirrelmail'

        r.addArchive('mirror://sourceforge/squirrelmail/')
        r.addSource('squirrelmail.conf')

        r.Run('echo "left_refresh=300" >> data/default_pref')

        for file in ('squirrelmail.cron', 'config.php.redhat'):
            r.Run("sed -i "
            " -e 's|__ATTDIR__|%%(localstatedir)s/spool/squirrelmail/attach|g'"
            " -e 's|__PREFSDIR__|%%(localstatedir)s/lib/squirrelmail/prefs|g'"
            " contrib/RPM/%s" % file)

        r.Run('sed -i'
              ' -e "s|^(\s*\\\$version\s*=\s*).*|\1\'%(version)s\';|g" '
              ' functions/strings.php')

        r.MakeDirs('%(sysconfdir)s/squirrelmail')
        r.MakeDirs('%(localstatedir)s/lib/squirrelmail/prefs', mode=0700)
        r.MakeDirs('%(localstatedir)s/spool/squirrelmail/attach', mode=0700)
        r.MakeDirs('%(sqdir)s')
        r.MakeDirs('%(contentdir)s/html')
        r.MakeDirs('%(sysconfdir)s/cron.daily')

        #copy over sub directories
        for file in ('class', 'functions', 'help', 'images',
                     'include', 'locale', 'src', 'themes',
                     'plugins'):
            r.Install(file, '%(sqdir)s/')


        #configuration files
        r.Install('data/default_pref',
                  '%(localstatedir)s/lib/squirrelmail/prefs')
        r.Install('config/*.php', '%(sqdir)s/config/', mode=0644)
        r.Install('config/*.pl', '%(sqdir)s/config/', mode=0755)
        r.Run('echo "">>contrib/RPM/config.php.redhat') #no newline
        r.Install('contrib/RPM/config.php.redhat',
                  '%(sysconfdir)s/squirrelmail/config.php')
        r.Install('index.php', '%(sqdir)s/', mode=0644)

        r.Install('contrib/RPM/squirrelmail.cron', '%(sysconfdir)s/cron.daily/')
        r.Install('squirrelmail.conf', '%(sysconfdir)s/httpd/conf.d/')
        r.Symlink('%(sysconfdir)s/squirrelmail/config.php',
                  '%(sqdir)s/config/config.php')
        #Deal with documentation
        r.Move('%(sqdir)s/plugins/squirrelspell/doc/*',
               '%(thisdocdir)s/plugins/squirrelspell/')
        r.Move('%(sqdir)s/themes/README.themes', '%(thisdocdir)s/')
        r.AutoDoc('doc/*')

        #Random removal
        r.Remove('%(sqdir)s/plugins/make_archive.pl')

        r.SetModes('%(sysconfdir)s/cron.daily/squirrelmail.cron', 0755)
        r.SetModes('%(sysconfdir)s/squirrelmail/config.php', 0640)

        r.Ownership('apache', 'apache',
                    '%(localstatedir)s/lib/squirrelmail/',
                    '%(localstatedir)s/spool/squirrelmail/attach')
        r.Ownership('root', 'apache',
                    '%(sysconfdir)s/squirrelmail/config.php')

        r.ComponentSpec('locale', '%(sqdir)s/locale/.*')

        r.Requires('php:runtime', '%(sqdir)s/.*\.php')
        # Multiple MTAs can provide the /usr/sbin/sendmail interface
        r.Requires('file: %(sbindir)s/sendmail', '%(sqdir)s/index.php')

        r.Requires('aspell:runtime', '%(sqdir)s/index.php')
        r.Requires('httpd:runtime', '%(sysconfdir)s/httpd/httpd.conf')
        r.Requires('tmpwatch:runtime', '%(sysconfdir)s/cron.daily/.*')
        r.Requires('crontabs:runtime', '%(sysconfdir)s/cron.daily/.*')
