class MPlayer(AutoPackageRecipe):

    name = 'mplayer'
    version = '1.0_rc3+29787'

    buildRequires = [
        'alsa-lib:devel', 'atk:devel', 'audiofile:devel', 'cairo:devel',
        'cdparanoia:devel', 'desktop-file-utils:runtime', 'DirectFB:lib-core',
        'esound:devel', 'expat:devel', 'faac:devel', 'fontconfig:devel',
        'freetype:devel', 'fribidi:devel', 'giflib:devel', 'glib:devel',
        'gtk:devel', 'jack:devel', 'lame:devel', 'libdv:devel',
        'libdvdnav:devel', 'libjpeg:devel', 'libmad:devel', 'libmpcdec:devel',
        'libogg:devel', 'libpng:devel', 'libtermcap:devel', 'libtheora:devel',
        'libvorbis:devel', 'libX11:devel', 'libXext:devel', 'libXinerama:devel',
        'libXrender:devel', 'libXScrnSaver:devel', 'libXt:devel', 'libXv:devel',
        'libXvMC:devel', 'libXxf86dga:devel', 'libXxf86vm:devel', 'lzo:devel',
        'Mesa:devel', 'ncurses:devel', 'pango:devel', 'pcre:devel',
        'pkgconfig:devel', 'pulseaudio:devel', 'samba:devel', 'SDL:devel',
        'speex:devel', 'x264:devel', 'zlib:devel', 'libavcodec:devel'
    ]
    # for CVS snaps, also need libavcodec:devel

    Flags.generic = True
    Flags.generic.setShortDoc('build a version to run everywhere')

    def unpack(r):

        mytag = r.version.split('+')[1].lstrip('r')
        r.addSvnSnapshot('svn://svn.mplayerhq.hu/mplayer/trunk', revision=mytag)

        r.Replace('svn_revision=.*$', 'svn_revision='+mytag, 'version.sh')

        r.addArchive(
            'http://www.mplayerhq.hu/MPlayer/skins/Blue-1.7.tar.bz2',
            dir='%(datadir)s/mplayer/skins/'
        )

    def configure(r):

        r.macros.codecsdir = '%(libdir)s/mplayer-codecs'
        if Arch.x86_64:
            r.macros.archenv = 'host_arch=x86_64  proc=x86_64  iproc=x86_64'
        else:
            r.macros.archenv = 'host_arch=i386  proc=i686  iproc=686'

        r.macros.cflags = ''
        r.macros.cxxflags = ''

        # mplayer's configure script does not accept a number of standard
        # configure arguments...
        r.ManualConfigure(
            ' --prefix=%(prefix)s'
            ' --confdir=%(sysconfdir)s/mplayer '
            ' --libdir=%(libdir)s'
            ' --codecsdir=%(codecsdir)s'
            ' --win32codecsdir=%(codecsdir)s'
            ' --xanimcodecsdir=%(codecsdir)s'
            ' --realcodecsdir=%(codecsdir)s'
            ' --enable-gui'
            ' --enable-largefiles'
            ' --enable-joystick'
            ' --enable-menu'
            ' --enable-dynamic-plugins'
            ' --language=all'
            ' --enable-runtime-cpudetection'
            ' --enable-xvmc'
            ' --with-xvmclib=XvMCW'
            #' --with-extralibdir=%(libdir)s/xorg.mesa.3d'
            '', preConfigure='%(archenv)s'
        )

    def policy(r):
        # in order for gmplayer to behave...
        r.Symlink('%(datadir)s/mplayer/skins/Blue',
                  '%(datadir)s/mplayer/skins/default')
        r.Install('etc/codecs.conf', '%(sysconfdir)s/mplayer/')
        r.Requires('mplayer-codecs:lib', '%(bindir)s/mplayer')

        # Default font for OSD
        r.Requires('bitstream-vera-fonts:data', '%(bindir)s/mplayer')
        r.DanglingSymlinks(exceptions='%(datadir)s/mplayer/subfont.ttf')
        r.Symlink('%(datadir)s/fonts/bitstream-vera/Vera.ttf', '%(datadir)s/mplayer/subfont.ttf')

