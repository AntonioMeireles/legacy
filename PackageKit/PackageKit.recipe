#
# Copyright (c) 2007-2010 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Packagekit(AutoPackageRecipe):
    name = 'PackageKit'
    version = '0.5.7'

    buildRequires =  [
        'atk:devel',
        'autoconf:data',
        'autoconf:runtime',
        'automake:runtime',
        'cairo:devel',
        'cElementTree:python',
        'ConsoleKit:runtime',
        'dbus:devel',
        'dbus-glib:devel',
        'dbus-glib:runtime',
        'dbus-python:python',
        'fontconfig:devel',
        'freetype:devel',
        'gettext:runtime',
        'glib:devel',
        'gtk-doc:devel',
        'gtk-doc:runtime',
        'gtk:devel',
        'intltool:runtime',
        'libtool:runtime',
        'libxslt:runtime',
        'NetworkManager:devel',
        'pango:devel',
        'pkgconfig:devel',
        'polkit:devel',
        'pygobject:python',
        'python:bin',
        'python:devel',
        'shared-mime-info:runtime',
        'sqlite:devel',
]


    def unpack(r):
        #r.addArchive('http://www.packagekit.org/releases/')
        r.addArchive('http://github.com/smerp/PackageKit/tarball/master')
        #r.addGitSnapshot("git@github.com:smerp/PackageKit.git")
        # this patch make gnome-packagekit works again
        #r.addPatch('packagekit_simulate.diff')
        r.addSource('pk.tmpwatch', dest='%(sysconfdir)s/cron.daily/PKConaryCache')
        r.Replace('ScanDesktopFiles=true', 'ScanDesktopFiles=false', 'etc/PackageKit.conf.in')
        r.Replace('UpdatePackageList=true', 'UpdatePackageList=false', 'etc/PackageKit.conf.in')
        r.Replace('UpdateCheckProcesses=true', 'UpdateCheckProcesses=false', 'etc/PackageKit.conf.in')
        r.Replace("CheckTestingRepos=true",'CheckTestingRepos=false',"etc/PackageKit.conf.in")
        r.Replace("UseUpdateCache=true","UseUpdateCache=false","etc/PackageKit.conf.in")
        r.Replace('auth_admin_keep', 'auth_self_keep', 'policy/org.freedesktop.packagekit.policy.in')

    def configure(r):
        r.Run("autogen.sh")
        r.Configure(' --disable-qt ' \
                    ' --disable-local ' \
                    ' --with-default-backend=conary ' \
                    ' --enable-conary ' \
                    ' --disable-dummy ' \
                    ' --with-security-framework=polkit ' \
                    ' --disable-gtk-doc ' \
                    ' --enable-browser-plugin ' \
                    ' --disable-gstreamer-plugin ' \
#                    ' --disable-ruck ' \
                    ' --enable-command-not-found ' \
                    ' --enable-gtk-module ' \
                    ' --disable-strict ' \
                    ' --disable-device-rebind ' \
                    ' --disable-cron ' \
                    ' --disable-pm-utils ' \
                    ' --enable-introspection=no ' \
                    ' --disable-service-packs ' \
                    ' --disable-managed ' 
#                    ' --disable-gudev '
                )

    def policy(r):

        # for command-not-found
        r.Remove('%(localstatedir)s/lib/PackageKit/*', allowNoMatch=True)
        #r.Remove('%(sysconfdir)s/dbus-1/system.d/org.freedesktop.PackageKitTestBackend.conf',
         #   "%(sysconfdir)s/etc/dbus-1/system.d/org.freedesktop.PackageKitAptBackend.conf")
        r.Remove("%(datadir)s/%(name)s/website/",recursive=True, allowNoMatch=True)
        r.Remove('%(localstatedir)s/db/PackageKit/transactions.db', allowNoMatch=True)
        r.Remove("%(localstatedir)s/cache/conary/job/")
        r.Remove("%(localstatedir)s/cache/conary/xmlrepo/")
        r.MakeDirs('%(localstatedir)s/db/PackageKit/')
        r.MakeDirs('%(localstatedir)s/cache/PackageKit/downloads')
        r.MakeDirs('%(localstatedir)s/run/PackageKit/udev')
        r.ExcludeDirectories(exceptions=['%(localstatedir)s/db/PackageKit',
                '%(localstatedir)s/cache/PackageKit/downloads',
                '%(localstatedir)s/lib/PackageKit',
                '%(localstatedir)s/run/PackageKit/udev'])
        r.Requires("elementtree:python","/usr/sbin/packagekitd")

        # PackageSpec
        r.SetModes("%(sysconfdir)s/profile.d/PackageKit.sh",0755)
        r.PackageSpec("PackageKit-command-not-found","%(sysconfdir)s/%(name)s/CommandNotFound.conf|%(sysconfdir)s/profile.d/*|%(libexecdir)s/pk-command-not-found")
        r.PackageSpec("PackageKit-browser-plugin","%(libdir)s/mozilla/plugins/packagekit-plugin.so")
        r.PackageSpec("PackageKit-gtk-module","%(libdir)s/gtk-2.0/modules/libpk-gtk-module.so")

