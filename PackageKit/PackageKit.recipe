#
# Copyright (c) 2007 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Packagekit(AutoPackageRecipe):
    name = 'PackageKit'
    version = '0.3.11'

    buildRequires = ['NetworkManager:devel', 'PolicyKit:devel', 'PolicyKit:runtime', 'dbus-glib:devel', 'dbus:devel', 'docbook-utils:runtime', 'glib:devel', 'libstdc++:devel', 'pkgconfig:devel', 'python-sqlite:python', 'libtool:runtime', 'dbus-glib:runtime', 'sqlite:devel', 'xmlto:runtime', 'dbus-python:python', 'pygobject:python', 'opensp:runtime', 'python:devel', 'gettext:runtime', 'intltool:runtime', 'libxslt:runtime', 'gtk-doc:runtime', 'atk:devel', 'cairo:devel', 'expat:devel', 'fontconfig:devel', 'freetype:devel', 'gtk:devel', 'libX11:devel', 'libXrender:devel', 'libpng:devel', 'libxcb:devel', 'pango:devel', 'pixman:devel', 'shared-mime-info:config', 'xcb-util:devel', 'zlib:devel', 'gstreamer:devel', 'libxml2:devel', 'xulrunner:devel']

    def unpack(r):
        r.addArchive('http://www.packagekit.org/releases/')
        #r.addArchive('%(name)s-%(version)s.tar.gz')
        #r.addGitSnapshot('git://anongit.freedesktop.org/git/packagekit')
        #r.Run('NONCONFIGURE=yes ./autogen.sh')
        r.addPatch('distro-id.patch')
        r.addSource('pk.tmpwatch', dest='%(sysconfdir)s/cron.daily/PKConaryCache')
        r.Replace('ScanDesktopFiles=true', 'ScanDesktopFiles=false', 'etc/PackageKit.conf.in')
        r.Replace('UpdatePackageList=true', 'UpdatePackageList=false', 'etc/PackageKit.conf.in')
        r.Replace('UpdateCheckProcesses=true', 'UpdateCheckProcesses=false', 'etc/PackageKit.conf.in')

    def configure(r):
        r.Configure('--with-default-backend=conary --enable-conary --disable-dummy --with-security-framework=polkit --disable-gtk-doc --disable-qt  --enable-browser-plugin --disable-gstreamer-plugin')
        r.Replace('-Werror','','contrib/packagekit-plugin/Makefile')

    def policy(r):
        r.Remove('%(localstatedir)s/lib/PackageKit/*', allowNoMatch=True)
        r.Remove('%(localstatedir)s/db/PackageKit/transactions.db', allowNoMatch=True)
        r.MakeDirs('%(localstatedir)s/db/PackageKit/')
        r.MakeDirs('%(localstatedir)s/cache/PackageKit/downloads')
        r.MakeDirs('%(localstatedir)s/run/PackageKit/udev')
        r.ExcludeDirectories(exceptions=['%(localstatedir)s/db/PackageKit',
                '%(localstatedir)s/cache/PackageKit/downloads',
                '%(localstatedir)s/lib/PackageKit',
                '%(localstatedir)s/run/PackageKit/udev'])
        r.SetModes('%(prefix)s/libexec/PackageKitDbusTest.py', 0755)
        r.SetModes('%(sysconfdir)s/cron.daily/packagekit-background.cron', 0755)
        r.Remove('%(sysconfdir)s/cron.daily/packagekit-background.cron')
