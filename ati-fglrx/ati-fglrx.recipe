
class AtiFglrx(BuildPackageRecipe):

    buildRequires = [ 'glibc:devel', 'gtk:runtime', 'libX11:devel', 
                      'libXext:devel', 'libXrandr:devel', 'libXrender:devel', 'libgcc:devellib', 
                      'libstdc++:devel', 'chkconfig:runtime', 'Mesa', 'elfutils:runtime', 'binutils:runtime', 
                      'fontconfig:devel', 'freetype:devel', 'libICE:devel', 'libSM:devel', 'libXcursor:devel', 'libXi:devel']

    name = 'ati-fglrx'
    version = '8.3'


    # https://a248.e.akamai.net/f/674/9206/0/www2.ati.com/drivers/linux/64bit/ati-driver-installer-8-3-x86.x86_64.run


    def setup(r):
        r.macros.version = r.version.replace('.', '-')

        if Arch.x86_64:
            r.macros.lib32 = '/usr/lib'
            r.FixupMultilibPaths(exceptions='.*')

        r.addSource('https://a248.e.akamai.net/f/674/9206/0/www2.ati.com/drivers/linux/ati-driver-installer-%(version)s-x86.x86_64.run')
        r.Run('sh ./ati-driver-installer-%(version)s-x86.x86_64.run --extract archive_files')

        if Arch.x86_64:
            r.Copy('archive_files/arch/x86_64/*', 'src/')
            r.Copy('archive_files/x710_64a/*', 'src/')
        else:
            r.Copy('archive_files/arch/x86/*', 'src/')
            r.Copy('archive_files/x710/*', 'src/')

        r.Copy('archive_files/common/*', 'src/')
        r.Move('src/usr/X11R6/bin/*','src/usr/bin/')
        r.Move('src/usr/X11R6/%(lib)s/modules/dri/','src/usr/%(lib)s/dri/updates/')
        r.Move('src/usr/X11R6/%(lib)s/modules/*','src/usr/%(lib)s/xorg/modules/updates/')
        r.Move('src/usr/X11R6/%(lib)s/*','src/usr/%(lib)s/')
        r.Move('src/usr/X11R6/include/X11','src/usr/include/')

        #        del r.AutoDoc

        r.Install('src/usr', '%(destdir)s')
        r.Install('src/etc', '%(destdir)s')

        r.Move('%(libdir)s/lib*', '%(libdir)s/xorg.fglrx.3d/')

        if Arch.x86_64:
            r.Move('archive_files/arch/x86/usr/X11R6/lib/modules/dri/*','/usr/lib/dri/updates/')
            r.Copy('archive_files/arch/x86/usr/X11R6/lib/*', '%(lib32)s/xorg.fglrx.3d/')

        r.SharedLibrary(subtrees='%(libdir)s/xorg/modules/updates/')
        r.SharedLibrary(subtrees='%(libdir)s/xorg/modules/updates/extensions/')
        r.SharedLibrary(subtrees='%(libdir)s/xorg/modules/updates/drivers/')

        r.SharedLibrary(subtrees='%(libdir)s/xorg.fglrx.3d')

        if Arch.x86_64:
            r.SharedLibrary(subtrees='%(lib32)s/xorg.fglrx.3d')

        r.addSource('atieventsd.init')
        r.Install('atieventsd.init', '%(initdir)s/atieventsd')

        r.InitialContents('%(sysconfdir)s/ati/.*')


        # The kernel side is in nvidia-kernel, and we need the kernel
        # modules that match this version exactly
        r.Requires('ati-fglrx-kernel:runtime(%(version)s)', 
                   '%(libdir)s/dri/updates/fglrx_dri.so')

        # We want to make sure that the kernel module can require the
        # matching userspace code
        r.ComponentProvides('%(version)s')

