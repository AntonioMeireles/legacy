#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Utillinux(CPackageRecipe):
    name = 'util-linux'
    version = '2.13_pre7'

    buildRequires = [ 'e2fsprogs:devel', 'install-info:runtime',
        'libtermcap:devel', 'ncurses:devel', 'slang:devel', 'gettext:devel',
        'texinfo:runtime', 'zlib:devel', 'audit:devel', 'perl:runtime',
        'perl:lib', 'automake:runtime', 'autoconf:runtime', 'pam:devel',
        'userspace-kernel-headers:devel', 'gettext:runtime', ]

    def setup(r):
        r.macros.upver = r.version.replace('_', '-')
        srpm = 'http://download.fedora.redhat.com/pub/fedora/linux/core/development/source/SRPMS/util-linux-2.13-0.48.fc7.src.rpm'
        r.addArchive('util-linux-%(upver)s.tar.bz2', rpm=srpm)

        r.addSource('util-linux-login.pamd', dest='%(sysconfdir)s/pam.d/login')
        r.addSource('util-linux-remote.pamd', dest='%(sysconfdir)s/pam.d/remote')
        r.addSource('util-linux-chsh-chfn.pamd', rpm=srpm, dest='%(sysconfdir)s/pam.d/chsh-chfn')

        r.addSource('nologin.c', rpm=srpm)
        r.addSource('nologin.8', rpm=srpm)

        r.addSource('mkinstalldirs')

        rpmPatches = ('util-linux-2.13-moretc.patch',
            'util-linux-2.12a-partlimit.patch',
            'util-linux-2.11f-rawman.patch',
            'util-linux-2.12j-managed.patch',
            'util-linux-2.12p-swaponsymlink-57300.patch',
            'util-linux-2.11y-procpartitions-37436.patch',
            'util-linux-2.13-ctty3.patch',
            'util-linux-2.11y-skipraid2.patch',
            'util-linux-2.11y-multibyte.patch',
            'util-linux-2.12a-ipcs-84243-86285.patch',
            'util-linux-2.11y-chsh-103004.patch',
            'util-linux-2.12a-126572-fdiskman.patch',
            #'floppy-0.12-locale.patch',
            'util-linux-2.12a-mountbylabel-dm.patch',
            'util-linux-2.12a-16415-rdevman.patch',
            'util-linux-2.12a-pamstart.patch',
            'util-linux-2.12j-pamconsole.patch',
            'raw-handle-nonpresent-devs.patch',
            'util-linux-2.12j-113790-hotkeys.patch',
            'util-linux-2.13-mount-man-nfs4.patch',
            'util-linux-2.12p-login-lastlog.patch',
            'util-linux-2.12p-mtab-lock.patch',
            'util-linux-2.12p-ipcs-typo.patch',
            'util-linux-2.12a-pamsession.patch',
            'util-linux-2.12p-lvm2dupes-76467.patch',
            'util-linux-2.12p-fdformat-ide.patch',
            'util-linux-2.12p-fstab-man.patch',
            'util-linux-2.12p-look-separator.patch',
            'util-linux-2.12p-vipw-perm.patch',
            'util-linux-2.13-audit-hwclock.patch',
            'util-linux-2.13-fdisk-gpt.patch',
            'util-linux-2.12p-mount-ocfs2.patch',
            'util-linux-2.12p-execl.patch',
            'util-linux-2.13-arch.patch',
            'util-linux-2.13-swapon-suspend.patch',
            'util-linux-2.13-mount-man-nfs.patch',
            #'util-linux-2.12p-floppy-generic.patch',
            'util-linux-2.13-login-hang.patch',
            'util-linux-2.13-losetup-all.patch',
            'util-linux-2.13-audit-login.patch',
            'util-linux-2.13-ipcs-shmax.patch',
            'util-linux-2.13-cramfs-maxentries.patch',
            'util-linux-2.13-cramfs-zerofiles.patch',
            'util-linux-2.12a-mount-man-cifs.patch',
            'util-linux-2.12p-cal-wide.patch',
            'util-linux-2.12p-col-EILSEQ.patch',
            'util-linux-2.13-mount-twiceloop.patch',
            'util-linux-2.13-rmparts.patch',
            #'util-linux-2.13-mkswap-selinux.patch',
            'util-linux-2.13-schedutils-man.patch',
            'util-linux-2.13-login-pam-acct.patch',
            'util-linux-2.13-umount-sysfs.patch',
            'util-linux-2.13-mount-uuid.patch',
            'util-linux-2.13-cal-wide.patch',
            'util-linux-2.13-mount-context.patch',
            'util-linux-2.13-mount-man-bugs.patch',
            'util-linux-2.13-hexdump-gcc.patch',
            'util-linux-2.13-mount-move.patch',
            'util-linux-2.13-mount-subtree.patch',
            'util-linux-2.13-fdisk-sectors.patch',
            'util-linux-2.13-fdisk-isfull.patch',
            'util-linux-2.12a-raw-man-dd.patch',
            'util-linux-2.13-swap-page.patch',
            'util-linux-2.13-login-ipv6.patch',
            'util-linux-2.13-login-timeval.patch',
            'util-linux-2.13-ctrlaltdel-man.patch',
            'util-linux-2.13-mount-sloppy.patch',
            'util-linux-2.13-mount-uhelper.patch',
            'util-linux-2.13-mount-nonfs.patch',
            'util-linux-2.13-losetup-deprecated.patch',
            'util-linux-2.13-mkswap-mounted.patch',
            )

        for x in rpmPatches:
            r.addPatch(x, rpm=srpm)

        r.addPatch('po_Makefile.in.in.mkinstalldirs')

        # RPL-1757 CVE-unassigned
        r.addPatch('2007-09-20-mount-umount-drop-privs.patch', level=1)

        r.addPatch('util-linux-enable-cramfs-extraction.patch', level=1) # RPL-2956

        r.Replace('/usr/spool/mail', '%(servicedir)s/spool/mail',
                  'login-utils/login.1')

        r.Automake(autoMakeArgs='-a')
        # note: we disable tty group (USE_TTY_GROUP) in Makefiles to prevent call chgrp
        # during the "make install". But we define -DUSE_TTY_GROUP that enable tty groups in
        # *.c files only.
        r.macros.cflags += ' -DUSE_TTY_GROUP'
        r.ManualConfigure('--prefix="" '
                          '--sysconfdir=%(sysconfdir)s '
                          '--datadir=%(datadir)s '
                          '--includedir=%(includedir)s '
                          '--libdir=%(libdir)s '
                          '--libexecdir=%(libexecdir)s '
                          '--localstatedir=%(localstatedir)s '
                          '--sharedstatedir=%(sharedstatedir)s '
                          '--mandir=%(mandir)s '
                          '--infodir=%(infodir)s '
                          '--disable-use-tty-group '
                          '--disable-wall '
                          '--enable-partx '
                          '--enable-login-utils '
                          '--enable-kill '
                          '--enable-raw '
                          '--enable-write')
        # note: we install to /bin and /usr/bin, so there's $bindir and $usrbindir in
        # util-linux build system. It's better follow package build-system than recipe
        # macros (where is prefix=/usr)
        r.Make(
            'OPT="%(cflags)s -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64"'
            'LDFLAGS="%(ldflags)s" HAVE_PIVOT_ROOT=yes')

        r.Run('gcc %(cflags)s -o nologin nologin.c')
        r.Run('cd sys-utils; makeinfo --number-sections ipc.texi')
        r.MakeInstall(preMake='INSTALLDIR="install -d -m 755"'
                              ' INSTALLSUID="install -m 755"'
                              ' INSTALLBIN="install -m 755"'
                              ' INSTALLMAN="install -m 644"'
                              ' MKINSTALLDIRS=%(builddir)s/mkinstalldirs')
        r.Install('mount/pivot_root', '%(essentialsbindir)s/', mode=0755)
        r.Install('mount/pivot_root.8', '%(mandir)s/man8/', mode=0644)
        r.Install('nologin', '%(essentialsbindir)s/', mode=0755)
        r.Install('nologin.8', '%(mandir)s/man8/', mode=0644)
        r.Symlink('raw.8', '%(mandir)s/man8/rawdevices.8')
        r.Symlink('%(essentialsbindir)s/clock', '%(sbindir)s/clock'),
        r.Symlink('hwclock', '%(essentialsbindir)s/clock'),
        r.Symlink('%(essentialbindir)s/kill', '%(bindir)s/kill'),

        # A few su/gid programs
        r.SetModes('%(bindir)s/{ch{fn,sh},newgrp}', 04755)
        r.SetModes('%(bindir)s/write', 02755)
        r.SetModes('%(essentialbindir)s/{mount,umount}', 04755)
        # maked "deprecated"
        r.Remove('%(bindir)s/{pg,line}', '%(mandir)s/man1/{pg,line}.1')
        # conflicts with schedutils
        r.Remove('/usr/bin/{chrt,taskset}')
        # mkcramfs link needed for anaconda:
        r.Symlink('%(essentialsbindir)s/mkfs.cramfs', '%(bindir)s/mkcramfs')

        r.Requires(exceptions='%(datadir)s/misc/getopt/.*')
        r.TagSpec('shell', '%(essentialsbindir)s/nologin')

        r.ComponentSpec('perl', '%(bindir)s/(scriptreplay|chkdupexe)')

        # RPL-1178
        for x in ('ddate', 'ctrlaltdel',):
            r.RemoveNonPackageFiles('.*%s.*'%x)
        for x in ('ul', 'cfdisk', 'setfdperm', 'isosize', 'minix', 'bfs',
                  'write', 'tailf',):
            r.PackageSpec('util-linux-extras', '.*%s.*'%x)
