#
# Copyright (c) 2004 Specifix, Inc.
# All rights reserved
#

class Utillinux(PackageRecipe):
    buildRequires = [ ]

    if Use.pam:
        buildRequires.append('pam:devel')
    if Use.slang:
        buildRequires.append('slang:devel')

    name = "util-linux"
    version = "2.11y"
    
    def setup(r):
	r.addArchive("http://ftp.kernel.org/pub/linux/utils/util-linux/util-linux-%(version)s.tar.bz2", keyid='517D0F0E')
	r.addSource('util-linux-2.7-login.pamd')
	r.addSource('util-linux-2.7-chfn.pamd')
	r.addSource('util-linux-2.7-chsh.pamd')
	r.addSource('mkcramfs.c')
	r.addSource('cramfs.h')
	r.addSource('nologin.c')
	r.addSource('nologin.8')
	# Red Hat has a LOT of patches.  In order to be compatible with
	# Red Hat, we'll include the same basic set.  Appropriate comments
	# have also been copied.

	# Changes to MCONFIG build-time configuration
	r.addPatch('util-linux-2.11y-rhconfig.patch')
	# Don't install the chkdupexe perl script
	r.addPatch('util-linux-2.11r-nochkdupexe.patch')
	# This patch is here because gafton put it here five years ago
	r.addPatch('util-linux-2.11a-gecossize.patch')

	r.addPatch('util-linux-2.11n-mount.patch')

	# Helps allow building/installing as non-root
	r.addPatch('util-linux-2.9v-nonroot.patch')

	# Force 'more' to link against libtermcap so that we don't have a
	# /bin binary depending on a /usr/lib library (ncurses)
	r.addPatch('util-linux-2.11w-moretc.patch')

	# 1. Reduce MAX_PARTS to 16 (upstream reasonably won't take it)
	#     XXX probably want to change this if compatibility not issue?
	# 2. Use O_LARGEFILE (I have no idea whether this has any effect given
	#    -D_FILE_OFFSET_BITS=64)
	# 3. Use the standard syscall() function instead of some bad hacks.
	r.addPatch('util-linux-2.11r-miscfixes.patch')

	# we use RH's mkcramfs, because the copyright/license is unclear
	r.addPatch('mkcramfs.patch')
	r.addPatch('mkcramfs-quiet.patch')
	r.addPatch('util-linux-2.11n-mkcramfs-pgsize.patch')

	# Note on how to set up raw device mappings using RHL /etc/sysconfig/rawdevices
	r.addPatch('util-linux-2.11f-rawman.patch')

	######## Patches that should be upstream eventually
	r.addPatch('mount-2.10r-kudzu.patch')

	r.addPatch('util-linux-2.11r-ownerumount.patch')
	r.addPatch('util-linux-2.11w-swaponsymlink-57300.patch')
	r.addPatch('util-linux-2.11y-procpartitions-37436.patch')
	r.addPatch('util-linux-2.11r-ctty3.patch')
	r.addPatch('util-linux-2.11n-loginutmp-66950.patch')
	r.addPatch('util-linux-2.11y-moremisc.patch')

	r.addPatch('util-linux-2.11y-skipraid2.patch')

	r.addPatch('util-linux-2.11y-blkgetsize-81069.patch')
	r.addPatch('util-linux-2.11y-umount-75421.patch')
	r.addPatch('util-linux-2.11y-umask-82552.patch')
	r.addPatch('util-linux-2.11y-multibyte.patch')
	r.addPatch('util-linux-2.11y-mcookie-83345.patch')
	r.addPatch('util-linux-2.11y-ipcs-84243-86285.patch')

	# Fixs wrong usage of BLKGETSIZE in mount_by_label
	r.addPatch('util-linux-2.11y-s390x.patch')
	r.addPatch('util-linux-2.11y-login-32bit-lastlog-88574.patch')
	r.addPatch('util-linux-2.11y-sysmap-85407.patch')
	r.addPatch('util-linux-2.11y-mount-97381.patch')
	r.addPatch('util-linux-2.11y-partx-68284.patch')
	r.addPatch('util-linux-2.11y-readprofile-100433.patch')
	r.addPatch('util-linux-2.11y-urandom.patch')
	r.addPatch('util-linux-2.11y-idecd-102114.patch')
	r.addPatch('util-linux-2.11y-chsh-103004.patch')
	r.addPatch('util-linux-2.11y-fdisksegv-103954.patch')
	r.addPatch('util-linux-2.11y-alldevs-101772.patch')



	r.Run("sed -i 's:^MAN_DIR=.*:MAN_DIR=%(mandir)s:; s:^INFO_DIR=.*:INFO_DIR=%(infodir)s:' MCONFIG")
	if not Use.pam:
	    r.Run("sed -i 's:^HAVE_PAM=.*:HAVE_PAM=no:' MCONFIG")
	if not Use.slang:
	    r.Run("sed -i 's:^HAVE_SLANG=.*:HAVE_SLANG=no:' MCONFIG")
	r.Run("sed -i 's:/usr/spool/mail:/var/spool/mail:g' login-utils/login.1")
	r.Configure()
	r.Make('-C mount loop.h')
	r.Make(
	    'OPT="%(cflags)s -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64"'
	    ' LDFLAGS='
	    ' HAVE_PIVOT_ROOT=yes'
	)
	r.Make('CFLAGS="%(cflags)s" LDFLAGS= -C partx')
	r.Run('cd rescuept; gcc %(cflags)s -o rescuept rescuept.c')
	r.Run('gcc %(cflags)s -o mkcramfs mkcramfs.c -I. -lz')
	r.Run('gcc %(cflags)s -o nologin nologin.c')
	r.Run('cd sys-utils; makeinfo --number-sections ipc.texi')
	r.MakeInstall(preMake='INSTALLDIR="install -d -m 755"'
        	                 ' INSTALLSUID="install -m 755"'
        	                 ' INSTALLBIN="install -m 755"'
        	                 ' INSTALLMAN="install -m 644"')
	r.Install('mount/pivot_root', '%(essentialsbindir)s/', mode=0755)
	r.Install('mount/pivot_root.8', '%(mandir)s/man8/', mode=0644)
	r.Install('rescuept/rescuept', '%(essentialsbindir)s/', mode=0755)
	r.Run('mv rescuept/README README.rescuept')
	r.Install('mkcramfs', '%(bindir)s/', mode=0755)
	r.Install('nologin', '%(essentialsbindir)s/', mode=0755)
	r.Install('nologin.8', '%(mandir)s/man8/', mode=0644)
	r.Symlink('raw.8', '%(mandir)s/man8/rawdevices.8')
	r.Install('partx/{{add,del}part,partx}', '%(essentialsbindir)s/',
		  mode=0555)
	r.Install('util-linux-2.7-login.pamd', '%(sysconfdir)s/pam.d/login',
		  mode=0644)
	r.Install('util-linux-2.7-chsh.pamd', '%(sysconfdir)s/pam.d/chsh',
		  mode=0644)
	r.Install('util-linux-2.7-chfn.pamd', '%(sysconfdir)s/pam.d/chfn',
		  mode=0644)
	r.Symlink('%(essentialsbindir)s/hwclock', '%(sbindir)s/hwclock'),
	r.Symlink('%(essentialsbindir)s/clock', '%(sbindir)s/clock'),
	r.Symlink('hwclock', '/%(essentialsbindir)s/clock'),
	# example files should not generate dependencies
	# XXX this should be an exception pasted onto the dependency policy!
	r.Run('chmod 644 %(destdir)s/%(datadir)s/misc/getopt/*')
	r.Install('text-utils/more.help', '%(datadir)s/misc/', mode=0644)
	# A few su/gid programs
	r.SetModes('%(bindir)s/{ch{fn,sh},newgrp}', 04755)
	r.SetModes('%(bindir)s/write', 02755)
	r.SetModes('%(essentialbindir)s/{mount,umount}', 04755)
	r.Remove(
	    '/sbin/mkfs.bfs',
	    '%(mandir)s/man8/mkfs.bfs.8',
	    '/sbin/sln',
	    '%(mandir)s/man8/sln.8',
	    '%(bindir)s/pg',
	    '%(mandir)s/man1/pg.1',
	    '%(bindir)s/line',
	    '%(mandir)s/man1/line.1',
	)
	r.Doc('*/README.*')
	r.TagSpec('shell', '%(essentialsbindir)s/nologin')
