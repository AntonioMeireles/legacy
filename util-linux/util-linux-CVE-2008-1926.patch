--- login-utils/login.c.orig	2009-11-03 14:27:06.000000000 -0500
+++ login-utils/login.c		2009-11-03 14:25:54.000000000 -0500
@@ -306,6 +306,25 @@
 }
 #endif  /* HAVE_SECURITY_PAM_MISC_H */
 
+static void
+logaudit(const char *tty, const char *username, const char *hostname,
+                                        struct passwd *pwd, int status)
+{
+        int audit_fd;
+
+        audit_fd = audit_open();
+        if (audit_fd == -1)
+                return;
+        if (!pwd && username)
+                pwd = getpwnam(username);
+
+	audit_log_acct_message(audit_fd, AUDIT_USER_LOGIN,
+		NULL, "login", username ? username : "(unknown)",
+		pwd ? pwd->pw_uid : -1, hostname, NULL, tty, status);
+
+        close(audit_fd);
+}
+
 int
 main(int argc, char **argv)
 {
@@ -571,24 +590,12 @@
 	       (retcode == PAM_CRED_INSUFFICIENT) ||
 	       (retcode == PAM_AUTHINFO_UNAVAIL))) {
 	    struct passwd *pw;
-	    char buf[64];
 	    pam_get_item(pamh, PAM_USER, (const void **) &username);
 
 	    syslog(LOG_NOTICE,_("FAILED LOGIN %d FROM %s FOR %s, %s"),
 		   failcount, hostname, username, pam_strerror(pamh, retcode));
 	    logbtmp(tty_name, username, hostname);
-	    audit_fd = audit_open();
-	    pw = getpwnam(username);
-	    if (pw) {
-		snprintf(buf, sizeof(buf), "uid=%d", pw->pw_uid);
-		audit_log_user_message(audit_fd, AUDIT_USER_LOGIN, 
-			buf, hostname, NULL, tty_name, 0);
-	    } else {
-		snprintf(buf, sizeof(buf), "acct=%s", username);
-		audit_log_user_message(audit_fd, AUDIT_USER_LOGIN, 
-			buf, hostname, NULL, tty_name, 0);
-	    }
-	    close(audit_fd);
+            logaudit(tty_name, username, hostname, NULL, 0);
 
 	    fprintf(stderr,_("Login incorrect\n\n"));
 	    pam_set_item(pamh,PAM_USER,NULL);
@@ -597,7 +604,6 @@
 
 	if (retcode != PAM_SUCCESS) {
 	    struct passwd *pw;
-	    char buf[64];
 	    pam_get_item(pamh, PAM_USER, (const void **) &username);
 
 	    if (retcode == PAM_MAXTRIES)
@@ -608,18 +614,7 @@
 		syslog(LOG_NOTICE,_("FAILED LOGIN SESSION FROM %s FOR %s, %s"),
 			hostname, username, pam_strerror(pamh, retcode));
 	    logbtmp(tty_name, username, hostname);
-	    audit_fd = audit_open();
-	    pw = getpwnam(username);
-	    if (pw) {
-		snprintf(buf, sizeof(buf), "uid=%d", pw->pw_uid);
-		audit_log_user_message(audit_fd, AUDIT_USER_LOGIN, 
-			buf, hostname, NULL, tty_name, 0);
-	    } else {
-		snprintf(buf, sizeof(buf), "acct=%s", username);
-		audit_log_user_message(audit_fd, AUDIT_USER_LOGIN, 
-			buf, hostname, NULL, tty_name, 0);
-	    }
-	    close(audit_fd);
+            logaudit(tty_name, username, hostname, NULL, 0);
 
 	    fprintf(stderr,_("\nLogin incorrect\n"));
 	    pam_end(pamh, retcode);
@@ -774,6 +769,7 @@
 	      syslog(LOG_NOTICE,
 		     _("LOGIN %s REFUSED ON TTY %s"),
 		     pwd->pw_name, tty_name);
+            logaudit(tty_name, pwd->pw_name, hostname, pwd, 0);
 	    continue;
 	}
 
@@ -980,6 +976,7 @@
 	close(audit_fd);
     }
     
+    logaudit(tty_name, username, hostname, pwd, 1);
     dolastlog(quietlog);
     
     chown(ttyn, pwd->pw_uid,
