#
# Copyright (c) 2005-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class LVM2(CPackageRecipe):
    name = 'lvm2'
    version = '2.02.51'

    buildRequires = [ 'ncurses:devel', 'readline:devel',
        'userspace-kernel-headers:devel', ]

    def setup(r):
        r.addArchive('ftp://sources.redhat.com/pub/lvm2/LVM2.%(version)s.tgz', keyid='567E2C17')
        # http://www.mail-archive.com/debian-bugs-dist@lists.debian.org/msg682952.html
        # https://www.redhat.com/archives/lvm-devel/2009-August/msg00106.html
        r.addPatch('lvm2-2_02_52-fix-pvcreate-partition.patch')
        r.addPatch('lvm2-2_02_52-fix-pvs-global-lock.patch')

        r.Configure(
            '--enable-lvm1_fallback '
            '--enable-fsdm '
            '--with-cluster=internal '
            '--with-pool=internal '
            '--with-user= '
            '--with-group= '

            '--with-staticdir=%(essentialsbindir)s '
            '--with-usrbindir=%(essentialsbindir)s '
            '--with-userlibdir=%(essentiallibdir)s '

            '--enable-static_link '
            '--enable-readline '

            '--enable-applib '
            '--enable-cmdlib '
            '--enable-dmeventd '
            '--enable-pkgconfig '
            # explicitly disable it
            '--disable-selinux '
            )
        r.Make()
        r.MakeInstall()

        for x in ('lvm', 'pvscan', 'vgchange', 'vgscan'):
            r.Symlink('lvm.static', '%(essentialsbindir)s/' + x)
        r.Doc('VERSION', 'WHATS_NEW')

        r.Move('/usr/sbin/dmsetup*', '/sbin/')
        r.Move('%(libdir)s/libdevmapper.*', '%(essentiallibdir)s/')
        r.PackageSpec('device-mapper',
                      '%(essentiallibdir)s/libdevmapper.*',
                      '%(libdir)s/libdevmapper.*',
                      '%(essentialsbindir)s/dmsetup.*',
                      '%(essentialsbindir)s/dmeventd',
                      '%(includedir)s/libdevmapper.h',
                      '%(includedir)s/libdevmapper-event.h',
                      '%(libdir)s/pkgconfig/devmapper.pc',
                      '%(libdir)s/pkgconfig/devmapper-event.pc',
                      '%(mandir)s/man8/dmsetup.8.gz'
                      )

        for i in ('archive', 'backup', 'cache'):
            d = '%(sysconfdir)s/lvm/' + i
            r.MakeDirs(d)
            r.SetModes(d, 0700)
            r.ExcludeDirectories(exceptions = d)

        r.MakeDirs('%(localstatedir)s/lock/lvm')
        r.SetModes('%(localstatedir)s/lock/lvm', 0700)
        r.ExcludeDirectories(exceptions = '%(localstatedir)s/lock/lvm')
        
        for d in ['archive', 'backup', 'cache']:
            r.SetModes('%(sysconfdir)s/lvm/' + d, 0700)


        # r.Install('scripts/clvmd_init_red_hat', '%(initdir)s/clvmd', mode = 0755)
        # r.Install('scripts/lvmconf.sh', '/sbin/lvmconf', mode = 0755)
