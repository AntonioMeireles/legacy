#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Hal(AutoPackageRecipe):
    name = 'hal'
    version = '0.5.8.1'

    # adding gnome-python creats a build req loop
    # gnome-vfs -> hal -> gnome-python -> gnome-vfs
    buildRequires = [ 'expat:devel', 'glib:devel', 'dbus-glib:devel',
                      'dbus:devel', 'python:devel', 'hwdata:runtime',
                      'doxygen:runtime', 'libusb:devel', 'popt:devel',
                      'userspace-kernel-headers:devel', 'pkgconfig:devel',
                      'gettext:runtime', 'perl:runtime', 'pygobject:python',
                      'perl-XML-Parser:perl', 'pygtk:python',
                      'PolicyKit:devel', 'udev:devel', 'pciutils:devel' ]

    extraConfig = ( '--with-os-type=redhat --with-init-scripts=redhat '
                    '--with-pid-file=%(localstatedir)s/run/haldaemon.pid '
                    '--with-stab-file=%(localstatedir)s/lib/pcmcia/stab '
                    '--enable-pcmcia-support --enable-sysfs-carrier '
                    '--enable-hotplug-map --enable-acpi-acpid '
                    '--disable-acpi-proc --disable-selinux' )

    if Use.builddocs:
        buildRequires.extend(['docbook-utils:runtime', 'openjade:runtime'])
    else:
        extraConfig += ' --disable-docbook-docs'

    def unpack(r):
        r.addArchive('http://freedesktop.org/~david/dist/')

        patches = [
            '01_hal_debian_dbuspolicy.patch', 
            '02_powerscripts.patch', 
            '03_macbookpro_configure.patch', 
            '04_cd_write.patch', 
            '05_one_formfactor_fallback.patch', 
            '06_smbios_return.patch', 
            '07_ppc_suspend.patch', 
            '08_openfirmware.patch', 
            '09_check_hashtable_initialisation.patch', 
            '10_callout_errors.patch', 
            '11_no_useless_runner_errors.patch', 
            '12_pegasus_pmu_crash_fix.patch', 
            '13_hal_callout_bashism.patch', 
            '14_power_suspend_linux_pmu_fix.patch', 
            '15_partition_probing.patch', 
            '19_sonypi_support.patch', 
            '23_addon_acpi.patch', 
            '24_ignored_volumes.patch', 
            '25_privileges-addons.patch', 
            '26_volume_and_aliased_keys.patch', 
            '27-hdm-nice-keyvalues.patch', 
            '28-fix-omnibook-brightness-levels.patch', 
            '30-mp3-player-fdi.patch', 
            '31_laptop-panel-fixes.patch', 
            '32_smartcard_drivetype.patch', 
            '33-prefer-pmi-over-powersave.patch', 
            '34_add_hwdb_button.patch', 
            '50_dbus-connection-close.patch', 
            '51_correctly_free_lists.patch', 
            '52_fix_hald_not_running_coredump.patch', 
            '53_dbus_is_error_set.patch', 
            '54_dbus_error_is_set.patch']

        for patch in patches:
            r.addPatch(patch)

    def configure(r):
        r.Replace('# chkconfig: 345 98 02', '# chkconfig: 345 98 09',
                  'hald/haldaemon.in')
        r.MakeDirs('%(sysconfdir)s/hal/fdi/information',
                   '%(sysconfdir)s/hal/fdi/policy',
                   '%(sysconfdir)s/hal/fdi/preprobe')
        r.Configure(r.extraConfig)

    def policy(r):
        r.TagSpec('initscript', '%(initdir)s/')
        r.UtilizeUser('haldaemon', r'%(sysconfdir)s/.*/hal\.conf')
        r.ExcludeDirectories(exceptions=['%(datadir)s/hal/'])
        r.ExcludeDirectories(exceptions=['%(sysconfdir)s/hal/'])
        r.PackageSpec('hal-gnome', '%(datadir)s/%(name)s/device-manager/',
                                   '%(bindir)s/hal-device-manager')
