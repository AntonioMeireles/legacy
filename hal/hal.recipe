#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Hal(CPackageRecipe):
    buildRequires = [ 'expat:devel', 'glib:devel', 'dbus:devel', 
        'hwdata:runtime', 'libcap:devel', 'popt:devel',
        'dbus-glib:devellib', 'glibc:devel', 'libusb:devel',
        'perl-XML-Parser:perl', 'gnome-python:python',
        'pygtk:python', 'binutils:runtime', 'docbook-utils:runtime',
        'doxygen:runtime', 'gawk:runtime', 'gettext:runtime',
        'glibc:runtime', 'perl:runtime', 'pkgconfig:devel',
        'dbus-glib:devel', 'pygobject:python' ]

    extraConfig = '--disable-docbook-docs --enable-hotplug-map --with-init-scripts=redhat --with-os-type=redhat --with-pid-file=%(localstatedir)s/run/haldaemon.pid --enable-sysfs-carrier --with-backend=linux2'
    
    extraConfig += '  --with-hal-user=root   --with-hal-group=root' 
    #workaround solong the conary group / user support is broken. Otherway the dbus will not start

    name = 'hal'
    version = '0.5.7.1'

    def setup(r):
        r.addArchive('http://freedesktop.org/~david/dist/%(name)s-%(version)s.tar.gz')
        r.addPatch('00upstream-01-music-players-fdi.patch')
        r.addPatch('00upstream-02-mWh-conversion.patch')
        r.addPatch('00upstream-03-fs-on-partitioned-devices.patch')
        r.addPatch('00upstream-04-dont-overwrite-formfactor.patch')
        r.addPatch('00upstream-05-fix-stale_nfs_handle_block.patch')
        r.addPatch('00upstream-06-stat-dev-not-mountpoint.patch')
        r.addPatch('00upstream-07-hald-runner_fdleak.patch')
        r.addPatch('02_ignored_volumes.patch')
        r.addPatch('04_hald_scripts.patch')
        r.addPatch('05_pmu_nohibernate.patch')
        r.addPatch('07_suspend2.patch')
        r.addPatch('08_privileges-addons.patch')
        r.addPatch('08_probe_serial.patch')
        r.addPatch('09_sony_brightness.patch')
        r.addPatch('10_volume_and_aliased_keys.patch')
        r.addPatch('11-hdm-nice-keyvalues.patch')
        r.addPatch('12_refresh_acpi_states.patch')
        r.addPatch('14_probe_volume_invalidlabel.patch')
        r.addPatch('15-fix-omnibook-brightness-levels.patch')
        r.addPatch('16-nonpartitions-ending-in-nums.patch')
        r.addPatch('17-mp3-player-fdi.patch')
        r.addPatch('18_fix_dbus_090_build.patch')
        r.addPatch('19_fix_wifi_detection.patch')
        r.addPatch('20_laptop-panel-fixes.patch')
        r.addPatch('21_smartcard_drivetype.patch')
        r.addPatch('22-prefer-pmi-over-powersave.patch')
        r.addPatch('23-fix-via-raid-detection.patch')
        r.addPatch('desktop-POTFILES.patch')
        r.addPatch('hdm-python2.4.patch')
        r.addPatch('is_mounted_read_only_property.patch')
        r.addPatch('lpi.patch')
        r.addPatch('mount-scripts-pmount.patch')
        r.addPatch('readme-remove-hacking.patch')
        r.addPatch('zzz_add_hwdb_button.patch')

        r.addAction("sed -i '/# chkconfig:/s/ 98/ 09/g' hald/haldaemon.in")
        r.Configure(r.extraConfig)
        r.Make()
        r.MakeInstall()
        r.PackageSpec('hal-gnome', '%(datadir)s/%(name)s/device-manager/',
            '%(bindir)s/hal-device-manager')
        r.TagSpec('initscript', '%(initdir)s/')
