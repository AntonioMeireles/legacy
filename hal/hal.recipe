#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage.recipe', label='conary.rpath.com@rpl:devel')
class Hal(RPMPackageRecipe,CPackageRecipe):
    buildRequires = [ 
        'expat:devel', 'glib:devel', 'dbus:devel', 
        'hwdata:runtime', 'libcap:devel', 'popt:devel',
        'dbus-glib:devellib', 'glibc:devel', 'libusb:devel',
        'perl-XML-Parser:perl', 'gnome-python:python',
        'pygtk:python', 'binutils:runtime', 'docbook-utils:runtime',
        'doxygen:runtime', 'gawk:runtime', 'gettext:runtime',
        'glibc:runtime', 'perl:runtime', 'pkgconfig:devel',
        'dbus-glib:devel', 'pygobject:python', 'udev:devel', 'xmlto:runtime',
        'smbios:runtime', 'smbios:devel', 'pciutils:devel', 
        'pciutils:devellib', 'gcc-c++:runtime', 'chkconfig:runtime', 
	    'zlib:lib', 'zlib:devellib', 'zlib:devel' ]

    extraConfig = '--disable-docbook-docs --with-os-type=redhat  --enable-umount-helper --enable-acpi-ibm --enable-acpi-toshiba --with-eject=/usr/bin/eject --with-pid-file=%(localstatedir)s/run/haldaemon.pid --enable-sonypic -with-dell-backlightu --enable-console-kit --enable-acl-management --with-hal-user=root'

    name = 'hal'
    version = '0.5.9'
    rpmRelease = '5.fc7'
    rpmPatches = ['hal-0.5.9-fixes.patch']

    def setup(r):
        r.unpack()

        r.addPatch('http://librarian.launchpad.net/7412197/hal_0.5.9-1ubuntu1.diff.gz')
        ubuntuPatches = [
            # commented are the patches already in fedora or that are ubuntu/deb specific
            #'01_hal_debian_dbuspolicy.patch',
            #'02_powerscripts.patch',
            #'10_repeated_property_changed_signals.patch',
            #'11_fix_luks_mounting.patch',
            '14_power_suspend_linux_pmu_fix.patch',
            '16_ntfs_allowed_mount_options.patch',
            '23_addon_acpi.patch',
            '24_ignored_volumes.patch',
            '25_privileges-addons.patch',
            '28_runner_64bit_values.patch',
            #'34_add_hwdb_button.patch.disabled',
            '40_readme_remove_hacking.patch',
            #'55_nonpolkit-mount-policy.patch',
            '56_probe_fstab.patch',
            '59_add_ssb_bus.patch',
            #'62_dbus-python-0.80.patch',
            '62_ignore_single_slash_label.patch',
            '63_fixup_macbookpro.patch',
            '65-keyboard-addon-repeated.patch',
            '66-NULL-fstype-crash.patch',
            '67-fix-probe-volume.patch',
            #'ubuntu-desktop-POTFILES.patch'
            #'ubuntu-lpi.patch'
            ]
        for p in ubuntuPatches:
            r.Run(""" patch -p1  < debian/patches/%s """ % p )

        r.Replace('98', '10', 'hald/haldaemon.in')

        r.Configure(r.extraConfig)
        r.Make()
        r.MakeInstall()
        r.Move('%(sysconfdir)s/rc.d/init.d/haldaemon','%(initdir)s/hald')

        r.PackageSpec('hal-gnome', '%(datadir)s/%(name)s/device-manager/',
                      '%(bindir)s/hal-device-manager')
        r.TagSpec('initscript', '%(initdir)s/')
        r.Requires('hal-info:data', '%(sbindir)s/hald')
        r.Requires('ConsoleKit:runtime', '%(sbindir)s/hald')

        r.ExcludeDirectories(exceptions='%(datadir)s/hal/fdi/information/20thirdparty')
        r.ExcludeDirectories(exceptions='%(datadir)s/hal/fdi/information/10freedesktop')
        r.ExcludeDirectories(exceptions='%(datadir)s/hal/fdi/preprobe/20thirdparty')
        r.ExcludeDirectories(exceptions='%(datadir)s/hal/fdi/preprobe/10osvendor')
        r.ExcludeDirectories(exceptions='%(datadir)s/hal/fdi/policy/20thirdparty')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/hald/hald-local')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/hald/hald-runner')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/cache/hald')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/hal')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/hal/fdi/information')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/hal/fdi/preprobe')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/hal/fdi/policy')

        r.UtilizeUser('haldaemon', r'%(sysconfdir)s/.*/hal\.conf')
