#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Hal(AutoPackageRecipe):
    name = 'hal'
    version = '0.5.8.1'

    # adding gnome-python creats a build req loop
    # gnome-vfs -> hal -> gnome-python -> gnome-vfs
    buildRequires = [ 'expat:devel', 'glib:devel', 'dbus-glib:devel',
                      'dbus:devel', 'python:devel', 'hwdata:config',
                      'doxygen:runtime', 'libusb:devel', 'popt:devel',
                      'userspace-kernel-headers:devel', 'pkgconfig:devel',
                      'gettext:runtime', 'perl:runtime', 'pygobject:python',
                      'perl-XML-Parser:perl', 'pygtk:python',
                      'PolicyKit:devel', ]

    extraConfig = ( '--with-os-type=redhat --with-init-scripts=redhat '
                    '--with-pid-file=%(localstatedir)s/run/haldaemon.pid '
                    '--with-stab-file=%(localstatedir)s/lib/pcmcia/stab '
                    '--enable-pcmcia-support --enable-sysfs-carrier '
                    '--enable-hotplug-map --enable-acpi-acpid '
                    '--disable-acpi-proc --disable-selinux' )

    if Use.builddocs:
        buildRequires.extend(['docbook-utils:runtime', 'openjade:runtime'])
    else:
        extraConfig += ' --disable-docbook-docs'

    def unpack(r):
        r.addArchive('http://freedesktop.org/~david/dist/')

    def configure(r):
        r.Replace('# chkconfig: 345 98 02', '# chkconfig: 345 98 09',
                  'hald/haldaemon.in')
        r.MakeDirs('%(sysconfdir)s/hal/fdi/information',
                   '%(sysconfdir)s/hal/fdi/policy',
                   '%(sysconfdir)s/hal/fdi/preprobe')
        r.Configure(r.extraConfig)

    def policy(r):
        r.TagSpec('initscript', '%(initdir)s/')
        r.UtilizeUser('haldaemon', r'%(sysconfdir)s/.*/hal\.conf')
        r.ExcludeDirectories(exceptions=['%(datadir)s/hal/'])
        r.ExcludeDirectories(exceptions=['%(sysconfdir)s/hal/'])
        r.PackageSpec('hal-gnome', '%(datadir)s/%(name)s/device-manager/',
                                   '%(bindir)s/hal-device-manager')
