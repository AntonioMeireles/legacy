#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class AlsaLib(RPMPackageRecipe,AutoPackageRecipe):
    name = 'alsa-lib'
    version = '1.0.22'
    rpmRelease = '1.fc12'
    rpmPatches = [ 'alsa-lib-1.0.17-config.patch',
                   'alsa-lib-1.0.14-glibc-open.patch',
                   'alsa-lib-1.0.16-no-dox-date.patch',
                   'alsa-lib-1.0.22-closetimer.patch',
                   'alsa-lib-1.0.22-softvol.patch' ]

    rpmSources = [ 'asound.conf' ]

    buildRequires = [ 'python:devel' ] #required for buildRequires.append
    if Use.builddocs:
        buildRequires.append('doxygen:runtime')

    def configure(r):
        r.Configure('--disable-aload')
        # Remove useless /usr/lib64 rpath on 64bit archs
        r.Run(""" 
sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool
""") 
    def make(r):
        r.Make()
        if Use.builddocs:
            r.Make('doc')

    def makeinstall(r):
        r.MakeInstall()
        # We need the library to be available even before /usr might be mounted
        r.MakeDirs('/%(lib)s')
        r.Move('%(libdir)s/libasound.s*', '/%(lib)s/')
        r.Symlink('../../%(lib)s/libasound.so.2', '%(libdir)s/libasound.so')

        r.AutoDoc('doc/asoundrc.txt')
        if Use.builddocs:
            r.Doc('doc/doxygen/*')

    def policy(r):
        # Install global configuration files
        r.Install('asound.conf', '%(sysconfdir)s/asound.conf', mode = 0644)
