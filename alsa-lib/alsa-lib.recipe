#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class AlsaLib(RPMPackageRecipe,AutoPackageRecipe):
    name = 'alsa-lib'
    version = '1.0.17'
    rpmRelease = '2.fc10'

    rpmPatches = [ 'alsa-lib-1.0.17-config.patch',
                   'alsa-lib-1.0.14-glibc-open.patch',
                   'alsa-lib-pulse-default.patch',
                   'alsa-lib-1.0.16-no-dox-date.patch',
                   'alsa-lib-1.0.17-softvolmute.patch',
                   'alsa-lib-1.0.17-clamprrfw.patch',
                   'alsa-lib-1.0.17-fixtype.patch',
                   'alsa-lib-1.0.17-fixreturnrrfw.patch', ]

    buildRequires = [ ] #required for buildRequires.append
    if Use.builddocs:
        buildRequires.append('doxygen:runtime')

    def configure(r):
        r.Configure('--with-configdir=%(sysconfdir)s/alsa')
        # Remove useless /usr/lib64 rpath on 64bit archs
        r.Run(""" 
sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool
""") 
    def make(r):
        r.Make()
        if Use.builddocs:
            r.Make('doc')

    def makeinstall(r):
        r.MakeInstall()

        r.AutoDoc('doc/asoundrc.txt')
        if Use.builddocs:
            r.Doc('doc/doxygen/*')

        r.Symlink('%(sysconfdir)s/alsa', '%(datadir)s/alsa')

    def policy(r):
        # these files are machine-managed and not generally
        # amenable to diff/patch merge.  They do change from
        # time to time and users should modify in ~/.asoundrc
        # anyway
        r.Transient('%(sysconfdir)s/alsa/')
        r.Config(exceptions='%(sysconfdir)s/alsa/')
