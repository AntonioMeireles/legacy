#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

# Get python version from this label
loadInstalled('python')

class Subversion(CPackageRecipe):
    name = 'subversion'
    version = '1.6.6'

    buildRequires = [ 'autoconf:runtime', 'libtool:runtime', 'python:devel',
                      'python:runtime', 'db:devel', 'apr:devel',
                      'apr-util:devel', 'neon:devel', 'httpd:devel',
                      'swig:runtime', 'which:runtime', 'krb5:devellib',
                      'expat:devel', 'libxml2:devel', 'zlib:devel',
                      'gettext:runtime', 'krb5:devel', 'httpd:runtime',
                      'e2fsprogs:devel', 'openldap:devel', 'perl:devel',
                      'perl:runtime', 'util-linux:devel',
                      'openssl:devel', 'sqlite:devel', 'cyrus-sasl:devel',
                      'pkgconfig:devel', 'ruby:runtime', ]

    if Use.builddocs:
        buildRequires.extend(['texinfo:runtime', 'docbook-xsl:data'])

    def setup(r):
        r.disableParallelMake()

        # svnparentpath is the directory containing the repositories

        r.macros.svnparentpath = '%(servicedir)s/subversion'
        r.macros.svnconfdir = '%(sysconfdir)s/subversion'

        r.macros.pydir = Python.sitepkgs
        r.macros.swigdirs = "swig_pydir=%(pydir)s/libsvn swig_pydir_extra=%(pydir)s/svn"

        r.addArchive('http://subversion.tigris.org/downloads/')
        r.addSource('subversion.conf', dest='%(sysconfdir)s/httpd/conf.d/subversion.conf')
        r.addSource('useraccess', dest='%(svnconfdir)s/useraccess')

        r.Replace(('SVN_PARENT_PATH','%(svnparentpath)s'),('SVN_CONF_DIR','%(svnconfdir)s'),
                  '%(sysconfdir)s/httpd/conf.d/subversion.conf',
                  '%(svnconfdir)s/useraccess')

        r.Create('%(svnconfdir)s/users')
        r.Configure('--with-neon=%(prefix)s '
                    '--with-apr=%(prefix)s '
                    '--with-apr-util=%(prefix)s '
                    '--with-berkeley-db '
                    '--disable-mod-activation '
                    '--with-sasl=%(prefix)s')
        # For some annoying reason, LDFLAGS will contain /usr/lib even on
        # 64-bit systems
        r.Make('LIBTOOL=%(bindir)s/libtool LDFLAGS=')
        r.MakeInstall('LDFLAGS=')
        r.Make('swig-py %(swigdirs)s LDFLAGS=')
        r.Make('install-swig-py %(swigdirs)s', preMake='DESTDIR=%(destdir)s')
        r.Make('swig-pl-lib LDFLAGS=')
        r.Make('install-swig-pl-lib LDFLAGS=', preMake='DESTDIR=%(destdir)s')
        r.Run('perl', 'Makefile.PL', 'INSTALLDIRS=vendor',
                'DESTDIR=%(destdir)s',
                dir='subversion/bindings/swig/perl/native')
        r.Replace('LD_RUN_PATH', '#LD_RUN_PATH',
                'subversion/bindings/swig/perl/native/Makefile.[a-z]*',
                'subversion/bindings/swig/perl/native/Makefile',
                lines='^LD_RUN_PATH.*')
        r.Make(dir='subversion/bindings/swig/perl/native')
        r.MakeInstall(dir='subversion/bindings/swig/perl/native')

        r.MakeDirs('%(svnparentpath)s')

        r.PackageSpec('mod_dav_svn',
                      '%(sysconfdir)s/httpd/conf.d/subversion.conf',
                      '%(libdir)s/httpd/',
                      '%(svnconfdir)s/')
        r.ComponentSpec('python', '%(libdir)s/libsvn_swig_py.*', '%(pydir)s/')

        r.ExcludeDirectories(exceptions='%(svnparentpath)s')
