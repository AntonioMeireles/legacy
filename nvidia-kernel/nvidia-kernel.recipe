#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class NvidiaKernel(AutoPackageRecipe):
    name = 'nvidia-kernel'
    version = '169.12'

    buildRequires = ['kernel:build-tree', 'mkinitrd:runtime']

    def setup(r):

        r.macros.kver = os.uname()[2]
        if Arch.x86:
            r.macros.arch = 'x86'
            r.macros.nvVersionSuffix = '1'
        else:
            r.macros.arch = 'x86_64'
            r.macros.nvVersionSuffix = '2'

        r.macros.url = 'http://download.nvidia.com/XFree86/Linux-%(arch)s'
        r.addSource('%(url)s/%(version)s/NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s.run')
        # http://www.nvnews.net/vbulletin/showthread.php?t=110088
        r.addSource('NVIDIA_kernel-169.12-2286310.diff')

        r.addAction('sh NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s.run --apply-patch ./NVIDIA_kernel-169.12-2286310.diff --extract-only') # Extract only

        r.Make('SYSSRC=/lib/modules/%(kver)s/build module', 
               dir='NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s/usr/src/nv')
        r.Install('NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s/usr/src/nv/nvidia.ko', 
                  '/lib/modules/%(kver)s/kernel/drivers/video/')

        # We want to make sure that the userspace code can require the
        # matching kernel-space code
        r.ComponentProvides('%(version)s')
        r.ComponentSpec('runtime', '/lib/modules/')

        # We need the kernel module and userspace versions to match
        r.Requires('nvidia:lib(%(version)s)', 
                   '/lib/modules/%(kver)s/kernel/drivers/video/nvidia.ko')

        r.AutoDoc(exceptions = '.*')

