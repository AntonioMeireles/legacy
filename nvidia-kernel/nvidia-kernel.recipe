#
# Copyright (c) 2004-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelmodulepackage')
class NvidiaKernel(KernelModulePackageRecipe):
    name = 'nvidia-kernel'
    version = '195.30'

    buildRequires = [
        'patch:runtime',
        'which:runtime',
      ]

    def unpack(r):
        r.addSource('http://download.nvidia.com/XFree86/Linux-x86/'
                '%(version)s/NVIDIA-Linux-x86-%(version)s-pkg1.run',
                use=Arch.x86)
        r.addSource('http://download.nvidia.com/XFree86/Linux-x86_64/'
                '%(version)s/NVIDIA-Linux-x86_64-%(version)s-pkg2.run',
                use=Arch.x86_64)

        if Arch.x86:
            r.macros.arch = 'x86'
            r.macros.nvVersionSuffix = '1'
        else:
            r.macros.arch = 'x86_64'
            r.macros.nvVersionSuffix = '2'

        r.addAction('sh NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s.run --extract-only')

    def build(r):
        r.Make('SYSSRC=/lib/modules/%(kver)s/build module',
                dir='NVIDIA-Linux-%(arch)s-%(version)s-pkg%(nvVersionSuffix)s/usr/src/nv')

    def install(r):
        r.Install('NVIDIA-Linux-*-%(version)s-pkg*/usr/src/nv/nvidia.ko', 
                '/lib/modules/%(kver)s/kernel/drivers/video/')

    def policy(r):
        # We want to make sure that the userspace code can require the
        # matching kernel-space code
        r.ComponentProvides('%(version)s')
        r.ComponentSpec('runtime', '/lib/modules/')
