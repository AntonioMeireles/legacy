#
# Copyright (c) 2006-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
loadInstalled('xulrunner')
class NsPluginwrapper(RPMPackageRecipe,AutoPackageRecipe):
    name = 'nspluginwrapper'
    version = '1.3.0'
    rpmRelease = '9.fc12'

    buildRequires = [ 'glib:devel', 'gtk:devel', 'libX11:devel', 'libXt:devel',
                      'zlib:devel', 'expat:devel', 'nspr:devel', 'gcc-c++:runtime',
                      'GConf:runtime', 'pkgconfig:devel', 'which:runtime',
                      'xextproto:devel', 'xulrunner:devel', 'alsa-plugins:devellib',
                      'curl:devel', 'openssl:devel'
                      ]

    rpmPatches = [ 'nspluginwrapper-1.3.0-make.patch',
                   'nspluginwrapper-1.3.0-configure.patch',
                   'nspluginwrapper-1.3.0-directory.patch',
                   'nspluginwrapper-20090625-fix-npident-array-sending.patch',
                   'nspluginwrapper-1.3.0-inst.patch',
                   ]

    plugin_config_version = '1.9'
    rpmArchives = ['plugin-config-%s.tar.gz' % plugin_config_version]

    def setup(r):
        r.unpack()
        r.addSource('plugin-config.sh.in', rpm=r.srpm)
        r.addSource('%(name)s.sh.in', rpm=r.srpm)

        r.addPatch('plugin-config-setuid.patch' , rpm=r.srpm, dir = '%(plugin_config_name)s')
        r.addPatch('plugin-config-umask.patch' , rpm=r.srpm, dir = '%(plugin_config_name)s')
        r.addPatch('plugin-config-print.patch' , rpm=r.srpm, dir = '%(plugin_config_name)s')
        r.addPatch('plugin-config-native.patch' , rpm=r.srpm, dir = '%(plugin_config_name)s')

        # Define libraries for 32/64 arches
        r.macros.lib32 = 'lib'
        r.macros.lib64 = 'lib64'
        r.macros.libdir32 = '%(prefix)s/%(lib32)s'

        # define mozilla plugin dir and back up dir for 64-bit browsers
        r.macros.pluginsourcedir = '%(libdir)s/mozilla/plugins'
        r.macros.plugindir = '%(libdir)s/mozilla/plugins-wrapped'
        if Arch.x86:
            r.macros.cflags += ' -m32 '
            r.macros.ldflags += '-m32 -L%(libdir)s'
        else:
            r.macros.cflags += ' -m64 '
            r.macros.ldflags += '-m64 -L%(libdir)s'


        commonConfig  = (' --prefix=%(prefix)s'
                         ' --pkgdir=%(name)s'
                         ' --pkglibdir=%(libdir)s/%(name)s'
                         ' --with-lib32=%(lib32)s'
                         ' --with-lib64=%(lib64)s'
                         ' --with-base-libdir=%(libdir)s'
                         ' --viewer-paths=%(libdir)s/%(name)s'
                         ' --with-x11-prefix=%(prefix)s'
                         ' --with-gecko=mozilla'
                         ' --enable-viewer'
                         ' --viewer-paths=%(libdir32)s/%(name)s:%(libdir)s/%(name)s'
                         ' --disable-biarch'
                         )

        if Arch.x86:
            commonConfig += (' --target-cpu=i386'
                             ' --with-base-lib=%(lib32)s')
            objDir = 'objs-32'
        else:
            commonConfig += (' --target-cpu=x86_64'
                             ' --with-base-lib=%(lib64)s')
            objDir = 'objs-64'

        r.MakeDirs(objDir)
        r.Configure(commonConfig, configureName='../configure', dir = objDir)

        # FIXME - simplify this
        r.macros.plugin_config_version = r.plugin_config_version
        r.macros.plugin_config_binary = 'plugin-config'
        r.macros.plugin_config_name= '%(plugin_config_binary)s-%(plugin_config_version)s'

        r.Configure(dir='%(plugin_config_name)s')

        r.Make(dir = objDir)
        r.Make(dir='%(plugin_config_name)s')

        r.MakeInstall(dir = objDir)
        r.MakeInstall(dir='%(plugin_config_name)s')

        r.MakeDirs('%(plugindir)s')
        r.MakeDirs('%(libdir)s/%(name)s')
        r.Symlink('%(libdir)s/%(name)s/npwrapper.so', '%(plugindir)s/')
        r.Move('%(bindir)s/%(plugin_config_binary)s', '%(libdir)s/%(name)s/%(plugin_config_binary)s')
        r.Remove('/usr/doc', recursive=True)

        r.SetModes('%(libdir)s/nspluginwrapper/plugin-config', 04755)

        r.Install('plugin-config.sh.in', '%(bindir)s/mozilla-plugin-config', mode = 0755)

        # r.Replace('EXCLUDE_LIST', 'libtotem*:libflash*:libjavaplugin*:gecko-mediaplayer*:mplayerplug-in*:librhythmbox*', '%(name)s.sh.in')
        r.Replace('EXCLUDE_LIST', 'libtotem*:libjavaplugin*:gecko-mediaplayer*:mplayerplug-in*:librhythmbox*', '%(name)s.sh.in')
        r.Install('%(name)s.sh.in', '%(sysconfdir)s/sysconfig/%(name)s', mode = 0644)

        r.Requires('xulrunner:lib',  '%(libdir)s/')

        r.Requires('soname: %(libdir)s/alsa-lib/libasound_module_pcm_pulse.so',
                   '%(libdir)s/')

        r.Requires('setarch:runtime', '%(bindir)s/mozilla-plugin-config')
        r.Requires('mozilla-filesystem:runtime', '%(bindir)s/mozilla-plugin-config')

        r.addSource('moz.global.env.vars.sh', dest = '%(sysconfdir)s/profile.d/', mode = 0755)

        # set up nsplugin player starting script
        r.Create('%(libdir)s/%(name)s/nspluginplayer',
                 contents = """
export MOZ_PLUGIN_PATH=%(libdir)s/mozilla/plugins
%(libdir)s/%(name)s/npplayer "$@"
""", mode = 0755)

        r.ComponentSpec('lib', '%(libdir)s/.*' )
        r.ComponentSpec('runtime', '%(bindir)s/.*' )
        r.ComponentSpec('runtime', '%(sysconfdir)s/.*' )

        if Arch.x86_64:
            # FIXME: find a better way, if any
            r.addSource('%(name)s.tagdescription', macros=True,
                        dest='%(tagdescriptiondir)s/%(name)s')
            r.addSource('%(name)s.taghandler', macros=True,
                        dest='%(taghandlerdir)s/%(name)s', mode=0755)

            r.Requires('file: %(libdir32)s/%(name)s/nspluginplayer', '%(taghandlerdir)s/%(name)s')
            r.TagSpec('nspluginwrapper', '%(bindir)s/mozilla-plugin-config')

        if Arch.x86:
            r.Remove('%(sysconfdir)s', recursive=True)
            r.Remove('%(bindir)s', recursive=True)
            r.Remove('%(datadir)s', recursive=True)
            # Docs only in one side
            r.AutoDoc(exceptions = '.*')
