#
# Copyright (c) 2005-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class LibDRM(RPMPackageRecipe, AutoPackageRecipe):
    name = 'libdrm'
    version = '2.4.31'
    isOPENsuse = True
    isXOrgFactory = True
    rpmRelease = '68.1'
    buildRequires = [ 'autoconf:runtime','automake:runtime','pkgconfig:devel',
                      'libxml2:runtime',  'libpciaccess:devel',
                      'libtool:devel', 'libtool:runtime', 'util-macros:devel', 
                      'libpthread-stubs:devellib', 'cairo:devel', 'udev:devel' ]

    rpmPatches = [ ]

    def configure(r):
        r.macros.optflags += ' -fno-strict-aliasing '
        # hardcode the 666 instead of 660 for device nodes
        r.addPatch('libdrm-make-dri-perms-okay.patch')
        # remove backwards compat not needed
        # r.addPatch('libdrm-2.4.0-no-bc.patch')
        # make rule to print the list of test programs
        r.addPatch('libdrm-2.4.25-check-programs.patch')

        r.addSource('91-drm-modeset.rules')

        r.Run('autoreconf -fi')
        r.Configure(' --with-pic'
                    ' --enable-nouveau-experimental-api '
                    ' --enable-vmwgfx-experimental-api'
                    ' --enable-udev'
                    ' --enable-libkms' )

    def makeinstall(r):
        r.MakeInstall()

        r.Make('$(make check-programs)', dir = 'tests')
        r.MakeDirs('%(bindir)s')
        r.Run(""" for foo in $(make check-programs) ;do cp .libs/$foo %(destdir)s%(bindir)s/ ; done ;""",
              dir = 'tests')


        r.Install('91-drm-modeset.rules',
                  '%(sysconfdir)s/udev/rules.d/',
                  mode = 0644)
