#
# Copyright (c) 2004-2005 rpath, Inc.
# All rights reserved
#

class Udev(PackageRecipe):
    buildRequires = [ 'sysfsutils:devel', 'pkgconfig:devel', 'glib:runtime',
                      'bison:runtime', 'pam:devel','glibc:devel' ]

    name = 'udev'
    version = '063'
    
    def setup(r):
	srpm = 'http://ftp.roedu.net/mirrors/fedora.redhat.com/core/development/SRPMS/udev-069-2.src.rpm'

	r.addArchive('ftp://ftp.kernel.org/pub/linux/utils/kernel/hotplug/%(name)s-063.tar.bz2')
	
	# addons and extra features
#XXX verify
        r.addSource('udev.rules', rpm=srpm)
        r.addSource('udev.conf', rpm=srpm)
        r.addSource('pam_console.dev', rpm=srpm)
        r.addSource('MAKEDEV.dev', rpm=srpm)
        r.addSource('hotplug.rules', rpm=srpm)
        r.addSource('udev.get_persistent_device_name.sh', rpm=srpm)
        r.addSource('udev.get_unique_hardware_path.sh', rpm=srpm)
        r.addSource('udev.get_unique_drive_id.sh', rpm=srpm)
        r.addSource('udev.rules.persistent', rpm=srpm)
        r.addSource('check-cdrom.sh', rpm=srpm)
        r.addSource('ide-media.sh', rpm=srpm)
        r.addSource('dvb.sh', rpm=srpm)
        r.addSource('start_udev', rpm=srpm)
        r.addSource('udev.html', rpm=srpm)
        r.addSource('udev.nodes', rpm=srpm)
        r.addSource('udevpermconv.sh', rpm=srpm)
        r.addSource('firmware_helper.c', rpm=srpm)

        r.addPatch('udev-062-build.patch', macros=True)
        r.addPatch('udev-039-scsi_id-tmp_dir.patch', rpm=srpm)

	r.addPatch('perms.patch')


	r.Replace('MAKEDEV -x', 'MAKEDEV', 'start_udev')

	r.Make('USE_KLIBC=false udevdir="/dev" EXTRAS="extras/scsi_id '
               'extras/chassis_id extras/ata_id extras/usb_id '
               'extras/run_directory" all')
	r.MakeInstall()

        r.Make("LIBDIR=%(libdir)s", subDir='pam_console_setowner')

        r.Run('%(cc)s %(cflags)s -o firmware_helper firmware_helper.c')

	r.Install('udev.rules', '%(sysconfdir)s/udev/rules.d/50-udev.rules')
	r.Install('hotplug.rules', '%(sysconfdir)s/udev/rules.d/hotplug.rules')
	r.Install('udev.conf', '%(sysconfdir)s/udev/')
	r.Install('udev.get_persistent_device_name.sh', '%(essentialsbindir)s/', mode=0755)
	r.Install('udev.get_unique_hardware_path.sh', '%(essentialsbindir)s/', mode=0755)
	r.Install('udev.get_unique_drive_id.sh', '%(essentialsbindir)s/', mode=0755)
	r.Install('udev.rules.persistent', '%(sysconfdir)s/udev/rules.d/49-udev-persistent.rules')
	r.Install('check-cdrom.sh', '%(sysconfdir)s/udev/scripts/')
	r.Install('ide-media.sh', '%(sysconfdir)s/udev/scripts/')
	r.Install('dvb.sh', '%(sysconfdir)s/udev/scripts/')
	r.Install('udevpermconv.sh', '%(sysconfdir)s/udev/scripts/')
	r.Install('udev.nodes', '%(sysconfdir)s/udev/makedev.d/50-udev.nodes')

	r.Install('start_udev', '%(essentialsbindir)s/', mode=0755)

        r.Install('pam_console.dev', '%(sysconfdir)s/udev/scripts/pam_console.dev', mode=0755)
        r.Symlink('%(sysconfdir)s/udev/scripts/pam_console.dev', '%(sysconfdir)s/dev.d/default/05-pam_console.dev')
        r.Install('firmware_helper', '%(essentialsbindir)s/')
        r.Install('check-cdrom.sh', '%(sysconfdir)s/udev/scripts/check-cdrom.sh', mode=0755)
        r.Install('ide-media.sh', '%(sysconfdir)s/udev/scripts/ide-media.sh', mode=0755)
        r.Install('MAKEDEV.dev', '%(sysconfdir)s/udev/scripts/MAKEDEV.dev', mode=0755)

        r.MakeDirs('%(sysconfdir)s/udev/devices')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/udev/devices')

	#Make directories for the firmware
        r.MakeDirs('%(essentiallibdir)s/firmware')
        r.ExcludeDirectories(exceptions='%(essentiallibdir)s/firmware')
