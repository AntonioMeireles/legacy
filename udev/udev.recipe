#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Udev(RPMPackageRecipe,CPackageRecipe):
    name = 'udev'
    version = '106'
    rpmRelease = '1.fc7'

    buildRequires = [ 'sysfsutils:devel', 'pkgconfig:devel', 'glib:runtime',
                      'bison:runtime', 'pam:devel' ]

    def setup(r):
        r.disableParallelMake()
        r.macros.debug = 'false'

        r.addArchive('ftp://ftp.kernel.org/pub/linux/utils/kernel/hotplug/', keyid='517D0F0E')

        # addons and extra features
        r.addSource('start_udev', rpm=r.srpm)
        r.addSource('firmware_helper.c', rpm=r.srpm)
        r.addSource('modprobe', rpm=r.srpm)
        r.addSource('udev.nodes')
        r.addSource('check-cdrom.sh', dest='/lib/udev/', mode=0755)


        # Make the static binaries...
        r.Make('USE_KLIBC=false'
               ' USE_SELINUX=false'
               ' USE_STATIC=true'
               ' STRIP="%(essentialbindir)s/true"'
               ' udevdir="/dev"'
               ' USE_LOG=false'
               ' DEBUG=%(debug)s'
               ' EXTRAS="extras/scsi_id extras/ata_id extras/usb_id '
                         'extras/edd_id extras/path_id extras/volume_id"'
               ' all ')

        r.Move('test-udev', 'test-udev.static')
        r.Move('udevstart', 'udevstart.static')
        r.Move('udevd', 'udevd.static')
        r.Move('extras/scsi_id/scsi_id', 'extras/scsi_id/scsi_id.static')
        r.Move('extras/ata_id/ata_id', 'extras/ata_id/ata_id.static')
        r.Move('extras/edd_id/edd_id', 'extras/edd_id/edd_id.static')
        r.Move('extras/usb_id/usb_id', 'extras/usb_id/usb_id.static')
        r.Move('extras/volume_id/vol_id', 'extras/volume_id/vol_id.static')

        r.Make('clean')

        # Make the shared binaries...
        r.Make('CC="gcc %(cflags)s"'
               ' USE_KLIBC=false'
               ' USE_SELINUX=false'
               ' udevdir="/dev"'
               ' USE_LOG=true'
               ' DEBUG=%(debug)s'
               ' STRIP="%(essentialbindir)s/true"'
               ' EXTRAS="extras/scsi_id extras/ata_id extras/usb_id '
                        'extras/edd_id extras/volume_id extras/run_directory"')
        # this is from firmware_helper from the srpm
        r.Run('%(cc)s %(cflags)s -o firmware_helper firmware_helper.c')

        r.Move('extras/scsi_id/scsi_id.static', 'extras/scsi_id/scsi_id')
        r.Move('extras/ata_id/ata_id.static', 'extras/ata_id/ata_id')
        r.Move('extras/edd_id/edd_id.static', 'extras/edd_id/edd_id')
        r.Move('extras/usb_id/usb_id.static', 'extras/usb_id/usb_id')
        r.Move('extras/volume_id/vol_id.static', 'extras/volume_id/vol_id')

        r.MakeInstall('EXTRAS="'
               'extras/scsi_id'
               ' extras/ata_id'
               ' extras/usb_id'
               ' extras/edd_id'
               ' extras/path_id'
               ' extras/volume_id'
               ' extras/floppy'
               ' extras/run_directory"')

        # multilib fixes
        r.Remove('/usr/lib/libvolume_id.so')
        r.Move('/lib/lib*so*', '%(essentiallibdir)s/')
        r.Symlink('%(essentiallibdir)s/libvolume_id.so.0', '%(libdir)s/libvolume_id.so')
        r.Move('/usr/lib/pkgconfig/libvolume_id.pc', '%(libdir)s/pkgconfig/')

        r.MakeDirs('%(sysconfdir)s/udev/devices')
        r.MakeDirs('%(sysconfdir)s/udev/{rules.d,scripts,devices,makedev.d}')
        r.MakeDirs('%(sysconfdir)s/dev.d/{default,block}')
        r.MakeDirs('%(datadir)s/udev')
        r.MakeDirs('/lib/firmware')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/.*')
        r.ExcludeDirectories(exceptions='%(datadir)s/udev')
        r.ExcludeDirectories(exceptions='/lib/firmware')
        r.ExcludeDirectories(exceptions='/dev')

        r.Install('test-udev.static', '%(essentialsbindir)s/test-udev.static')
        r.Install('udevstart.static', '%(essentialsbindir)s/udevstart.static')
        r.Install('udevd.static', '%(essentialsbindir)s/udevd.static')
        r.Install('start_udev', '%(essentialsbindir)s/')
        r.Install('udev.nodes', '%(sysconfdir)s/udev/makedev.d/50-udev.nodes', mode=0755)
        r.Install('modprobe', '/lib/udev/', mode=0755)

        for i in ('0', '1', '2', '3'):
            r.MakeDirs('%%(sysconfdir)s/dev.d/fd%s' % i)

        r.Install('firmware_helper', '%(essentialsbindir)s/')
        # These rules will do for now...
        r.Install('etc/udev/redhat/*', '%(sysconfdir)s/udev/rules.d/')
