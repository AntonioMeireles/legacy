#
# Copyright (c) 2004-2005 rpath, Inc.
# All rights reserved
#

class Udev(PackageRecipe):
    buildRequires = [ 'sysfsutils:devel', 'pkgconfig:devel', 'glib:runtime',
                      'bison:runtime', 'pam:devel','glibc:devel' ,'chkconfig:runtime']

    name = 'udev'
    version = '070'
    
    def setup(r):
	r.addArchive('ftp://ftp.kernel.org/pub/linux/utils/kernel/hotplug/%(name)s-%(version)s.tar.bz2')
	
	# addons and extra features
#XXX verify

	r.addSource('udev_etc.tar.gz') #rules from etc/udev
	r.Run('tar -xzf udev_etc.tar.gz')
	r.addSource('start_udev')
	r.addSource('udev_init.sh')
	r.Install('udev_init.sh','%(sysconfdir)s/init.d/udevd',mode=0755)
	#r.Replace('MAKEDEV -x', 'MAKEDEV', 'start_udev')

	r.Make('USE_KLIBC=false udevdir="/dev" EXTRAS="extras/scsi_id '
               'extras/chassis_id extras/ata_id extras/usb_id '
               'extras/run_directory extras/firmware" all')
	r.MakeInstall()

#        r.Make("LIBDIR=%(libdir)s", subDir='pam_console_setowner')

        #r.Run('%(cc)s %(cflags)s -o firmware_helper firmware_helper.c')
	r.Install('etc_bla/udev','%(sysconfdir)s')
	r.Install('etc_bla/udev/scripts', '%(sysconfdir)s/udev/',mode=0755)

        r.Install('extras/firmware/firmware_helper', '%(essentialsbindir)s/')
        r.MakeInstall(subDir='extras/scsi_id/')
        r.Install('extras/ata_id/ata_id', '%(essentialsbindir)s/')
        r.Install('extras/usb_id/usb_id', '%(essentialsbindir)s/')
	r.Install('extras/run_directory/udev_run_devd', '%(essentialsbindir)s/')
	r.Install('extras/run_directory/udev_run_hotplugd', '%(essentialsbindir)s/')
        r.Install('extras/firmware/firmware_helper', '%(essentialsbindir)s/')


        #r.Install('check-cdrom.sh', '%(sysconfdir)s/udev/scripts/check-cdrom.sh', mode=0755)
        #r.Install('ide-media.sh', '%(sysconfdir)s/udev/scripts/ide-media.sh', mode=0755)
        #r.Install('MAKEDEV.dev', '%(sysconfdir)s/udev/scripts/MAKEDEV.dev', mode=0755)
	r.Install('start_udev', '%(essentialsbindir)s/start_udev', mode=0755)
	
        r.MakeDirs('%(sysconfdir)s/udev/devices')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/udev/devices')

	#Make directories for the firmware
        r.MakeDirs('%(essentiallibdir)s/firmware')
        r.ExcludeDirectories(exceptions='%(essentiallibdir)s/firmware')
