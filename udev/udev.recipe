#
# Copyright (c) 2004 Specifix, Inc.
# All rights reserved
#

class Udev(PackageRecipe):
    buildRequires = [ 'sysfsutils:devel', 'pkgconfig:devel', 'glib:runtime',
                      'bison:runtime', 'pam:devel' ]

    name = 'udev'
    version = '039'
    
    def setup(r):
	srpm = 'http://mirror.linux.duke.edu/pub/fedora/linux/core/updates/3/SRPMS/udev-039-10.FC3.6.src.rpm'

	r.addArchive('ftp://ftp.kernel.org/pub/linux/utils/kernel/hotplug/%(name)s-%(version)s.tar.bz2')
        r.addArchive('pam_console_setowner-1.4.tgz',
            dir=r.theMainDir, rpm=srpm)
	
	# addons and extra features
	r.addSource('udev.rules', rpm=srpm)
	r.addSource('udev.permissions', rpm=srpm)
        r.addSource('pam_console.dev', rpm=srpm)
	r.addSource('udev.conf', rpm=srpm)
	r.addSource('ata_identify.c', rpm=srpm,
	    dir='ata_identify/')
	r.addSource('ata_identify-Makefile', rpm=srpm,
	    dir='ata_identify/', dest='Makefile')
	r.addSource('udev.get_persistent_device_name.sh', rpm=srpm)
	r.addSource('udev.get_unique_hardware_path.sh', rpm=srpm)
	r.addSource('udev.get_unique_drive_id.sh', rpm=srpm)
	r.addSource('udev.rules.persistent', rpm=srpm)
	r.addSource('start_udev', rpm=srpm)
	r.addSource('check-cdrom.sh', rpm=srpm)
	r.addSource('ide-media.sh', rpm=srpm)
	r.addSource('MAKEDEV.dev', rpm=srpm)

        r.addPatch('udev-039-static.patch', rpm=srpm)
        r.addPatch('udev-025-volsbin.patch', rpm=srpm)
        r.addPatch('udev-039-wait-error-log.patch', rpm=srpm)
        r.addPatch('udev-039-logging.patch', rpm=srpm)
        r.addPatch('udev-039-wait-ppp-class.patch', rpm=srpm)
        r.addPatch('udev-039-wait-dm-block.patch', rpm=srpm)
        r.addPatch('udev-039-static2.patch', rpm=srpm)
        r.addPatch('udev-039-netif.patch', rpm=srpm)
        r.addPatch('udev-039-dummy.patch', rpm=srpm)
        r.addPatch('udev-039-volume_id-nonblock.patch', rpm=srpm)
        r.addPatch('udev-039-norm.patch', rpm=srpm)
        r.addPatch('udev-032-symlink.patch', rpm=srpm)
        r.addPatch('udev-038-volmak.patch', rpm=srpm)
        r.addPatch('udev-039-wait.patch', rpm=srpm)
        r.addPatch('udev-039-sig.patch', rpm=srpm)
        r.addPatch('udev-039-media.patch', rpm=srpm)
        r.addPatch('udev-039-noinfo.patch', rpm=srpm)

	r.Replace('MAKEDEV -x', 'MAKEDEV', 'start_udev')

	r.Make('USE_KLIBC=false udevdir="/dev"')
	r.MakeInstall()

	r.Make(subDir='ata_identify')
	r.MakeInstall(subDir='ata_identify')

        r.Make("LIBDIR=%(libdir)s", subDir='pam_console_setowner')

	r.Install('udev.conf', '%(sysconfdir)s/udev/')
	r.Install('udev.rules', '%(sysconfdir)s/udev/rules.d/50-udev.rules')
	r.Install('udev.permissions', '%(sysconfdir)s/udev/permissions.d/50-udev.permissions')
	r.Install('udev.get_persistent_device_name.sh', '%(essentialsbindir)s/', mode=0755)
	r.Install('udev.get_unique_hardware_path.sh', '%(essentialsbindir)s/', mode=0755)
	r.Install('udev.get_unique_drive_id.sh', '%(essentialsbindir)s/', mode=0755)
	r.Install('udev.rules.persistent', '%(sysconfdir)s/udev/rules.d/51-udev-persistent.rules')

	r.Install('start_udev', '%(essentialsbindir)s/', mode=0755)

        r.Install('pam_console.dev', '%(sysconfdir)s/udev/scripts/pam_console.dev', mode=0755)
        r.Symlink('%(sysconfdir)s/udev/scripts/pam_console.dev', '%(sysconfdir)s/dev.d/default/05-pam_console.dev')
        r.Install('pam_console_setowner/pam_console_setowner', '%(essentialsbindir)s/')

        r.Move('%(sysconfdir)s/dev.d/net/hotplug.dev', '%(sysconfdir)s/udev/scripts/')
        r.Symlink('%(sysconfdir)s/udev/scripts/hotplug.dev', '%(sysconfdir)s/dev.d/net/')

        r.Install('check-cdrom.sh', '%(sysconfdir)s/udev/scripts/check-cdrom.sh', mode=0755)
        r.Install('ide-media.sh', '%(sysconfdir)s/udev/scripts/ide-media.sh', mode=0755)
        r.Install('MAKEDEV.dev', '%(sysconfdir)s/udev/scripts/MAKEDEV.dev', mode=0755)
