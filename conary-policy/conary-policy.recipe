#
# Copyright (c) 2006-2011 rPath, Inc.
#               2011-2012 The Foresight Linux Project
#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

import datetime
loadSuperClass('python')
class ConaryPolicy(BuildPackageRecipe, Python.VersionMixIn):
    name = 'conary-policy'
    version = '1.2'
    tag = 'd43bc1b'
    if tag:
        version += '+' + tag

    def setup(r):
        r.setDefaultPython()
        if r.tag:
            r.addMercurialSnapshot('https://bitbucket.org/rpathsync/%(name)s',
                                   tag=r.tag)

        r.addPatch('CNP-211.patch')

        # from meeuw / https://bitbucket.org/meeuw/conary-policy/ and until it gets merged
        # use the canonical path (for usr merge, /bin/bash -> /usr/bin/bash)
        # regex fixes - don't match files from systemd like systemd-journald.socket 
        # https://bitbucket.org/meeuw/conary-policy/commits/6b713ccfcda11009f82ea2de4c84d16515b3f67f/raw
        # https://bitbucket.org/meeuw/conary-policy/commits/73bfc16fbf860f110f5141d6759a5195743454b5/raw
        for patch in [ '6b713c.patch', '73bfc1.patch',]:
            r.addPatch(patch)

        # A policy that enforces that two troves with different
        # names may not provide the same dependency. magic by
        # Michael K. Johnson. 
        r.addSource('group_duplicateprovides.py',
                    dest='%(prefix)s/lib/conary/policy/')

        # this is capsule's specific and breaks expected behaviour
        # on native bootstraps.
        r.Remove('policy/bootstraptrovedeps.py')

        r.MakeInstall()
        # NOT %(libdir)s
        r.CompilePython('%(prefix)s/lib/conary/policy')
        r.Requires(bootstrapPythonFlags=('%(lib)s', '%(pyver)s'))
