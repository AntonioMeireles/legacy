#
# Copyright (c) 2006-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('javapackage')
class SunJava(JavaPackageRecipe, CPackageRecipe):
    name = 'sun-jdk'
    version = '6u12'

    clearBuildRequires()

    javaname = 'sun-java-%s' % version
    jdkhome = '%%(jvmdir)s/%s' % javaname
    javahome = '%s/jre' % jdkhome

    def upstreamUnpack(r):

        r.macros.jrename = 'sun-jre'
        r.macros.jdkhome = r.jdkhome
        r.macros.javaname = r.javaname

        upver = r.version.replace('.', '_')
        site = 'http://download.java.net/dlj/binaries/'+'jdk-'+upver+'-dlj-linux-'
        arch32 = 'i586.bin'
        arch64 = 'amd64.bin'

        r.addSource(site+arch32, use=(Arch.x86))
        r.addSource(site+arch64, use=(Arch.x86_64))

        r.addSource('%(name)s.sh', macros=True)

        r.Run('sh *.bin --accept-license --unpack')

    def upstreamSetup(r):

        r.Install('jdk*/*', '%(jdkhome)s/')

        desktop = '%(jdkhome)s/jre/plugin/desktop/sun_java'
        desktopFile = '%s.desktop' % desktop
        desktopIcon = '%s.png' % desktop
        r.Replace(
            ('X-Sun-Supported;', ''),
            ('X-Red-Hat-Base;', ''),
            ('X-Ximian-Settings;', ''),
            ('Application;', ''),
            desktopFile
        )

        r.Install(desktopFile, '%(datadir)s/applications/')
        r.Install(desktopIcon, '%(datadir)s/pixmaps/sun-jcontrol.png')

        # Create symlink for firefox plugin
        r.macros.javaplugin = '%%(javahome)s/lib/%s/libnpjp2.so' % ('amd64', 'i386')[Arch.x86==True]
        r.Symlink('%(javaplugin)s', '%(libdir)s/mozilla/plugins/libjavaplugin_oji.so')

        r.PackageSpec('%(jrename)s', '%(libdir)s/mozilla/plugins/')

        r.macros.jsuffix = ('-64','')[Arch.x86==True]
        r.Install(
            '%(name)s.sh',
            '%(sysconfdir)s/profile.d/%(name)s%(jsuffix)s.sh',
            package='%(jrename)s', mode=0755
        )

        r.ComponentSpec('locale', '%(javahome)s/lib/locale/')
        r.ComponentSpec('runtime', '/')
        r.PackageSpec('%(jrename)s', '%(javahome)s/')

        # RPL-1534
        r.Requires(exceptDeps='java.*')

        # RPL-1558
        r.Requires('%(jrename)s:runtime', '%(jdkhome)s/.*')

        r.TagSpec('desktop-file', '%(datadir)s/applications/')

        del(r.AutoDoc)
        del(r.RemoveNonPackageFiles)

