#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadRecipe('rpmpackage')
loadRecipe('gnomepackage')
class Gdm(RPMPackageRecipe,GnomePackageRecipe):

    name = 'gdm'
    version = '2.25.2'
    rpmRelease = '19.fc11'

    buildRequires = [ 'libglade:devel', 'pango:devel', 'gtk:devel', 'libgnomeui:devel', 'libgnomecanvas:devel', 'librsvg:devel', 'libxml2:devel', 'fontconfig:devel', 'libgsf:devel', 'libcroco:devel', 'attr:devel', 'rarian:runtime', 'desktop-file-utils:runtime', 'GConf:devel', 'ORBit2:devel', 'atk:devel', 'cairo:devel', 'freetype:devel', 'glib:devel', 'gnome-keyring:devel', 'gnome-vfs:devel', 'libart_lgpl:devel', 'libbonobo:devel', 'libbonoboui:devel', 'libgnome:devel', 'libpng:devel', 'popt:devel', 'tcp_wrappers:devel', 'gettext:runtime', 'gtk:runtime', 'perl:runtime', 'usermode:runtime', 'zenity:runtime', 'libX11:devel', 'libXau:devel', 'libXdmcp:devel', 'libXext:devel', 'libXi:devellib', 'libXinerama:devel', 'libXrender:devel','libdmx:devellib', 'gnome-doc-utils:devel', 'gnome-doc-utils:runtime', 'audit:devel', 'shadow:runtime', 'automake:runtime', 'autoconf:runtime', 'libtool:devel',  'pkgconfig:devel' , 'm4:runtime', 'expat:devel', 'pam:devel', 'dbus-glib:runtime', 'GConf:runtime', 'xorg-server:runtime', 'PolicyKit-gnome:devel', 'PolicyKit:devel', 'gnome-panel:devel', 'iso-codes:devellib', 'libxklavier:devel', 'xdm:runtime', 'hal:devel', 'nss:devel' ]

    extraConfig = ' --with-pam-prefix=%(sysconfdir)s'
    extraConfig += ' --enable-console-helper  --without-selinux --with-console-kit'
    extraConfig += ' --disable-scrollkeeper --enable-profiling '

    rpmPatches = [ 'gdm-2.24.0-force-active-vt.patch',
                   'gdm-2.23.92-save-root-window.patch',
                   'gdm-2.25.2-append-logs.patch',
                   # uses /etc/sysconfig/keyboard and is thus not directly upstreamable
                   # should probably be changed to get the system layout from the X server
                   'gdm-system-keyboard.patch',
                   'gdm-2.25.2-multistack-but-boring.patch',
                   'gdm-2.25.2-start-faster.patch',
                   'gdm-2.25.2-use-resolvable-hostname.patch',
                   'gdm-2.25.2-maybe-work-around-gcc-bug.patch',
                    ]
    rpmSources = ['gdm-pam', 'gdm-autologin-pam', 'gdmsetup-pam' ]
    def setup(r):
        RPMPackageRecipe.unpack(r)
        r.addPatch('logo.patch')
        r.Run("autoreconf -fi")
        # evaluate extraConfig's sysconfdir before setting new value
        r.extraConfig = r.extraConfig % r.macros
        #r.macros.sysconfdir= '%(sysconfdir)s/X11'

        r.Replace(['session    required    pam_selinux.so close', ''],
                  ['session    required    pam_selinux.so open', ''],
                  'gdm-autologin-pam')
        r.Replace(['auth     [success=done ignore=ignore default=bad] pam_selinux_permit.so', ''],
                  ['session    required    pam_selinux.so close', ''],
                  ['session    required    pam_selinux.so open', ''],
                  'gdm-pam')
        # FIXME: for this we need to bump our pam
        #        r.Copy('gdm-pam', 'data/gdm')
        #        r.Copy('gdm-autologin-pam', 'data/gdm-autologin')
        #        r.Copy('gdmsetup-pam', 'utils/gdmsetup-pam')
        GnomePackageRecipe.build(r)

        r.MakeDirs('%(sysconfdir)s/gdm/{Init,PreSession,PostSession}')

        GnomePackageRecipe.install(r)

        # create log dir
        r.MakeDirs('%(localstatedir)s/log/gdm')
        r.ExcludeDirectories(exceptions=[
            '%(localstatedir)s/log/gdm',
            '%(sysconfdir)s/gdm/{Init,PreSession,PostSession}',
            '%(datadir)s/gdm/autostart/LoginWindow',
            ])

        # remove the gdm Xsession as we're using the xdm one
        r.Remove('%(sysconfdir)s/gdm/Xsession')
        # FIXME: came back here to check once i clean xdm side
        r.Symlink('%(sysconfdir)s/X11/xdm/Xsession', '%(sysconfdir)s/gdm/Xsession')

        r.Ownership('gdm', 'gdm', '%(localstatedir)s/lib/gdm')
        r.SetModes('%(localstatedir)s/lib/gdm', 01770)

        r.Ownership('gdm', 'gdm', '%(localstatedir)s/lib/gdm/.gconf.mandatory')
        r.SetModes('%(localstatedir)s/lib/gdm/.gconf.mandatory', 01750)

        r.Ownership('gdm', 'gdm', '%(localstatedir)s/lib/gdm/.gconf.mandatory/.*')
        r.SetModes('%(localstatedir)s/lib/gdm/.gconf.mandatory/.*', 01640)

        r.Ownership('gdm', 'gdm', '%(localstatedir)s/lib/gdm/.gconf.path')
        r.SetModes('%(localstatedir)s/lib/gdm/.gconf.path', 01640)

        r.Ownership('root', 'gdm', '%(localstatedir)s/gdm')
        r.SetModes('%(localstatedir)s/gdm', 01770)

        r.Ownership('root', 'gdm', '%(localstatedir)s/run/gdm')
        r.SetModes('%(localstatedir)s/run/gdm', 01777)

        r.MakeDirs('%(datadir)s/gdm/autostart/LoginWindow')

        r.PackageSpec('gdm-user-switch-applet',
            '%(libexecdir)s/gdm-user-switch-applet')
        r.PackageSpec('gdm-user-switch-applet', 
            '%(libdir)s/bonobo/servers/GNOME_FastUserSwitchApplet.server')
        r.PackageSpec('gdm-user-switch-applet', 
            '%(datadir)s/gnome-2.0/ui/GNOME_FastUserSwitchApplet.xml')

        r.DanglingSymlinks(exceptions=['%(sysconfdir)s/gdm/Xsession'])


