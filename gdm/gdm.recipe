#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadRecipe('rpmpackage', label='foresight.rpath.org@fl:2-devel')
loadRecipe('gnomepackage', label='foresight.rpath.org@fl:2-devel')
class Gdm(RPMPackageRecipe,GnomePackageRecipe):

    name = 'gdm'
    version = '2.22.0'
    rpmRelease = '5.fc9'
    rpmURL='http://koji.fedoraproject.org/packages/%(name)s/%(version)s/%(rpmRelease)s/src/'

    buildRequires = [ 'libglade:devel', 'pango:devel', 'gtk:devel', 'libgnomeui:devel', 'libgnomecanvas:devel', 'librsvg:devel', 'libxml2:devel', 'fontconfig:devel', 'libgsf:devel', 'libcroco:devel', 'attr:devel', 'rarian:runtime', 'desktop-file-utils:runtime', 'GConf:devel', 'ORBit2:devel', 'atk:devel', 'cairo:devel', 'freetype:devel', 'glib:devel', 'gnome-keyring:devel', 'gnome-vfs:devel', 'libart_lgpl:devel', 'libbonobo:devel', 'libbonoboui:devel', 'libgnome:devel', 'libpng:devel', 'popt:devel', 'tcp_wrappers:devel', 'gettext:runtime', 'gtk:runtime', 'perl:runtime', 'usermode:runtime', 'zenity:runtime', 'libX11:devel', 'libXau:devel', 'libXdmcp:devel', 'libXext:devel', 'libXi:devellib', 'libXinerama:devel', 'libXrender:devel','libdmx:devellib', 'gnome-doc-utils:devel', 'gnome-doc-utils:runtime', 'audit:devel', 'shadow:runtime', 'automake:runtime', 'autoconf:runtime', 'libtool:devel',  'pkgconfig:devel' , 'm4:runtime', 'expat:devel', 'pam:devel', 'dbus-glib:runtime', 'GConf:runtime', 'xorg-server:runtime', 'PolicyKit-gnome:devel', 'PolicyKit:devel', 'gnome-panel:devel', 'iso-codes:devellib' ]

    extraConfig = ' --with-pam --with-pam-prefix=%(sysconfdir)s'
    extraConfig += ' --enable-console-helper  --without-selinux --with-console-kit'
    extraConfig += ' --disable-scrollkeeper --with-pam-dir=/lib/security'
    extraConfig += ' --with-dbus-sys=%(sysconfdir)s/dbus-1/system.d'
    extraConfig += ' --with-dbus-services=%(datadir)s/dbus-1/services'
    extraConfig += ' --with-custom-conf=%(sysconfdir)s/gdm/custom.conf'
    extraConfig += ' --with-defaults-conf=%(datadir)s/gdm/defaults.conf'

    rpmPatches = [  'xkb-groups.patch',
                    'gdm-silence-debugging.patch',
                    # Fix Chinese date/time display (fixed in upstream svn)
                    'zh.patch',
                    # https://bugzilla.redhat.com/show_bug.cgi?id=445631
                    'gdm-2.22.0-fix-language-selector.patch',
                    # https://bugzilla.redhat.com/show_bug.cgi?id=445613
                    'gdm-2.22.0-fix-pam-mkhomedir.patch',
                 ]

    def setup(r):
        RPMPackageRecipe.unpack(r)
        r.addSource('gdm-pam.keyringed', dest='config/gdm')
        r.addSource('gdm.conf-custom')
        r.addPatch('logo.patch')

        # evaluate extraConfig's sysconfdir before setting new value
        r.extraConfig = r.extraConfig % r.macros
        #r.macros.sysconfdir= '%(sysconfdir)s/X11'

        GnomePackageRecipe.build(r)
        GnomePackageRecipe.install(r)
        # add trailling newline, in order for conary-policy to  be happy...
        r.Run(""" echo '' >> %(destdir)s%(sysconfdir)s/gdm/Xsession """)
        r.Move('%(localstatedir)s/lib/gdm/.*', '%(localstatedir)s/gdm')
        r.SetModes('%(localstatedir)s/gdm', 01770)
        r.SetModes('%(localstatedir)s/gdm/.gconf.mandatory', 01750)
        r.SetModes('%(localstatedir)s/gdm/.gconf.mandatory/.*', 01640)
        r.SetModes('%(localstatedir)s/gdm/.gconf.path', 01640)
        r.SetModes('%(localstatedir)s/run/gdm', 01777)
        r.Ownership('root', 'gdm', '%(localstatedir)s/gdm')
        r.Ownership('root', 'gdm', '%(localstatedir)s/gdm')
        r.Ownership('root', 'gdm', '%(localstatedir)s/gdm/.gconf.mandatory')
        r.Ownership('root', 'gdm', '%(localstatedir)s/gdm/.gconf.mandatory/.*')
        r.Ownership('root', 'gdm', '%(localstatedir)s/log/gdm')


        # remove the gdm Xsession as we're using the xdm one
        r.Remove('%(sysconfdir)s/gdm/Xsession')
        # FIXME: came back here to check once i clean xdm side
        r.Symlink('%(sysconfdir)s/X11/xdm/Xsession', '%(sysconfdir)s/gdm/Xsession')

        # remove the gnome session file, since we don't use it anymore
        #r.Remove('%(sysconfdir)s/dm/Sessions/gnome.desktop')

        # remove the other gnome session file, since we put it in gnome-session
        #r.Remove('%(datadir)s/xsessions')

        r.MakeDirs('%(sysconfdir)s/gdm/{Init,PreSession,PostSession}')
        r.MakeDirs('%(localstatedir)s/log/gdm')


        r.PackageSpec('gdm-user-switch-applet',
            '%(libexecdir)s/gdm-user-switch-applet')
        r.PackageSpec('gdm-user-switch-applet', 
            '%(libdir)s/bonobo/servers/GNOME_FastUserSwitchApplet.server')
        r.PackageSpec('gdm-user-switch-applet', 
            '%(datadir)s/gnome-2.0/ui/GNOME_FastUserSwitchApplet.xml')

        r.ExcludeDirectories(exceptions=[
            '%(localstatedir)s/log/gdm',
            '%(sysconfdir)s/gdm/{Init,PreSession,PostSession}'
            ])
        r.DanglingSymlinks(exceptions=['%(sysconfdir)s/gdm/Xsession'])


