#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadRecipe('gnomepackage.recipe')
class Gdm(GnomePackageRecipe):

    buildRequires = [ 'libglade:devel', 'pango:devel', 'gtk:devel',
        'libgnomeui:devel', 'libgnomecanvas:devel', 'librsvg:devel',
        'libxml2:devel', 'fontconfig:devel', 'libgsf:devel',
        'libcroco:devel', 'attr:devel', 'scrollkeeper:runtime',
        'desktop-file-utils:runtime', 'GConf:devel', 'ORBit2:devel',
        'atk:devel', 'cairo:devel', 'freetype:devel', 'glib:devel',
        'gnome-keyring:devel', 'gnome-vfs:devel', 'libart_lgpl:devel',
        'libbonobo:devel', 'libbonoboui:devel', 'libgnome:devel',
        'libpng:devel', 'popt:devel', 'tcp_wrappers:devel', 
        'gettext:runtime', 'gtk:runtime', 'perl:runtime',
        'usermode:runtime', 'zenity:runtime',
        'libX11:devel', 'libXau:devel', 'libXdmcp:devel', 
        'libXext:devel', 'libXi:devel', 'libXinerama:devellib',
        'libXrender:devel','libdmx:devel', 'gnome-doc-utils:devel' ]

    extraConfig = GnomePackageRecipe.extraConfig
    if Use.pam:
        buildRequires.append('pam:devel')
        extraConfig += ' --with-pam --with-pam-prefix=%(sysconfdir)s'
    else:
        extraConfig += ' --without-pam'
        
    if Use.selinux:
        buildRequires.append('libselinux:devel')
        extraConfig += ' --with-selinux'
    else:
        extraConfig += ' --without-selinux'
        
    extraConfig += ' --enable-console-helper'
        
    name = 'gdm'
    version = '2.16.4'
    
    docs = GnomePackageRecipe.docs
    docs.append('TODO')

    def unpack(r):
        GnomePackageRecipe.unpack(r)
        r.addArchive('Foresight-GDM-0.03.tar.bz2',
            dir='%(datadir)s/gdm/themes/')
        r.addSource('gdm.conf-custom')
        r.Replace('Exec=', 'Exec=gksudo ', 'gui/gdmsetup.desktop')
        r.Replace('Exec=', 'Exec=gksudo ', 'gui/gdmsetup.desktop.in.in')


    def build(r):
        # evaluate extraConfig's sysconfdir before setting new value
        r.extraConfig = r.extraConfig % r.macros
        r.macros.sysconfdir= '%(sysconfdir)s/X11'
        GnomePackageRecipe.build(r)

    def install(r):
        GnomePackageRecipe.install(r)
        r.Install('gdm.conf-custom','%(sysconfdir)s/gdm/custom.conf')
        r.ExcludeDirectories(exceptions=['%(localstatedir)s/log/gdm'])
        r.SetModes('%(localstatedir)s/gdm', 01770)
        r.Ownership('root', 'gdm', '%(localstatedir)s/gdm')
