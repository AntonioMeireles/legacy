#
# Copyright (c) 2004 Specifix, Inc.
# All rights reserved
#

loadRecipe('gnomepackage.recipe', label='conary.rpath.com@rpl:devel')
class Gdm(GnomePackageRecipe):

    buildRequires = GnomePackageRecipe.buildRequires
    buildRequires.extend([ 'libglade:devel', 'pango:devel', 'gtk:devel',
                           'libgnomeui:devel', 'libgnomecanvas:devel',
                           'librsvg:devel', 'libxml2:devel',
                           'fontconfig:devel', 'libgsf:devel',
                           'libcroco:devel', 'attr:devel',
                           'scrollkeeper:runtime' ])
                   
    extraConfig = GnomePackageRecipe.extraConfig
    if Use.pam:
        buildRequires.append('pam:devel')
        extraConfig += ' --with-pam --with-pam-prefix=%(sysconfdir)s'
    else:
        extraConfig += ' --without-pam'
        
    if Use.selinux:
        buildRequires.append('libselinux:devel')
        extraConfig += ' --with-selinux'
    else:
        extraConfig += ' --without-selinux'
        
    extraConfig += ' --enable-console-helper'
        
    name = 'gdm'
    version = '2.6.0.9'
    
    docs = GnomePackageRecipe.docs
    docs.append('TODO')

    def unpack(r):
	GnomePackageRecipe.unpack(r)
	r.addArchive('http://src.vandine.org/themes/gdm/Foresight-0.01.tar.bz2', dir='%(maindir)s/gui/greeter/themes/')
        r.Replace('Exec=','Exec=gksudo ','gui/gdmsetup.desktop.in')
        r.Replace('Categories=Application;System;SystemSetup;X-Red-Hat-Base;','Categories=Application;System;Settings','gui/gdmsetup.desktop.in')
	r.Replace('#MinimalUID=100','MinimalUID=500','config/gdm.conf.in')

    def build(r):
	r.addAction("sed -i 's/#GraphicalTheme=circles/GraphicalTheme=Foresight/' config/gdm.conf.in")
	r.addAction("sed -i 's/#UseCirclesInEntry=false/UseCirclesInEntry=true/' config/gdm.conf.in")
	r.addAction("sed -i 's/#Greeter=@EXPANDED_BINDIR@\/gdmlogin/Greeter=@EXPANDED_BINDIR@\/gdmgreeter/' config/gdm.conf.in")
	r.addAction("sed -i 's/#BackgroundColor=#76848F/BackgroundColor=#404760/' config/gdm.conf.in")
	r.addAction("sed -i 's/gui\/greeter\/themes\/happygnome\/Makefile/gui\/greeter\/themes\/Foresight\/Makefile gui\/greeter\/themes\/happygnome\/Makefile/' configure")
	r.addAction("sed -i 's/SUBDIRS = circles/SUBDIRS = circles Foresight/' gui/greeter/themes/Makefile.{am,in}")
	r.Replace('#GtkTheme=Default','GtkTheme=Clearlooks','config/gdm.conf.in')
	# evaluate extraConfig's sysconfdir before setting new value
	r.extraConfig = r.extraConfig % r.macros
	r.macros.sysconfdir= '%(sysconfdir)s/X11'
	GnomePackageRecipe.build(r)

    def install(r):
	GnomePackageRecipe.install(r)

	r.ExcludeDirectories(exceptions=['%(localstatedir)s/log/gdm'])
	r.SetModes('%(localstatedir)s/gdm', 01770)
	r.Ownership('root', 'gdm', '%(localstatedir)s/gdm')
        r.User('gdm', 42, homedir='/var/gdm')
        r.Requires('/usr/bin/consolehelper', '%(bindir)s/gdmsetup')
