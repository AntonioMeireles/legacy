#
# Copyright (c) 2004-2005 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class PilotLink(CPackageRecipe):
    buildRequires = [ 'readline:devel', 'ncurses:devel', 'libpng:devel',
                      'libtool:runtime', 'gcc:devel' ]

    if Use.perl:
        buildRequires.append('perl:runtime')

    name = 'pilot-link'
    version = '0.11.8'

    def setup(r):
        srpm = 'ftp://download.fedora.redhat.com/pub/fedora/linux/core/2/SRPMS/pilot-link-0.11.8-3.1.src.rpm'
        r.addArchive('pilot-link-%(version)s.tar.bz2', rpm=srpm)

        r.addPatch('pilot-link-0.11.0-perlmd5.patch', rpm=srpm, use=Use.perl)
        r.addPatch('pilot-link-0.11.0-perlpollute.patch', rpm=srpm, use=Use.perl)
        r.addPatch('pilot-link-0.11.2-malsync.patch', rpm=srpm, use=Use.perl)

        extraConfig = '--with-python=no --with-itcl=no --with-tk=no '\
                      '--with-tcl=no --with-java=no --with-cpp=yes ' \
                      '--with-perl=no' # always disable perl and build by hand.

        r.Configure(extraConfig)
        r.Make('LIBTOOL=%(bindir)s/libtool')

        if Use.perl:
            r.Run("""cd bindings/Perl && sed -i 's|^\$libdir =.*|\$libdir = "../../libpisock/.libs/";|g' Makefile.PL""")
            r.Run('cd bindings/Perl && perl Makefile.PL PREFIX=%(prefix)s INSTALLDIRS=vendor')
            r.Make(subDir='bindings/Perl')

        r.MakeInstall('LIBTOOL=%(bindir)s/libtool')
        r.MakeInstall(subDir='doc/man')

        if Use.perl:
            r.MakeInstall(subDir='bindings/Perl')

            r.Remove('%(libdir)s/perl5/vendor_perl/*/*/auto/PDA/Pilot/Pilot.bs')
            r.Remove('%(libdir)s/perl5/site_perl/*/*/*/PDA/Pilot/.packlist')
