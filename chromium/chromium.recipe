class Chromium(PackageRecipe):
    name = 'chromium'
    version = '40915'

    buildRequires = ['depot_tools:runtime',
                     'nss:devellib',
                     'nspr:devellib',
                     'gcc-c++:runtime',
                     'gcc:runtime',
                     'bison:runtime',
                     'flex:runtime',
                     'gperf:runtime',
                     'pkgconfig:devel',
                     'glib:devellib',
                     'gtk:devellib',
                     'msttcorefonts:data',
                     'freetype:devellib',
                     'freetype:devel',
                     'cairo:devellib',
                     'dbus:devellib',
                     'subversion:runtime',
                     'GConf:devellib',
                     'gcc:devel',
                     'xextproto:devel',
                     'util-linux:runtime',
                     'alsa-lib:devel',
                     'libXext:devellib',
                     'desktop-file-utils:runtime',
                     'mozilla-filesystem:runtime',
                     'make:runtime',
                     'gettext:runtime', 
                     'intltool:runtime',
                     'bzip2:devel', 
                     'libjpeg:devel',
                     'scrnsaverproto:devel',
                     'Mesa:devel',
                     'libXScrnSaver:devel',
                     'dbus-glib:devellib',
                     'vim:runtime', # For debugging...
                    ]

    def setup(r):
        r.addArchive('http://build.chromium.org/buildbot/archives/'
                     'chromium.r37686.tgz')

        # Updates the code that was extracted to a specific svn revision.
        r.Run("GYP_GENERATORS=make GYP_DEFINES='werror=' " + \
              "/opt/google/depot_tools/gclient update --force --revision=src@%s" % \
              r.version, dir='chrome-svn/tarball/chromium')

        r.MakeDirs('%(builddir)s/chrome-svn/tarball/chromium/src/out')

        # Build the makefiles.
        if Arch.x86_64:
            r.Symlink('%(builddir)s/chrome-svn/tarball/chromium/src/out',
                      '%(builddir)s/chrome-svn/tarball/chromium/src/out64')
            r.Run("GYP_GENERATORS=make GYP_DEFINES='werror= target_arch=x64' "
                  "/opt/google/depot_tools/gclient runhooks --force",
                  dir='chrome-svn/tarball/chromium')
        else:
            r.Symlink('%(builddir)s/chrome-svn/tarball/chromium/src/out',
                      '%(builddir)s/chrome-svn/tarball/chromium/src/out32')

        # Make.
        r.Run('/usr/bin/make -j5 chrome BUILDTYPE=Release',
              dir='chrome-svn/tarball/chromium/src')

        # Install.
        r.addSource('chromium-browser')
        r.Replace('@@LIBDIR@@', '%(libdir)s', 'chromium-browser')
        r.Install('chromium-browser', '%(bindir)s/chromium-browser')

        buildLoc = 'chrome-svn/tarball/chromium/src/out/Release/'
        artifacts = ['chrome.pak', 'locales', 'resources', 
                     'xdg-settings', 'chrome']

        r.MakeDirs('%(libdir)s/chromium-browser')
        for artifact in artifacts:
            r.Install(buildLoc + artifact, '%(libdir)s/chromium-browser/')
      
        # r.Doc(buildLoc + 'chromium-browser.1')
        r.addSource('chromium-browser.desktop')
        r.Desktopfile('chromium-browser.desktop')

        r.Install('chrome-svn/tarball/chromium/src/out/Release/'
                  'product_logo_48.png', 
                  '%(datadir)s/pixmaps/chromium-browser.png')

        # Chromium doesn't look in the mozilla plugins dir by default.
        r.Symlink('%(libdir)s/mozilla/plugins',
                  '%(libdir)s/chromium-browser/plugins')
