import datetime
class Chromium(AutoPackageRecipe):
    name = 'chromium'
    baseVersion = '17.0.963.64' 
    version = baseVersion + '+' + datetime.date.today().strftime("%Y.%m.%d")

    buildRequires = ['depot_tools:runtime',
                     'nss:devel',
                     'nspr:devel',
                     'gcc-c++:runtime',
                     'gcc:runtime',
                     'bison:runtime',
                     'flex:runtime',
                     'gperf:runtime',
                     'pkgconfig:devel',
                     'glib:devel',
                     'gtk:devel',
                     'msttcorefonts:data',
                     'freetype:devel',
                     'cairo:devel',
                     'dbus:devel',
                     'subversion:runtime',
                     'GConf:devel',
                     'gcc:devel',
                     'xextproto:devel',
                     'util-linux:runtime',
                     'alsa-lib:devel',
                     'libXext:devel',
                     'desktop-file-utils:runtime',
                     'mozilla-filesystem:runtime',
                     'make:runtime',
                     'gettext:runtime',
                     'intltool:runtime',
                     'bzip2:devel',
                     'libjpeg:devel',
                     'scrnsaverproto:devel',
                     'Mesa:devel',
                     'libXScrnSaver:devel',
                     'dbus-glib:devel',
                     'cups:devel',
                     'libgnome-keyring:devel',
                     'gnutls:devel', 
                     'libgcrypt:devel',
                     'libgpg-error:devel',
                     'rsync:runtime',
                     'libevent:devel',
                     'yasm:runtime',
                     'libxml2:devel',
                     'libxslt:devel',
                     'libXtst:devel',
                     'libXi:devel',
                     'which:runtime',
                     'sqlite:devel',
                     'icu:devel',
                     'libvpx:devel',
                     'flac:devel',
                     'ffmpeg:devel',
                     'pam:devel',
                     'libXinerama:devel',
                     'speex:devel',
                     'pulseaudio:devel',
                     'unzip:runtime',
                     'elfutils:devel',
                     'libelf:devel',
                    ]

    if Arch.x86_64:
        # NaCl build expects it ...
        buildRequires += ['zlib:lib[is:x86]']


    def setup(r):
        r.addArchive('http://gsdview.appspot.com/chromium-browser-official/%(name)s-'+ r.baseVersion +'.tar.bz2')
        r.addArchive('http://commondatastorage.googleapis.com/nativeclient-mirror/nacl/nacl_sdk/nacl_sdk.zip',
                     dir = '%%(name)s-%s' % r.baseVersion)
        r.addPatch('chromium-media-no-sse-r0.patch')
        r.addPatch('nacl-cflags-remove-fstack-protector.patch', dir = 'native_client')

        # needed in order to NaCl build to proceed
        r.macros.cflags  = re.sub('-fstack-protector', '', r.macros.cflags)

        r.macros.gypDefines =  ('release_extra_cflags=\"%(cflags)s \" '
                                'no_strict_aliasing=1 '
                                'use_system_xdg_utils=1 '
                                'use_system_zlib=1 '
                                ##  system's ffmpeg plus system's libvpx forces disabling of 
                                ## remoting. upstream linking mess
                                'use_system_libvpx=0 '
                                # system's one works but flacky ...
                                'use_system_ffmpeg=0 '
                                # until http://crbug.com/22208
                                'use_system_sqlite=0 '
                                # until https://bugzilla.mozilla.org/show_bug.cgi?id=547312
                                # http://crbug.com/58087
                                'use_system_ssl=0 '

                                'ffmpeg_branding=Chrome '
                                'proprietary_codecs=1 '

                                # we are at icu-4.4.x. builtin at 4.6
                                'use_system_icu=0 '
                                'use_cups=1 '
                                # system's libjpeg induces rendering messes
                                'use_system_libjpeg=0 '
                                'use_system_libxml=1 '
                                'use_system_libxslt=1 '
                                'use_system_bzip2=1 '
                                'use_system_flac=1 '
                                'use_system_speex=1 '
                                'use_system_libevent=1 '
                                'use_system_libpng=1 ' 
                                'linux_link_gnome_keyring=1 '
                                'use_gconf=1 '
                                'use_cups=1 '
                                'werror= '
                                'gcc_version=44 '
                                'use_system_yasm=1 '
                                # 
                                'linux_strip_binary=1 '
                                'remove_webcore_debug_symbols=1 '
                                #
                                'linux_sandbox_path=%(libdir)s/chromium-browser/chrome_sandbox '
                                'disable_sse2=1 '
                                # to get around build issues. 
                                'v8_use_snapshot=0 '
                                )
        if Arch.x86_64:
            r.macros.gypDefines += 'target_arch=x64 '
        else:
            r.macros.gypDefines += 'target_arch=ia32 '


        r.MakeDirs('out')
        # Disable prefixing to allow linking against system zlib
        r.Replace('^#include "mozzconf.h"$',
                  '',
                  # 'chromium_build/third_party/zlib/zconf.h')
                  'third_party/zlib/zconf.h')

        r.ManualConfigure('update pepper_17',
                          configureName = 'naclsdk',
                          dir = 'nacl_sdk')
        r.Symlink('../../nacl_sdk/pepper_17/toolchain/linux_x86_newlib',
                  'native_client/toolchain/linux_x86_newlib')

        r.Run("GYP_DEFINES=\'%(gypDefines)s\'  GYP_GENERATORS=make "
              "build/gyp_chromium "
              " build/all.gyp --depth=. ",
              )

        # Make.
        for t in [ 'chrome',
                   'chrome_sandbox',
                   'chromedriver',]:
            r.Make(t + ' BUILDTYPE=Release V=1 ')

        # Install.
        r.addSource('chromium-browser',
                    macros=True )
        r.Install('chromium-browser',
                  '%(bindir)s/chromium-browser',
                  mode = 0755)
        r.Symlink('%(bindir)s/chromium-browser',
                  '%(bindir)s/chromium')

        buildLoc = 'out/Release/'
        artifacts = [ 'chrome.pak',
                      'resources.pak',
                      'locales',
                      'resources', 
                      'chrome',
                      'chrome_sandbox',
                      'chromedriver',
                      # bellow needed while we use internal ffmpeg
                      'libffmpegsumo.so',
                      # 'ffmpegsumo_nolink'
                      # NaCl bits
                      'nacl_helper',
                      'nacl_helper_bootstrap',
                      'libppGoogleNaClPluginChrome.so',
                      'nacl_irt_x86_*.nexe',
                      ]

        r.MakeDirs('%(libdir)s/chromium-browser')

        for artifact in artifacts:
            r.Install(buildLoc + artifact,
                      '%(libdir)s/chromium-browser/')

        r.SetModes('%(libdir)s/chromium-browser/chrome_sandbox', 04755)

        r.addSource('chromium-browser.desktop')
        r.Desktopfile('chromium-browser.desktop')
        # closes FL-2783
        r.addSource('chromium-browser.xml', 
                    dir = '%(datadir)s/gnome-control-center/default-apps/',
                    mode = 0644)

        r.Install(buildLoc + 'chrome.1',
                  '%(mandir)s/man1/%(name)s.1',
                  mode = 0644)

        for size in ['16', '22', '24', '32',
                     '48', '64', '128', '256',]:
            r.Install('chrome/app/theme/chromium/product_logo_'+size+'.png',
                      '%(datadir)s/icons/hicolor/' + size + 'x' + size + '/apps/%(name)s-browser.png',
                      mode = 0644)

        r.Symlink('%(datadir)s/icons/hicolor/48x48/apps/%(name)s-browser.png', 
                  '%(datadir)s/pixmaps/chromium-browser.png')

        # Chromium doesn't look in the mozilla plugins dir by default.
        r.Symlink('%(libdir)s/mozilla/plugins',
                  '%(libdir)s/chromium-browser/plugins')
        
        # when using system ffmpeg
        # Chromium looks for these in its folder
        # See media_posix.cc and base_paths_linux.cc
        #for x in ['libavcodec.so.52', 
        #          'libavformat.so.52',
        #          'libavutil.so.50']:
        #    r.Symlink('%(libdir)s/'+x, '%(libdir)s/chromium-browser/'+x)
