class Chromium(PackageRecipe):
    name = 'chromium'
    version = '28808'

    buildRequires = ['depot_tools:runtime',
                     'nss:devellib',
                     'nspr:devellib',
                     'gcc-c++:runtime',
                     'gcc:runtime',
                     'bison:runtime',
                     'flex:runtime',
                     'gperf:runtime',
                     'pkgconfig:devel',
                     'glib:devellib',
                     'gtk:devellib',
                     'msttcorefonts:data',
                     'freetype:devellib',
                     'freetype:devel',
                     'cairo:devellib',
                     'dbus:devellib',
                     'subversion:runtime',
                     'GConf:devellib',
                     'gcc:devel',
                     'xextproto:devel',
                     'util-linux:runtime',
                     'alsa-lib:devel',
                     'libXext:devellib',
                     'desktop-file-utils:runtime',
                     'mozilla-filesystem:runtime',
                     'make:runtime',
                     # For debugging...
                     'vim:runtime',
                    ]

    def setup(r):
        r.addArchive('http://build.chromium.org/buildbot/archives/'
                     'chromium.r28096.tgz')

        r.addSource('no-Werror.patch')
        r.addPatch('no-Werror.patch')

        # Updates the code that was extracted to a specific svn revision.
        r.Run('/opt/google/depot_tools/gclient update --revision=src@%s' % \
              r.version, dir='chrome-svn/tarball/chromium')

        r.MakeDirs('%(builddir)s/chrome-svn/tarball/chromium/src/out')

        # Build the makefiles.
        if Arch.x86_64:
            r.Symlink('%(builddir)s/chrome-svn/tarball/chromium/src/out',
                      '%(builddir)s/chrome-svn/tarball/chromium/src/out64')
            r.Run("GYP_GENERATORS='make' GYP_DEFINES='target_arch=x64' "
                  "python ./src/build/gyp_chromium",
                  dir='chrome-svn/tarball/chromium')
        else:
            r.Symlink('%(builddir)s/chrome-svn/tarball/chromium/src/out',
                      '%(builddir)s/chrome-svn/tarball/chromium/src/out32')
            r.Run("GYP_GENERATORS='make' "
                  "python ./src/build/gyp_chromium",
                  dir='chrome-svn/tarball/chromium')

        # Workaround for:
        # http://code.google.com/p/chromium/issues/detail?id=19854
        r.Run('sed -e "/cmd_v8_snapshot_run_mksnapshot/ '
                      's|\$(builddir)|\$(rootdir)/\\0|g" '
              '-i v8/tools/gyp/v8_snapshot.mk',
              dir='chrome-svn/tarball/chromium/src')

        r.Run('sed -e "/cmd_ncvalidate_ncdecode_table =/ '
              's|\$(builddir)|\$(rootdir)/\\0|g" '
              '-i  native_client/src/trusted/validator_x86/ncvalidate.mk',
              dir='chrome-svn/tarball/chromium/src')
        r.Run('sed -e "/cmd_ncvalidate_ncdecode_tablegen =/ '
              's|\$(builddir)|\$(rootdir)/\\0|g" '
              '-i  native_client/src/trusted/validator_x86/ncvalidate.mk',
              dir='chrome-svn/tarball/chromium/src')
        r.Run('sed -e "/cmd_ncvalidate_ncop_expr_node_flag/ '
              's|\$(builddir)|\$(rootdir)/\\0|g" '
              '-i  native_client/src/trusted/validator_x86/ncvalidate.mk',
              dir='chrome-svn/tarball/chromium/src')

        r.Run('sed -e "/cmd_service_runtime_x86_header_gen/ '
              's|\$(builddir)|\$(rootdir)/\\0|g" '
              '-i  native_client/src/trusted/service_runtime/arch/x86/'
              'service_runtime_x86.mk ',
              dir='chrome-svn/tarball/chromium/src')
        r.Run('sed -e "/cmd_service_runtime_x86_sheader_gen/ '
              's|\$(builddir)|\$(rootdir)/\\0|g" '
              '-i  native_client/src/trusted/service_runtime/arch/x86/'
              'service_runtime_x86.mk ',
              dir='chrome-svn/tarball/chromium/src')

        # Make.
        r.Run('/usr/bin/make -r -j8 chrome chrome_sandbox BUILDTYPE=Release '
              'builddir="out/Release"',
              dir='chrome-svn/tarball/chromium/src')


        # Install.
        r.addSource('chromium-browser')
        r.Replace('@@LIBDIR@@', '%(libdir)s', 'chromium-browser')
        r.Install('chromium-browser', '%(bindir)s/chromium-browser')

        buildLoc = 'chrome-svn/tarball/chromium/src/out/Release/'
        artifacts = ['chrome.pak', 'locales', 'resources', 'themes',
                     'xdg-settings', 'chrome', 'chrome_sandbox']

        r.MakeDirs('%(libdir)s/chromium-browser')
        for artifact in artifacts:
            r.Install(buildLoc + artifact, '%(libdir)s/chromium-browser/')
      
        # r.Doc(buildLoc + 'chromium-browser.1')
        r.addSource('chromium-browser.desktop')
        r.Desktopfile('chromium-browser.desktop')

        r.Install('chrome-svn/tarball/chromium/src/out/Release/'
                  'product_logo_48.png', 
                  '%(datadir)s/pixmaps/chromium-browser.png')

        # Chromium doesn't look in the mozilla plugins dir by default.
        r.Symlink('%(libdir)s/mozilla/plugins',
                  '%(libdir)s/chromium-browser/plugins')
