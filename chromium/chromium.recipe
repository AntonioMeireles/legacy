import datetime
class Chromium(AutoPackageRecipe):
    name = 'chromium'
    baseTarballRevision = '57968'
    svnVersion = '61784'
    # reconstruct real version from chromium/src/chrome/VERSION
    # version = '7.0.548.0+r' + svnVersion + '+' + datetime.date.today().strftime("%Y.%m.%d")
    baseVersion = '7.0.517.43' 
    version = baseVersion + '+' + datetime.date.today().strftime("%Y.%m.%d")

    buildRequires = ['depot_tools:runtime',
                     'nss:devellib',
                     'nspr:devellib',
                     'gcc-c++:runtime',
                     'gcc:runtime',
                     'bison:runtime',
                     'flex:runtime',
                     'gperf:runtime',
                     'pkgconfig:devel',
                     'glib:devel',
                     'gtk:devel',
                     'msttcorefonts:data',
                     'freetype:devel',
                     'cairo:devel',
                     'dbus:devellib',
                     'subversion:runtime',
                     'GConf:devel',
                     'gcc:devel',
                     'xextproto:devel',
                     'util-linux:runtime',
                     'alsa-lib:devel',
                     'libXext:devel',
                     'desktop-file-utils:runtime',
                     'mozilla-filesystem:runtime',
                     'make:runtime',
                     'gettext:runtime',
                     'intltool:runtime',
                     'bzip2:devel',
                     'libjpeg:devel',
                     'scrnsaverproto:devel',
                     'Mesa:devel',
                     'libXScrnSaver:devel',
                     'dbus-glib:devel',
                     'cups:devel',
                     'libgnome-keyring:devel',
                     'gnutls:devel', 
                     'libgcrypt:devel',
                     'libgpg-error:devel',
                     'rsync:runtime',
                     'libevent:devel',
                     'yasm:runtime'
                    ]

    def setup(r):
        r.addArchive('http://build.chromium.org/buildbot/official/%(name)s-'+ r.baseVersion +'.tar.bz2')

        r.macros.gypDefines =  (''
                                'no_strict_aliasing=1  '
                                'use_system_zlib=1 '
                                'use_system_libjpeg=1 '
                                'use_system_libxml=0 '
                                'use_system_libxslt=0 '
                                'use_system_bzip2=1 '
                                'use_system_libevent=1 '
                                'use_system_libpng=1 ' 
                                'linux_link_gnome_keyring=1 ' 
                                # 'use_system_ffmpeg=1 '
                                'proprietary_codecs=1 '
                                'linux_use_tcmalloc=0 '
                                'werror= gcc_version=41 '
                                '-Dlinux_strip_binary=1 '
                                '-Duse_system_yasm=1 '
                                # until https://bugzilla.mozilla.org/show_bug.cgi?id=547312
                                '-Duse_system_ssl=0 '
                                )
        if Arch.x86_64:
            r.macros.gypDefines += 'target_arch=x64 '
            outArch = '64'
        else:
            r.macros.gypDefines += 'target_arch=ia32 '
            outArch = '32'

        r.MakeDirs('out')
        # Disable prefixing to allow linking against system zlib
        r.Replace('^#include "mozzconf.h"$',
                  '',
                  # 'chromium_build/third_party/zlib/zconf.h')
                  'third_party/zlib/zconf.h')

        r.Run("GYP_DEFINES=\'%(gypDefines)s\'  GYP_GENERATORS=make "
               "build/gyp_chromium "
               " build/all.gyp --depth=. ",
              )

        # Make.
        r.Make('chrome V=1 BUILDTYPE=Release ')
               

        # Install.
        r.addSource('chromium-browser')
        r.Replace('@@LIBDIR@@', '%(libdir)s', 'chromium-browser')
        r.Install('chromium-browser', '%(bindir)s/chromium-browser')

        buildLoc = 'out/Release/'
        artifacts = ['chrome.pak', 'locales', 'resources.pak', 'resources', 
                     'xdg-settings', 'chrome', 'libffmpegsumo.so']

        r.MakeDirs('%(libdir)s/chromium-browser')
        for artifact in artifacts:
            r.Install(buildLoc + artifact, '%(libdir)s/chromium-browser/')
      
        # r.Doc(buildLoc + 'chromium-browser.1')
        r.addSource('chromium-browser.desktop')
        r.Desktopfile('chromium-browser.desktop')

        r.Install('out/Release/'
                  'product_logo_48.png', 
                  '%(datadir)s/pixmaps/chromium-browser.png')

        # Chromium doesn't look in the mozilla plugins dir by default.
        r.Symlink('%(libdir)s/mozilla/plugins',
                  '%(libdir)s/chromium-browser/plugins')
