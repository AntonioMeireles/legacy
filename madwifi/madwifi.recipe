#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class MadWIFI(AutoPackageRecipe):

    name = 'madwifi'
    version = '0.10.5.6_r4068_20090705'

    buildRequires = [  ]

    def unpack(r):
        r.macros.kver = os.uname()[2]
        r.macros.version = r.version.replace('_','-')
        r.addArchive('http://snapshots.madwifi-project.org/madwifi-hal-0.10.5.6/madwifi-hal-%(version)s.tar.gz')


    def configure(r):
        pass

    def make(r):
        r.Make(dir = 'tools')

    def makeinstall(r):

        r.MakeInstall('BINDIR=%(bindir)s MANDIR=%(mandir)s', dir = 'tools')
        r.Copy('include', '%(includedir)s/%(name)s')
        r.Copy('net80211/*.h', '%(includedir)s/%(name)s/net80211/')

        # The kernel side is in madwifi-kernel, and we need the kernel
        # modules that match this version exactly
        r.Requires('madwifi-kernel:runtime(%(version)s)', 
                   '%(bindir)s/ath_info')

        # override 
        r.Create('%(sysconfdir)s/modprobe.d/madwifi', mode = 0644,
                 contents = """
alias wifi0 ath_pci
alias ath0 ath_pci
options ath_pci autocreate=sta
""")

        r.Create('%(sysconfdir)s/modprobe.d/blacklist-ath5k', mode = 0644,
                 contents = """
blacklist ath5k
""")
