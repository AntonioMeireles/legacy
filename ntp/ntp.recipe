#
# Copyright (c) 2004-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Ntp(AutoPackageRecipe):
    name = 'ntp'
    version = '4.2.4p8'

    # without perl:runtime, @PATH_PERL@ is expanded to the empty string
    buildRequires = [ 'perl:runtime', 'perl:lib', 'ncurses:devel',
                      'readline:devel', 'openssl:devel',
                      'w3c-libwww:devel', 'libelf:devel' ]

    def unpack(r):
        r.macros.ntpdir = '%(sysconfdir)s/ntp'
        # Current Source: http://ntp.isc.org/bin/view/Main/SoftwareDownloads
        r.addArchive('http://www.eecis.udel.edu/~ntp/ntp_spool/ntp4/ntp-4.2/')
        # caddr_t not defined in md5.h
        r.addPatch('ntp-4.2.0-caddrt.patch')
        r.addPatch('ntp-4.2.4p8-sntp-manpage.patch')
        r.addSource('ntpd.sysconfig', dest='%(sysconfdir)s/sysconfig/ntpd',
                    mode=0644)
        r.addSource('ntp.conf', dest='%(sysconfdir)s/ntp.conf', mode=0644)
        r.addSource('keys', dest='%(ntpdir)s/keys', mode=0600)
        r.addSource('rc.ntpd', dest='%(initdir)s/ntpd', mode=0755, macros=True)

    def policy(r):
        r.MakeDirs('%(localstatedir)s/lib/ntp')
        r.Ownership('ntp', 'ntp', '%(localstatedir)s/lib/ntp')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/ntp')
        r.TagSpec('initscript', '%(initdir)s/')
        r.Doc('scripts', 'conf', 'html')

        # Move ntp-wait and ntptrace to the :util package so that people
        # building appliances do not have a perl requirement just to run ntp.
        r.PackageSpec('%(name)s-utils', '%(bindir)s/(ntp-wait|ntptrace)')
        r.Requires('%(bindir)s/(ntp-wait|ntptrace)', '%(name)s:runtime')

        r.Requires('%(essentialbindir)s/sed', '%(initdir)s/ntpd')
        r.Requires('%(essentialbindir)s/awk', '%(initdir)s/ntpd')
        r.Requires('%(essentialsbindir)s/hwclock', '%(initdir)s/ntpd')
