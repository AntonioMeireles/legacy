#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Cups(RPMPackageRecipe, CPackageRecipe):
    name = 'cups'
    version = '1.4.2'
    rpmUpVer = '1.4.2'
    rpmRelease = '20.fc12'

    buildRequires = [
        'acl:devel',
        'autoconf:runtime',
        'automake:runtime',
        'chkconfig:runtime',
        'dbus:devel',
        'desktop-file-utils:runtime',
        'gnutls:devel',
        'groff:runtime',
        'gtk:runtime',
        'icedtea-jdk:runtime',
        'info-lp',
        'libgcrypt:devel',
        'libgpg-error:devel',
        'libjpeg:devel',
        'libpng:devel',
        'libstdc++:devel',
        'libstdc++:devellib',
        'libtiff:devel',
        'libusb:devel',
        'openldap:devel',
        'openslp:devel',
        'openssl:devel',
        'pam:devel',
        'perl:runtime',
        'php-cgi:runtime',
        'php:devel',
        'pkgconfig:devel',
        'poppler:runtime',
        'python:bin',
        'samba-client:runtime',
        'xdg-utils:runtime',
        'zlib:devel',
    ]

    rpmPatches = [
        'cups-no-gzip-man.patch',
        'cups-1.1.16-system-auth.patch',
        'cups-multilib.patch',
        'cups-serial.patch',
        'cups-banners.patch',
        'cups-serverbin-compat.patch',
        'cups-no-export-ssllibs.patch',
        'cups-str3448.patch',
        'cups-direct-usb.patch',
        'cups-lpr-help.patch',
        'cups-peercred.patch',
        'cups-pid.patch',
        'cups-page-label.patch',
        'cups-eggcups.patch',
        'cups-getpass.patch',
        'cups-driverd-timeout.patch',
        'cups-strict-ppd-line-length.patch',
        'cups-logrotate.patch',
        'cups-usb-paperout.patch',
        'cups-build.patch',
        'cups-res_init.patch',
        'cups-filter-debug.patch',
        'cups-uri-compat.patch',
        'cups-cups-get-classes.patch',
        'cups-avahi.patch',
        'cups-str3382.patch',
        'cups-str3285_v2.patch',
        'cups-str3390.patch',
        'cups-str3391.patch',
        'cups-str3381.patch',
        'cups-str3399.patch',
        'cups-str3403.patch',
        'cups-str3407.patch',
        'cups-str3418.patch',
        'cups-CVE-2009-3553.patch',
        'cups-str3422.patch',
        'cups-str3413.patch',
        'cups-str3439.patch',
        'cups-str3440.patch',
        'cups-str3442.patch',
        'cups-negative-snmp-string-length.patch',
        'cups-sidechannel-intrs.patch',
        'cups-media-empty-warning.patch',
        'cups-str3435.patch',
        'cups-str3436.patch',
        'cups-str3425.patch',
        'cups-str3428.patch',
        'cups-str3431.patch',
        'cups-gnutls-gcrypt-threads.patch',
        'cups-str3458.patch',
#        'cups-lspp.patch', # selinux support
    ]
    externalArchive = 'ftp://ftp.easysw.com/pub/cups/%(version)s/cups-%(version)s-source.tar.bz2'

    def setup(r):
        r.unpack()
        r.addSource('cups.init' , rpm=r.srpm)
        r.addSource('cupsprinter.png' , rpm=r.srpm,
            dest="%(datadir)s/pixmaps/")
        # Install the udev rules.
        r.addSource('cups-libusb.rules', rpm=r.srpm,
            dest="%(sysconfdir)s/udev/rules.d/70-cups-libusb.rules")
        r.addSource('cups-lpd' , rpm=r.srpm)
        r.addSource('cups.logrotate' , rpm=r.srpm,
            dest="%(sysconfdir)s/logrotate.d/cups", mode=0644)
        r.addSource('ncp.backend' , rpm=r.srpm,
            dest="%(prefix)s/lib/cups/backend/ncp", mode=0755)
        r.addSource('cups.cron' , rpm=r.srpm,
            dest="%(sysconfdir)s/cron.daily/cups")
        # Ship a generic postscript PPD file (RH BZ#73061)
        r.addSource('textonly.ppd' , rpm=r.srpm,
            dest="%(datadir)s/cups/model/")
        r.addSource('textonly.filter' , rpm=r.srpm,
            dest="%(prefix)s/lib/cups/filter/textonly")
        r.addSource('pstoraster', rpm=r.srpm,
            dest="%(prefix)s/lib/cups/filter/", mode=0755)
        # this is part of ghostscript
        #r.addSource('pstoraster.convs', rpm=r.srpm,
        #    dest="%(sysconfdir)s/cups/", mode=0644)
	#r.addPatch('http://patches.ubuntu.com/c/cups/extracted/rootbackends-worldreadable.dpatch')
	#r.addPatch('http://patches.ubuntu.com/c/cups/extracted/runloop-backchannel-eof-spin.dpatch')

        # This was fixed in the lspp patch, but we don't want it
        r.Replace('method', 'scheme', 'scheduler/job.c')

        r.Replace('DefaultAuthType Basic',
            'DefaultAuthType Basic\n\nMaxLogSize 0',
            'conf/cupsd.conf.in')
        r.Copy('cups-lpd', 'cups-lpd.real')
        r.Move('locale/cups_no.po', 'locale/cups_nb.po')

        #r.Automake(aclocalArgs='-I config-scripts',
        #    autoConfArgs='-I config-scripts')
        r.Run('aclocal -I config-scripts')
        r.Run('autoconf -I config-scripts')

        r.macros.cflags += ' -fPIC -DLDAP_DEPRECATED=1'

        # ssl
        r.macros.cflags += ' `pkg-config --cflags openssl`  '
        r.macros.ldflags += ' `pkg-config --libs-only-L openssl` '

        r.Configure(' --with-optim="%(cflags)s" --with-docdir=%(thisdocdir)s '
            '--enable-slp --enable-libpaper --enable-ssl '
            '--enable-gnutls --enable-static --enable-pie --enable-relro'
            '--enable-avahi --enable-dbus --with-dbusdir=/etc/dbus-1 '
            '--enable-pdftops --with-pdftops=pdftops '
            '--enable-gssapi --enable-pdftops --disable-launchd '
            '--with-cups-group=lp --with-printcap=/var/run/cups/printcap '
            '--with-system-groups=wheel '
            '--with-log-file-perm=0600 --with-config-file-perm=0644 '
            '--with-php=/usr/bin/php-cgi '
            '--localedir=%(datadir)s/locale')

        r.Make('OPTIM="%(cflags)s"')

        r.MakeInstall(rootVar='BUILDROOT')

        # Serial backend needs to run as root (bug #212577).
        r.SetModes("%(prefix)s/lib/cups/backend/serial", 0700)

        r.Install('cups.init', '%(initdir)s/cups', mode=0755)
        r.Run('find %(destdir)s%(datadir)s/cups/model -name "*.ppd" '
              ' |xargs gzip -n9f')

        r.Install('cups-lpd.real', '%(sysconfdir)s/xinetd.d/cups-lpd',
                  mode=0755)
        r.Symlink('%(bindir)s/smbspool', '%(libdir)s/cups/backend/smb')
        r.Symlink('%(thisdocdir)s', '%(datadir)s/%(name)s/doc')

        # Handle https:// device URIs (bug #478677, STR #3122).
        r.Symlink('%(prefix)s/lib/cups/backend/https', 'ipp')

        r.Remove('%(datadir)s/applications/cups.desktop') # RPL-2129
        # Put the php config bit into place
        r.Create('%(sysconfdir)s/php.d/cups.ini',
            contents = """\
; Enable %(name)s extension module
extension=phpcups.so
""")

        for dir in 'admin classes jobs printers'.split(' '):
            r.MakeDirs('%(thisdocdir)s/' + dir)
            r.Create('%(thisdocdir)s/' + dir + '/index.html',
            contents = '''<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/transitional.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="refresh" content="2; URL=http://localhost:631/%s" />
<title>CUPS $i</title>
</head>
<body bgcolor="#cccc99" text="#000000" link="#0000ff" vlink="#ff00ff">
<p>You are trying to access the CUPS admin frontend through reading the files.
The correct way to access the CUPS admin frontend is pointing your browser at
<a href="http://localhost:631/">http://localhost:631/</a>.</p>
<p>You should be automatically redirected to the correct URL in 2 seconds.
If your browser does not support redirection, please use
<a href="http://localhost:631/%s">this link</a>.</p>
</body>
</html>''' % (dir, dir))

        r.DanglingSymlinks(exceptions=['%(mandir)s/man1/.*',
                                       '%(libdir)s/cups/backend/smb'])
        r.MakeDirs('%(localstatedir)s/spool/cups')
        r.MakeDirs('%(sysconfdir)s/cups/certs/', mode=0711)
        r.MakeDirs('%(sysconfdir)s/cups/ppd/', mode=0755)
        r.MakeDirs('%(localstatedir)s/log/cups')

        r.SetModes('%(bindir)s/lppasswd', 04755)
        r.SetModes('%(localstatedir)s/spool/cups/', 0710)
        r.SetModes('%(sysconfdir)s/cups/cupsd.conf', 0640)
        r.Ownership('root', 'sys',
            '%(sysconfdir)s/cups',
            '%(sysconfdir)s/cups/certs',
            '%(sysconfdir)s/cups/(classes|printers).conf')
        r.Ownership('root', 'lp',
            '%(sysconfdir)s/cups/ppd',
            '%(localstatedir)s/spool/cups',
            '%(sysconfdir)s/cups/cupsd.conf')
        r.Ownership('lp', 'sys', '%(localstatedir)s/log/cups')

        r.ExcludeDirectories(exceptions=['%(localstatedir)s/spool/cups',
                                         '%(sysconfdir)s/cups/certs',
                                         '%(sysconfdir)s/cups/ppd',
                                         '%(localstatedir)s/log/cups'])
        r.TagSpec('initscript', '%(initdir)s/')
        r.TagSpec('gtk-update-icon-cache', '/usr/share/pixmaps/cupsprinter.png')
        # put filters/backend progs in :runtime
        r.ComponentSpec('cups:runtime', '%(libdir)s/cups/')
        # FIXME: cups uses its docdir as a location to store web page info such
        # as css and images. we should probably hack it not to do that, but for
        # now we can just include all that in :runtime
        r.ComponentSpec('runtime', '%(thisdocdir)s/')
