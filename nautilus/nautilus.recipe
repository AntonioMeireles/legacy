#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadRecipe('gnomepackage')
loadRecipe('rpmpackage')
class Nautilus(RPMPackageRecipe,GnomePackageRecipe):

    buildRequires = [ 'glib:devel', 'gtk:devel', 'pango:devel',
                      'libgnomeui:devel', 'gnome-vfs:devel',
                      'gnome-desktop:devel', 'gamin:devel', 'desktop-file-utils:runtime',
                      'startup-notification:devel', 'libexif:devel', 'librsvg:devel',
                      'fontconfig:runtime', 'libxml2:devel',
                      'intltool:runtime', 'GConf:devel', 'ORBit2:devel', 'atk:devel',
                      'audiofile:devel', 'beagle:devel', 'cairo:devel', 'esound:devel',
                      'fontconfig:devel', 'freetype:devel', 'gnome-keyring:devel',
                      'libart_lgpl:devel', 'libbonobo:devel', 'libbonoboui:devel',
                      'libglade:devel', 'libgnome:devel', 'libgnomecanvas:devel',
                      'libpng:devel', 'popt:devel', 'GConf:runtime',
                      'docbook-utils:runtime', 'gettext:runtime', 'glib:runtime',
                      'perl:runtime', 'shared-mime-info:runtime', 'gvfs:devel',
                      'libbeagle:devel', 'exempi:devel', 'unique:devel' ]

    name = 'nautilus'
    version = '2.28.1'
    rpmRelease = '2.fc12'
    rpmPatches = [ 'nautilus-config.patch',
                   'nautilus-2.28.1-tracker-0.7-failed-connection.patch',
                   'nautilus-2.28.1-dynamic-search.patch',
                   'rtl-fix.patch',
                   'nautilus-gvfs-desktop-key-2.patch',
                   # http://bugzilla.gnome.org/show_bug.cgi?id=519743
                   'nautilus-filetype-symlink-fix.patch',
                   # Need to file upstream and investigate a real fix
                   'nautilus-2.28.0-revert-bg-fade-break.patch',
                   # nautilus crashed with SIGSEGV in nautilus_file_peek_display_name()
                   # https://bugzilla.gnome.org/show_bug.cgi?id=590591
                   # https://bugzilla.redhat.com/show_bug.cgi?id=531826
                   # TODO: push upstream once confirmed as fixed
                   'nautilus-2.28.2-infopanel-selection-crash.patch'
                  ]

    extraConfig = '--disable-update-mimedb --disable-more-warnings'

    def unpack(r):
        RPMPackageRecipe.unpack(r)
        r.addPatch('hide_icons.patch')
        r.addPatch('browse_mode.patch')
        r.addPatch('font.patch')

        r.addAction('gtkdocize; autoreconf -fi')
        r.macros.cflags += ' -DUGLY_HACK_TO_DETECT_KDE  '

    def policy(r):
        r.MakeDirs('%(libdir)s/nautilus/extensions-2.0')
        r.ExcludeDirectories(exceptions = '%(libdir)s/nautilus/extensions-2.0')
        r.Remove('%(datadir)s/icons/hicolor/icon-theme.cache')
        r.Remove('%(datadir)s/icons/hicolor/.icon-theme.cache')
