#
# Copyright (c) 2010 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Jabberd(AutoPackageRecipe):
    name = 'jabberd'
    version = '2.2.11'

    buildRequires = [
        'chkconfig:runtime',
        'expat:devel',
        'info-jabber:user',
        'libgsasl:devel',
        'libidn:devel',
        'openssl:devel',
        'postgresql:devel',
        'sqlite:devel',
        'udns:devel',
        'zlib:devel',
    ]

    def unpack(r):
        r.addArchive('http://codex.xiaoka.com/pub/jabberd2/releases/')
        r.addSource('initscript', dest='%(initdir)s/jabberd', mode=0755)

        # Fix configs
        configFiles = [
            'etc/c2s.xml.dist.in', 'etc/router.xml.dist.in',
            'etc/s2s.xml.dist.in', 'etc/sm.xml.dist.in', ]
        r.Replace('@localstatedir@/jabberd/log', '@localstatedir@/log/jabberd',
            *configFiles)
        r.Replace('@localstatedir@/jabberd/run', '@localstatedir@/run/jabberd',
            'etc/c2s.xml.dist.in')
        r.Replace('@localstatedir@/jabberd/pid', '@localstatedir@/run/jabberd',
            *configFiles)
        r.Replace('@localstatedir@/jabberd/db', '@localstatedir@/lib/jabberd/db',
            'etc/c2s.xml.dist.in', 'etc/sm.xml.dist.in')

        app_dirs = [
                '%(localstatedir)s/log/jabberd',
                '%(localstatedir)s/run/jabberd',
                '%(localstatedir)s/lib/jabberd/db',
                '%(localstatedir)s/lib/jabberd/pid',
                ]
        root_dirs = [
                '%(sysconfdir)s/jabberd',
                ]
        r.MakeDirs(*(app_dirs + root_dirs))
        r.Ownership('jabber', 'jabber', *app_dirs)
        r.ExcludeDirectories(exceptions=root_dirs)

    def configure(r):
        r.Configure(
                '--enable-mio=epoll '
                '--enable-pgsql '
                '--enable-pipe '
                '--enable-sqlite '
                '--sysconfdir=%(sysconfdir)s/jabberd '
                )

    def policy(r):
        r.ComponentSpec('runtime', '%(libdir)s/jabberd/')
