#
# Copyright (c) 2010 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Jabberd(AutoPackageRecipe):
    name = 'jabberd'
    version = '2.2.10'

    buildRequires = [
        'libgsasl:devel',
        'expat:devel',
        'libidn:devel',
        'openssl:devel',
        'udns:devel',
        'zlib:devel',
        'info-jabber:user',
        'sqlite:devel',
    ]

    def unpack(r):
        r.addArchive('http://codex.xiaoka.com/pub/jabberd2/releases/')
        # Fix configs
        configFiles = [
            'etc/c2s.xml.dist.in', 'etc/router.xml.dist.in',
            'etc/s2s.xml.dist.in', 'etc/sm.xml.dist.in', ]
        r.Replace('@localstatedir@/jabberd/log', '@localstatedir@/log/jabberd',
            *configFiles)
        r.Replace('@localstatedir@/jabberd/run', '@localstatedir@/run/jabberd',
            'etc/c2s.xml.dist.in')
        r.Replace('@localstatedir@/jabberd/pid', '@localstatedir@/run/jabberd',
            *configFiles)
        r.Replace('@localstatedir@/jabberd/db', '@localstatedir@/lib/jabberd/db',
            'etc/c2s.xml.dist.in', 'etc/sm.xml.dist.in')

        r.MakeDirs('%(localstatedir)s/log/jabberd',
            '%(localstatedir)s/run/jabberd',
            '%(localstatedir)s/lib/jabberd/db', '%(sysconfdir)s/jabberd')
        r.Ownership('jabber', 'jabber',
            '%(localstatedir)s/log/jabberd', '%(localstatedir)s/run/jabberd',
            '%(localstatedir)s/lib/jabberd/db',)
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/jabberd')


    def configure(r):
        r.Configure('--enable-sqlite --enable-pipe --sysconfdir=%(sysconfdir)s/jabberd')
