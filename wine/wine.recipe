
class Wine(AutoPackageRecipe):
    name = 'wine'
    version = '1.3.21'

    buildRequires = [
                      'bison:runtime',
                      'alsa-lib:devel',
                      'audiofile:devel',
                      'bison:runtime',
                      'dbus:devel',
                      'cups:devel',
                      'desktop-file-utils:runtime',
                      'esound:devel',
                      'flex:runtime',
                      'fontconfig:runtime',
                      'fontconfig:devel',
                      'fontforge:runtime',
                      'freeglut:devel',
                      'freetype:devel',
                      'gcc-c++:runtime',
                      'glib:devel',
                      'lcms:devel',
                      'libICE:devel',
                      'libSM:devel',
                      'libX11:devel',
                      'libXext:devel',
                      'libXxf86vm:devel',
                      'libXrender:devel',
                      'libgphoto2:devel',
                      'libxml2:devel',
                      'libxslt:devel',
                      'libieee1284:devel',
                      'libjpeg:devel',
                      'libusb:devel',
                      'openldap:devel',
                      'perl:devel',
                      'perl:runtime',
                      'perl:lib',
                      'pkgconfig:devel',
                      'sane-backends:devel',
                      'zlib:devel',
                      'ncurses:devel',
                      'giflib:devel',
                      'libXcursor:devel',
                      'libXi:devel',
                      'libXrandr:devel',
                      'libXinerama:devel',
                      'libXcomposite:devel',
                      'openssl:devel',
                      'libpng:devel',
                      'Mesa:devel',
                      'autoconf:runtime',
                      'automake:runtime',
                      'pkgconfig:devel',
                      'libtool:devel',
                      'libtool:runtime',
                      'util-macros:devel',
                      'gnutls:devel',
                      'jack:devel',
                      'libXt:devel',
                      'librsvg:runtime',
                      'perl-XML-Simple:perl',
                      ]
    # XXX: don t put nas:devel as a buildReq!!

    def unpack(r):
        r.macros.version = r.version.replace('_', '-')
        r.addArchive('http://prdownloads.sourceforge.net/wine/')
        r.addSource('wine.desktop', dir = '%(datadir)s/applications/', mode = 0644)
        r.addSource('http://kegel.com/wine/winetricks', dir = '%(bindir)s/', mode = 0755)
	r.addSource('http://downloads.sourceforge.net/wine/wine_gecko-1.2.0-x86.msi', dir = '%(datadir)s/wine/gecko/')

    def configure(r):
        # r.macros.cflags += ' -fno-tree-fre -fno-tree-pr '
        r.macros.ldflags += ' -L%(libdir)s/xorg.mesa.3d '
        r.Environment('LDFLAGS','%(ldflags)s')
        r.Remove('config.cache')
        r.Run('autoconf')
        r.Configure(' --sysconfdir=%(sysconfdir)s/wine  --disable-static --enable-opengl '
                    ' --x-includes=%(includedir)s --x-libraries=%(libdir)s')

    def makeinstall(r):
        r.MakePathsInstall('includedir=%(destdir)s%(includedir)s/wine '
                           'sysconfdir=%(destdir)s%(sysconfdir)s/wine '
                           'dlldir=%(destdir)s%(libdir)s/wine '
                           'LDCONFIG=/bin/true UPDATE_DESKTOP_DATABASE=/bin/true')

    def policy(r):
        r.CheckSonames(exceptions='%(libdir)s/libwine.*')
        r.TagSpec('desktop-file', '%(datadir)s/applications/wine.desktop')
        # r.Requires('soname: libuuid.so.1(SysV UUID_1.0 x86)', '%(bindir)s/wine')
        # UUID_1.0 isn't available in old libuuid from e2fsprogs and we want this 
        # to behave when is rebuilt against it
        r.Requires('soname: libuuid.so.1(SysV x86)', '%(bindir)s/wine')
        
