
loadSuperClass('rpmpackage')
class Wine(RPMPackageRecipe,AutoPackageRecipe):
    name = 'wine'
    version = '0.9.58'

    rpmRelease = '1.fc9'
    rpmPatches = [ 'wine-wineshelllink.patch', 'wine-prefixfonts.patch', 'wine-rpath.patch' ]

    rpmSources = [ 'wine.init',
                   'wine-32.conf',

                   'wine-notepad.desktop',
                   'wine-regedit.desktop',
                   'wine-uninstaller.desktop',
                   'wine-winecfg.desktop',
                   'wine-winefile.desktop',
                   'wine-winemine.desktop',
                   'wine-winhelp.desktop',
                   'wine-wineboot.desktop',

                   # desktop dir
                   'wine.menu',
                   'wine.directory',

                   # mime types
                   'wine-mime-msi.desktop',

                   'wineshelllink-fedora',
                   ]


    externalArchive = 'mirror://sourceforge/wine/'


    buildRequires = [
                      'bison:runtime',
                      'alsa-lib:devel',
                      'audiofile:devel',
                      'bison:runtime', 'hal:devel', 'dbus:devel', 'cups:devel',
                      'desktop-file-utils:runtime',
                      'esound:devel',
                      'flex:runtime',
                      'fontconfig:runtime',
                      'fontconfig:devel',
                      'fontforge:runtime',
                      'freeglut:devel',
                      'freetype:devel',
                      'glib:devel',
                      'lcms:devel',
                      'libICE:devel',
                      'libSM:devel',
                      'libX11:devel',
                      'libXext:devel',
                      'libXxf86vm:devel',
                      'libXrender:devel',
                      'libgphoto2:devel',
                      'libxml2:devel',
                      'libxslt:devel',
                      'libieee1284:devel',
                      'libjpeg:devel',
                      'libusb:devel',
                      'openldap:devel',
                      'perl:devel',
                      'perl:runtime',
                      'perl:lib',
                      'pkgconfig:devel',
                      'sane-backends:devel',
                      'zlib:devel',
                      'ncurses:devel', 'giflib:devel',
                      'libXcursor:devel',
                      'libXi:devel',
                      'libXrandr:devel',
                      'libXinerama:devel',
                      'libXcomposite:devel',
                      'openssl:devel',
                      'libpng:devel',
                      'Mesa:devel',
                    ]


    def configure(r):
        r.macros.ldflags += ' -L%(libdir)s/xorg.mesa.3d '
        r.Environment('LDFLAGS','%(ldflags)s')
        r.Configure('--sysconfdir=%(sysconfdir)s/wine  --disable-static --enable-opengl')

    def makeinstall(r):
        r.MakePathsInstall('includedir=%(destdir)s%(includedir)s/wine '
                           'sysconfdir=%(destdir)s%(sysconfdir)s/wine '
                           'dlldir=%(destdir)s%(libdir)s/wine '
                           'LDCONFIG=/bin/true UPDATE_DESKTOP_DATABASE=/bin/true')

        r.MakeDirs('%(sysconfdir)s/wine')

        # Allow users to launch Windows programs by just clicking on the .exe file...

        r.Install('wine.init','%(initdir)s/wine', mode = 0755)

        # add wine dir to desktop
        r.MakeDirs('%(sysconfdir)s/xdg/menus/applications-merged')
        r.Install('wine.menu','%(sysconfdir)s/xdg/menus/applications-merged/', mode = 0644)

        r.MakeDirs('%(datadir)s/desktop-directories')
        r.Install('wine.directory','%(datadir)s/desktop-directories/', mode = 0644)

        r.Install('wine-32.conf','%(sysconfdir)s/ld.so.conf.d/', mode = 0644)

        r.Install('wineshelllink-fedora','%(bindir)s/wineshelllink-fedora', mode = 0755)

    def policy(r):
        r.CheckSonames(exceptions='%(libdir)s/libwine.*')

        r.TagSpec('desktop-file', '%(datadir)s/applications/wine.desktop')

        for i in [ 'wine-notepad.desktop',
                   'wine-regedit.desktop',
                   'wine-uninstaller.desktop',
                   'wine-winecfg.desktop',
                   'wine-winefile.desktop',
                   'wine-winemine.desktop',
                   'wine-winhelp.desktop',
                   'wine-wineboot.desktop',
                   'wine-mime-msi.desktop',
                   ]:
                   r.Desktopfile(i)
