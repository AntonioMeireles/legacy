#
# Copyright (c) 2006 Antonio Meireles
# All rights reserved
#

loadSuperClass('kernelmodulepackage=drivers.rpath.org@rpl:devel')
class Ipw3945(KernelModulePackageRecipe):
    buildRequires = [ 'mkinitrd:runtime', 'ipw3945config']
    name = 'ipw3945'
    version = '1.1.0'
    
    def unpack(r):
	r.addArchive('%(name)s-%(version)s-pre2.tgz')

    def build(r):
        r.Replace(('/sbin/depmod.*', '@/bin/true'),
                  ('^install: modules', 'install:'),
                  'Makefile')
        r.Make(' CONFIG_IPW3945_MONITOR=y CONFIG_IEEE80211_RADIOTAP=y  KVER=%(kver)s modules '
               'LINUXINCLUDE="-I/lib/modules/%(kver)s/include '
               '-I/lib/modules/%(kver)s/build/include"')
        # This makefile doesn't have a nice way to deal with DESTDIR
        r.Make('KVER=%(kver)s'
              ' KMISC=%(destdir)s/lib/modules/%(kver)s/drivers/net/wireless/'
               ' LINUXINCLUDE="-I/lib/modules/%(kver)s/include'
               ' -I/lib/modules/%(kver)s/build/include"'
               ' install')
        r.Install('ipw3945.ko','%(destdir)s/lib/modules/%(kver)s/drivers/net/wireless/')

        r.AutoDoc('CHANGES')
        
        def policy(r):
            r.Requires('ieee80211:lib',
                       r'/lib/modules/%(kver)s/drivers/net/wireless/.*\.ko')
            r.Requires('ipw3945-fw:lib',
                       r'/lib/modules/%(kver)s/drivers/net/wireless/.*\.ko')
            

                
