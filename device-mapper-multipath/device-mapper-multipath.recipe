#
# Copyright (c) 2011 THe Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class DeviceMapperMultipath(RPMPackageRecipe,CPackageRecipe):
    name = 'device-mapper-multipath'
    version = '0.4.9'
    rpmRelease = '15.fc15' 
    buildRequires = [ 'chkconfig:runtime', 'device-mapper:devel',
                      'libaio:devel', 'ncurses:devel',
                      'readline:devel' ]

    rpmPatches = [ '0001-for-upstream-add-tpg_pref-prioritizer.patch',
                   '0002-for-upstream-add-tmo-config-options.patch',
                   '0003-for-upstream-default-configs.patch',
                   '0001-RH-queue-without-daemon.patch',
                   '0002-RH-path-checker.patch',
                   '0003-RH-root-init-script.patch',
                   '0004-RH-fix-kpartx.patch',
                   '0005-RH-cciss_id.patch',
                   '0006-RH-move-bindings.patch',
                   '0007-RH-do-not-remove.patch',
                   '0008-RH-Make-build-system-RH-Fedora-friendly.patch',
                   '0009-RH-multipathd-blacklist-all-by-default.patch',
                   '0010-RH-multipath-rules-udev-changes.patch',
                   '0011-RH-fix-init-script-LSB-headers.patch',
                   '0012-RH-udev-sync-support.patch',
                   '0013-RH-add-weighted_prio-prioritizer.patch',
                   '0014-RH-add-hp_tur-checker.patch',
                   '0015-RH-add-multipathd-count-paths-cmd.patch',
                   '0016-RHBZ-554561-fix-init-error-msg.patch',
                   '0017-RHBZ-554592-man-page-note.patch',
                   '0018-RHBZ-554596-SUN-6540-config.patch',
                   '0019-RHBZ-554598-fix-multipath-locking.patch',
                   '0020-RHBZ-554605-fix-manual-failover.patch',
                   '0021-RHBZ-548874-add-find-multipaths.patch',
                   '0022-RHBZ-557845-RHEL5-style-partitions.patch',
                   '0023-RHBZ-557810-emc-invista-config.patch',
                   '0024-RHBZ-565933-checker-timeout.patch' ]
    rpmSources = [ 'multipath.conf' ]
    tarballName = 'multipath-tools-091027.tar.gz'

    def setup(r):
        RPMPackageRecipe.unpack(r)
        
        r.Make('LIB=%(lib)s')

        r.MakeInstall( ' DESTDIR=%(destdir)s '
                       ' bindir=%(essentialsbindir)s '
                       ' syslibdir=%(essentiallibdir)s '
                       ' libdir=%(libdir)s/multipath '
                       ' rcdir=%(initdir)s ')

        r.MakeDirs('%(sysconfdir)s/multipath')
        r.ExcludeDirectories(exceptions = '%(sysconfdir)s/multipath')
        # r.Install('multipath.conf', '%(sysconfdir)s/multipath/')
        r.Doc('multipath.conf', 'multipath.conf.annotated',
              'multipath.conf.defaults', 'multipath.conf.synthetic')

        r.PackageSpec('kpartx', '.*kpartx.*')
