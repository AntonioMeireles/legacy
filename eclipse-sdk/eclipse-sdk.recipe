#
# Copyright (c) 2008-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class EclipseSDK(PackageRecipe):

    name = 'eclipse-sdk'
    version = '3.5'
    build_id = '22562'
    timestamp = 'I20090611-1540'

    buildRequires = [
        'fontconfig:devel', 'freetype:devel', 'glib:devel', 'gtk:devel',
        'icedtea-jre:runtime', 'icedtea-jdk:runtime', 'libXext:devel', 'libXrender:devel', 'perl:perl',
        'perl:runtime', 'python:devel', 'unzip:runtime', 'xalan-j:java',
        'desktop-file-utils:runtime', 'ant:runtime', 'ant:java',
        'elfutils:runtime',
    ]


    def setup(r):

        if Arch.x86_64:
            r.buildRequires.extend([
                'glibc:devellib[is: x86]',
                'glib:devellib[is: x86]',
                'GConf:devellib[is: x86]',
                'ORBit2:devellib[is: x86]',
            ])

        r.macros.timestamp = r.timestamp
        r.macros.build_site = 'http://download.eclipse.org/technology/linuxtools/eclipse-build/'
        r.macros.build_repo = 'http://dev.eclipse.org/svnroot/technology/org.eclipse.linuxtools/eclipse-build/trunk'

        r.macros.eclipsedir = '%(libdir)s/eclipse-%(major_version)s/'

        r.addSvnSnapshot('%(build_repo)s/eclipse-build', revision=r.build_id)
        for d in ('config', 'feature'):
            r.addSvnSnapshot('%(build_repo)s/eclipse-build-'+d, revision=r.build_id)
            r.Run('ln -s `pwd`/../eclipse-sdk--eclipse-build-%s eclipse-build-%s' % (d, d))

        r.addSource('%(build_site)s/eclipse-%(timestamp)s-fetched-src.tar.bz2')

        patches = [
            'eclipse-java-home.patch',
            'eclipse-swt-jni-fix.patch',
            'eclipse-swt-mesa-fix.patch',
        ]
        for patch in patches:
            r.addSource(patch, dir='patches/', macros = True)

        r.addPatch('eclipse-build.xml-patches.patch')

        r.addSource('eclipse.desktop', macros=True)
        r.Desktopfile('eclipse.desktop')

        bootClassPath = [
            '$JAVA_HOME/jre/lib/rt.jar',
            '$JAVA_HOME/jre/lib/jce.jar',
            '$JAVA_HOME/jre/lib/jsse.jar',
        ]
        r.Run('sed -r -i "s#=.+jce.jar#='+':'.join(bootClassPath)+'#" build.properties')
        r.Run('sed -r -i "s#=.+jce.jar#='+':'.join(bootClassPath)+'#" pdebuild.properties')

        arch = ('x86', 'x86_64')[Arch.x86_64==True]
        awt_arch = ('i386', 'amd64')[Arch.x86_64==True]

        # TODO 
        # Don't build for non-linux,gtk,%(arch)s targets
        # Don't build for arches other than the one on which we're building
 
        r.Run('AWT_LIB_PATH=$JAVA_HOME/jre/lib/%s ant -DbuildArch=%s' % (awt_arch, arch))

        r.Install(
            'build/eclipse-%(timestamp)s-fetched-src/installation/*',
            '%(eclipsedir)s/'
        )

        r.Symlink('%(eclipsedir)s/eclipse', '%(bindir)s/eclipse')

        r.Move('%(eclipsedir)s/eclipse.ini', '%(sysconfdir)s/eclipse/')
        r.Symlink('%(sysconfdir)s/eclipse/eclipse.ini', '%(eclipsedir)s/eclipse.ini')

        r.Replace('-Xmx256m','-Xmx512m', '%(sysconfdir)s/eclipse/eclipse.ini')
        r.AutoDoc(exceptions='.*')

        r.Requires(exceptDeps='java: org.apache.tools.ant.*')
        r.Requires(exceptDeps='java: org.eclipse.pde.internal.build.publisher.BrandP2Task')

        r.ExcludeDirectories(exceptions='%(libdir)s/eclipse-%(version)s/dropins')
        
