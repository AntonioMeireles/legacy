#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class EclipseSDK(AutoPackageRecipe):

    name = 'eclipse-sdk'
    version = '3.6.2'
    build_version = '0.6_2edc608'

    buildRequires = [
        # XXX HACK ALERT 
        # get this to build right with plain icedtea
        # 'icedtea-jre:runtime',
        # 'icedtea-jdk:runtime',
        'sun-jre:runtime',
        'sun-jdk:runtime',

        'pkgconfig:devel',
        'glib:devel',
        'gtk:devel',
        'fontconfig:devel',
        'freetype:devel',
        'libXext:devel',
        'libXrender:devel',
        'perl:perl',
        'perl:runtime',
        'python:devel',
        'unzip:runtime',
        'xalan-j:java',
        'desktop-file-utils:runtime',
        'ant:runtime',
        'ant:java',
        'elfutils:runtime',
        'libgnome:devel',
        'libgnomeui:devel',
        'cairo:devel',
        'xulrunner:devel',
        'Mesa:devel',
        'zip:runtime',
        'inputproto:devel',
        'libXtst:devel',
        'gcc-c++:runtime',
        'WebKit:devel',
        'jzlib:java',
        'libXi:devel',
        'rsync:runtime',
    ]


    def setup(r):
        r.macros.build_version = r.build_version
        r.macros.build_site = 'http://download.eclipse.org/technology/linuxtools/eclipse-build/3.6.x_Helios/'
        r.macros.bundles = 'http://download.eclipse.org/tools/orbit/downloads/drops/R20100519200754/bundles'

        r.macros.eclipsedir = '%(libdir)s/eclipse'

#        r.addArchive('%(build_site)s/eclipse-build-%(build_version)s.tar.bz2')
        r.addArchive('eclipse-build-%(build_version)s.tar.bz2')

        r.addSource('%(build_site)s/eclipse-%(version)s-src.tar.bz2')

        r.addSource('eclipse.wrapper', macros = True)

        def updateDependencies(name, bundles):
            for bundle in bundles:
                r.addSource('%%(bundles)s/%s' % bundle)
                r.Replace(bundle+'=.*', bundle+'=%(builddir)s/'+bundle, name+'.properties')

        # JTD
        updateDependencies('jdtdependencies', [
            'org.hamcrest.core_1.1.0.v20090501071000.jar',
        ])
        # SDK
        updateDependencies('sdkdependencies', [
            'org.objectweb.asm_3.2.0.v200909071300.jar',
        ])
        # Platform
        updateDependencies('dependencies', [
            'com.ibm.icu_4.2.1.v20100412.jar',
            'com.jcraft.jsch_0.1.41.v200903070017.jar',
            'javax.servlet_2.5.0.v200910301333.jar',
            'javax.servlet.jsp_2.0.0.v200806031607.jar',
            'org.apache.commons.codec_1.3.0.v20080530-1600.jar',
            'org.apache.commons.el_1.0.0.v200806031608.jar',
            'org.apache.commons.httpclient_3.1.0.v201005080502.jar',
            'org.apache.commons.logging_1.0.4.v201005080501.jar',
            'org.apache.jasper_5.5.17.v200903231320.jar',
            'org.apache.lucene_1.9.1.v20100518-1140.jar',
            'org.apache.lucene.analysis_1.9.1.v20100518-1140.jar',
            'org.mortbay.jetty.server_6.1.23.v201004211559.jar',
            'org.mortbay.jetty.util_6.1.23.v201004211559.jar',
            'org.sat4j.core_2.2.0.v20100429.jar',
            'org.sat4j.pb_2.2.0.v20100429.jar',
        ])

        r.addArchive('http://download.eclipse.org/tools/orbit/downloads/drops/R20100519200754/bundles/org.junit_3.8.2.v3_8_2_v20100427-1100.zip', dir='eclipse-build-%(build_version)s/')
        r.addSource('mirror://sourceforge/junit/junit/4.5/junit-4.5.jar')

        r.Replace(
            ('/usr/share/java/ant.jar', '%(datadir)s/ant/ant.jar'),
            ('/usr/share/java/ant.*.jar:/usr/share/java/', '%(datadir)s/ant/'),
            'nonosgidependencies.properties'
        )
        r.Run("echo 'org.apache.ant_1.7.1.v20100518-1145/lib/ant-nodeps.jar=/usr/share/ant/ant-nodeps.jar' >> nonosgidependencies.properties")

        r.Replace(
            ('/usr/share/java/junit4.jar', '%(builddir)s/junit-4.5.jar'),
            ('/usr/share/java/junit.jar', '%(builddir)s/org.junit_3.8.2.v3_8_2_v20100427-1100/junit.jar'),
            'jdtnonosgidependencies.properties'
        )

        patches = [
            'eclipse-swt-mesa-fix.patch',
            'eclipse-sdk-iterators.patch',
            'eclipse-sdk-bug317829.patch',
#            'eclipse-sdk-bug309059.patch',
        ]

        for patch in patches:
            r.addSource(patch, dir='patches/', macros = True)

        r.addPatch('eclipse-build.xml-patches.patch')

        r.addPatch('eclipse-build-no-symlink.patch')

        # buildfix
        r.Replace('.*/remove-old-ant-plugins.patch.*', '', 'build.xml')

        bootClassPath = [
            '$JAVA_HOME/jre/lib/rt.jar',
            '$JAVA_HOME/jre/lib/jce.jar',
            '$JAVA_HOME/jre/lib/jsse.jar',
        ]
        r.Run('sed -r -i "s#=.+jce.jar#='+':'.join(bootClassPath)+'#" build.properties')
        r.Run('sed -r -i "s#=.+jce.jar#='+':'.join(bootClassPath)+'#" pdebuild.properties')

        arch = ('x86', 'x86_64')[Arch.x86_64==True]
        awt_arch = ('i386', 'amd64')[Arch.x86_64==True]

        # TODO
        # Don't build for non-linux,gtk,%(arch)s targets
        # Don't build for arches other than the one on which we're building

        r.Run('AWT_LIB_PATH=$JAVA_HOME/jre/lib/%s ant -DbuildArch=%s provision.cvs' % (awt_arch, arch))
        r.Run('ant -DdestDir=%%(destdir)s -Dprefix=/usr -DbuildArch=%s -Dmultilib=true installSDKinDropins' % arch)

        # use our own wrapper to get update sites pre-populated
        r.Install('eclipse.wrapper', '%(bindir)s/eclipse', mode = 0755)

        r.Install('junit-4.5.jar', '%(eclipsedir)s/dropins/jdt/plugins/junit4.jar')

        r.AutoDoc(exceptions='.*')

        r.Requires(exceptDeps='java: org.apache.tools.ant.*')
        r.Requires(exceptDeps='java: org.eclipse.pde.internal.build.publisher.BrandP2Task')

        r.Requires(exceptDeps=r'soname: ELF.*/libjawt.so.*')

        r.Remove('%(libdir)s/eclipse/eclipse.ini')
        r.Symlink('%(sysconfdir)s/eclipse.ini', '%(libdir)s/eclipse/' )

        # http://wiki.eclipse.org/WTP_FAQ#Why_am_I_getting_a_java.lang.OutOfMemoryError:_PermGen_space.3F
        # r.Replace('256m', '384m', '%(sysconfdir)s/eclipse.ini')
        # https://bugs.eclipse.org/bugs/show_bug.cgi?id=294877
        r.Run(
            """
echo "" >> %(destdir)s/%(sysconfdir)s/eclipse.ini
echo "-XX:CompileCommand=exclude,org/eclipse/core/internal/dtree/DataTreeNode,forwardDeltaWith" >> %(destdir)s/%(sysconfdir)s/eclipse.ini
echo "-XX:CompileCommand=exclude,org/eclipse/jdt/internal/compiler/lookup/ParameterizedMethodBinding,<init>" >> %(destdir)s/%(sysconfdir)s/eclipse.ini
echo "-XX:CompileCommand=exclude,org/eclipse/cdt/internal/core/dom/parser/cpp/semantics/CPPTemplates,instantiateTemplate" >> %(destdir)s/%(sysconfdir)s/eclipse.ini
echo "-XX:CompileCommand=exclude,org/eclipse/cdt/internal/core/pdom/dom/cpp/PDOMCPPLinkage,addBinding" >> %(destdir)s/%(sysconfdir)s/eclipse.ini
echo "-XX:CompileCommand=exclude,org/python/pydev/editor/codecompletion/revisited/PythonPathHelper,isValidSourceFile" >> %(destdir)s/%(sysconfdir)s/eclipse.ini
echo "-XX:CompileCommand=exclude,org/python/pydev/ui/filetypes/FileTypesPreferencesPage,getDottedValidSourceFiles" >> %(destdir)s/%(sysconfdir)s/eclipse.ini 
            """
            )

