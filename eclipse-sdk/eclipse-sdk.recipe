#
# Copyright (c) 2008-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class EclipseSDK(AutoPackageRecipe):

    name = 'eclipse-sdk'
    version = '3.6.1'
    build_version = '0.6.2'

    buildRequires = [
        # XXX HACK ALERT 
        # get this to build right with plain icedtea
        # 'icedtea-jre:runtime',
        # 'icedtea-jdk:runtime',
        'sun-jre:runtime',
        'sun-jdk:runtime',
        'rpm:runtime',

        'pkgconfig:devel',
        'glib:devel',
        'gtk:devel',
        'fontconfig:devel',
        'freetype:devel',
        'libXext:devel',
        'libXrender:devel',
        'perl:perl',
        'perl:runtime',
        'python:devel',
        'unzip:runtime',
        'xalan-j:java',
        'desktop-file-utils:runtime',
        'ant:runtime',
        'ant:java',
        'elfutils:runtime',
        'libgnome:devel',
        'libgnomeui:devel',
        'cairo:devel',
        'xulrunner:devel',
        'Mesa:devel',
        'zip:runtime',
        'inputproto:devel',
        'libXtst:devel',
        'gcc-c++:runtime',
        'WebKit:devel',
        'jzlib:java',
        'libXi:devel',
    ]


    def setup(r):
        r.macros.build_version = r.build_version
        r.macros.build_site = 'http://download.eclipse.org/technology/linuxtools/eclipse-build/3.6.x_Helios/'
        r.macros.bundles = 'http://download.eclipse.org/tools/orbit/downloads/drops/R201009090800/bundles'
        r.macros.fedora_site = 'http://download.fedora.redhat.com/pub/fedora/linux/development'

        arch = ('x86', 'x86_64')[Arch.x86_64==True]
        awt_arch = ('i386', 'amd64')[Arch.x86_64==True]


        r.macros.rpm_arch = ('i386', 'x86_64')[Arch.x86_64==True]
        r.macros.eclipsebuild = 'RPM/BUILD/eclipse-build-'+r.build_version
        r.macros.rpmbuild = (
            "rpmbuild"
            " -vv --nodeps"
            " --macros='%(prefix)s/lib/rpm/macros"
                ":%(prefix)s/lib/rpm/platform/%(rpm_arch)s-linux/macros:rpm.macros'"
        )

        r.macros.eclipsedir = '%(libdir)s/eclipse'

        r.addArchive('%(fedora_site)s/14/source/SRPMS/eclipse-3.6.1-1.fc14.src.rpm', dir='eclipse-build')

        r.addSource('rpm.macros')
        r.addSource('eclipse.spec')
        r.addAction("%(rpmbuild)s -bp eclipse.spec")

        for p in ('eclipse-swt-mesa-fix.patch', 'eclipse-sdk-iterators.patch'):
            r.addPatch(p, dir='%(eclipsebuild)s/build/eclipse-%(version)s-src', macros=True)

        def updateDependencies(name, bundles):
            dependencies = []
            for bundle in bundles:
                dependencies.append(bundle+'=%(destdir)s%(eclipsedir)s/dependencies/'+bundle)
                r.addSource('%%(bundles)s/%s' % bundle, dir='%(destdir)s%(eclipsedir)s/dependencies')
            r.Run("echo '%s' > %%(eclipsebuild)s/%s.properties" % ('\n'.join(dependencies), name))

        # JTD
        updateDependencies('jdtdependencies', [
            'org.hamcrest.core_1.1.0.v20090501071000.jar',
        ])
        # SDK
        updateDependencies('sdkdependencies', [
            'org.objectweb.asm_3.2.0.v200909071300.jar',
        ])
        # Platform
        updateDependencies('dependencies', [
            'com.ibm.icu_4.2.1.v20100412.jar',
            'com.jcraft.jsch_0.1.41.v200903070017.jar',
            'javax.servlet_2.5.0.v200910301333.jar',
            'javax.servlet.jsp_2.0.0.v200806031607.jar',
            'org.apache.commons.codec_1.3.0.v20080530-1600.jar',
            'org.apache.commons.el_1.0.0.v200806031608.jar',
            'org.apache.commons.httpclient_3.1.0.v201005080502.jar',
            'org.apache.commons.logging_1.0.4.v201005080501.jar',
            'org.apache.jasper_5.5.17.v200903231320.jar',
            'org.apache.lucene_1.9.1.v20100518-1140.jar',
            'org.apache.lucene.analysis_1.9.1.v20100518-1140.jar',
            'org.mortbay.jetty.server_6.1.23.v201004211559.jar',
            'org.mortbay.jetty.util_6.1.23.v201004211559.jar',
            'org.sat4j.core_2.2.0.v20100429.jar',
            'org.sat4j.pb_2.2.0.v20100429.jar',
        ])

        r.addArchive('%(bundles)s/org.junit_3.8.2.v3_8_2_v20100427-1100.zip', dir='eclipse-build/')
        r.addSource('mirror://sourceforge/junit/junit/4.5/junit-4.5.jar')

        r.Replace(
            ('/usr/share/java/ant.jar', '%(datadir)s/ant/ant.jar'),
            ('/usr/share/java/ant.*.jar:/usr/share/java/', '%(datadir)s/ant/'),
            '%(eclipsebuild)s/nonosgidependencies.properties'
        )
        r.Replace(
            ('/usr/share/java/junit4.jar', '%(builddir)s/junit-4.5.jar'),
            ('/usr/share/java/junit.jar', '%(builddir)s/org.junit_3.8.2.v3_8_2_v20100427-1100/junit.jar'),
            '%(eclipsebuild)s/jdtnonosgidependencies.properties'
        )

        bootClassPath = [
            '$JAVA_HOME/jre/lib/rt.jar',
            '$JAVA_HOME/jre/lib/jce.jar',
            '$JAVA_HOME/jre/lib/jsse.jar',
        ]
        r.Run('sed -r -i "s#=.+jce.jar#='+':'.join(bootClassPath)+'#" %(eclipsebuild)s/build.properties')
        r.Run('sed -r -i "s#=.+jce.jar#='+':'.join(bootClassPath)+'#" %(eclipsebuild)s/pdebuild.properties')

        r.Run('AWT_LIB_PATH=$JAVA_HOME/jre/lib/%s ant' % awt_arch, dir='%(eclipsebuild)s')

        r.Run("%(rpmbuild)s --short-circuit -bi eclipse.spec")

        r.Install('RPM/BUILDROOT/eclipse-%(version)s-1.%(rpm_arch)s/*', '/', preserveSymlinks=True)

        r.Install('junit-4.5.jar', '%(eclipsedir)s/dependencies/junit4.jar')
        r.Install('org.junit_3.8.2.v3_8_2_v20100427-1100/junit.jar', '%(eclipsedir)s/dependencies/junit.jar'),

        r.macros.jdtdir = '%(destdir)s%(eclipsedir)s/dropins/jdt/plugins'
        r.macros.sdkdir = '%(destdir)s%(eclipsedir)s/dropins/sdk/plugins'

        jar = 'org.hamcrest.core_1.1.0.v20090501071000.jar'
        r.Run('ln -v -s -f "%%(eclipsedir)s/dependencies/%s" "%%(jdtdir)s/%s"' % (jar, jar))
        jar = 'org.objectweb.asm_3.2.0.v200909071300.jar'
        r.Run('ln -v -s -f "%%(eclipsedir)s/dependencies/%s" "%%(sdkdir)s/%s"' % (jar, jar))
        jar = 'org.junit_3.8.2.v3_8_2_v20100427-1100/junit.jar'
        r.Run('ln -v -s -f "%%(eclipsedir)s/dependencies/junit.jar" "%%(jdtdir)s/%s"' % jar)
        for jar in ('%(jdtdir)s/org.junit_4.8.1.v4_8_1_v20100427-1100/junit.jar', '%(sdkdir)s/junit4.jar', '%(sdkdir)s/org.junit4/junit.jar'):
            r.Run('ln -v -s -f "%%(eclipsedir)s/dependencies/junit4.jar" "%s"' % jar)

        r.AutoDoc(exceptions='.*')

        r.ComponentSpec('lib', '%(eclipsedir)s/.*.so')

        r.Requires(exceptDeps='java: .*')
        r.Provides(exceptDeps='java: .*')
        r.Requires(exceptDeps=r'soname: ELF.*/libjawt.so.*')

