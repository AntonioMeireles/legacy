#
# Copyright (c) 2008-2011 Foresight Linux
#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelmodulepackage')
loadInstalled('virtualbox-ose')

class VirtualboxKernel(KernelModulePackageRecipe):
    name = 'virtualbox-kernel'
    version = VirtualboxOse.version
 
    buildRequires = [
        'autoconf:runtime',
        'file:runtime',
        'make:runtime',
        'virtualbox-ose:module-source'
      ]
 
    def unpack(r):
        r.addAction('cp -ar /usr/src/VirtualBox/kernel/* .')
        r.Environment('KERN_DIR', '/lib/modules/%(kver)s/build')

    def build(r):
        for suf in ['drv', 'guest', 'netflt', 'netadp', 'sf', 'video']:
            name = 'vbox' + suf
            r.Make('VBOX_USE_INSERT_PAGE=1', dir = name)

    def install(r):
        r.macros.moduledir = 'updates'
        for suf in ['drv', 'guest', 'netflt', 'netadp', 'sf', 'video']:
            name = 'vbox' + suf
        
            r.Install(name + '/*.ko', '/lib/modules/%(kver)s/%(moduledir)s/')

    def policy(r):
        r.ComponentProvides('%(version)s')
        # host  modules : vboxdrv,vboxnetflt,vboxnetadp
        # guest modules : vboxguest,vboxsf,vboxvideo
        # FIXME we should probably split this in two pkgs in order to differentiate
        # host from guest kmods. Point is, no one seems to be doing that ...
        r.ComponentSpec('runtime', '.*')
