#
# Copyright (c) 2008-2013 The Foresight Linux Project
#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadSuperClass('kernelmodulepackage')
loadInstalled('virtualbox-ose')
class VirtualboxKernel(KernelModulePackageRecipe):
    name = 'virtualbox-kernel'
    version = VirtualboxOse.version
 
    buildRequires = [
        'autoconf:runtime',
        'file:runtime',
        'make:runtime',
        'virtualbox-ose:module-source'
      ]
    drivers = ['drv', 'guest', 'netflt', 'netadp', 'sf', 'video', 'pci']

    def unpack(r):
        r.addAction('cp -ar /usr/src/VirtualBox/kernel/* .')
        r.Environment('KERN_DIR', '/lib/modules/%(kver)s/build')
        

    def build(r):
        for suf in r.drivers:
            name = 'vbox' + suf
            r.Make('VBOX_USE_INSERT_PAGE=1', dir = name)

    def install(r):
        r.macros.moduledir = 'updates'
        for suf in r.drivers:
            name = 'vbox' + suf
        
            r.Install(name + '/*.ko', '/lib/modules/%(kver)s/%(moduledir)s/')

    def policy(r):
        r.ComponentProvides('%(version)s')
        r.ComponentSpec('runtime', '.*')
        # host  modules : vboxdrv,vboxnetflt,vboxnetadp
        # guest modules : vboxguest,vboxsf,vboxvideo,vboxpci
        # FIXME we should probably split this in two pkgs in order to differentiate
        # host from guest kmods. Point is, no one seems to be doing that ...
        r.Requires('virtualbox-ose:runtime(%(version)s)',
        '/lib/modules/')
