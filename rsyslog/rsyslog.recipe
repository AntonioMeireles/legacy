#
# Copyright (c) 2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Rsyslog(CPackageRecipe):
    name = 'rsyslog'
    version = '2.0.0'

    buildRequires = [ 'zlib:devel', 'krb5:devel', 'mysql:devel',
        'openssl:devel', 'postgresql:devel', ]

    def setup(r):
        r.addArchive('http://download.rsyslog.com/rsyslog/')

        # there is a config provided in redhat/rsyslog.config, but we want to
        # modify the output format to include the priority at which the message
        # was logged
        r.addSource('config', dest='%(sysconfdir)s/%(name)s.conf', mode=0644)

        r.Configure('--enable-mysql --enable-pgsql --enable-gssapi-krb5')

        r.Make()
        r.MakeInstall()

        r.Install('redhat/rsyslog.log', '%(sysconfdir)s/lograte.d/%(name)s', mode=0644)
        r.Install('redhat/rsyslog.sysconfig', '%(sysconfdir)s/sysconfig/', mode=0644)
        r.Install('redhat/rsyslog.init', '%(initdir)s/%(name)s', mode=0755)
        r.TagSpec('initscript', '%(initdir)s/')

        for x in ('rklogd', 'rsyslogd',):
            r.Move('%(sbindir)s/'+x, '%(essentialsbindir)s/'+x)
            r.Symlink('%(essentialsbindir)s/'+x, '%(sbindir)s/'+x)

        r.ComponentSpec('pgsql', '%(libdir)s/%(name)s/.*pgsql.*')
        r.ComponentSpec('mysql', '%(libdir)s/%(name)s/.*mysql.*')
