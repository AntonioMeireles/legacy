#
# Copyright (c) 2004-2005 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Traceroute(AutoPackageRecipe):

    buildRequires = [ 'libtool:runtime' ] # for the silly config.sub copy(?)
    name = 'traceroute'
    version = '1.4a12'

    def unpack(r):
        srpm = 'ftp://ftp.redhat.com/pub/redhat/linux/enterprise/3/en/os/i386/SRPMS/traceroute-1.4a12-20.src.rpm'

        r.addArchive('ftp://ftp.ee.lbl.gov/traceroute-%(version)s.tar.gz')

        r.addPatch('traceroute-1.4a5-fix.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-secfix.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-autoroute.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-autoroute2.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-unaligned.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-fhs.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-aliases.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-droproot.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-bigpacklen.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a5-lsrr.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a12-sockopt.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a12-sockopt2.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a12-tos-monitoring.patch', rpm=srpm)
        r.addPatch('traceroute-1.4a12-mpls-icmp-02.patch', rpm=srpm)

        r.Run('rm -f config.sub')
        r.Run('cp /usr/share/libtool/config.sub .')

    def makeinstall(r):
        r.MakeDirs('%(essentialbindir)s', '%(mandir)s/man8', '%(sbindir)s')
        r.MakeInstall(installtarget='install install-man')

        r.Symlink('%(essentialbindir)s/traceroute', '%(sbindir)s/')
        r.SetModes('%(essentialbindir)s/traceroute', 04755)
