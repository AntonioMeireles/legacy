#
# Copyright (c) 2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class PolicyKit(AutoPackageRecipe):
    name = 'PolicyKit'
    version = '0.6'

    buildRequires = [ 'libtool:runtime', 'automake:runtime',
                      'autoconf:runtime', 'dbus:devel', 'pkgconfig:devel',
                      'glib:devel', 'dbus-glib:devel', 'dbus-glib:runtime',
                      'pam:devel', 'xmlto:runtime', 'expat:devel',
                      'gnome-doc-utils:devel', 'gnome-doc-utils:runtime',
                      ]

    def unpack(r):
        r.addGitSnapshot('git://anongit.freedesktop.org/git/PolicyKit', tag='POLICY_KIT_0_6')
        r.addPatch('PolicyKit-fix-if-selinux-disabled.patch')
        r.addPatch('wheel.patch')
        r.Run('./autogen.sh')

    def configure(r):
        r.Configure('--with-os-type=redhat --disable-docbook-docs')
    def policy(r):
        r.ExcludeDirectories(exceptions='%(datadir)s/PolicyKit/policy')

        # NOTE: /usr/libexec/polkit-grant-helper will be owned by group
        # 'polkituser', and installed with mode 2755 (setgid binary).
        # The directories /var/run/PolicyKit and /var/lib/PolicyKit will be
        # owned by user 'polkituser' and group 'polkituser' and will be of mode 775.

        # NOTE: /usr/libexec/polkit-grant-helper-pam will be setuid root.

        r.Ownership('root','polkituser','%(libexecdir)s/polkit-grant-helper')
        r.Ownership('root','polkituser','%(libexecdir)s/polkit-grant-helper-pam')
        r.SetModes('%(libexecdir)s/polkit-grant-helper', 2755)
        r.SetModes('%(libexecdir)s/polkit-grant-helper-pam', 4755)

        r.Ownership('polkituser','polkituser','%(localstatedir)s/run/PolicyKit')
        r.Ownership('polkituser','polkituser','%(localstatedir)s/lib/PolicyKit')
        r.SetModes('%(localstatedir)s/run/PolicyKit', 0775)
        r.SetModes('%(localstatedir)s/lib/PolicyKit', 0775)

        # allows x86 and x86_64 :lib co-existence
        r.ComponentSpec(':runtime', '%(localstatedir)s/lib/PolicyKit/reload')
