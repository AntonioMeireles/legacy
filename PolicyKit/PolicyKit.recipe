#
# Copyright (c) 2007-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

#loadSuperClass('rpmpackage')
#class PolicyKit(RPMPackageRecipe,AutoPackageRecipe):
class PolicyKit(AutoPackageRecipe):
    name = 'PolicyKit'
    version = '0.92'
    #rpmRelease = '6.fc11'
    #rpmPatches = [ 'pk-ck-api-change.patch',
     #              'entry-leak.patch',
     #              'polkit-0.8-dbus-policy.patch' ]

    buildRequires = [ 'libtool:runtime', 'automake:runtime',
                      'autoconf:runtime', 'dbus:devel', 'pkgconfig:devel',
                      'glib:devel', 'dbus-glib:devel', 'dbus-glib:runtime',
                      'pam:devel', 'xmlto:runtime', 'expat:devel',
                      'gnome-doc-utils:devel', 'gnome-doc-utils:runtime',
                      'perl-XML-Parser:perl', 'gettext:runtime', 'intltool:runtime',
                      'eggdbus:devel', 'eggdbus:runtime', 'gtk-doc:devel', 'gtk-doc:runtime', 'intltool:devel'
                      ]

    def configure(r):
        r.addArchive("http://cgit.freedesktop.org/PolicyKit/snapshot/")
        #r.addPatch('wheel.patch')
        #    r.addPatch('setgid.patch')
    
        r.Configure('--with-os-type=redhat --disable-selinux --disable-gtk-doc',configureName="autogen.sh")

    def policy(r):
        r.ExcludeDirectories(exceptions='%(datadir)s/PolicyKit/policy')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/PolicyKit-public')

        # see upstream design specification for why these permissions are necessary
        """
        for d in [ 'polkit-set-default-helper',]:
                    r.Ownership('polkituser', 'root', '%(libexecdir)s/' + d)
                    r.SetModes('%(libexecdir)s/' + d, 04755)
        
        for d in [ 'polkit-read-auth-helper',
                   'polkit-revoke-helper',
                   'polkit-explicit-grant-helper',
                   'polkit-grant-helper']:
                    r.Ownership('root','polkituser','%(libexecdir)s/' + d)
                    r.SetModes('%(libexecdir)s/' + d, 02755)

        r.Ownership('root','polkituser','%(libexecdir)s/polkit-grant-helper-pam')
        r.SetModes('%(libexecdir)s/polkit-grant-helper-pam', 04754)

        r.Ownership('root','polkituser','%(libexecdir)s/polkit-resolve-exe-helper')
        r.SetModes('%(libexecdir)s/polkit-resolve-exe-helper', 04755)

        r.Ownership('root','polkituser','%(localstatedir)s/run/PolicyKit')
        r.SetModes('%(localstatedir)s/run/PolicyKit', 0770)

        r.Ownership('root','polkituser','%(localstatedir)s/lib/PolicyKit')
        r.SetModes('%(localstatedir)s/lib/PolicyKit', 0770)

        r.Ownership('polkituser','root','%(localstatedir)s/lib/PolicyKit-public')
        r.SetModes('%(localstatedir)s/lib/PolicyKit-public', 0755)

        r.Ownership('polkituser','polkituser','%(localstatedir)s/lib/misc/PolicyKit.reload')
        r.SetModes('%(localstatedir)s/lib/misc/PolicyKit.reload', 0664)

        """

        # allows x86 and x86_64 :lib co-existence
        r.ComponentSpec(':runtime', '%(localstatedir)s/lib/misc/PolicyKit.reload')
