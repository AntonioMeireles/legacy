#
# Copyright (c) 2007-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class PolicyKit(AutoPackageRecipe):
    name = 'PolicyKit'
    version = '0.7'

    buildRequires = [ 'libtool:runtime', 'automake:runtime',
                      'autoconf:runtime', 'dbus:devel', 'pkgconfig:devel',
                      'glib:devel', 'dbus-glib:devel', 'dbus-glib:runtime',
                      'pam:devel', 'xmlto:runtime', 'expat:devel',
                      'perl-XML-Parser:perl',
                      ]

    def unpack(r):
        r.addArchive('http://hal.freedesktop.org/releases/')

    def configure(r):
        r.addPatch('wheel.patch')
        r.addPatch('bashisms.patch') # RPL-2319
        r.Configure('--with-os-type=redhat --disable-docbook-docs '
                    '--disable-selinux --disable-gtk-doc')

    def policy(r):
        r.ExcludeDirectories(exceptions='%(datadir)s/PolicyKit/policy')

        # see upstream design specification for why these permissions are necessary
        for d in [ 'polkit-set-default-helper', 'polkit-read-auth-helper' ,
                   'polkit-revoke-helper', 'polkit-explicit-grant-helper',
                   'polkit-grant-helper']:
            r.Ownership('root', 'polkituser', '%(libexecdir)s/' + d)
            r.SetModes('%(libexecdir)s/' + d, 02755)

        r.Ownership('root', 'polkituser',
                    '%(libexecdir)s/polkit-grant-helper-pam')
        r.SetModes('%(libexecdir)s/polkit-grant-helper-pam', 04755)

        for item in ('run/PolicyKit', 'lib/PolicyKit'):
            r.Ownership('polkituser', 'polkituser',
                        '%%(localstatedir)s/%s' % item)
            r.SetModes('%%(localstatedir)s/%s'% item, 0770)

        for item in ('lib/PolicyKit-public', 'lib/misc/PolicyKit.reload'):
            r.Ownership('polkituser', 'polkituser',
                        '%%(localstatedir)s/%s' % item)
            r.SetModes('%%(localstatedir)s/%s' % item, 0775)

        # allows x86 and x86_64 :lib co-existence
        r.ComponentSpec(':runtime', '%(localstatedir)s/lib/PolicyKit/reload')
