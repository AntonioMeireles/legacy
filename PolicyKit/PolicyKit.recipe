#
# Copyright (c) 2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class PolicyKit(AutoPackageRecipe):
    name = 'PolicyKit'
    version = '0.5'

    buildRequires = [ 'libtool:runtime', 'automake:runtime',
                      'autoconf:runtime', 'dbus:devel', 'pkgconfig:devel',
                      'glib:devel', 'dbus-glib:devel', 'dbus-glib:runtime',
                      'pam:devel', 'xmlto:runtime', 'expat:devel',
                      'gnome-doc-utils:devel', 'gnome-doc-utils:runtime',
                      ]

    def unpack(r):
        srpm = 'PolicyKit-0.5-1.6.20070821git.fc7.hughsie.src.rpm'
        r.addArchive('%(name)s-%(version)s.tar.gz', rpm=srpm)

    def configure(r):
        r.Configure('--with-os-type=redhat')
    def policy(r):
        r.ExcludeDirectories(exceptions='%(datadir)s/PolicyKit/policy')

        # NOTE: /usr/libexec/polkit-grant-helper will be owned by group
        # 'polkituser', and installed with mode 2755 (setgid binary).
        # The directories /var/run/PolicyKit and /var/lib/PolicyKit will be
        # owned by user 'polkituser' and group 'polkituser' and will be of mode 775.

        # NOTE: /usr/libexec/polkit-grant-helper-pam will be setuid root.

        r.Ownership('polkituser','polkituser','%(libexecdir)s/polkit-grant-helper')
        r.SetModes('%(libexecdir)s/polkit-grant-helper', 02755)
        r.SetModes('%(libexecdir)s/polkit-grant-helper-pam', 02755)

        r.Ownership('polkituser','polkituser','%(localstatedir)s/run/PolicyKit')
        r.Ownership('polkituser','polkituser','%(localstatedir)s/lib/PolicyKit')
        r.SetModes('%(localstatedir)s/run/PolicyKit', 775)
        r.SetModes('%(localstatedir)s/lib/PolicyKit', 775)

        # allows x86 and x86_64 :lib co-existence
        r.ComponentSpec(':runtime', '%(localstatedir)s/lib/PolicyKit/reload')
