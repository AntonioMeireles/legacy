#
# Copyright (c) 2007-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class PolicyKit(RPMPackageRecipe,AutoPackageRecipe):
    name = 'PolicyKit'
    version = '0.95'
    rpmName = 'polkit'
    rpmRelease = '0.git20090913.2.fc12'
    tarballName = 'polkit-%(version)s.git20090913.tar.gz'
    rpmPatches = [ '0001-Fix-process-start-time-when-using-polkit_unix_proces.patch' ]

    buildRequires = [ 'libtool:runtime', 'automake:runtime',
                      'autoconf:runtime', 'dbus:devel', 'pkgconfig:devel',
                      'glib:devel', 'dbus-glib:devel', 'dbus-glib:runtime',
                      'pam:devel', 'xmlto:runtime', 'expat:devel',
                      'gnome-doc-utils:devel', 'gnome-doc-utils:runtime',
                      'perl-XML-Parser:perl', 'gettext:runtime', 'intltool:runtime',
                      'eggdbus:devel', 'eggdbus:runtime', 'gtk-doc:devel',
                      'gtk-doc:runtime', 'intltool:devel', 'gobject-introspection:devel',
                      ]

    # FIXME new upstream naming is polkit. keeping old one for now

    def configure(r):
        r.Configure(' --disable-static --libexecdir=%(libexecdir)s/polkit-1 '
                    ' --enable-introspection --enable-examples --disable-selinux --disable-gtk-doc')

    def policy(r):
        r.ExcludeDirectories(exceptions='%(datadir)s/PolicyKit/policy')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/PolicyKit-public')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/polkit-1')

        r.SetModes('%(localstatedir)s/lib/polkit-1', 0700)
        r.SetModes('%(bindir)s/pkexec', 04755)
        r.SetModes('%(libexecdir)s/polkit-1/polkit-agent-helper-1', 04755)

        for d in [ '%(localstatedir)s/lib/polkit-1/',
                   '%(localstatedir)s/lib/polkit-1/localauthority',
                   '%(localstatedir)s/lib/polkit-1/localauthority/10-vendor.d',
                   '%(localstatedir)s/lib/polkit-1/localauthority/20-org.d',
                   '%(localstatedir)s/lib/polkit-1/localauthority/30-site.d',
                   '%(localstatedir)s/lib/polkit-1/localauthority/50-local.d',
                   '%(localstatedir)s/lib/polkit-1/localauthority/90-mandatory.d']:
            r.MakeDirs(d)
            r.SetModes(d, 0700)
            r.ExcludeDirectories(exceptions = d)

        r.Create('%(localstatedir)s/lib/polkit-1/localauthority/localauthority.conf.d/60-desktop-policy.conf',
                 contents = """
# This allows users in the desktop_admin_r group to authenticate as
# the administrator.
#
# DO NOT EDIT THIS FILE, it will be overwritten on update.

[Configuration]
AdminIdentities=unix-group:desktop_admin_r
""")
        r.Create('%(localstatedir)s/lib/polkit-1/localauthority/10-vendor.d/10-desktop-policy.pkla',
                 contents = """
# Authorizations/policy for the desktop_admin_r and desktop_user_r groups.
#
# DO NOT EDIT THIS FILE, it will be overwritten on update.

# Allow "standard users" to do some things without being interrupted by
# password dialogs (TODO: not complete)
#
[Desktop User Permissions]
Identity=unix-group:desktop_user_r
Action=org.gnome.clockapplet.mechanism.settimezone
ResultAny=no
ResultInactive=no
ResultActive=yes

# Allow "administrative users" to do a lot of things without being interrupted by
# password dialogs (TODO: not complete)
#
[Desktop Administrator Permissions]
Identity=unix-group:desktop_admin_r
Action=org.gnome.clockapplet.mechanism.*;org.freedesktop.devicekit.disks.*;org.freedesktop.RealtimeKit1.*
ResultAny=no
ResultInactive=no
ResultActive=yes

""")

        r.UtilizeGroup('desktop_user_r', '%(bindir)s/pkexec')
        r.UtilizeGroup('desktop_admin_r', '%(bindir)s/pkexec')

        # allows x86 and x86_64 :lib co-existence
        r.ComponentSpec(':runtime', '%(localstatedir)s/lib/misc/PolicyKit.reload')

