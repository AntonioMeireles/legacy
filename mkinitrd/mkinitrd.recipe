#
# Copyright (c) 2004-2005 rpath, Inc.
# All rights reserved
#

class Mkinitrd(PackageRecipe):
    name = 'mkinitrd'
    version = '4.2.15'

    buildRequires = [ 'popt:devel' ]
    if Arch.x86:
        buildRequires.append('dietlibc:devel')

    def setup(r):
        r.macros.rpmrevision = '1'
        srpm = 'ftp://download.fedora.redhat.com/pub/fedora/linux/core/4/SRPMS/mkinitrd-%(version)s-%(rpmrevision)s.src.rpm'

        r.addArchive('mkinitrd-%(version)s.tar.bz2', rpm=srpm)
	r.addSource('kernel.tagdescription', macros=True)
	r.addSource('kernel.taghandler', macros=True)

        # change branding
        r.Replace(('redhat-release', 'distro-release'),
                  ('/redhat', '/foresight'),
                  ('"Red Hat Linux', '"Foresight Linux'),
                  'grubby/{grubby.c,new-kernel-pkg,test.sh}')
	r.addPatch('mkinitrd.patch', level=1)
        r.Make()
        r.MakeInstall('makdir=%(mandir)s', rootVar='BUILDROOT')

	r.Install('kernel.tagdescription', '%(tagdescriptiondir)s/kernel')
	r.Install('kernel.taghandler', '%(taghandlerdir)s/kernel', mode=0755)

        for req in ('tar:runtime', '/bin/awk', '/bin/gawk', 'sed:runtime',
                    'mktemp:runtime', 'module-init-tools:runtime',
                    'util-linux:runtime', 'gzip:runtime', 'coreutils:runtime',
                    'e2fsprogs:runtime', 'grep:runtime'):
            r.Requires(req, '%(essentialsbindir)s/mkinitrd')
