#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Mkinitrd(RPMPackageRecipe, CPackageRecipe):
    name = 'mkinitrd'
    version = '6.0.9'
    rpmRelease = '5'

    buildRequires = [ 'popt:devel', 'device-mapper:devel', 'e2fsprogs:devel',
        'glib:devel', 'parted:devel', 'pkgconfig:devel', 'libdhcp:devel',
        'pump:devel', 'openssl:devel', 'python:devel',
        'libdhcp4client:devel', 'libdhcp6client:devel', 'libnl:devel', ]

    def setup(r):
        r.disableParallelMake()
        r.unpack()
        # nash should be built statically
        r.addPatch('nash-static.patch')
        # in the makefile - we override them by setting CFLAGS when calling make
        r.macros.cflags += ' -D_FORTIFY_SOURCE=2 -fPIC -D_GNU_SOURCE'
        r.addPatch('disable-selinux.patch')
        r.addSource('kernel.tagdescription', macros=True, dest='%(tagdescriptiondir)s/kernel')
        r.addSource('kernel.taghandler', macros=True, dest='%(taghandlerdir)s/kernel', mode=0755)

        # don't try to link against selinux since we don't have it
        r.Replace(('-lsepol', ''), ('-lselinux', ''),
            'Makefile', '*/Makefile', allowNoChange=True)

        # wrap fopen, socket, pipe, etc so __real_fopen doesn't show up as an
        # unresolved symbol... filed upstream as
        # http://bugzilla.redhat.com/bugzilla/show_bug.cgi?id=220746
        r.addPatch('wrapstuff.patch')

        # handle adding firmware to initrd.
        r.addPatch('firmware-handling.patch')
        r.MakeDirs('%(sysconfdir)s/mkinitrd-firmware.d')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/mkinitrd-firmware.d')

        # change branding
        r.Replace(('redhat-release', 'distro-release'),
                  ('/redhat', '/rpath'),
                  ('"Red Hat Linux', '"rPath Linux'),
                  'grubby/{grubby.c,new-kernel-pkg,test.sh}')
        r.Replace('Red Hat ', '', 'nash/nash.c')

        r.Make()
        r.MakeInstall('makdir=%(mandir)s')

        # FIXME: remove once conary-policy with CNP-55 fixed is released
        r.Move('%(prefix)s/lib/pkgconfig/*', '%(libdir)s/pkgconfig/')

