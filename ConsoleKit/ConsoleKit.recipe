#
# Copyright (c) 2007-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class ConsoleKit(RPMPackageRecipe,AutoPackageRecipe):
    name = 'ConsoleKit'
    version = '0.3.0'
    rpmRelease = '8.fc11'
    rpmPatches = [ 'ConsoleKit-0.3.0-get-vt-from-display-instead-of-controlling-tty.patch',
                   # http://bugs.freedesktop.org/show_bug.cgi?id=19020
                   # http://bugs.freedesktop.org/show_bug.cgi?id=20471
                   'consolekit-dbus-permissions.patch',
                   'ConsoleKit-skipvalidation.patch',
                   # http://bugs.freedesktop.org/show_bug.cgi?id=21310
                   'null-warning.patch',
                   ]

    buildRequires = [ 'chkconfig:runtime', 'dbus-glib:devel', 'dbus:devel',
                      'glib:devel', 'libX11:devel', 'libXau:devel',
                      'libXdmcp:devel', 'libxcb:devel', 'pkgconfig:devel',
                      'xmlto:runtime', 'pam:devel', 'dbus:devellib',
                      'PolicyKit:devel', 'zlib:devel','gettext:runtime',
                      'automake:runtime', 'autoconf:runtime',
                      'libtool:runtime', 'libtool:devel'
                      ]

    def configure(r):
        r.Run('autoreconf -fi')
        r.Configure('--with-pid-file=%(localstatedir)s/run/'
                     'console-kit-daemon.pid --enable-pam-module '
                     '--with-pam-module-dir=/%(lib)s/security')

    def policy(r):
        # get around missing trailing newsline
        r.Run('echo >> %(destdir)s/%(sysconfdir)s/ConsoleKit/seats.d/'
              '00-primary.seat')

        r.Create('/var/log/ConsoleKit/history') 
        r.InitialContents('/var/log/ConsoleKit/history')

        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/ConsoleKit')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/log/ConsoleKit')
        r.Ownership('root','root','%(localstatedir)s/log/ConsoleKit')
        r.SetModes('%(localstatedir)s/log/ConsoleKit', 0755)

        r.ExcludeDirectories(exceptions='/usr/lib/ConsoleKit/run-session.d')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/ConsoleKit/run-session.d')

        # allows x86 and x86_64 :lib co-existence
        r.ComponentSpec(':runtime', '/usr/lib/ConsoleKit/scripts/.*')
