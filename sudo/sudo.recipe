#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Sudo(CPackageRecipe):
    name = 'sudo'
    version = '1.6.9p12'

    buildRequires = [ 'pam:devel', 'groff:runtime' ]

    def setup(r):
        r.addArchive('ftp://ftp.sudo.ws/pub/sudo/')
        r.addSource('sudo.pam', dest='%(sysconfdir)s/pam.d/sudo')

        r.macros.cflags += ' -fpie'
        r.macros.ldflags += ' -pie'

        r.Configure('--with-logging=syslog --with-logfac=authpriv'
                    ' --with-editor=%(essentialbindir)s/vi'
                    ' --with-env-editor --with-ignore-dot'
                    ' --with-tty-tickets --without-interfaces'
                    ' --with-pam')

        r.Make()

        r.MakeInstall('install_uid=0 install_gid=0'
                      ' sudoers_uid=0 sudoers_gid=0')
        r.MakeDirs('%(localstatedir)s/run/sudo/', mode=0700)
        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/sudo')

        r.SetModes('%(bindir)s/sudo{edit,}', 04511)
        r.SetModes('%(sysconfdir)s/sudoers', 0440)

        r.Doc('TROUBLESHOOTING', 'UPGRADE', '*.pod')

        # bison is used only in a commented-out section of the Makefile
        r.EnforceConfigLogBuildRequirements(exceptions='%(bindir)s/bison')
