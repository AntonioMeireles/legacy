#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Sudo(CPackageRecipe):
    name = 'sudo'
    version = '1.7.2p1'

    buildRequires = [ 'pam:devel', 'groff:runtime' ]

    srpm = 'ftp://ftp.redhat.com/redhat/linux/enterprise/5Server/en/os/SRPMS/%(name)s-%(version)s-8.el5_5.src.rpm'

    def setup(r):
        r.addArchive('sudo-1.7.2p1.tar.gz',rpm=r.srpm)
        r.addSource('sudo.pam', dest='%(sysconfdir)s/pam.d/sudo')
        # We don't use Red Hat's sudoers file due to RPL-3253
        # r.addSource('sudo-1.7.2p1-sudoers', dest='%(sysconfdir)s/sudoers',
        #             rpm=r.srpm)

        r.addPatch('sudo-1.6.7p5-strip.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-login.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-envdebug.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.1-libtool.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.1-getgrouplist.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-audit.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-negation.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-includedir.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-loopsegv3.patch',rpm=r.srpm)
        # RPL-3231, CVE-2010-0426
        r.addPatch('sudo-1.7-CVE-2010-0426.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2-pseudocmd2.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p2-envsanitize.patch',rpm=r.srpm)
        r.addPatch('sudo-1.7.2p1-bz628628.patch',rpm=r.srpm)


        r.macros.cflags += ' -fpie'
        r.macros.ldflags += ' -pie'

        r.Configure('--with-logging=syslog --with-logfac=authpriv'
                    ' --with-editor=%(essentialbindir)s/vi'
                    ' --with-env-editor --with-ignore-dot'
                    ' --with-tty-tickets --without-interfaces'
                    ' --with-pam')

        r.Make()

        r.MakeInstall('install_uid=0 install_gid=0'
                      ' sudoers_uid=0 sudoers_gid=0')
        r.MakeDirs('%(localstatedir)s/run/sudo/', mode=0700)
        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/sudo')

        r.SetModes('%(bindir)s/sudo{edit,}', 04511)
        r.SetModes('%(sysconfdir)s/sudoers', 0440)

        r.Doc('TROUBLESHOOTING', 'UPGRADE', '*.pod')

        # bison is used only in a commented-out section of the Makefile
        r.EnforceConfigLogBuildRequirements(exceptions='%(bindir)s/bison')
