#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class ManPages(RPMPackageRecipe, CPackageRecipe):
    name = 'man-pages'
    version = '2.43'
    rpmRelease = '11.fc7'

    # glibc provides iconv
    buildRequires = [ 'glibc:runtime', 'diffutils:runtime'  ]

    def setup(r):
        r.addArchive('http://www.kernel.org/pub/linux/docs/manpages/')
        r.addArchive('man-pages-extralocale.tar.bz2', rpm=r.srpm,
            dir='man-pages-%(version)s')

        r.addSource('rpcgen.1', rpm=r.srpm,
            dir='man1')

        r.addPatch('man-pages-1.51-iconv.patch', rpm=r.srpm)
        r.addPatch('man-pages-1.51-nopent.patch', rpm=r.srpm)
        r.addPatch('man-pages-1.60-re_comp.patch', rpm=r.srpm)
        r.addPatch('man-pages-1.60-issue.patch', rpm=r.srpm)

        r.Run('rm man1/README')

        manSubDirs = range(1, 10)
        for dir in manSubDirs:
            r.MakeDirs('%(mandir)s/{,en}/man' + str(dir))


        # Convert some strange manpages to UTF-8
        brokenManPages = [ ('iso_8859-15', '7'),
                           ('iso_8859-16', '7'),
                           ('iso_8859-1',  '7'),
                           ('iso_8859-2',  '7'),
                           ('iso_8859-9',  '7'),
                           ('koi8-r',      '7') ]

        for manpage, section in brokenManPages:
            manFile = 'man' + section + '/' + manpage + '.' + section

            r.Run('iconv -f %s -t UTF-8 %s -o %s.conv' %
                  (manpage.upper(), manFile, manFile))
            r.Run('mv %s.conv %s' % (manFile, manFile))


        # Install appropriate man pages
        r.Run("""
            for n in man?/* ; do
                cp -a $n %(destdir)s%(mandir)s/$n
            done
        """)

        r.Doc('man-pages-%(version)s.Announce')

        # These are parts of fileutils
        r.Remove('%(mandir)s/man1/'
                        '{chgrp,chmod,chown,cp,dd,df,dircolors,du,install}.1')
        r.Remove('%(mandir)s/man1/{ln,ls,mkdir,mkfifo,mknod,mv,rm,rmdir,touch}.1')
        r.Remove('%(mandir)s/man1/{dir,vdir}.1')

        # Part of diffutils
        r.Remove('%(mandir)s/man1/diff.1')

        # Part of quota
        r.Remove('%(mandir)s{,/en}/man2/quotactl.2')

        # Part of console-tools
        r.Remove('%(mandir)s/man4/console.4')

        # Part of bind-utils
        r.Remove('%(mandir)s/man5/resolver.5')

        # Only briefly part of a devel version of glibc
        r.Remove('%(mandir)s/man3/freehostent.3')

        # Part of libcap
        r.Remove('%(mandir)s/man2/capget.2')
        r.Remove('%(mandir)s/man2/capset.2')

        # Part of libattr-devel
        r.Remove('%(mandir)s{,/en}/man2/{fgetxattr,flistxattr,fremovexattr,fsetxattr,getxattr,lgetxattr,listxattr,llistxattr,lremovexattr,lsetxattr,removexattr,setxattr}.2*')

        # Part of shadow
        r.Remove('%(mandir)s/man3/getspnam.3')

        # Provided by bind-utils
        r.DanglingSymlinks(exceptions='/usr/share/man/man5/resolv.conf.5.gz')
