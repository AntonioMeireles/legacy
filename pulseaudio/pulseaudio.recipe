#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class PulseAudio(RPMPackageRecipe,AutoPackageRecipe):
    name = 'pulseaudio'
    version  = '0.9.21'
    rpmRelease = '5.fc12'

    rpmPatches = [  '0001-dbus-remove-filter-functions-only-if-they-were-actua.patch',
                    '0002-native-fix-request-counter-miscalculations.patch',
                    '0003-core-make-sure-we-always-return-a-valid-memblock-in-.patch',
                    '0004-bluetooth-destruct-stream-only-if-it-is-not-already-.patch',
                    '0005-bluetooth-don-t-hit-an-assert-if-latency-is-queried-.patch',
                    '0006-client-detect-forking-in-sample-cache-API-too.patch',
                    '0007-client-verify-connection-state-in-pa_stream_connect_.patch',
                    '0008-udev-don-t-forget-to-unref-devices-we-are-not-intere.patch',
                    '0009-once-make-once-related-variables-volatile.patch',
                    '0010-bluetooth-fix-invalid-memory-access.patch',
                    '0011-log-add-an-easy-way-to-disable-log-rate-limiting.patch',
                    '0012-udev-make-sure-we-get-events-only-for-sound-devices.patch',
                    '0013-alsa-ignore-volume-changes-from-the-hw-if-we-are-not.patch',
                    '0014-cpu-check-for-CMOV-flag-before-using-this-intsructio.patch',
                    '0015-alsa-cover-Input-Source-Int-Mic.patch',
                    '0016-alsa-Cover-the-Int-Mic-Boost-element.patch',
                    '0017-udev-handle-sound-cards-with-both-modem-and-audio-pr.patch',
                    '0018-udev-rework-modem-detection-a-bit.patch',
                    '0019-daemon-first-take-name-on-the-bus-then-return-in-sta.patch',
                    '0020-alsa-cover-bass-boost-mixer-element.patch',
                    '0021-Mark-shared-variables-as-volatile.patch',
                    '0022-udev-use-ID_MODEL_ENC-instead-of-ID_MODEL-if-it-is-s.patch',
                    '0023-pacat-allow-configuration-of-latency-in-msec.patch',
                    '0024-client-implement-PULSE_LATENCY_MSEC.patch',
                    '0025-client-include-dolby-channel-names-in-comments.patch',
                    '0026-alsa-add-profile-set-for-M-Audio-FastTrack-Pro-USB.patch',
                    '0027-threaded-mainloop-Properly-initialise-m-n_waiting_fo.patch',
                    '0028-udev-Use-SOUND_CLASS-instead-of-SOUND_FORM_FACTOR-wh.patch',
                    '0029-More-src-pulsecore-cpu-arm.c-FTBFS-fixes.patch',
                    '0030-Fix-the-following-warnings-which-now-cause-buildd-fa.patch',
                    '0031-libpulse-Store-pa_stream-pointers-to-hashmaps-instea.patch',
                    '0032-native-rework-handling-of-seeks-that-depend-on-varia.patch',
                    '0033-core-Fix-macro-typo-PA_SINK_IS_LINKED-PA_SINK_INPUT_.patch',
                    '0034-alsa-cover-Desktop-Speaker-mixer-elements.patch',
                    '0035-alsa-cover-Shared-Mic-Line-in-Analog-Source.patch',
                    '0036-alsa-cover-Internal-Mic-elements.patch',
                    '0037-alsa-use-default-output-port-names.patch',
                    '0038-build-sys-add-gobject-to-build-dependencies.patch',
                    '0039-padsp-emulate-dev-audio-too.patch',
                    '0040-dbus-first-restart-timer-then-dispatch-it.patch',
                    '0041-fdsem-be-more-verbose-when-reading-from-eventfd-fail.patch',
                    '0042-pacat-always-fully-fulfill-write-requests.patch',
                    '0043-pacmd-store-away-fd-type.patch',
                    '0044-pacmd-don-t-enter-busy-loop-when-reading-from-stdin-.patch',
                    '0045-shm-don-t-complain-about-missing-SHM-segments.patch',
                    '0046-vala-fix-definition-of-INVALID_INDEX.patch',
                    '0047-vala-fix-definition-of-the-GLib-mainloop-adapter.patch',
                    '0048-Add-missing-profile-and-alsa-mixer-paths-to-src-Make.patch',
                    '0049-channelmap-Use-Subwoofer-as-pretty-name-for-LFE.patch',
                    '0050-vala-fix-wrapping-of-port-setting-calls.patch',
                    '0051-proplist-explicitly-mention-a-role-test.patch',
                    '0052-stream-restore-be-a-little-bit-more-verbose-why-we-d.patch',
                    '0053-sample-cache-use-the-sample-name-as-unmodified-fallb.patch',
                    '0054-scache-when-playing-a-sample-from-the-cache-make-sur.patch',
                    '0055-pacat-pass-buffer_attr-to-recording-streams-too.patch',
                    '0056-suspend-on-idle-resume-audio-device-even-for-initial.patch',
                    '0057-native-improve-logging-for-buffer_attrs.patch',
                    '0058-alsa-util-strip-spaces-from-ALSA-card-pcm-names.patch',
                    '0059-alsa-reset-max_rewind-max_request-while-suspending.patch',
                    '0060-core-util-introduce-generic-function-pa_strip.patch',
                    '0061-esd-simple-use-pa_memblockq_pop_missing.patch',
                    '0062-core-rework-how-stream-volumes-affect-sink-volumes.patch',]

    rpmSources = [ 'default.pa-for-gdm']

    buildRequires = [ 'GConf:devel', 'ORBit2:devel', 'alsa-lib:devel', 'avahi:devel', 'hal:devel', 'libcap:devel', 'liboil:devel', 'libsamplerate:devel', 'libsndfile:devel', 'libtool:devel', 'm4:runtime', 'tcp_wrappers:devel', 'libatomic_ops:devel', 'libtool:runtime', 'autoconf:runtime','automake:runtime', 'gettext:devel', 'polkit:devel', 'bluez:devel', 'gcc-fortran:runtime', 'jack:devel', 'libICE:devel', 'libSM:devel', 'pkgconfig:devel', 'lirc:devel', 'gcc-c++:runtime', 'gdbm:devel', 'speex:devel', 'perl-XML-Parser:perl' ,'intltool:runtime', 'intltool:devel', 'gettext:runtime',  'libXext:devel', 'libXtst:devel', 'openssl:devel', 'udev:devel', 'inputproto:devel', 'libXtst:devel',  'libXi:devel' ]

    def configure(r):
        # from pulse git 

        # core-util: introduce FD_CLOEXEC wrappers for open/socket/pipe/accept
        # Lennart Poettering [Fri, 30 Oct 2009 02:30:42 +0000 (03:30 +0100)]
        ## CNY-3408 r.addPatch('http://git.0pointer.de/?p=pulseaudio.git;a=patch;h=9c1a98953f25aff7f11af80a073c9c46dee2438c')
        r.addPatch('pulseaudio.git-9c1a98953f25aff7f11af80a073c9c46dee2438c.patch')

        # use cloexec wrappers wherever applicable
        # Lennart Poettering [Fri, 30 Oct 2009 02:32:38 +0000 (03:32 +0100)]
        ## CNY-3408 r.addPatch('http://git.0pointer.de/?p=pulseaudio.git;a=patch;h=65e7bc18a9a7b89e55b87a74ae47d45269b51847')
        r.addPatch('pulseaudio.git-65e7bc18a9a7b89e55b87a74ae47d45269b51847.patch')
        # core-util: make sure to enable FD_CLOEXEC unconditionally to cope with kernels that...
        ## CNY-3408 r.addPatch('http://git.0pointer.de/?p=pulseaudio.git;a=patch;h=a698ee3f52e9d61b378cb0dad2cfb1bcc31c708a')
        r.addPatch('pulseaudio.git-a698ee3f52e9d61b378cb0dad2cfb1bcc31c708a.patch')
        # core-util: introduce pa_fopen_cloexec()
        ## CNY-3408 r.addPatch('http://git.0pointer.de/?p=pulseaudio.git;a=patch;h=752727a13d2d55439aefe618677f7e932acc9862')
        r.addPatch('pulseaudio.git-752727a13d2d55439aefe618677f7e932acc9862.patch')
        # tdb: use O_CLOEXEC if available
        ## CNY-3408 r.addPatch('http://git.0pointer.de/?p=pulseaudio.git;a=patch;h=88b72958bebd1770e45a4af2dc9fec75aaf1f2de')
        r.addPatch('pulseaudio.git-88b72958bebd1770e45a4af2dc9fec75aaf1f2de.patch')
        # use pa_fopen_cloexec() where applicable
        ## CNY-3408 r.addPatch('http://git.0pointer.de/?p=pulseaudio.git;a=patch;h=168be3830ae291dd819abebec813f76151487bb3')
        r.addPatch('pulseaudio.git-168be3830ae291dd819abebec813f76151487bb3.patch')

        r.addPatch('inotifyCompat.hack')
        
        # from ubuntu (gets resume right, hopefully) [I]
        r.addPatch('pulse-pm-utils-hooks.patch')

        extraConfig = (' --disable-static --disable-rpath '
                       ' --with-system-user=pulse '
                       ' --with-system-group=pulse '
                       ' --with-access-group=pulse-access '
                       # FIXME --enable-udev --disable-hal works sanely in my box
                       # sadly some ppl are reporting issues with it (FL-2444)
                       # that can be rooted directly to enabling udev. 
                       # albeit i could _not_ reproduce those issues (pulse
                       # daemon half-starts  and isn't killed by pulseaudio -k
                       # i 'm returning to old behaviour as it was safe before
                       # for all users.
                       #' --disable-udev --enable-hal --enable-hal-compat ')
                       ' --enable-udev --disable-hal --disable-hal-compat ')
        r.Configure(extraConfig)

    def make(r):
        r.Make('LIBTOOL=%(bindir)s/libtool')

        for x in [ 'liboss-util',
                   'module-oss',
                   'module-detect',
                   'module-pipe-sink',
                   'module-pipe-source',
                   'module-device-manager',]:
            r.Remove('%(libdir)s/pulse-%(version)s/modules/' + x + '.so')

        r.Remove('%(bindir)s/start-pulseaudio-kde')
        r.Remove('%(sysconfdir)s/xdg/autostart/pulseaudio-kde.desktop')

    def policy(r):
        # configure --disable-static had no effect; delete manually.
        # FIXME lines bellow bust things for a number of our users
        # (cannot repro here)
        
        #r.Remove('%(libdir)s/*.a', allowNoMatch = True)
        #r.Remove('%(libdir)s/pulse-%(version)s/modules/*.a', allowNoMatch = True)
        #for mod in [ 'liboss-util', 'module-oss', 
        #             'module-detect', 'module-pipe-sink', 
        #             'module-pipe-source']:
        #            r.Remove('%(libdir)s/pulse-%(version)s/modules/' + mod + '.so',
        #                     allowNoMatch = True)

        r.Symlink('%(bindir)s/esdcompat','%(bindir)s/esd')
        r.UtilizeGroup('pulse', '%(bindir)s/pulseaudio')
        r.UtilizeGroup('pulse-access', '%(bindir)s/pulseaudio')
        r.UtilizeGroup('pulse-rt', '%(bindir)s/pulseaudio')

        r.Requires('esound:runtime', '%(bindir)s/esd')
        r.Requires('flac:lib', '%(bindir)s/pulseaudio')
        # r.Requires('rtkit:runtime', '%(bindir)s/pulseaudio')

        r.MakeDirs('%(localstatedir)s/lib/pulse')
        r.SetModes('%(localstatedir)s/lib/pulse', 0700)
        r.Ownership('pulse', 'pulse', '%(localstatedir)s/lib/pulse')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/pulse')

        r.MakeDirs('%(localstatedir)s/lib/gdm/.pulse/')
        r.Install('default.pa-for-gdm', '%(localstatedir)s/lib/gdm/.pulse/default.pa', 
                  # allows for multilib 
                  package = 'pulseaudio:runtime')
        # allows for multilib 
        r.ComponentSpec('runtime', '/lib/udev/.*')

        r.SetModes('%(localstatedir)s/lib/gdm/.pulse', 0700)
        r.Ownership('gdm', 'gdm', '%(localstatedir)s/lib/gdm/.pulse')

        r.SetModes('%(localstatedir)s/lib/gdm/.pulse', 0600)
        r.Ownership('gdm', 'gdm', '%(localstatedir)s/lib/gdm/.pulse/default.pa')


        r.SetModes('%(libexecdir)s/pulse/proximity-helper', 04755)

        # from ubuntu (gets resume right, hopefully) [II]
        r.Install('01PulseAudio', '%(libdir)s/pm-utils/sleep.d/', mode = 0755)
        r.Requires('pm-utils:runtime', '%(libdir)s/pm-utils/sleep.d/.*')
