#
#1;1704;0c Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class PulseAudio(RPMPackageRecipe,AutoPackageRecipe):
    name = 'pulseaudio'
    version  = '0.9.15'
    rpmRelease = '16.fc11'

    rpmPatches = [ '0001-alsa-allow-configuration-of-fallback-device-strings.patch', 
                   '0001-util-if-NULL-is-passed-to-pa_path_get_filename-ju.patch', 
                   '0001-alsa-don-t-hit-an-assert-when-invalid-module-argume.patch', 
                   '0001-alsa-fix-wording-we-are-speaking-of-card-profiles.patch', 
                   '0001-alsa-initialize-buffer-size-before-number-of-period.patch', 
                   '0001-conf-remove-obsolete-module-idle-time-directive-fro.patch', 
                   '0001-core-make-sure-soft-mute-status-stays-in-sync-with.patch', 
                   '0001-endian-fix-LE-BE-order-for-24-bit-accessor-function.patch', 
                   '0001-log-print-file-name-only-when-we-have-it.patch', 
                   '0001-man-document-24bit-sample-types-in-man-page.patch', 
                   '0001-man-document-log-related-daemon.conf-options.patch', 
                   '0001-man-document-that-tsched-doesn-t-use-fragment-setti.patch', 
                   '0001-mutex-when-we-fail-to-fill-in-mutex-into-static-mut.patch', 
                   '0001-oss-don-t-deadlock-when-we-try-to-resume-an-OSS-dev.patch', 
                   '0001-simple-protocol-don-t-hit-an-assert-when-we-call-co.patch', 
                   '0001-idxset-add-enumeration-macro-PA_IDXSET_FOREACH.patch', 
                   '0001-rescue-streams-when-one-stream-move-fails-try-to-co.patch', 
                   '0001-sample-correctly-pass-s24-32-formats.patch', 
                   '0001-sample-util-fix-iteration-loop-when-adjusting-volum.patch', 
                   '0001-sample-util-properly-allocate-silence-block-for-s24.patch', 
                   '0001-sconv-fix-a-few-minor-conversion-issues.patch', 
                   '0001-alsa-be-a-bit-more-verbose-when-a-hwparam-call-fail.patch', 
                   '0001-rescue-make-we-don-t-end-up-in-an-endless-loop-when.patch', 
                   '0001-core-introduce-pa_-sink-source-_set_fixed_latency.patch', 
                   '0001-core-cache-requested-latency-only-when-we-are-runni.patch', 
                   '0001-sample-fix-build-on-BE-archs.patch', 
                   '0001-alsa-properly-convert-return-values-of-snd_strerror.patch', 
                   '0001-alsa-remove-debug-code.patch', 
                   '0001-Remove-exploitable-LD_BIND_NOW-hack-CVE-2009-1894.patch',
                   ]


    buildRequires = [ 'GConf:devel', 'ORBit2:devel', 'alsa-lib:devel', 'avahi:devel', 'hal:devel', 'libcap:devel', 'liboil:devel', 'libsamplerate:devel', 'libsndfile:devel', 'libtool:devel', 'm4:runtime', 'tcp_wrappers:devel', 'libatomic_ops:devel', 'libtool:runtime', 'autoconf:runtime','automake:runtime', 'gettext:devel', 'PolicyKit:devel', 'bluez-libs:devel', 'gcc-fortran:runtime', 'jack:devel', 'libICE:devel', 'libSM:devel', 'pkgconfig:devel', 'lirc:devel', 'gcc-c++:runtime', 'gdbm:devel', 'speex:devel', 'perl-XML-Parser:perl' ,'intltool:runtime', 'intltool:devel', 'gettext:runtime',  'libXext:devel', 'libXtst:devel', 'openssl:devel', 'udev:devel', 'inputproto:devel' ]

    def configure(r):
        extraConfig = ' --disable-ltdl-install --disable-static --disable-rpath --with-system-user=pulse --with-system-group=pulse --with-realtime-group=pulse-rt --with-access-group=pulse-access'
        r.Configure(extraConfig)

    def make(r):
        r.Make('LIBTOOL=%(bindir)s/libtool')

    def policy(r):
        # r.Remove('%(libdir)s/libpulsecore.so')

        r.SetModes('%(bindir)s/pulseaudio', 04755)
        r.Ownership('root', 'root', '%(bindir)s/pulseaudio')

        r.SetModes('%(libexecdir)s/pulse/proximity-helper', 04755)

        r.Symlink('%(bindir)s/esdcompat','%(bindir)s/esd')
        r.UtilizeGroup('pulse', '%(bindir)s/pulseaudio')
        r.UtilizeGroup('pulse-access', '%(bindir)s/pulseaudio')
        r.UtilizeGroup('pulse-rt', '%(bindir)s/pulseaudio')

        r.Requires('esound:runtime', '%(bindir)s/esd')
        r.Requires('flac:lib', '%(bindir)s/pulseaudio')
        r.Requires('pavucontrol:runtime', '%(bindir)s/pulseaudio')

        r.MakeDirs('%(localstatedir)s/lib/pulse')
        r.SetModes('%(localstatedir)s/lib/pulse', 0700)
        r.Ownership('pulse', 'pulse', '%(localstatedir)s/lib/pulse')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/pulse')
