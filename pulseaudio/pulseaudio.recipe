#
#1;1704;0c Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class PulseAudio(RPMPackageRecipe,AutoPackageRecipe):
    name = 'pulseaudio'
    version  = '0.9.13'
    rpmRelease = '4.fc10'

    rpmPatches = [ '0001-Initialize-exit_idle_time-to-1-instead-of-0-when-i.patch',
                   '0002-Unload-module-bluetooth-device-if-the-remote-device.patch',
                   '0003-instead-of-resetting-virtual_volume-unconditionally.patch',
                   '0004-use-pa_channel_map_init_extend-instead-of-pa_chann.patch',
                   '0005-if-the-channel-map-was-modified-due-to-PA_SINK_INPUT.patch',
                   '0006-define-0dB-in-PA-as-maximum-amplification.patch',
                   '0007-Fix-a-potential-C-C99-ism-add-a-log-message-on-er.patch',
                   '0008-Fix-two-typos-that-broke-tunnels.patch',
                   '0009-properly-remove-dbus-matches-an-filters-when-unloadi.patch',
                   '0010-Fix-possible-invalid-read-while-attempting-to-load-m.patch',
                   '0011-always-check-for-libtool-prefix-binary-name-to-avoid.patch',
                   '0012-Fix-spelling-of-privilige.patch',
                   '0013-Make-missing-git-changelog.perl-non-fatal.patch',
                   '0014-fix-invalid-validity-check.patch',
                   '0015-convert-argument-to-boolean-int-in-PA_UNLIKELY-too.patch',
                   '0016-include-log.h-near-the-end-so-that-macro.h-can-be-in.patch',
                   '0017-Try-to-catch-certain-driver-errors.patch',
                   '0018-make-the-debug-trap-macro-a-proper-macro-in-macro.h.patch',
                   '0019-don-t-set-the-volume-of-pacat-unless-it-is-explicitl.patch',
                   '0020-warn-if-ALSA-wakes-us-up-and-there-is-actually-nothi.patch',
                   '0021-fix-build.patch',
                   '0022-make-sure-to-use-64bit-rounding-even-on-32bit-machin.patch',]

    buildRequires = [ 'GConf:devel', 'ORBit2:devel', 'alsa-lib:devel', 'avahi:devel', 'hal:devel', 'libcap:devel', 'liboil:devel', 'libsamplerate:devel', 'libsndfile:devel', 'libtool:devel', 'm4:runtime', 'tcp_wrappers:devel', 'libatomic_ops:devel', 'libtool:runtime', 'autoconf:runtime','automake:runtime', 'gettext:devel', 'PolicyKit:devel', 'bluez-libs:devel', 'gcc-fortran:runtime', 'jack:devel', 'libICE:devel', 'libSM:devel', 'pkgconfig:devel', 'lirc:devel', 'gcc-c++:runtime', 'gdbm:devel', 'speex:devel', 'perl-XML-Parser:perl' ,'intltool:runtime', 'intltool:devel', 'gettext:runtime', 'valgrind:devel',]

    def configure(r):
        extraConfig = ' --disable-ltdl-install --disable-static --disable-rpath --with-system-user=pulse --with-system-group=pulse --with-realtime-group=pulse-rt --with-access-group=pulse-access'
        r.Configure(extraConfig)

    def make(r):
        r.Make('LIBTOOL=%(bindir)s/libtool')

    def policy(r):
        r.Remove('%(libdir)s/libpulsecore.so')

        r.SetModes('%(bindir)s/pulseaudio', 04755)
        r.Ownership('root', 'root', '%(bindir)s/pulseaudio')

        r.SetModes('%(libexecdir)s/pulse/proximity-helper', 04755)

        r.Symlink('%(bindir)s/esdcompat','%(bindir)s/esd')
        r.UtilizeGroup('pulse', '%(bindir)s/pulseaudio')
        r.UtilizeGroup('pulse-access', '%(bindir)s/pulseaudio')
        r.UtilizeGroup('pulse-rt', '%(bindir)s/pulseaudio')

        r.Requires('esound:runtime', '%(bindir)s/esd')
        r.Requires('flac:lib', '%(bindir)s/pulseaudio')

        r.MakeDirs('%(localstatedir)s/lib/pulse')
        r.SetModes('%(localstatedir)s/lib/pulse', 0700)
        r.Ownership('pulse', 'pulse', '%(localstatedir)s/lib/pulse')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/lib/pulse')
