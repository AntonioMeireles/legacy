#
# Copyright (c) 2007-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Ghostscript(CPackageRecipe):
    name = 'ghostscript'
    version = '8.61'

    buildRequires = [ 'SDL:devel', 'libICE:devel', 'libSM:devel',
        'libX11:devel', 'libXext:devel', 'libXt:devel', 'perl:runtime',
        'cups:devel', 'fontconfig:devel', 'libjpeg:devel', 'libpng:devel',
        'libstdc++:devel', 'libtiff:devel', 'openssl:devel',
        'pkgconfig:devel', 'zlib:devel', 'expat:devel', 'gnutls:devel']

    def setup(r):
        r.macros.upver = r.version.replace('.', '')
        r.addArchive('mirror://sourceforge/%(name)s/')

        # RPL-2217 CVE-2008-0411
        r.addPatch('ghostscript-8.61.CVE-2008-0411.patch')

        # RPL-2991 CVE-2009-0583 CVE-2009-0584
        r.addPatch('ghostscript-CVE-2009-0583.patch')

        # RPL-
        r.addPatch('CVE-2009-0196.patch', dir='jbig2dec')
        r.addPatch('CVE-2009-0792.patch')
        r.addPatch('CVE-2007-6725.patch')
        r.addPatch('CVE-2008-6679.patch')

        r.macros.cflags += ' -fPIC '

        r.Configure()
        r.Make('so')
        r.Make()
        r.MakeInstall()
        r.MakeInstall(installtarget='soinstall')

        r.Move('%(bindir)s/gsc', '%(bindir)s/gs')
        r.Remove('%(bindir)s/gsx')

        # Don't ship files that get shipped in the cups package.
        r.Remove('%(sysconfdir)s/cups', recursive = True)
        r.Remove('%(libdir)s/cups/filter', recursive = True)
        r.Remove('/lib/cups/filter')
        # r.Remove('%(datadir)s/cups/model/')
        #r.ComponentSpec('cups', '/etc/cups/', '%(libdir)s/cups/filter/',
        #                        '%(datadir)s/cups/model/')

