#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class Chkconfig(RPMPackageRecipe, CPackageRecipe):
    name = 'chkconfig'
    version = '1.3.32'
    rpmRelease = '1'

    buildRequires = [ 'popt:devel', ]
    if not Use.bootstrap:
        buildRequires.extend([ 'gettext:runtime',
            'newt:devel', 'newt:runtime',])

    def setup(r):
        r.unpack()
        r.addSource('initscript.tagdescription', macros=True,
                    dest='%(tagdescriptiondir)s/initscript')
        r.addSource('initscript.taghandler', macros=True,
                    dest='%(taghandlerdir)s/initscript', mode=0755)
        r.addSource('chkconfig-override.tagdescription', macros=True,
                    dest='%(tagdescriptiondir)s/chkconfig-override')
        r.addSource('chkconfig-override.taghandler', macros=True,
                    dest='%(taghandlerdir)s/chkconfig-override', mode=0755)

        if Use.bootstrap:
            r.Replace(('ntsysv alternatives', 'alternatives'),
                      ('install.*ntsysv.*', 'true'),
                      ('SUBDIRS = po', 'SUBDIRS ='), 'Makefile')

        r.macros.cflags += ' -D_GNU_SOURCE'
        # fix build failure in Makefile
        r.Remove('po/chkconfig.pot')
        r.Make(forceFlags=True)
        r.MakeInstall('MANDIR=%(mandir)s', rootVar='instroot')
        # needed for LSB compliance -- used in taghandler for maximum
        # compatibility with LSB-compliant apps on system
        r.Symlink('chkconfig', '%(essentialsbindir)s/install_initd')
        r.Symlink('chkconfig', '%(essentialsbindir)s/remove_initd')

        # take responsibility for these directories
        r.ExcludeDirectories(exceptions='(%(sysconfdir)s|%(localstatedir)s/lib)/alternatives')
        r.PackageSpec('ntsysv', '/usr/sbin/ntsysv', '%(mandir)s/.*/ntsysv.*')

        # install_initd breaks if initscript dirs missing (RPL-646)
        r.Requires('initscripts:runtime', '%(essentialsbindir)s/install_initd')

        r.Requires('/bin/basename', '%(taghandlerdir)s/initscript')

        # RPL-1178 - alternatives not needed for apliances
        r.PackageSpec('chkconfig-alternatives', '.*alternatives.*')
