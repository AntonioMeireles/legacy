#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('binarypackage=conary.rpath.com@rpl:devel')
class Skype(BinaryPackageRecipe):

    name = 'skype'
    version = '2.1.0.81'
    buildRequires = ['gtk:runtime']
    def unpack(r):

        r.addArchive('http://download.skype.com/linux/')

        files = [
            ('skype', '/opt/%(name)s/%(name)s.bin'),
            ('skype.desktop', '%(datadir)s/applications/'),
            ('skype.conf', '%(sysconfdir)s/dbus-1/system.d/'),
            ('icons/SkypeBlue_48x48.png', '%(datadir)s/icons/skype.png'),
            ('{avatars,lang,sounds}', '%(datadir)s/skype/'),
            ('{LICENSE,README}', '%(thisdocdir)s/')
        ]
        for file in files:
            r.Install(*file)

        # things shouldn't be this way ...
        # we are adding a recent libstdc++ / libgcc_s combo and hidding it
        # from the Requires / Provides machinery...

        r.addSource('libstdc++.so.6.0.12', dest='/opt/%(name)s/')
        r.addSource('libgcc_s-4.4.1-20090729.so.1', dest='/opt/%(name)s/')
        r.Symlink('/opt/%(name)s/libstdc++.so.6.0.12', '/opt/%(name)s/libstdc++.so.6')
        r.Symlink('/opt/%(name)s/libgcc_s-4.4.1-20090729.so.1', '/opt/%(name)s/libgcc_s.so.1')

    def policy(r):

        for x in [ 'libgcc', 'libstdc\+\+']:
            r.Requires(exceptDeps='soname:\ ELF32.*%s.*' % x )
            r.Provides(exceptDeps='soname:\ ELF32.*%s.*' % x)

        # hooks for proper webcam support and theming support
        r.addSource('skype.wrapper', dest = '%(bindir)s/skype', mode = 0755)

        r.TagSpec('desktop-file', '%(datadir)s/applications/')

        r.Requires('soname: libcanberra.so.0(CANBERRA_0 SysV x86)',
                   '/opt/%(name)s/%(name)s.bin')

        r.Requires('soname: /usr/lib/libv4l/v4l1compat.so.0(SysV x86)',
                   '/opt/%(name)s/%(name)s.bin')
        

