class cgit(CPackageRecipe):
    name = 'cgit'
    version = 'v0.9.2'
    buildRequires = [
        'asciidoc:runtime',
        'libxslt:runtime',
        'openssl:devel',
        'util-linux:runtime',
        'which:runtime',
        'zlib:devel',
    ]
    
    def setup(r):
        r.addGitSnapshot('http://git.zx2c4.com/cgit',
                         tag='%(version)s')
        # "manual git submodule" implementation for addGitSnapshot
        # git pull --recurse-submodules
        # git submodule update
        # git submodule status
        r.macros.gittag = 'edca4152'
        r.addGitSnapshot('git://git.kernel.org/pub/scm/git/git.git',
                         tag='%(gittag)s', dir='%(maindir)s/tempgit')
        r.addAction('rmdir git; mv tempgit/cgit* ./git; rmdir tempgit')

        r.Create('cgit.conf',
                 contents='CGIT_SCRIPT_PATH = /srv/www/htdocs/cgit')

        r.Create('/etc/httpd/conf.d/cgit.conf',
                 contents="""
<Directory "/srv/www/htdocs/cgit/">
        AllowOverride None
        Options +ExecCGI
        Order allow,deny
        Allow from all
</Directory>""")

        r.Create('/etc/cgitrc')

        r.MakeDirs('/var/cache/cgit', mode=0770)
        r.Ownership('apache', 'apache', '/var/cache/cgit')

        r.Make()
        r.MakeInstall()
        # I give up for now making asciidoc work.  Fix it if you want to.
        #r.MakeInstall('install-man')

        r.AutoDoc(exceptions='git/.*')
