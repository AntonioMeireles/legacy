#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kdecorepackage')
class kdeBaseWorkspace(kdeCorePackageRecipe):

    name = 'kdebase-workspace'
    version = '4.8.3'

    module = 'kde-workspace'

    buildRequires = [
        'bluez:devel', 
        'boost:devel', 
        'ConsoleKit:devel', 
        'dbus:devel',
        'dbusmenu-qt:devel', 
        'fontconfig:devel', 
        'freetype:devel', 
        'glib:devel',
        'google-gadgets-kde:devel', 
        'libICE:devel', 
        'libjpeg:devel',
        'libpng:devel', 
        'libraw1394:devel', 
        'libSM:devel', 
        'libusb:devel',
        'libX11:devel', 
        'libXau:devel', 
        'libXcomposite:devel',
        'libXcursor:devel', 
        'libXdamage:devel', 
        'libXdmcp:devel',
        'libXext:devel', 
        'libXfixes:devel', 
        'libXft:devel', 
        'libXi:devel',
        'libXinerama:devel', 
        'libxkbfile:devel', 
        'libxklavier:devel',
        'libXrandr:devel', 
        'libXrender:devel', 
        'libXres:devel',
        'libXScrnSaver:devel', 
        'libXtst:devel', 
        'libXxf86misc:devel',
        'lm_sensors:devel', 
        'Mesa:devel', 
        'NetworkManager:devel', 
        'pam:devel',
        'polkit-qt-1:devel', 
        'PyQt4:python', 
        'python:devel',
        'qimageblitz:devel', 
        'qt4:devel', 
        'strigi:devel', 
        'zlib:devel', 
    ]

    def unpack(r):
        r.addArchive('http://download.kde.org/stable/%(version)s/src/kde-workspace-%(version)s.tar.xz')

    def postUnpack(r):

        # We don't like *.bak
        r.Environment('GENKDMCONF_FLAGS', '--no-backup')

        r.addPatches(
            'kubuntu_11_fix_root_only_kcms.diff',
            'kubuntu_13_startkde_set_country.diff',
            'kubuntu_19_always_show_kickoff_subtext.diff',
            'kubuntu_52_gtk2_engines_oxygen_config.diff',
            'kubuntu_63_ksplash_fix.diff',
            'kubuntu_80_fix_includes.diff',
            'kubuntu_93_fix_username_icon_alignment.diff',
            'kubuntu_114_respect_screensaver_settings.diff',
        )

        # kde3 path conflict
        r.Replace('ksysguarddrc', 'ksysguarddrc4', 'ksysguard/ksysguardd/CMakeLists.txt')

        # we don't have kdm user
        r.Replace('Instance: "kdm"', 'Instance: #"kdm"', 'kdm/config.def')

    def postInstall(r):

        # Make gdm happy
        r.Install('kdm/kfrontend/sessions/kde-plasma.desktop', '%(datadir)s/xsessions/')
        r.Install('kdm/kfrontend/sessions/kde-plasma-safe.desktop', '%(datadir)s/xsessions/')

        r.Move('%(sysconfdir)s/ksysguarddrc', '%(sysconfdir)s/ksysguarddrc4')

    def policy(r):

        r.Requires('xdm:config', '%(bindir)s/kdm')
        r.Requires('qt4-core:runtime', '%(bindir)s/startkde')

        r.ExcludeDirectories(exceptions='%(sysconfdir)s/kde4/kdm/sessions')


