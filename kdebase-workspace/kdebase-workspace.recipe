#
# Copyright (c) 2004-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kdecorepackage')
class kdeBaseWorkspace(kdeCorePackageRecipe):

    name = 'kdebase-workspace'
    version = '4.3.1+r1021745'

    module = 'kdebase/workspace'

    buildRequires = [
        'bluez:devel', 'boost:devel', 'ConsoleKit:devel', 'dbus:devel',
        'fontconfig:devel', 'freetype:devel', 'glib:devel',
        'google-gadgets-kde:devel', 'libICE:devel', 'libpng:devel',
        'libSM:devel', 'libusb:devel', 'libX11:devel', 'libXau:devel',
        'libXcomposite:devel', 'libXcursor:devel', 'libXdamage:devel',
        'libXdmcp:devel', 'libXext:devel', 'libXfixes:devel', 'libXft:devel',
        'libXi:devel', 'libXinerama:devel', 'libxkbfile:devel',
        'libxklavier:devel', 'libXrandr:devel', 'libXrender:devel',
        'libXScrnSaver:devel', 'libXtst:devel', 'libXxf86misc:devel',
        'lm_sensors:devel', 'Mesa:devel', 'NetworkManager:devel', 'pam:devel',
        'pykde:python', 'PyQt4:python', 'python:devel', 'qimageblitz:devel',
        'qt4:devel', 'soprano:devel', 'strigi:devel', 'zlib:devel'
    ]

    def postUnpack(r):

        # We don't like *.bak
        r.Environment('GENKDMCONF_FLAGS', '--no-backup')

        r.addUbuntuPatches('k/kdebase-workspace',
            '20_use_dejavu_as_default_font.diff',
            '21_kdm_doesnt_use_kstandarddirs.diff',
            '23_do_not_depend_on_bindings.diff',
            '25_task.h_forward_decl_netwininfo.diff',
            'kubuntu_10_turn_on_kwin_compositing.diff',
            'kubuntu_11_fix_root_only_kcms.diff',
            'kubuntu_19_always_show_kickoff_subtext.diff',
            'kubuntu_60_low_disk_space.diff',
            'kubuntu_63_ksplash_fix.diff',
            'kubuntu_71_default_plasma_layout.diff',
            'kubuntu_80_fix_includes.diff',
        )

        r.Replace('Name=KDE', 'Name=KDE4.3', 'kdm/kfrontend/sessions/kde.desktop.cmake')

        # kde3 path conflict
        r.Replace('ksysguarddrc', 'ksysguarddrc4', 'ksysguard/ksysguardd/CMakeLists.txt')

    def postInstall(r):

        # Make gdm happy
        r.Install('kdm/kfrontend/sessions/kde.desktop', '%(datadir)s/xsessions/kde42.desktop')

        r.Move('%(sysconfdir)s/ksysguarddrc', '%(sysconfdir)s/ksysguarddrc4')

    def policy(r):

        r.Requires('xdm:config', '%(bindir)s/kdm')
        r.Requires('qt4-core:runtime', '%(bindir)s/startkde')

        r.ExcludeDirectories(exceptions='%(sysconfdir)s/kde4/kdm/sessions')

        r.SetModes('%(libdir)s/kde4/libexec/kcheckpass', 06755)

