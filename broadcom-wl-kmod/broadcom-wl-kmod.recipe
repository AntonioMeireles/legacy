#
# Copyright (c) 2008-2012 The Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelmodulepackage')
class BroadcomWlKmod(KernelModulePackageRecipe):
    name = 'broadcom-wl-kmod'
    version =  '6.30.223.30'

    def unpack(r):
        # r.macros.version = r.version.replace('.', '_')
        # 
        # http://www.hackermusings.com/2013/02/better-wireless-drivers-for-the-bcm4331/
        # ...
        # r.addArchive('https://www.broadcom.com/docs/linux_sta/'
        #              'hybrid-portsrc_x86_32-v%(version)s.tar.gz',
        #              use=Arch.x86, dir = '%(name)s-%(version)s')
        # r.addArchive('https://www.broadcom.com/docs/linux_sta/'
        #              'hybrid-portsrc_x86_64-v%(version)s.tar.gz',
        #              use=Arch.x86_64, dir = '%(name)s-%(version)s')
        r.addArchive('https://launchpad.net/ubuntu/+archive/primary/+files/bcmwl_%(version)s+bdcom.orig.tar.gz')
        r.addSource('LICENSE')

        if Arch.x86_64:
            r.macros.binarch = 'x86_64'
        else:
            r.macros.binarch = 'i386'
        # upstream patches
        # addapted
        r.addPatch('0002-Makefile.patch', macros = True)
        # verbatin from https://launchpad.net/ubuntu/+source/bcmwl/...
        for p in [ '0001-MODULE_LICENSE.patch',
                   '0003-Make-up-for-missing-init_MUTEX.patch',
                   # '0005-add-support-for-linux-3.4.0.patch',   
                   '0006-add-support-for-linux-3.8.0.patch',
                   '0007-nl80211-move-scan-API-to-wdev.patch',
                   '0008-add-support-for-linux-3.9.0.patch',
                   '0009-add-support-for-linux-3.10.0.patch',
               ]:
            r.addPatch(p, dir = 'src')
        r.Replace('\$\(src\)', '%(builddir)s/src/', 'Makefile')
        r.Replace('\+\=\ src\/',  '+= src/src/', 'Makefile' )

    def build(r):
        r.macros.ksrcdir = '/lib/modules/%(kver)s/build'

        r.Environment('KBASE', '/lib/modules/%(kver)s/')

        r.Make("-C '/lib/modules/%(kver)s/build' M=`pwd`")

    def install(r):
        r.macros.moduledir = r.moduleDir
        r.Install('*.ko', '/lib/modules/%(kver)s/%(moduledir)s/')

    def policy(r):
        r.Doc('LICENSE')
        # We want to make sure that the userspace code can require the
        # matching kernel-space code
        r.ComponentProvides('%(version)s')
        r.ComponentSpec('runtime', '/lib/modules/')

        r.Requires('broadcom-wl:runtime',
                   '/lib/modules/%(kver)s/misc/wl.ko')
