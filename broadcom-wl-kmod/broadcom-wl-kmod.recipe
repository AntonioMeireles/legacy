#
# Copyright (c) 2008-2012 The Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelmodulepackage')
class BroadcomWlKmod(KernelModulePackageRecipe):
    name = 'broadcom-wl-kmod'
    version =  '5.100.82.112'

    def unpack(r):
        r.macros.version = r.version.replace('.', '_')

        r.addArchive('https://www.broadcom.com/docs/linux_sta/'
                     'hybrid-portsrc_x86_32-v%(version)s.tar.gz',
                     use=Arch.x86, dir = '%(name)s-%(version)s')
        r.addArchive('https://www.broadcom.com/docs/linux_sta/'
                     'hybrid-portsrc_x86_64-v%(version)s.tar.gz',
                     use=Arch.x86_64, dir = '%(name)s-%(version)s')

        # upstream patches
        for p in [ 'broadcom-sta-5.100.82.111-linux-3.0.patch',
                   'broadcom-sta-5.100.82.112-linux-2.6.39.patch',
                   'broadcom-sta-5.100.82.112-linux-3.2.patch',
                   'broadcom-sta-5.10.91.9-license.patch',
                   '04-linux-semaphore-include.patch',
                   '05-user_ioctl.patch',
                   '09-3.4.0.patch',
                   'broadcom-wl-5.100.82.112-kernel-3.8.patch',
                   'broadcom-wl-5.100.82.112-kernel-3.9.patch',
                   ]:
            r.addPatch(p)
        
    def build(r):
        r.Make("-C '/lib/modules/%(kver)s/build' M=`pwd`")

    def install(r):
        r.macros.moduledir = r.moduleDir
        r.Install('*.ko', '/lib/modules/%(kver)s/%(moduledir)s/')
        # blacklist bcma ...
        r.Create('%(sysconfdir)s/modprobe.d/blacklist-bcma.conf',
                 mode = 0644,
                 contents = 'blacklist bcma')

    def policy(r):
        # We want to make sure that the userspace code can require the
        # matching kernel-space code
        r.ComponentProvides('%(version)s')
        r.ComponentSpec('runtime', '/lib/modules/')

        r.Requires('broadcom-wl:runtime',
                   '/lib/modules/%(kver)s/misc/wl.ko')
