#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class DistroRelease(PackageRecipe):
    name = 'distro-release'
    version = '1.0rc1'
    
    def setup(r):
        release = "Foresight Desktop Linux release %(version)s (Development)" %r.macros
        issue = release + '\nKernel \\r on an \\m\n'

        r.Create('%(sysconfdir)s/distro-release', contents=release)
        r.Create('%(sysconfdir)s/issue', contents=issue + '\n')
        r.Create('%(sysconfdir)s/issue.net', contents=issue)
        r.addArchive('tags.tgz', dir='/')
        # Distributions can set configuration values for arches
        # and use flags here by defining them below in /etc/conary/distro/arch
        # and /etc/conary/distro/use.

        # XXX turn off dietlibc for other architectures that x86.
        # XXX Ideally, this would be done in conary's default use flag values
        if not Arch.x86:
            r.Create('/etc/conary/distro/use/dietlibc',
                     contents='sense disallowed\n')

        # create nvidia and ati use flags

        if Use.nvidia:    
            r.Create('/etc/conary/distro/use/ati',
                     contents='shortDoc Enable support for ati proprietary graphics drivers\n'
                     'sense disallowed \n')
            r.Create('/etc/conary/distro/use/nvidia',
                     contents='shortDoc Enable support for nVidia proprietary graphics drivers\n'
                     'sense required \n')
        elif Use.ati:
            r.Create('/etc/conary/distro/use/ati',
                     contents='shortDoc Enable support for ati proprietary graphics drivers\n'
                     'sense required\n')
            r.Create('/etc/conary/distro/use/nvidia',
                     contents='shortDoc Enable support for nVidia proprietary graphics drivers\n'
                     'sense disallowed\n')
        else:
            r.Create('/etc/conary/distro/use/ati',
                     contents='shortDoc Enable support for ati proprietary graphics drivers\n'
                     'sense disallowed \n')
            r.Create('/etc/conary/distro/use/nvidia',
                     contents='shortDoc Enable support for nVidia proprietary graphics drivers\n'
                     'sense disallowed \n')

        r.addSource('foresight.conaryrc')
        r.Install('foresight.conaryrc','%(sysconfdir)s/conary/config.d/foresight')


        r.Create('%(sysconfdir)s/chkconfig.d/xfs', contents = '# chkconfig: 5 04 10')
        r.TagSpec('chkconfig-override', '%(sysconfdir)s/chkconfig.d/xfs')

        r.Create('%(sysconfdir)s/chkconfig.d/xdm', contents = '# chkconfig: 5 10 82')
        r.TagSpec('chkconfig-override', '%(sysconfdir)s/chkconfig.d/xdm')

        r.Create('%(sysconfdir)s/chkconfig.d/ntpd', contents = '# chkconfig: 345 58 74')
        r.TagSpec('chkconfig-override', '%(sysconfdir)s/chkconfig.d/ntpd')

        r.addSource('oss.modules')
        r.Install('oss.modules', '%(sysconfdir)s/sysconfig/modules/oss.modules', mode=0755)


        r.Requires('e2fsprogs:runtime','%(prefix)s/libexec/conary/tags/home-user_xattr-user')
