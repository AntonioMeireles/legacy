#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage.recipe')
class Rdist(RPMPackageRecipe, CPackageRecipe):
    name = 'rdist'
    version = '6.1.5'
    buildRequires = [ 'byacc:runtime', 'bison:runtime' ]
    rpmRelease = '44'
    rpmPatches = [ 'rdist-6.1.5-linux.patch', 'rdist-6.1.5-links.patch',
        'rdist-6.1.5-oldpath.patch', 'rdist-6.1.5-hardlink.patch',
        'rdist-6.1.5-bison.patch', 'rdist-6.1.5-varargs.patch',
        'rdist-6.1.5-maxargs.patch', 'rdist-6.1.5-lfs.patch',
        'rdist-6.1.5-cleanup.patch', 'rdist-6.1.5-svr4.patch',
        'rdist-6.1.5-ssh.patch', 'rdist-6.1.5-mkstemp.patch',
        'rdist-6.1.5-stat64.patch', 
        'rdist-6.1.5-fix-msgsndnotify-loop.patch', ]

    def setup(r):
        r.unpack()
        # Source: http://www.magnicomp.com/rdist/
        r.addSource('rdist-eu-license.txt', rpm=r.srpm)
        # Source: http://people.redhat.com/pknirsch/src/
        r.addArchive('rdist-v1.1.tar.bz2', rpm=r.srpm,
                               dir='rdist-%(version)s')
        # This patch does not apply until the archive is added
        r.addPatch('rdist-6.1.5-re_args.patch', rpm=r.srpm)

        r.Make()
        r.Make('-C rdist')

        r.Install('src/rdist', '%(bindir)s/', mode=0755)
        r.Install('rdist/rdist', '%(bindir)s/oldrdist', mode=0755)
        r.Install('src/rdistd', '%(sbindir)s/', mode=0755)
        r.Symlink('../sbin/rdistd', '%(bindir)s/rdistd')
        r.Install('doc/rdist.man', '%(mandir)s/man1/rdist.1')
        r.Install('doc/rdistd.man', '%(mandir)s/man8/rdist.8')
        r.Doc('rdist-eu-license.txt')
