#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

import re
loadSuperClass('rpmpackage')
class Thunderbird(RPMPackageRecipe, AutoPackageRecipe):
    name = 'thunderbird'
    version = '3.1.7'
    rpmRelease = '2.fc14'

    rpmArchives = [ '%(name)s-langpacks-%(version)s-20101209.tar.bz2',
                    ]

    rpmSources = [ '%(name)s.desktop', 
                   'thunderbird.sh.in', 
                   'thunderbird-redhat-default-prefs.js',
                   'thunderbird-open-browser.sh', 
                   'thunderbird-mozconfig',]
    rpmPatches = [ 'mozilla-jemalloc.patch',
                   'thunderbird-shared-error.patch',
                   'xulrunner-1.9.2.1-build.patch',
                   'crashreporter-remove-static.patch',
                   'mozilla-libjpeg-turbo.patch',
                   'mozilla-missing-cflags.patch',
                   ]

    tarballName = '%(name)s-%(version)s.source.tar.bz2'

    buildRequires = [
        'atk:devel', 'cairo:devel', 'desktop-file-utils:runtime', 
        'fontconfig:devel', 'freetype:devel', 'glib:devel', 'gtk:devel', 
        'libICE:devel', 'libIDL:devel', 'libpng:devel', 'libSM:devel', 
        'libstdc++:devel', 'libX11:devel', 'libXau:devel', 'libXdmcp:devel', 
        'libXext:devel', 'libXft:devel', 'libXinerama:devellib', 
        'libXrender:devel', 'libXt:devel', 'nspr:devel', 'nss:devel', 
        'pango:devel', 'perl:runtime', 'pkgconfig:devel', 'zip:runtime', 
        'zlib:devel', 'GConf:devel', 'libgnome-keyring:devel', 'gnome-vfs:devel', 
        'libart_lgpl:devel', 'libbonobo:devel', 'libbonoboui:devel', 
        'libgnome:devel', 'libgnomecanvas:devel', 'libgnomeui:devel', 
        'libxml2:devel', 'ORBit2:devel', 'popt:devel', 'gawk:runtime', 
        'expat:devel', 'libjpeg:devel', 'unzip:runtime', 'libXinerama:devel',
        'alsa-lib:devel', 'dbus-glib:devel', 'libnotify:devel',
        # they are still locked in the middle ages
        'autoconf213:runtime',
        ]

    def configure(r):
        # built-in hunspell not gcc44+ friendly. (segfaults)
        r.addPatch('http://bugs.gentoo.org/attachment.cgi?id=237839')

        r.macros.mozappdir = '%(libdir)s/%(name)s-%(version)s'
        r.macros.ldflags += ' -Wl,-rpath,%(mozappdir)s '
        r.Copy('thunderbird-mozconfig', '.mozconfig')
        r.Run('echo "ac_add_options --enable-official-branding" >> .mozconfig')
        # we 're not on hunspell yet
        r.Replace('ac_add_options --enable-system-hunspell', '', '.mozconfig')

        r.macros.optflags = re.sub('-O2', '-Os', r.macros.optflags)
        r.macros.optflags = re.sub('-Wall', '', r.macros.optflags)
        r.Replace(('\$RPM_OPT_FLAGS', '%(optflags)s'),
                  ('\$PREFIX', '%(prefix)s'),
                  ('\$LIBDIR', '%(libdir)s'),'.mozconfig')
        r.Replace('\$\(MOZ_APP_NAME\)-\$\(MOZ_APP_VERSION\)','$(MOZ_APP_NAME)-%(version)s', 'config/autoconf.mk.in')
        r.Replace('\$\(MOZ_APP_NAME\)-devel-\$\(MOZ_APP_VERSION\)','$(MOZ_APP_NAME)-devel-%(version)s', 'config/autoconf.mk.in')


    def make(r):
        r.Make('-f client.mk build')
        # create debuginfo for crash-stats.mozilla.com
        # r.Make('buildsymbols', dir='objdir-tb')

    def makeinstall(r):
        r.MakeInstall(dir='objdir-tb')
        
    def policy(r):
        r.Desktopfile('thunderbird.desktop', category='Email;Network;GNOME;')
        r.addSource('thunderbird.png', dest='%(datadir)s/pixmaps/')
        
        # set up the thunderbird start script
        r.Replace('TBIRD_VERSION', '%(version)s', 'thunderbird.sh.in')
        r.Remove('%(bindir)s/%(name)s')
        r.Install('thunderbird.sh.in', '%(bindir)s/%(name)s', mode = 0755 )

        r.Replace('LIBDIR', '%(libdir)s', 'thunderbird-open-browser.sh', allowNoChange=True)
        r.Install('thunderbird-open-browser.sh', '%(mozappdir)s/openbrowser.sh')

        r.Replace('THUNDERBIRD_RPM_VR', '%(version)s', '%(name)s-redhat-default-prefs.js')
        r.Replace('COMMAND', 'open-browser.sh', '%(name)s-redhat-default-prefs.js')
        r.Replace('Fedora', 'Foresight Linux', '%(name)s-redhat-default-prefs.js')
        r.Install('%(name)s-redhat-default-prefs.js', '%(mozappdir)s/greprefs/all-redhat.js')
        r.Install('%(name)s-redhat-default-prefs.js', '%(mozappdir)s/defaults/pref/all-redhat.js')
        
        # 
        r.Remove('%(bindir)s/thunderbird-config')

        # langpacks
        r.Run(""" 
 mkdir  %(destdir)s/%(mozappdir)s/extensions
 cp -ar ../%(name)s-%(version)s/%(name)s-langpacks %(destdir)s/%(mozappdir)s/extensions/
 cd %(destdir)s/%(mozappdir)s/extensions/
 for langpack in `ls %(name)s-langpacks/*.xpi`; do
   language=`basename $langpack .xpi`
   extensiondir=%(destdir)s/%(mozappdir)s/extensions/langpack-$language@thunderbird.mozilla.org
   mkdir  $extensiondir
   unzip $langpack -d $extensiondir
   find $extensiondir -type f | xargs chmod 644

 done
 rm -rf thunderbird-langpacks

 """)

        # ghost files
        r.Create('%(mozappdir)s/components/compreg.dat')
        r.Create('%(mozappdir)s/components/xpti.dat')
        r.InitialContents('%(mozappdir)s/components/compreg.dat')
        r.InitialContents('%(mozappdir)s/components/xpti.dat')



        # tell tbird to honour users' LANG env
        r.Run('''echo 'pref("intl.locale.matchOS", true)' >> %(destdir)s/%(libdir)s/%(name)s-%(version)s/defaults/pref/all-thunderbird.js ''')


        r.Copy('other-licenses/branding/%(name)s/mailicon16.png',
               '%(mozappdir)s/icons/')
        r.Copy('other-licenses/branding/%(name)s/mailicon16.png',
               '%(datadir)s/icons/hicolor/16x16/apps/thunderbird.png')

        r.Copy('other-licenses/branding/%(name)s/mailicon22.png',
               '%(datadir)s/icons/hicolor/22x22/apps/thunderbird.png')
        r.Copy('other-licenses/branding/%(name)s/mailicon24.png',
               '%(datadir)s/icons/hicolor/24x24/apps/thunderbird.png')
        r.Copy('other-licenses/branding/%(name)s/mailicon32.png',
               '%(datadir)s/icons/hicolor/32x32/apps/thunderbird.png')
        r.Copy('other-licenses/branding/%(name)s/mailicon48.png',
               '%(datadir)s/icons/hicolor/48x48/apps/thunderbird.png')
        r.Copy('other-licenses/branding/%(name)s/mailicon256.png',
               '%(datadir)s/icons/hicolor/256x256/apps/thunderbird.png')


