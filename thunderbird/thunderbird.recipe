#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Thunderbird(CPackageRecipe):
    name = 'thunderbird'
    version = '2.0.0.0'

    buildRequires = [
        'atk:devel', 'cairo:devel', 'desktop-file-utils:runtime',
        'fontconfig:devel', 'freetype:devel', 'glib:devel', 'gtk:devel',
        'libICE:devel', 'libIDL:devel', 'libpng:devel', 'libSM:devel',
        'libstdc++:devel', 'libX11:devel', 'libXau:devel', 'libXdmcp:devel',
        'libXext:devel', 'libXft:devel', 'libXinerama:devellib',
        'libXrender:devel', 'libXt:devel', 'nspr:devel', 'nss:devel',
        'pango:devel', 'perl:runtime', 'pkgconfig:devel', 'zip:runtime',
        'zlib:devel', 'expat:devel',
    ]

    if Use.gnome:
        buildRequires += [
            'GConf:devel', 'gnome-keyring:devel', 'gnome-vfs:devel',
            'libart_lgpl:devel', 'libbonobo:devel', 'libbonoboui:devel',
            'libgnome:devel', 'libgnomecanvas:devel', 'libgnomeui:devel',
            'libxml2:devel', 'ORBit2:devel', 'popt:devel'
        ]


    def setup(r):
        r.addSource('http://ftp.mozilla.org/pub/mozilla.org/%(name)s/releases/%(version)s/source/%(name)s-%(version)s-source.tar.bz2')
        # beta2 is a tarball within a tarball...
        r.addAction('tar -xjf *.bz2 ; mv mozilla/* .')

        r.macros.cflags = '-Os -g -fPIC'

        extraConf=''
        if Use.gnome:
            extraConf += ' --enable-gnomevfs --enable-gnomeui'
        else:
            extraConf += ' --disable-gnomevfs --disable-gnomeui'

        r.disableParallelMake()
        r.addSource('thunderbird.desktop')
        r.addSource('thunderbird.png', dest='%(datadir)s/pixmaps/thunderbird.png')

        # This is due to a gcc bug in visibility on x86_64 and
        # should be removed when we update to gcc-4.2
        if Arch.x86_64:
            r.Replace('ac_cv_visibility_pragma=yes', 'ac_cv_visibility_pragma=no', 'configure')

        r.Configure('--enable-official-branding --disable-debug'
            ' --disable-debug-modules --disable-installer --disable-updater'
            ' --disable-xprint --enable-mathml --enable-optimize=-Os --enable-shared'
            ' --disable-static --enable-default-toolkit=gtk2 --enable-pango'
            ' --enable-svg-renderer=cairo --enable-system-cairo --enable-svg'
            ' --enable-postscript --enable-canvas --with-pthreads'
            ' --with-system-nss --with-system-nspr'
            ' --enable-xinerama --disable-strip --disable-strip-libs'
            ' --enable-application=mail --enable-gnomevfs --enable-gnomeui ')
        r.Make()
        r.MakeInstall()

        r.Desktopfile('thunderbird.desktop')

        # tell tbird to honour users' LANG env
        r.Run('''echo 'pref("intl.locale.matchOS", true)' >> %(destdir)s/%(libdir)s/%(name)s-%(version)s/defaults/pref/all-thunderbird.js ''')
