#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Flex(CPackageRecipe):
    name = 'flex'
    version = '2.5.4a'

    buildRequires = [ 'byacc:runtime', 'indent:runtime',
        'install-info:runtime', 'm4:runtime', 'gettext:runtime', ]

    def setup(r):
        r.disableParallelMake()
        # temporary hack while tarball does not follow its own version number
        r.mainDir('flex-2.5.4')
        r.addArchive('http://ftp.gnu.org/gnu/non-gnu/flex/flex-%(version)s.tar.gz')
        r.addPatch('flex-2.5.4a-skel.patch')
        r.addPatch('flex-2.5.4-glibc22.patch')
        r.addPatch('flex-2.5.4a-gcc3.patch')
        r.addPatch('flex-2.5.4a-gcc31.patch')
        r.addPatch('flex-2.5.4a2.patch')

        r.ManualConfigure('--prefix=%(prefix)s')
        r.Make()
        r.MakePathsInstall('mandir=%(destdir)s/%(mandir)s/man1')
        r.Symlink('flex', '%(bindir)s/lex')
        r.Symlink('flex.1', '%(mandir)s/man1/lex.1')
        r.Symlink('flex.1', '%(mandir)s/man1/flex++.1')
        r.Symlink('libfl.a', '%(libdir)s/libl.a')

        # r.test
        # remove prereqs for recompiling flex -- we'll take care of them
        r.Replace('\$\(FLEX\): .*', '$(FLEX): scan.c', 'Makefile')
        r.TestSuiteFiles('(ccl|dfa|ecs|gen|main|misc|nfa|parse|scan|skel|sym|tblcmp|yylex).o',
                         'libfl.a', 'scan.l')
        r.TestSuite('.', 'make bigcheck')
        r.Requires('flex:devel', '%(bindir)s/flex')
