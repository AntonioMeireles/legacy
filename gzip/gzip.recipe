#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Gzip(AutoPackageRecipe):
    name = 'gzip'
    version = '1.3.12'

    if not Use.bootstrap:
        # needs info-file tag description from the install-info package
        buildRequires = [ 'install-info:runtime', 'texinfo:runtime' ]

    def unpack(r):
        r.disableParallelMake()
        r.addArchive('mirror://gnu/gzip/', keyid='B5C4CE13')
        r.addPatch('gzip-1.3.1-zgreppipe.patch')
        r.addPatch('gzip-1.3.3-window-size.patch')
        r.addPatch('CVE-2009-2624.patch')
        r.addPatch('CVE-2010-0001.patch')

        # glibc-2.6 started defining futimens, and this new defination differs
        # from that of gnulib, which is shipped as part of many pieces of gnu
        # software. presumably this will be fixed in the next release of this
        # package, but for now we hack around the problem
        r.Replace('futimens', 'gl_futimens',
            'lib/utimens.c', 'lib/utimens.h', # in gnulib
            'gzip.c') # in gzip


        r.macros.bindir = r.macros.essentialbindir

    def make(r):
        r.Make('AR=%(target)s-ar')

    def policy(r):
        # RPL-1178 - bzless isn't needed for appliances
        r.PackageSpec('gzip-extras', '.*z(more|less).*')
