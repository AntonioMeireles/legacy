#
# Copyright (c) 2009 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Libproxy(AutoPackageRecipe):
    name = 'libproxy'
    version = '0.4.6'

    buildRequires = [ 'GConf:devel', 'ORBit2:devel', 'WebKit:devel', 'atk:devel', 'cairo:devel', 'dbus:devel', 'expat:devel', 'fontconfig:devel', 'freetype:devel', 'glib:devel', 'gtk:devel', 'libICE:devel', 'libSM:devel', 'libX11:devel', 'libXau:devel', 'libXdmcp:devel', 'libXext:devel', 'libXmu:devel', 'libXrender:devel', 'libXt:devel', 'libpng:devel', 'libxcb:devel', 'pango:devel', 'pixman:devel', 'pkgconfig:devel', 'python:bin', 'xcb-util:devel', 'xulrunner:devel', 'zlib:devel', 'gnome-common:devel', 'gnome-common:runtime', 'autoconf:runtime', 'libtool:devel', 'libtool:runtime', 'gettext:devel', 'gettext:runtime', 'NetworkManager:devel', 'cmake:runtime', 'automoc:runtime', 'bzr:runtime', 'cvs:runtime', 'gcc-c++:runtime', 'git:runtime', 'kdelibs:config', 'kdelibs:devel', 'libXScrnSaver:devel', 'libXcomposite:devel', 'libXcursor:devel', 'libXdamage:devel', 'libXfixes:devel', 'libXi:devel', 'libXinerama:devel', 'libXpm:devel', 'libXrandr:devel', 'libXtst:devel', 'libXv:devel', 'libXxf86misc:devel', 'libmodman:devel', 'libstdc++:devel', 'libxkbfile:devel', 'mercurial:runtime', 'openssh:runtime', 'openssl:devel', 'perl:devel', 'phonon:devel', 'python:devel', 'qt4-core:devellib', 'qt4:devel', 'subversion:runtime' ]
 
    def setup(r):
        r.addArchive('http://libproxy.googlecode.com/files/')
        r.addPatch('support_wk_1_5.patch')

        r.Replace('@PROJECT_VERSION@','%(version)s',
                  'libproxy/libproxy-1.0.pc.in')

        r.CMake('-DLIBEXEC_INSTALL_DIR=%(libexecdir)s '
                # XXX find why line bellow needed
                '-DCMAKE_MODULE_PATH="%(datadir)s/apps/cmake/modules" '

                '-DMODULE_INSTALL_DIR=%(libdir)s/%(name)s/%(version)s/modules '
                '-DCMAKE_CXX_FLAGS="%(cxxflags)s" '
                '-DCMAKE_C_FLAGS="%(cflags)s" ' 
                '-DCMAKE_SKIP_RPATH=TRUE '
                '-DCMAKE_BUILD_TYPE=None '
                '-DWITH_GNOME3=OFF '
                '-DWITH_WEBKIT=ON '
                '-DWITH_PERL=OFF ', objDir='build')
        r.Make(dir='build')
        r.MakeInstall(dir='build')

        # XXX fixme
        # CMAKE_SKIP_RPATH=TRUE doesn't work in all cases
        if Arch.x86_64:
            r.Requires(exceptDeps=r'soname\:\ ELF64\/usr\/lib64\/xulrunner\-sdk\-1\.9\.2\/lib\/libmozjs\.so\(SysV\ x86\_64\)')
        else:
            r.Requires(exceptDeps=r'soname\:\ ELF32\/usr\/lib\/xulrunner\-sdk\-1\.9\.2\/lib\/libmozjs\.so\(SysV\ x86\)')

        r.PackageSpec('libproxy-kde', '%(libdir)s/%(name)s/%(version)s/modules/config_kde4.so')
        r.PackageSpec('libproxy-gnome', '%(libdir)s/%(name)s/%(version)s/modules/config_gnome.so')
        r.PackageSpec('libproxy-networkmanager', '%(libdir)s/%(name)s/%(version)s/modules/network_networkmanager.so')
        r.PackageSpec('libproxy-mozjs', '%(libdir)s/%(name)s/%(version)s/modules/pacrunner_mozjs.so')
        r.PackageSpec('libproxy-webkit', '%(libdir)s/%(name)s/%(version)s/modules/pacrunner_webkit.so')
