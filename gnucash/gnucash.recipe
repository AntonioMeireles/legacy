#
# Copyright (c) 2007 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
# 

loadRecipe('gnomepackage.recipe')
class GNUCash(GnomePackageRecipe):
    name = 'gnucash'
    version = '2.2.3'
    docsVer = '2.2.0'

    buildRequires = ['libtool:runtime','GConf:devel', 'GConf:runtime',
'ORBit2:devel', 'aqbanking:devel', 'desktop-file-utils:runtime',
'doxygen:runtime', 'esound:devel', 'gail:devel', 'gnome-keyring:devel',
'gnome-vfs:devel', 'goffice:devel', 'gtkhtml:devel', 'guile:devel',
'guile:runtime', 'gwenhywfar:devel', 'install-info:runtime',
'ktoblzcheck:devel', 'libart_lgpl:devel', 'libbonobo:devel',
'libbonoboui:devel', 'libglade:devel', 'libgnome:devel',
'libgnomecanvas:devel', 'libgnomeui:devel', 'libgsf:devel', 'libofx:devel',
'pcre:devel','perl:devel', 'perl-DateManip:perl', 'perl-Finance-Quote:perl', 'popt:devel',
'scrollkeeper:runtime', 'slib:data']

    def setup(r):
        r.macros.docsVer = GNUCash.docsVer
        r.macros.docdir= '%(name)s-docs-%(docsVer)s'
        r.macros.sourceUrl = 'http://www.gnucash.org/pub/gnucash/sources/stable/'
        r.addArchive('%(sourceUrl)s')
        r.addArchive('%(sourceUrl)s/%(name)s-docs-%(docsVer)s.tar.gz',
                     dir='%(name)s-%(version)s/')

        # clean languages:
        r.Run('unset LINGUAS')

        # CONFIGURE
        r.Configure(' --disable-sql --enable-error-on-warning=no --enable-ofx'
                    ' --enable-hbci  --enable-locale-specific-tax'
                    ' --disable-schemas-install')
        r.Configure(dir='%(docdir)s')

        # MAKE
        r.Make()
        r.Make(dir='%(docdir)s')
        

        # make INSTALL
        r.MakeInstall() 
        r.MakeInstall(dir='%(docdir)s')

        # gnucash uses libtool's libltdl, so the la files must be included
        r.RemoveNonPackageFiles(exceptions='.*\.la')

        # Perl dependencies. Not detected automatically because of the dynamic
        # imports.
        r.Requires('perl-libwww-perl:perl', '%(bindir)s/gnc-fq-check')
        r.Requires('perl-Crypt-SSLeay:perl', '%(bindir)s/gnc-fq-check')
        r.Requires('perl-Finance-Quote:perl', '%(bindir)s/gnc-fq-check')
        r.Requires('perl-Finance-QuoteHist:perl', '%(bindir)s/gnc-fq-check')
        r.Requires('perl-HTML-Parser:perl', '%(bindir)s/gnc-fq-check')
        r.Requires('perl-HTML-TableExtract:perl', '%(bindir)s/gnc-fq-check')

        r.Requires('perl-libwww-perl:perl', '%(bindir)s/gnc-fq-dump')
        r.Requires('perl-Crypt-SSLeay:perl', '%(bindir)s/gnc-fq-dump')
        r.Requires('perl-Finance-Quote:perl', '%(bindir)s/gnc-fq-dump')
        r.Requires('perl-HTML-TableExtract:perl', '%(bindir)s/gnc-fq-dump')

        r.Requires('perl-libwww-perl:perl', '%(bindir)s/gnc-fq-helper')
        r.Requires('perl-Crypt-SSLeay:perl', '%(bindir)s/gnc-fq-helper')
        r.Requires('perl-Finance-Quote:perl', '%(bindir)s/gnc-fq-helper')
        r.Requires('perl-HTML-TableExtract:perl', '%(bindir)s/gnc-fq-helper')

        # Explicitly require slib
        r.Requires('slib:data', '%(bindir)s/gnucash-bin')
        # Explicitly require guile:runtime
        r.Requires('guile:runtime', '%(bindir)s/gnucash-bin')

        # Everything hbci related goes into its own package, to isolate
        # aqbanking (which used requires qt/kde, but is also less useful for
        # people who don't do online banking from gnucash)
        r.PackageSpec('%(name)s-hbci', '.*hbci.*')
