#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class DistCache(RPMPackageRecipe, CPackageRecipe):
    name = 'distcache'
    version = '1.4.5'
    rpmRelease = '14.1'

    buildRequires = [ 'automake:runtime', 'autoconf:runtime',
                      'libtool:runtime', 'openssl:devel', 'e2fsprogs:devel', ]

    def setup(r):
        r.disableParallelMake()
        r.macros.cflags += ' -fPIC'
        r.addArchive('mirror://sourceforge/distcache/')
        r.addPatch('distcache-1.4.5-setuid.patch', rpm=r.srpm)
        r.addSource('dc_server.init', rpm=r.srpm,
            dest='%(initdir)s/dc_server', mode=0755)
        r.Replace('(# chkconfig: )- 90',r'\1 345 22', '%(initdir)s/dc_server')
        r.addSource('dc_client.init', rpm=r.srpm,
            dest='%(initdir)s/dc_client', mode=0755)
        r.Replace('(# chkconfig: )- 88',r'\1 345 22', '%(initdir)s/dc_client')

        # parallel build option '--disable-libtool-lock' available
        r.macros.cflags  += ' -I%(krbprefix)s/include'
        r.macros.ldflags += ' -L%(krbprefix)s/%(lib)s'
        r.Configure('--enable-shared --enable-ssl')
        r.Make()
        r.MakeInstall()
        r.MakeInstall('-C ssl')
        r.Remove('%(bindir)s/{nal_test,piper}')
        r.TagSpec('initscript', '%(initdir)s/')
