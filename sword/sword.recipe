#
# Copyright (c) 2008 - 2010 Foresight Linux Project
# Copyright (c) 2005-2009 rPath, Inc.
#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Sword(CPackageRecipe):
    name = "sword"
    version = "1.6.2"

    buildRequires = ['clucene:devel', 'curl:devel', 'libstdc++:devel',
                     'openssl:devel', 'pkgconfig:devel', 'zlib:devel', 
                     'icu:runtime', 'icu:devel', 
                     'autoconf:runtime', 'automake:runtime', 'libtool:runtime',
                     'cppunit:devel', 'php:runtime', 'python:devel',
                     'swig:runtime', 'perl:devel']

    def setup(r):
        r.macros.majversion = '.'.join(r.version.split('.')[0:2])
        r.macros.url = 'http://crosswire.org/ftpmirror/pub/sword/source'
        r.addArchive('%(url)s/v%(majversion)s/sword-%(version)s.tar.gz')
        r.addPatch('curl_720_workaround.patch')
        r.Replace('#include <curl\/types\.h>', '', 'src/mgr/curlftpt.cpp')
        r.Replace('#include <curl\/types\.h>', '', 'src/mgr/curlhttpt.cpp')

        r.Configure('--disable-static --with-icu --with-clucene')

        # Don't use rpath!
        r.Replace(('^hardcode_libdir_flag_spec=.*',
                   'hardcode_libdir_flag_spec=""'),
                  ('^runpath_var=LD_RUN_PATH',
                   'runpath_var=DIE_RPATH_DIE'),
                  'libtool')

        r.Make()
        r.MakeInstall()
        # # Only python & perl bindings atm until 
        # # I found out how to make the rest compile
        # r.Run('./autogen.sh', dir='bindings/swig/package')
        # r.Configure(' --with-sword-dir=%(destdir)s/%(prefix)s/', dir='bindings/swig/package')
        # r.Make('perlswig',  dir='bindings/swig/package')
        # r.Make('perl_make',  dir='bindings/swig/package')
        # r.MakeInstall(dir='bindings/swig/package/perl')
        # r.Make('pythonswig', dir='bindings/swig/package')
        # r.Make('python_make', dir='bindings/swig/package')
        # r.PythonSetup('install', dir='bindings/swig/package/python/')
        #r.Run('cd bindings/swig/package/python;'
        #      ' python setup.py install --prefix=%(destdir)s/%(prefix)s')

        r.MakeDirs('%(datadir)s/sword/modules')
        r.ExcludeDirectories(exceptions='%(datadir)s/sword/modules')
        r.Create('%(sysconfdir)s/sword.conf', contents="\n".join((
            '[Install]',
            'DataPath=/usr/share/sword/',
            '',
            '[Sources]',
            'DIRSource=/usr/share/sword|[local]|/usr/share/sword',
            '',
        )))
