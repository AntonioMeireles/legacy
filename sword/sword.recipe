#
# Copyright (c) 2008 - 2010 Foresight Linux Project
# Copyright (c) 2005-2009 rPath, Inc.
#
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Sword(CPackageRecipe):
    name = "sword"
    version = "1.6.2"

    buildRequires = ['clucene:devel', 'curl:devel', 'libstdc++:devel',
                     'openssl:devel', 'pkgconfig:devel', 'zlib:devel', 
                     'icu:runtime', 'icu:devel', 
                     'autoconf:runtime', 'automake:runtime', 'libtool:runtime',
                     'cppunit:devel', 'php:runtime', 'python:devel',
                     'swig:runtime', 'perl:devel']

    def setup(r):
        r.macros.majversion = '.'.join(r.version.split('.')[0:2])
        r.macros.url = 'http://crosswire.org/ftpmirror/pub/sword/source'
        r.addArchive('%(url)s/v%(majversion)s/sword-%(version)s.tar.gz')
        r.addPatch('curl_720_workaround.patch')
        r.Replace('#include <curl\/types\.h>', '', 'src/mgr/curlftpt.cpp')
        r.Replace('#include <curl\/types\.h>', '', 'src/mgr/curlhttpt.cpp')

        r.Configure('--disable-static --with-icu --with-clucene')
        r.Make()
        r.MakeInstall()
        # Only python bindings atm until 
        # I found out how to make the rest compile
        r.Replace('ac_sword_dir\/lib', 'ac_sword_dir/%(lib)s', 'bindings/swig/package/sword.m4')
        r.Run('./autogen.sh', dir='bindings/swig/package')
        # Don't use rpath!
        r.Configure(' --with-sword-dir=%(destdir)s/%(prefix)s', dir='bindings/swig/package')
        r.Make('pythonswig', dir='bindings/swig/package')
        r.Make('python_make', dir='bindings/swig/package')
        r.PythonSetup('install', dir='bindings/swig/package/python/')

        r.MakeDirs('%(datadir)s/sword/modules')
        r.ExcludeDirectories(exceptions='%(datadir)s/sword/modules')

        r.Create('%(sysconfdir)s/sword.conf', contents="\n".join((
            '[Install]',
            'DataPath=/usr/share/sword/',
            '',
            '[Sources]',
            'DIRSource=/usr/share/sword|[local]|/usr/share/sword',
            '',
        )))
