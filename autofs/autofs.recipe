#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Autofs(CPackageRecipe):
    name = 'autofs'
    version = '5.0.2'

    buildRequires = [ 'autoconf:runtime', 'procps:runtime', 'hesiod:devel',
        'e2fsprogs:runtime', 'util-linux:runtime', 'flex:runtime',
        'libxml2:devel', 'bison:runtime', 'module-init-tools:runtime',
        'cyrus-sasl:devel', 'openssl:devel', 'zlib:devel', 'openldap:devel',
        'krb5:devel', ]

    def setup(r):
        r.disableParallelMake()
        r.macros.majver = r.version.split('.')[0]
        r.addArchive('http://ftp.kernel.org/pub/linux/daemons/%(name)s/v%(majver)s/',
            keyid='517D0F0E')

        # UPSTREAM PATCHES
        # it is unfortunate that upstream has decided to name their patches so
        # verbosely, as this lends to an inability to download them quickly,
        # like in vim. however, here's a scriptlet to populate the patch list
        # in uppatch (assuming you actually want to apply all the patches. if
        # not, please include a comment as to which you've omitted for future
        # editors). obviously, replace VERSION= with the correct value.
        # VERSION="5.0.2" ; wget -O - 'http://ftp.kernel.org/pub/linux/daemons/autofs/v5/patch_order-'$VERSION 2> /dev/null | sed -e 's/.*"//' -e 's/>//g' -e 's/<.*//' -e "s/^/'/" -e "s/$/',/"
        for uppatch in (
            'autofs-5.0.2-add-krb5-include.patch',
            'autofs-5.0.2-bad-proto-init.patch',
            'autofs-5.0.2-add-missing-multi-support.patch',
            'autofs-5.0.2-add-multi-nsswitch-lookup.patch',
            'autofs-5.0.2-consistent-random-selection-option-name.patch',
            'autofs-5.0.2-fix-offset-dir-create.patch',
            'autofs-5.0.2-quote-exports.patch',
            'autofs-5.0.2-hi-res-time.patch',
            'autofs-5.0.2-quoted-slash-alone.patch',
            'autofs-5.0.2-fix-dnattr-parse.patch',
            'autofs-5.0.2-fix-nfs-version-in-get-supported-ver-and-cost.patch',
            'autofs-5.0.2-instance-stale-mark.patch',
            'autofs-5.0.2-fix-largefile-dumbness.patch',
            'autofs-5.0.2-dont-fail-on-empty-master.patch',
            'autofs-5.0.2-ldap-percent-hack.patch',
            'autofs-5.0.2-fix-mount-nfs-nosymlink.patch',
            'autofs-5.0.2-dont-fail-on-empty-master-fix.patch',
            'autofs-5.0.2-default-nsswitch.patch',
            'autofs-5.0.2-add-ldap-schema-discovery.patch',
            'autofs-5.0.2-random-selection-fix.patch',
            'autofs-5.0.2-timeout-option-parse-fix.patch',
            'autofs-5.0.2-ldap-check-star.patch',
            'autofs-5.0.2-add-ldap-schema-discovery-fix.patch',
            'autofs-5.0.2-ldap-schema-discovery-config-update.patch',
            'autofs-5.0.2-ldap-search-basedn-list.patch',
            'autofs-5.0.2-libxml2-workaround.patch',
            'autofs-5.0.2-reread-config-on-hup.patch',
            'autofs-5.0.2-add-multiple-server-selection-option.patch',
            'autofs-5.0.2-foreground-logging.patch',
            'autofs-5.0.2-cleanup-krb5-comment.patch',
            'autofs-5.0.2-submount-deadlock.patch',
            'autofs-5.0.2-add-ferror-check.patch',
            'autofs-5.0.2-autofs-5-typo.patch',
            'autofs-5.0.2-swallow-null-macro.patch',
            'autofs-5.0.2-remove-unsed-export-validation-code.patch',
            'autofs-5.0.2-dynamic-logging.patch',
            'autofs-5.0.2-fix-recursive-loopback-mounts.patch',
            'autofs-5.0.2-log-map-reload.patch',
            'autofs-5.0.2-basedn-with-spaces.patch',
            'autofs-5.0.2-dynamic-logging-fixes.patch',
            'autofs-5.0.2-basedn-with-spaces-fix.patch',
            'autofs-5.0.2-check-mtab-updated.patch',
            'autofs-5.0.2-basedn-with-spaces-fix-2.patch',
            'autofs-5.0.2-check-auto_master.patch',
            'autofs-5.0.2-add-ldap-schema-discovery-fix-2.patch',
            'autofs-5.0.2-negative-timeout-update.patch',
            'autofs-5.0.2-large-groups.patch',
            'autofs-5.0.2-report-failed-lookups.patch',
            'autofs-5.0.2-dynamic-logging-non-sasl.patch',
            'autofs-5.0.2-check-mtab-updated-fix.patch',
            'autofs-5.0.2-singleton-host-list.patch',
            'autofs-5.0.2-start-pipe-buff-size.patch',
            'autofs-5.0.2-fix-off-by-one-lookup.patch',
            'autofs-5.0.2-improve-server-unavail.patch',
            'autofs-5.0.2-add-multiple-server-selection-option-fix.patch',
            'autofs-5.0.2-external-cred-cache.patch',
            'autofs-5.0.2-percent-hack-fix.patch',
            'autofs-5.0.2-quote-exports-fix.patch',
            'autofs-5.0.2-hosts-nosuid-default.patch',
            'autofs-5.0.2-quote-exports-fix-fix.patch',
            'autofs-5.0.2-quell-mount-module-message.patch',
            'autofs-5.0.2-improve-server-unavail-fix.patch',
            'autofs-5.0.2-hosts-nodev-default.patch',
            'autofs-5.0.2-ldap-page-control.patch',
            'autofs-5.0.2-instance-stale-mark-update.patch',
            'autofs-5.0.2-submount-shutdown-race.patch',
            'autofs-5.0.2-ldap-search-basedn-list-fix.patch',
        ):
            r.addPatch('http://ftp.kernel.org/pub/linux/daemons/%(name)s/v%(majver)s/' + uppatch)

        r.addPatch('autofs-5.0.0-chkconfigfix.patch')
        r.addPatch('autofs-5.0.1-init-script-logic-reversed.patch')

        r.Configure('--with-hesiod --with-openldap')
        r.Replace(('.*#undef HAVE_LDAP_CREATE_PAGE_CONTROL.*', '#define HAVE_LDAP_CREATE_PAGE_CONTROL 1'),
                  ('.*#undef HAVE_LDAP_PARSE_PAGE_CONTROL.*', '#define HAVE_LDAP_PARSE_PAGE_CONTROL 1'),
                  'include/config.h')
        r.Make('initdir=%(initdir)s')

        r.MakeInstall('STRIP=: initdir=%(initdir)s', rootVar='INSTALLROOT')

        r.Install('samples/rc.autofs', '%(initdir)s/autofs', mode=0755)
        r.Install('samples/auto.master', '%(sysconfdir)s/', mode=0644)
        r.Install('samples/auto.misc', '%(sysconfdir)s/', mode=0644)

        r.ComponentSpec('lib', '%(libdir)s/autofs/.*')
        r.TagSpec('initscript', '%(initdir)s/')
