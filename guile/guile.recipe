#
# Copyright (c) 2004-2005 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Guile(CPackageRecipe):
    name = 'guile'
    version = '1.8.0'

    # needs info-file tag description from the install-info package
    buildRequires = [ 
                      'gmp:devel',
                      'libtool:devel',
                      'readline:devel',
    ]

    def setup(r):
        r.disableParallelMake()

        srpm = 'http://download.fedora.redhat.com/pub/fedora/linux/core/6/source/SRPMS/guile-1.8.0-8.20060831cvs.src.rpm'

        #r.addArchive('http://ftp.gnu.org/pub/gnu/guile/', keyid='8C7E73A4')
        r.addArchive('%(name)s-%(version)s.tar.gz', rpm=srpm)

        r.addSource('guile-slib.tagdescription', macros=True)
        r.addSource('guile-slib.taghandler', macros=True)

        r.addPatch('guile-1.8.0-20060831cvs.patch.gz', rpm=srpm)
        r.addPatch('guile-1.8.0-slib.patch', rpm=srpm)
        r.addPatch('guile-1.8.0-deplibs.patch', rpm=srpm)
        r.addPatch('guile-1.8.0-multilib.patch', rpm=srpm)

        # Make guile work with the newer slib (3a4)
        r.Replace("^\(define \(slib:load", 
                  "(define slib:features *features*)\n(define (slib:load",
                  "ice-9/slib.scm")

        extraConfig = '--disable-static --disable-error-on-warning '

        r.Configure(extraConfig)

        r.Make()
        r.MakeInstall()

        r.Install('guile-slib.tagdescription', '%(tagdescriptiondir)s/guile-slib')
        r.Install('guile-slib.taghandler', '%(taghandlerdir)s/guile-slib', mode=0755)

        r.Provides('file', '%(bindir)s/guile')
