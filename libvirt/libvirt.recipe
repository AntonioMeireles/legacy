#
# Copyright (c) 2008 Lance Haig.
#               2008 the Foresight Linux Project 
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class LibVirt(RPMPackageRecipe,AutoPackageRecipe):
    buildRequires = [
        'autoconf:runtime',
        'chkconfig:runtime',
        'gcc-c++:runtime', 
        'gettext:runtime', 
        'gnutls:devel',
        'intltool:runtime', 
        'libxml2:devel', 
        'libxml2:runtime', 
        'libxslt:runtime', 
        'parted:devel',
        'pkgconfig:devel',
        'python:devel',
        'readline:devel', 
        'xen:devel',
        'zlib:devel',
      ]

    name = 'libvirt'
    version = '0.4.5'
    rpmRelease = '2.fc10'
    rpmPatches = [ 'libvirt-0.4.5-no-emulator-segfault.patch' ]

    def configure(r):
        r.addPatch('libvirt-gnutls-autodetect.patch')
        r.Run('autoconf')

        config =  ' --with-libvirtd --with-init-scripts=redhat --without-sasl --without-polkit --without-avahi --with-gnu-ld --with-lxc '
        config += ' --with-xen --with-qemu '
        config += ' --with-remote-file=%(localstatedir)s/run/libvirtd.pid '
        config += ' --prefix=%(prefix)s --localstatedir=%(localstatedir)s --libdir=%(libdir)s'

        r.ManualConfigure(config)

    def policy(r):

        for d in [ '%(localstatedir)s/run/%(name)s', 
                   '%(sysconfdir)s/libvirt/qemu/networks/autostart',
                   '%(localstatedir)s/log/libvirt/qemu',
                   # FC9 default locations are sane; let's use them. 
                   '%(localstatedir)s/lib/libvirt/images', '%(localstatedir)s/lib/libvirt/boot', 
                   ]:
            r.MakeDirs(d)
            r.ExcludeDirectories(exceptions = d)

        # We don't want to install /etc/libvirt/qemu/networks in the package directly
        # because if the admin wants to delete the default network completely, we don't
        # want to end up re-incarnating it on every conary upgrade.
        r.Copy('%(sysconfdir)s/libvirt/qemu/networks/default.xml', '%(datadir)s/libvirt/networks/default.xml')
        r.Remove('%(sysconfdir)s/libvirt/qemu/networks/default.xml')
        r.Remove('%(sysconfdir)s/libvirt/qemu/networks/autostart/default.xml')
        # Strip auto-generated UUID - we need it generated per-install
        r.Run('sed -i -e "/<uuid>/d" %(destdir)s%(datadir)s/libvirt/networks/default.xml')

        r.SetModes('/usr/libexec/libvirt_proxy', 04755)

        # We want to install the default network for initial conary installs
        # or on the first upgrade from a non-network aware libvirt only.
        # We check this by looking to see if the daemon is already installed
        # thru a taghandler

        r.addSource('%(name)s_uuidgen.tagdescription', macros=True,
                    dest='%(tagdescriptiondir)s/%(name)s_uuidgen')
        r.addSource('%(name)s_uuidgen.taghandler', macros=True,
                    dest='%(taghandlerdir)s/%(name)s_uuidgen', mode=0755)

        r.Requires('file: %(bindir)s/virsh', '%(taghandlerdir)s/%(name)s_uuidgen')
        r.Requires('file: %(sbindir)s/dnsmasq', '%(bindir)s/virsh')

        r.TagSpec('%(name)s_uuidgen', '%(bindir)s/virsh')

