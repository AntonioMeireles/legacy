#
# Copyright (c) 2008 Lance Haig.
#               2008-2009 the Foresight Linux Project 
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('rpmpackage')
class LibVirt(RPMPackageRecipe,AutoPackageRecipe):
    buildRequires = [ 'iptables:runtime', 
                      'libxml2:devel', 
                      'libxml2:runtime', 
                      'libxslt:runtime', 
                      'ncurses:devel', 
                      'readline:devel', 
                      'sysfsutils:devel', 
                      'zlib:devel',
                      #'xen:devel', # enable this on rpl2 for xen support
                      'gnutls:devel',
                      'gnutls:runtime',
                      'cyrus-sasl:devel',
                      'cyrus-sasl:runtime',
                      'parted:devel',
                      'parted:devellib',
                      'parted:runtime',
                      'pkgconfig:devel',
                      'PolicyKit:devel',
                      'avahi:devel',
                      'bridge-utils:runtime',
                      'cyrus-sasl:devel',
                      'dbus:devel',
                      'python:devel',
                      'readline:devel',
                      'PolicyKit:runtime', 
                      'gcc-c++:runtime', 
                      'kvm:runtime', 
                      'open-iscsi:runtime',
                      'gettext:runtime', 
                      'intltool:runtime', 
                      'chkconfig:runtime',
                      'dnsmasq:runtime',
                      'nfs-client:runtime',
                      'hal:devel', 'udev:runtime',
                      'module-init-tools:runtime',
                      'lvm2:runtime',
                      'info-kvm:group',
                      ]

    name = 'libvirt'
    version = '0.7.0'
    rpmRelease = '2.fc12'
    rpmPatches = [
        'libvirt-0.7.0-chown-kernel-initrd-before-spawning-qemu.patch',
        'libvirt-0.6.4-svirt-sound.patch'
    ]

    def configure(r):
        r.Replace('with_init_scripts', 'with_init_script', 'configure')

        config =  ' --with-libvirtd --with-init-script=redhat --with-sasl'
        config += ' --with-polkit --with-avahi --with-gnu-ld --with-lxc'
        config += ' --without-xen --with-qemu --with-python --without-phyp'
        config += ' --without-capng --without-netcf'
        config += ' --with-remote-pid-file=%(localstatedir)s/run/libvirtd.pid '
        config += ' --prefix=%(prefix)s --localstatedir=%(localstatedir)s --libdir=%(libdir)s'
        config += ' --with-qemu-user=root --with-qemu-group=kvm'

        r.ManualConfigure(config)

    def policy(r):

        for d in [ '%(localstatedir)s/run/%(name)s', 
                   '%(sysconfdir)s/libvirt/qemu/networks/autostart',
                   '%(localstatedir)s/log/libvirt/qemu',
                   '%(localstatedir)s/lib/%(name)s/images',
                   '%(localstatedir)s/lib/%(name)s/boot', 
                   '%(localstatedir)s/cache/%(name)s',
                   '%(sysconfdir)s/%(name)s',
                   ]:
            r.MakeDirs(d)
            r.ExcludeDirectories(exceptions = d)

        for d in [ '%(libdir)s/%(name)s/drivers',
                   '%(localstatedir)s/lib/%(name)s/.*',
                   '%(localstatedir)s/run/%(name)s/.*',
                   ]:
            r.ExcludeDirectories(exceptions = d)

        # set perms right
        r.SetModes('%(sysconfdir)s/%(name)s/', 0700)

        r.SetModes('%(localstatedir)s/log/%(name)s/', 0700)
        r.SetModes('%(localstatedir)s/lib/%(name)s/images/', 0711)
        r.SetModes('%(localstatedir)s/lib/%(name)s/boot/', 0711)
        r.SetModes('%(localstatedir)s/lib/%(name)s/qemu/', 0700)
        r.SetModes('%(localstatedir)s/lib/%(name)s/lxc/', 0700)

        r.SetModes('%(localstatedir)s/lib/%(name)s/network/', 0700)
        r.SetModes('%(localstatedir)s/lib/%(name)s/iptables/', 0700)
        r.SetModes('%(localstatedir)s/lib/%(name)s/iptables/filter', 0700)
        r.SetModes('%(localstatedir)s/lib/%(name)s/iptables/nat', 0700)

        r.SetModes('%(localstatedir)s/log/%(name)s/qemu', 0700)

        r.SetModes('%(libexecdir)s/libvirt_parthelper', 0755)
        r.SetModes('%(sbindir)s/libvirtd', 0755)

        # We don't want to install /etc/libvirt/qemu/networks in the package directly
        # because if the admin wants to delete the default network completely, we don't
        # want to end up re-incarnating it on every conary upgrade.
        r.MakeDirs('%(datadir)s/libvirt/networks')
        r.Copy('%(sysconfdir)s/libvirt/qemu/networks/default.xml', '%(datadir)s/libvirt/networks/default.xml')
        r.Remove('%(sysconfdir)s/libvirt/qemu/networks/default.xml')
        r.Remove('%(sysconfdir)s/libvirt/qemu/networks/autostart/default.xml')
        # Strip auto-generated UUID - we need it generated per-install
        r.Run('sed -i -e "/<uuid>/d" %(destdir)s%(datadir)s/libvirt/networks/default.xml')

        # We want to install the default network for initial conary installs
        # or on the first upgrade from a non-network aware libvirt only.
        # We check this by looking to see if the daemon is already installed
        # thru a taghandler

        r.addSource('%(name)s_uuidgen.tagdescription', macros=True,
                    dest='%(tagdescriptiondir)s/%(name)s_uuidgen')
        r.addSource('%(name)s_uuidgen.taghandler', macros=True,
                    dest='%(taghandlerdir)s/%(name)s_uuidgen', mode=0755)

        r.Requires('file: %(bindir)s/virsh', '%(taghandlerdir)s/%(name)s_uuidgen')
        r.Requires('file: %(sbindir)s/dnsmasq', '%(bindir)s/virsh')

        r.TagSpec('%(name)s_uuidgen', '%(bindir)s/virsh')

        # Client files
        r.PackageSpec("%(name)s-client", '%(mandir)s/man1/virsh\.1.*')
        r.PackageSpec("%(name)s-client", '%(mandir)s/man1/virt-xml-validate\.1.*')
        r.PackageSpec("%(name)s-client", '%(bindir)s/virsh')
        r.PackageSpec("%(name)s-client", '%(bindir)s/virt-xml-validate')
        r.PackageSpec("%(name)s-client", '%(libdir)s/lib.*\.so\..*')
        r.PackageSpec("%(name)s-client", '%(datadir)s/locale/.*')
        r.PackageSpec("%(name)s-client", '%(datadir)s/%(name)s/schemas/.*')
        r.PackageSpec("%(name)s-client", '%(sysconfdir)s/sasl2/libvirt.conf')
