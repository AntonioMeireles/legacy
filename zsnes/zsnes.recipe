#
# Copyright (c) 2008 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
 
 
class zsnes(AutoPackageRecipe):
    name = 'zsnes'
    version = '1.5.1'
 
    buildRequires = ['Mesa:devel', 'SDL:devel', 'libpng:devel', 'libstdc++:devel', 'nasm:runtime', 'ncurses:devel', 'zlib:devel',
                     'autoconf:runtime', 'automake:runtime', 'libtool:runtime', 'libao:devel', 'desktop-file-utils:runtime']
 
    def setup(r):
        r.addArchive('http://prdownloads.sourceforge.net/zsnes/zsnes151src.tar.bz2')
        for p in [ 'zsnes-1.51-Makefile.in.FIX.BROKENESS.patch', 
                   'zsnes-1.51-FORTIFY_SOURCE.patch', 
                   'zsnes-1.51-pulseaudio.patch',]:
            r.addPatch(p, extraArgs = '-F5')

        r.macros.ldflags += ' -L%(libdir)s/xorg.mesa.3d/ '

        r.Replace(('int\ main\(size_t\ argc,\ const\ char\ \*\*argv\)',
                   'int main(int argc, const char *const *const argv)'),
                   ('\#include\ \<fstream\>', '#include <fstream>\n#include <cstring>'),
                  'src/parsegen.cpp')
        r.Replace(('int\ main\(size_t\ argc\,\ const\ char\ \*const\ \*const\ argv\)',
                  'int main(int argc, const char *const *const argv)'),
                   ('\#include \<string\>', '#include <string>\n#include <cstdlib>'),
                  'src/tools/depbuild.cpp')
        r.Replace('#include <cctype>', '#include <cctype>\n#include <cstring>',
                  'src/tools/strutil.h')
        r.Run(""" sed -i \
           -e 's:^\s*CFLAGS=.* -D__RELEASE__.*$:CFLAGS="$CFLAGS -D__RELEASE__":' \
              -e 's:^\s*CFLAGS=.* -I\/usr\/local\/include .*$:CFLAGS="${CFLAGS} -I.":' \
              -e '/^\s*LDFLAGS=.* -L\/usr\/local\/lib /d' \
              src/configure.in ; sed -i -e 's/^Icon=%(name)s.png$/Icon=%(name)s/g' \
 src/linux/%(name)s.desktop""")

        r.Run('autoreconf -fi', dir = 'src')
        
        r.Configure('--enable-libao --enable-release  --disable-cpucheck force_arch="i686"', dir = 'src/')

        r.Make(dir = 'src/')
        r.MakeInstall(dir = 'src/')

        r.Desktopfile('src/linux/%(name)s.desktop')

        r.Install('src/icons/16x16x32.png', '%(datadir)s/icons/hicolor/16x16/apps/zsnes.png', mode = 0644)
        r.Install('src/icons/32x32x32.png', '%(datadir)s/icons/hicolor/32x32/apps/zsnes.png', mode = 0644)
        r.Install('src/icons/48x48x32.png', '%(datadir)s/icons/hicolor/48x48/apps/zsnes.png', mode = 0644)
        r.Install('src/icons/64x64x32.png', '%(datadir)s/icons/hicolor/64x64/apps/zsnes.png', mode = 0644)
