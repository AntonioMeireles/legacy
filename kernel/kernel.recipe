#
# Copyright (c) 2005-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelpackage.recipe')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.24.7'

    def unpack(r):
        r.addPatch('vmware_mptbase_workaround.patch')
        r.addPatch('linux-2.6-open-vm-tools.patch')
        r.addPatch('linux-2.6-hptiop-3210.patch')
        r.addPatch('linux-2.6-tsc_prevent_time_going_backwards.patch')
        r.addPatch('linux-2.6-igb-PCI-Express-82575-Gigabit-Ethernet-driver.patch')

        # Security Patches
        # CVE-2008-2136
        r.addPatch('0001-sit-Add-missing-kfree_skb-on-pskb_may_pull-fail.patch')
        # CVE-2008-2148
        r.addPatch('vfs-fix-permission-checking-in-sys_utimensat.patch')

    def build(r):
        r.Run('for i in $(find %(destdir)s | grep drivers\/ata); '
              'do if [ $(nm $i |grep --count ata_device_add) -ne 0 -o '
              '$(nm $i |grep --count ata_pci_init_one) -ne 0 ]; '
              'then basename `echo $i` >> modules.libata; '
              'fi ; done')
        r.Install('modules.libata', '/lib/modules/%(kver)s/modules.libata')
