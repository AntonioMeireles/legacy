#
# Copyright (c) 2005-2009 rPath, Inc.
#               2008-2010 Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadInstalled('open-vm-tools')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.35.10'

    def unpackBase(r):
        r.macros.kseries = ".".join(r.version.split('.')[0:3])
        r.addArchive(
            'ftp://ftp.kernel.org/pub/linux/kernel/v%(majorversion)s/'
            'longterm/v%(kseries)s/'
            'linux-%(version)s.tar.bz2',
            keyid='517D0F0E'
            )
    
    def addNonInteractiveConfig(r):
        # avoid requests for interactive response
        r.addPatch('linux-2.6-build-nonintconfig.patch')

    def unpack(r):        
	# r.addPatch('git-linus.diff') 
        r.addPatch('linux-2.6-makefile-after_link.patch') 
        # r.addPatch('linux-2.6-compile-fixes.patch') 
        r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R') 
        
        r.addPatch('linux-2.6-hotfixes.patch')
        r.addPatch('git-utrace.patch')
        r.addPatch('utrace-ptrace-fix-build.patch')
        r.addPatch('utrace-remove-use-of-kref_set.patch')
        r.addPatch('linux-2.6.29-sparc-IOC_TYPECHECK.patch')
        r.addPatch('linux-2.6-i386-nx-emulation.patch')
        r.addPatch('linux-2.6-32bit-mmap-exec-randomization.patch')
        r.addPatch('ext4-always-journal-quota-file-modifications.patch')
        r.addPatch('btrfs-fix-error-handling-in-btrfs_get_sub.patch')
        r.addPatch('btrfs-setup-blank-root-and-fs_info-for-mount-time.patch')
        r.addPatch('btrfs-fix-race-between-btrfs_get_sb-and-unmount.patch')
        r.addPatch('disable-xhci-by-default.patch')
        r.addPatch('linux-2.6-defaults-acpi-video.patch')
        r.addPatch('linux-2.6-acpi-video-dos.patch')
        r.addPatch('acpi-ec-add-delay-before-write.patch')
        r.addPatch('linux-2.6-acpi-debug-infinite-loop.patch')
        r.addPatch('linux-2.6-defaults-no-pm-async.patch')
        r.addPatch('linux-2.6-debug-sizeof-structs.patch')
        r.addPatch('linux-2.6-debug-nmi-timeout.patch')
        r.addPatch('linux-2.6-debug-taint-vm.patch')
        r.addPatch('linux-2.6-debug-vm-would-have-oomkilled.patch')
        r.addPatch('linux-2.6-debug-always-inline-kzalloc.patch')
        r.addPatch('pnp-log-pnp-resources-as-we-do-for-pci.patch')
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch')
        r.addPatch('linux-2.6-defaults-pci_use_crs.patch')
        r.addPatch('linux-2.6-defaults-aspm.patch')
        r.addPatch('pci-acpi-disable-aspm-if-no-osc.patch')
        r.addPatch('pci-aspm-dont-enable-too-early.patch')
        r.addPatch('pci-disable-aspm-if-bios-asks-us-to.patch')
        r.addPatch('hda_intel-prealloc-4mb-dmabuffer.patch')
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch')
        r.addPatch('die-floppy-die.patch')
        r.addPatch('linux-2.6.30-no-pcspkr-modalias.patch')
        r.addPatch('thinkpad-acpi-fix-backlight.patch')
        r.addPatch('linux-2.6-serial-460800.patch')
        r.addPatch('linux-2.6-silence-noise.patch')
        r.addPatch('linux-2.6-silence-fbcon-logo.patch')
        r.addPatch('create-sys-fs-cgroup-to-mount-cgroupfs-on.patch')
        r.addPatch('linux-2.6-crash-driver.patch')
        r.addPatch('linux-2.6-e1000-ich9-montevina.patch')
        r.addPatch('fix_xen_guest_on_old_EC2.patch')
        r.addPatch('drm-polling-fixes.patch')
        r.addPatch('drm-edid-invalid.patch')
        r.addPatch('drm-simplify-i2c-config.patch')
        r.addPatch('drm-sil164-module.patch')
        r.addPatch('drm-i2c-ch7006-fix.patch')
        r.addPatch('drm-ttm-fix.patch')
        r.addPatch('drm-nouveau-updates.patch')
        r.addPatch('drm-nouveau-race-fix.patch')
        r.addPatch('drm-nouveau-nva3-noaccel.patch')
        r.addPatch('drm-nouveau-nv86-bug.patch')
        r.addPatch('drm-nouveau-nv50-crtc-update-delay.patch')
        r.addPatch('drm-nouveau-connector-fix.patch')
        r.addPatch('drm-nouveau-imac-g4.patch')
        r.addPatch('drm-nouveau-evo-hang.patch')
        r.addPatch('drm-nouveau-nvaf-grclass.patch')
        r.addPatch('drm-intel-big-hammer.patch')
        # r.addPatch('drm-intel-next.patch')
        r.addPatch('drm-intel-make-lvds-work.patch')
        r.addPatch('drm-i915-disable-sr-polling.patch')
        r.addPatch('linux-2.6-intel-iommu-igfx.patch')
        r.addPatch('drm-ttm-fix-two-race-conditions-fix-busy-codepaths.patch')
        r.addPatch('efifb-add-more-models.patch')
        r.addPatch('efifb-check-that-the-base-addr-is-plausible-on-pci-systems.patch')
        r.addPatch('linux-2.6-silence-acpi-blacklist.patch')
        r.addPatch('hdpvr-ir-enable.patch')
        r.addPatch('flexcop-fix-xlate_proc_name-warning.patch')
        r.addPatch('linux-2.6-v4l-dvb-fixes.patch')
        r.addPatch('linux-2.6-v4l-dvb-update.patch')
        r.addPatch('linux-2.6-v4l-dvb-experimental.patch')
        r.addPatch('linux-2.6-via-velocity-dma-fix.patch')
        r.addPatch('linux-2.6-rcu-netpoll.patch')
        r.addPatch('disable-i8042-check-on-apple-mac.patch')
        r.addPatch('add-appleir-usb-driver.patch')
        r.addPatch('hid-support-tivo-slide-remote.patch')
        r.addPatch('neuter_intel_microcode_load.patch')
        r.addPatch('only-use-alpha2-regulatory-information-from-country-IE.patch')
        r.addPatch('kprobes-x86-fix-kprobes-to-skip-prefixes-correctly.patch')
        r.addPatch('fix-rcu_deref_check-warning.patch')
        r.addPatch('linux-2.6-cgroups-rcu.patch')
        r.addPatch('sched-05-avoid-side-effect-of-tickless-idle-on-update_cpu_load.patch')
        r.addPatch('sched-10-change-nohz-idle-load-balancing-logic-to-push-model.patch')
        r.addPatch('sched-15-update-rq-clock-for-nohz-balanced-cpus.patch')
        r.addPatch('sched-20-fix-rq-clock-synchronization-when-migrating-tasks.patch')
        r.addPatch('sched-25-move-sched_avg_update-to-update_cpu_load.patch')
        r.addPatch('sched-30-sched-fix-nohz-balance-kick.patch')
        r.addPatch('sched-35-increment-cache_nice_tries-only-on-periodic-lb.patch')
        r.addPatch('sched-cure-more-NO_HZ-load-average-woes.patch')
        r.addPatch('btusb-macbookpro-7-1.patch')
        r.addPatch('btusb-macbookpro-6-2.patch')
        r.addPatch('add-macbookair3-ids.patch')
        r.addPatch('libata-it821x-dump-stack-on-cache-flush.patch')
        r.addPatch('dm-allow-setting-of-uuid-via-rename-if-not-already-set.patch')
        r.addPatch('dmar-disable-when-ricoh-multifunction.patch')
        r.addPatch('ima-allow-it-to-be-completely-disabled-and-default-off.patch')
        r.addPatch('sdhci-8-bit-data-transfer-width-support.patch')
        r.addPatch('mmc-make-sdhci-work-with-ricoh-mmc-controller.patch')
        r.addPatch('mmc-add-ricoh-e822-pci-id.patch')
        r.addPatch('tpm-autodetect-itpm-devices.patch')
        r.addPatch('tpm-fix-stall-on-boot.patch')
        r.addPatch('kvm-fix-fs-gs-reload-oops-with-invalid-ldt.patch')
        r.addPatch('fix-i8k-inline-asm.patch')
        r.addPatch('inet_diag-make-sure-we-run-the-same-bytecode-we-audited.patch')
        r.addPatch('netlink-make-nlmsg_find_attr-take-a-const-ptr.patch')
        r.addPatch('posix-cpu-timers-workaround-to-suppress-problems-with-mt-exec.patch')
        r.addPatch('rtl8180-improve-signal-reporting-for-rtl8185-hardware.patch')
        r.addPatch('rtl8180-improve-signal-reporting-for-actual-rtl8180-hardware.patch')
        r.addPatch('tty-make-tiocgicount-a-handler.patch')
        r.addPatch('tty-icount-changeover-for-other-main-devices.patch')
        r.addPatch('mm-page-allocator-adjust-the-per-cpu-counter-threshold-when-memory-is-low.patch')
        r.addPatch('mm-vmstat-use-a-single-setter-function-and-callback-for-adjusting-percpu-thresholds.patch')
        r.addPatch('orinoco-initialise-priv_hw-before-assigning-the-interrupt.patch')

        #VMware support
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        # sf mirror network unreliable:/ 
        #r.addArchive('mirror://sourceforge/open-vm-tools/'
        r.addArchive('http://downloads.sourceforge.net/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(version)s')
                     # dir='linux-2.6.35.1')
        # 2.6.35 compatibility
        # from ubuntu
        r.addPatch('03-vmxnet.patch', dir='open-vm-tools-%(ovmtoolsver)s')
        r.addPatch('04-vsock.patch', dir='open-vm-tools-%(ovmtoolsver)s')

        # Add the cp437 version of the terminus font to the kernel and 
        # keep a backup of the original font for comparison purposes. 
        # -- /ermo
        r.addSource('terminus_font_8x16.c', dest = 'drivers/video/console/')
        r.Copy('drivers/video/console/font_8x16.c', 'drivers/video/console/font_8x16.c.org')
        # Comment out the line below to keep original VGA font.
        r.Copy('drivers/video/console/terminus_font_8x16.c', 'drivers/video/console/font_8x16.c')

    def configure(r):
        r.addSource('kernel-foresight-i686.config', dest = 'configs/', use=Arch.x86)
        r.addSource('kernel-foresight-x86_64.config', dest = 'configs/', use=Arch.x86_64)
            
        if Arch.x86:
            r.macros.cfgver = '.smp.gcc4.4.x86.i686'
            r.Copy('configs/kernel-foresight-i686.config', '.config')
        elif Arch.x86_64:
            r.macros.cfgver = '.smp.gcc4.4.x86_64'
            r.Copy('configs/kernel-foresight-x86_64.config', '.config')

        r.Make( 'nonint_oldconfig 2>oc.err ||'
                ' { diff -u .config.old .config > config.changes;'
                '   cat config.changes ;'
                '   echo "missing config items:"; cat oc.err ;'
                '   exit 1; }')
        # if we get here, this file is empty, remove it
        r.Remove('oc.err')

    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmmemctl',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vsock',
                  # deprecated
                  # 'drivers/scsi/pvscsi',
                  'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'

            r.Run('make -C %(builddir)s SUBDIRS=$PWD SRCROOT=$PWD/.'
                  ' MODULEBUILDDIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s/modules/linux'
                  ' OVT_SOURCE_DIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s',
                  ' VM_KBUILD=26'
                  ' modules',
                  dir=modsrc)

            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))

        # rm cruft
        r.Remove('/lib/modules/%(kver)s/source/open-vm-tools-%(ovmtoolsver)s/', recursive = True)
