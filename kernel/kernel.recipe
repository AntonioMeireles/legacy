#
# Copyright (c) 2005-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelpackage.recipe')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.24.7'

    def unpack(r):
        r.addPatch('vmware_mptbase_workaround.patch')
        r.addPatch('linux-2.6-open-vm-tools.patch')
        r.addPatch('linux-2.6-hptiop-3210.patch')
        r.addPatch('linux-2.6-tsc_prevent_time_going_backwards.patch')
        r.addPatch('linux-2.6-igb-PCI-Express-82575-Gigabit-Ethernet-driver.patch')
        r.addPatch('linux-2.6-ixgbe_1.3.20.3_update.patch')
        r.addPatch('asn1-additional-sanity-checking-during-ber-decoding.patch')
        r.addPatch('x86-pci-call-dmi_check_pciprobe.patch')
        r.addPatch('no-generic-nopls-2.6.24.7.patch')

        # Security Patches
        # CVE-2008-2136
        r.addPatch('0001-sit-Add-missing-kfree_skb-on-pskb_may_pull-fail.patch')
        # CVE-2008-2148
        r.addPatch('vfs-fix-permission-checking-in-sys_utimensat.patch')
        # CVE-2008-2372
        r.addPatch('reinstate-zero_page-optimization-in-get_user_pages-and-fix-xip.patch')
        r.addPatch('fix-zero_page-breakage-with-vmware.patch')
        # CVE-2008-2750
        r.addPatch('linux-2.6-net-l2tp-fix-potential-memory-corruption-in-pppol2tp_recvmsg.patch')
        # CVE-2008-2826
        r.addPatch('sctp-make-sure-n-sizeof-does-not-overflow.patch')

    def build(r):
        r.Run('for i in $(find %(destdir)s | grep drivers\/ata); '
              'do if [ $(nm $i |grep --count ata_device_add) -ne 0 -o '
              '$(nm $i |grep --count ata_pci_init_one) -ne 0 ]; '
              'then basename `echo $i` >> modules.libata; '
              'fi ; done')
        r.Install('modules.libata', '/lib/modules/%(kver)s/modules.libata')
