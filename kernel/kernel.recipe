#
# Copyright (c) 2005-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelpackage.recipe')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.25.4'

    def unpack(r):
        r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R')
        r.addPatch('linux-2.6-hotfixes.patch')
        r.addPatch('linux-2.6-sysrq-c.patch')
        r.addPatch('linux-2.6-x86-tune-generic.patch')
        r.addPatch('linux-2.6-smp-boot-delay.patch')
        r.addPatch('linux-2.6-x86-dont-map-vdso-when-disabled.patch')
        r.addPatch('linux-2.6-x86-dont-use-disabled-vdso-for-signals.patch')
        r.addPatch('linux-2.6-x86-fix-asm-constraint-in-do_IRQ.patch')
        r.addPatch('linux-2.6-x86-pci-revert-remove-default-rom-allocation.patch')
        r.addPatch('linux-2.6-x86-dont-read-maxlvt-if-apic-unmapped.patch')
        r.addPatch('linux-2.6-x86-fix-setup-of-cyc2ns-in-tsc_64.patch')
        r.addPatch('linux-2.6-x86-prevent-pge-flush-from-interruption.patch')
        r.addPatch('linux-2.6-usb-ehci-hcd-respect-nousb.patch')
        r.addPatch('linux-2.6-acpi-eeepc-hotkey.patch')
        r.addPatch('linux-2.6-devmem.patch')
        r.addPatch('linux-2.6-crash-driver.patch')
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch')
        r.addPatch('linux-2.6-scsi-cpqarray-set-master.patch')
        r.addPatch('linux-2.6-alsa-kill-annoying-messages.patch')
        r.addPatch('linux-2.6-alsa-hda-codec-add-AD1884A.patch')
        r.addPatch('linux-2.6-alsa-hda-codec-add-AD1884A-mobile.patch')
        r.addPatch('linux-2.6-alsa-hda-codec-add-AD1884A-x300.patch')
        r.addPatch('linux-2.6-cifs-fix-unc-path-prefix.patch')
        r.addPatch('linux-2.6-squashfs.patch')
        r.addPatch('linux-2.6-ext34-xattr-fix.patch')
        r.addPatch('linux-2.6-xfs-small-buffer-reads.patch')
        r.addPatch('linux-2.6-net-silence-noisy-printks.patch')
        r.addPatch('linux-2.6-net-iptables-add-xt_iprange-aliases.patch')
        r.addPatch('linux-2.6-netlink-fix-parse-of-nested-attributes.patch')
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch')
        r.addPatch('linux-2.6-input-fix_fn_key_on_macbookpro_4_1_and_mb_air.patch')
        r.addPatch('linux-2.6-serial-460800.patch')
        r.addPatch('linux-2.6-silence-noise.patch')
        r.addPatch('linux-2.6-defaults-fat-utf8.patch')
        r.addPatch('linux-2.6-ata-quirk.patch')
        r.addPatch('linux-2.6-libata-force-hardreset-in-sleep-mode.patch')
        r.addPatch('linux-2.6-libata-acpi-hotplug-fixups.patch')
        r.addPatch('linux-2.6-libata-be-a-bit-more-slack-about-early-devices.patch')
        r.addPatch('linux-2.6-sata-eeepc-faster.patch')
        r.addPatch('linux-2.6-libata-acpi-handle-bay-devices-in-dock-stations.patch')
        r.addPatch('linux-2.6-wireless.patch')
        r.addPatch('linux-2.6-wireless-pending.patch')
        r.addPatch('linux-2.6-at76.patch')
        r.addPatch('linux-2.6-wireless-fixups.patch')
        r.addPatch('linux-2.6-smarter-relatime.patch')
        r.addPatch('linux-2.6-nfs-client-mounts-hang.patch')
        r.addPatch('linux-2.6-default-mmf_dump_elf_headers.patch')
        r.addPatch('linux-2.6-lirc.patch')
        r.addPatch('linux-2.6-e1000-ich9.patch')
        r.addPatch('linux-2.6-netdev-atl2.patch')
        r.addPatch('linux-2.6-drm-git-mm.patch')
        r.addPatch('nouveau-drm.patch')
        r.addPatch('nouveau-drm-update.patch')
        r.addPatch('linux-2.6-drm-i915-modeset.patch')
        r.addPatch('linux-2.6-drm-radeon-fix-oops.patch')
        r.addPatch('linux-2.6-drm-radeon-fix-oops2.patch')
        r.addPatch('linux-2.6-drm-modesetting-oops-fixes.patch')
        r.addPatch('linux-2.6-drm-fix-master-perm.patch')
        r.addPatch('drm-radeon-update.patch')
        r.addPatch('linux-2.6-firewire-git-update.patch')
        r.addPatch('linux-2.6-firewire-git-pending.patch')
        r.addPatch('linux-2.6-uvcvideo.patch')
        r.addPatch('linux-2.6-merge-efifb-imacfb.patch')
        r.addPatch('linux-2.6.22-rndis_host-wm5.patch')
        r.addPatch('linux-2.6-alsa-ice17xx_update.patch')
        r.addPatch('http://download.filesystems.org/unionfs/unionfs-2.x/unionfs-2.3.3_for_2.6.25.diff.gz')
        r.addPatch('linux-2.6-open-vm-tools.patch')
        r.addPatch('linux-2.6-export_flush_tlb_page.patch')

    def build(r):
        r.Run('for i in $(find %(destdir)s | grep drivers\/ata); '
              'do if [ $(nm $i |grep --count ata_device_add) -ne 0 -o '
              '$(nm $i |grep --count ata_pci_init_one) -ne 0 -o '
              '$(nm $i |grep --count ata_cable_40wire) -ne 0 ]; '
              'then basename `echo $i` >> modules.found; '
              'fi ; done ; sort -u modules.found -o modules.libata')
        r.Install('modules.libata', '/lib/modules/%(kver)s/modules.libata')
