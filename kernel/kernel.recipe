#
# Copyright (c) 2005-2009 rPath, Inc.
#               2008-2011 The Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadInstalled('open-vm-tools')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):
    name = 'kernel'
    version = '3.0.8'
    realVersion = version
    longterm = False

    def unpackBase(r):
                r.addArchive(
                    'http://ftp.kernel.org/pub/linux/kernel'
                    '/v3.0/linux-%s.tar.bz2' % r.realVersion,
                    keyid='517D0F0E'
                    )
    def setMacros(r):
        r.version = '2.6.40.8'
        r.macros.version = r.version
        KernelPackageRecipe.setMacros(r)

    def unpack(r):
        # r.addPatch('stable-queue.patch')
        r.addPatch('linux-2.6-makefile-after_link.patch') 
        # r.addPatch('linux-2.6-compile-fixes.patch')
        # r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R')

        r.addPatch('perf-check-ownership.patch')
        r.addPatch('linux-2.6.29-sparc-IOC_TYPECHECK.patch')
        r.addPatch('arm-omap-dt-compat.patch')
        r.addPatch('arm-smsc-support-reading-mac-address-from-device-tree.patch')
        r.addPatch('arm-readl.patch')
        r.addPatch('TEGRA-2.6.40.2-enable-USB-ports.patch')
        r.addPatch('linux-2.6-i386-nx-emulation.patch')
        r.addPatch('linux-2.6-32bit-mmap-exec-randomization.patch')
        r.addPatch('xfs-Fix-possible-memory-corruption-in-xfs_readlink.patch')
        r.addPatch('linux-2.6-defaults-acpi-video.patch')
        r.addPatch('linux-2.6-acpi-video-dos.patch')
        r.addPatch('acpi-ec-add-delay-before-write.patch')
        r.addPatch('linux-2.6-acpi-debug-infinite-loop.patch')
        r.addPatch('acpi-ensure-thermal-limits-match-cpu-freq.patch')
        r.addPatch('acpi-sony-nonvs-blacklist.patch')
        r.addPatch('linux-2.6-debug-taint-vm.patch')
        r.addPatch('linux-2.6-debug-vm-would-have-oomkilled.patch')
        r.addPatch('linux-2.6-defaults-aspm.patch')
        r.addPatch('hda_intel-prealloc-4mb-dmabuffer.patch')
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch')
        r.addPatch('die-floppy-die.patch')
        r.addPatch('linux-2.6.30-no-pcspkr-modalias.patch')
        r.addPatch('linux-2.6-serial-460800.patch')
        r.addPatch('linux-2.6-silence-noise.patch')
        r.addPatch('linux-2.6-silence-fbcon-logo.patch')
        r.addPatch('x86-pci-reduce-severity-of-host-bridge-window-conflict-warnings.patch')
        r.addPatch('linux-2.6-crash-driver.patch')
        r.addPatch('linux-2.6-e1000-ich9-montevina.patch')
        r.addPatch('fix_xen_guest_on_old_EC2.patch')
        r.addPatch('drm-nouveau-updates.patch')
        # r.addPatch('drm-intel-next.patch')
        r.addPatch('drm-intel-make-lvds-work.patch')
        r.addPatch('drm-i915-sdvo-lvds-is-digital.patch')
        r.addPatch('drm-lower-severity-radeon-lockup.diff')
        r.addPatch('linux-2.6-intel-iommu-igfx.patch')
        r.addPatch('block-stray-block-put-after-teardown.patch')
        r.addPatch('linux-2.6-silence-acpi-blacklist.patch')
        r.addPatch('linux-2.6-v4l-dvb-fixes.patch')
        r.addPatch('linux-2.6-v4l-dvb-update.patch')
        r.addPatch('linux-2.6-v4l-dvb-experimental.patch')
        r.addPatch('media-DiBcom-protect-the-I2C-bufer-access.patch')
        r.addPatch('media-dib0700-protect-the-dib0700-buffer-access.patch')
        r.addPatch('media-dib0700-correct-error-message.patch')
        r.addPatch('rcutree-avoid-false-quiescent-states.patch')
        r.addPatch('disable-i8042-check-on-apple-mac.patch')
        r.addPatch('add-appleir-usb-driver.patch')
        r.addPatch('ums-realtek-driver-uses-stack-memory-for-DMA.patch')
        r.addPatch('usb-add-quirk-for-logitech-webcams.patch')
        r.addPatch('crypto-register-cryptd-first.patch')
        r.addPatch('x86-efi-Calling-__pa-with-an-ioremap-address-is-invalid.patch')
        r.addPatch('x86-p4-make-watchdog-and-perf-work-together.patch')
        r.addPatch('dmar-disable-when-ricoh-multifunction.patch')
        r.addPatch('epoll-fix-spurious-lockdep-warnings.patch')
        r.addPatch('epoll-limit-paths.patch')
        r.addPatch('iwlagn-check-for-priv--txq-in-iwlagn_wait_tx_queue_empty.patch')
        r.addPatch('utrace.patch')
        r.addPatch('vfs-fix-automount-for-negative-autofs-dentries.patch')
        r.addPatch('md-dont-delay-reboot-by-1-second-if-no-MD-devices.patch')
        r.addPatch('Platform-fix-samsung-laptop-DMI-identification-for-N.patch')
        r.addPatch('x86-Save-stack-pointer-in-perf-live-regs-savings.patch')
        r.addPatch('x86-Fetch-stack-from-regs-when-possible-in-dump_trac.patch')
        r.addPatch('binfmt_elf-fix-PIE-execution-with-random-disabled.patch')
        r.addPatch('mmc-Always-check-for-lower-base-frequency-quirk-for-.patch')
        r.addPatch('0001-mm-vmscan-Limit-direct-reclaim-for-higher-order-allo.patch')
        r.addPatch('0002-mm-Abort-reclaim-compaction-if-compaction-can-procee.patch')
        r.addPatch('platform-fix-samsung-brightness-min-max-calculations.patch')
        r.addPatch('be2net-move-to-new-vlan-model.patch')
        r.addPatch('be2net-non-member-vlan-pkts-not-received-in-promisco.patch')
        r.addPatch('benet-remove-bogus-unlikely-on-vlan-check.patch')
        
        # VMware support
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        r.addArchive('http://downloads.sourceforge.net/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%s' % r.realVersion)

        # FL specific, as we rename kver to 2.6.4x.yy
        r.Replace('LINUX_VERSION_CODE\ \>\=\ KERNEL\_VERSION\(3\,\ 0\, 0\)',
                  'LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 40)',
                  'open-vm-tools-%(ovmtoolsver)s/modules/linux/shared/compat_netdevice.h')

        # Add the cp437 version of the terminus font to the kernel and 
        # keep a backup of the original font for comparison purposes. 
        # -- /ermo
        r.addSource('terminus_font_8x16.c', dest = 'drivers/video/console/')
        r.Copy('drivers/video/console/font_8x16.c', 'drivers/video/console/font_8x16.c.org')
        # Comment out the line below to keep original VGA font.
        r.Copy('drivers/video/console/terminus_font_8x16.c', 'drivers/video/console/font_8x16.c')

    def addConfiguration(r):
        r.addSource('kernel-foresight-i686.config',
                    dest = 'configs/',
                    use=Arch.x86)
        r.addSource('kernel-foresight-x86_64.config',
                    dest = 'configs/',
                    use=Arch.x86_64)

        r.macros.cfgver = '%(targetarch)s'
        r.Copy('configs/*.config', '.config')

    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'

        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vsock',
                  'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'
            r.Run('make -C %(builddir)s SUBDIRS=$PWD SRCROOT=$PWD/.'
                  ' MODULEBUILDDIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s/modules/linux'
                  ' OVT_SOURCE_DIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s',
                  ' VM_KBUILD=26 '
                  ' CC_OPTS=-DVMW_HAVE_EPOLL'
                  ' modules',
                  dir=modsrc)

            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # rm cruft
        r.Remove('/lib/modules/%(kver)s/source/open-vm-tools-%(ovmtoolsver)s/', recursive = True)
