#
# Copyright (c) 2005-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadInstalled('open-vm-tools')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.27.21'

    def unpack(r):
        r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R')

        r.addPatch('linux-2.6-makefile-after_link.patch')
        r.addPatch('linux-2.6-compile-fixes.patch')
        r.addPatch('git-cpufreq.patch')
        r.addPatch('linux-2.6-hotfixes.patch')
        r.addPatch('linux-2.6-utrace.patch')
        r.addPatch('linux-2.6-x86-tracehook.patch')
        r.addPatch('linux-2.6.27-x86-tracehook-syscall-arg-order.patch')
        r.addPatch('linux-2.6-sysrq-c.patch')
        r.addPatch('linux-2.6-sched-fine-tune-SD_MC_INIT.patch')
        r.addPatch('linux-2.6-sched-fine-tune-SD_SIBLING_INIT.patch')
        r.addPatch('linux-2.6-sched-wakeup-preempt-when-small-overlap.patch')
        r.addPatch('linux-2.6-ps3-storage-alias.patch')
        r.addPatch('linux-2.6-g5-therm-shutdown.patch')
        r.addPatch('linux-2.6-vio-modalias.patch')
        r.addPatch('linux-2.6-imac-transparent-bridge.patch')
        r.addPatch('sparc-2.6.git-aae7fb87ec4d2df6cb551670b1765cf4e5795a3b.patch')
        r.addPatch('linux-2.6-sparc-cs4231-ebus-dma.patch')
        # r.addPatch('linux-2.6-execshield.patch')
        r.addPatch('linux-2.6.27-ext4-rename-ext4dev-to-ext4.patch')
        r.addPatch('linux-2.6.27.9-ext4-cap-check-delay.patch')
        r.addPatch('linux-2.6.27-ext4-print-warning-once.patch')
        r.addPatch('linux-2.6.27-ext4-fix-header-check.patch')
        r.addPatch('linux-2.6.27-ext4-fix-bb-prealloc-list-corruption.patch')
        r.addPatch('linux-2.6.27-ext4-fix-bogus-bug-ons-in-mballoc.patch')
        r.addPatch('linux-2.6-usb-ehci-hcd-respect-nousb.patch')
        r.addPatch('linux-2.6-usb-option-increase-outgoing-buffers.patch')
        r.addPatch('linux-2.6-crypto-fips_enable.patch')
        r.addPatch('linux-2.6-defaults-acpi-video.patch')
        r.addPatch('linux-2.6-acpi-video-dos.patch')
        r.addPatch('linux-2.6-acpi-handle-ec-init-failure.patch')
        r.addPatch('linux-2.6-acpi-dock-fix-eject-request-process.patch')
        r.addPatch('linux-2.6-debug-sizeof-structs.patch')
        r.addPatch('linux-2.6-debug-nmi-timeout.patch')
        r.addPatch('linux-2.6-debug-taint-vm.patch')
        r.addPatch('linux-2.6-debug-spinlock-taint.patch')
        r.addPatch('linux-2.6-debug-vm-would-have-oomkilled.patch')
        r.addPatch('linux-2.6-mm-pagefault-enable-ints.patch')
        r.addPatch('linux-2.6-debug-always-inline-kzalloc.patch')
        r.addPatch('print-dmi-hw-name-in-warnings.patch')
        r.addPatch('linux-2.6-crash-driver.patch')
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch')
        r.addPatch('linux-2.6-pciehp-update.patch')
        r.addPatch('linux-2.6-defaults-pciehp.patch')
        r.addPatch('linux-2.6-defaults-fat-utf8.patch')
        r.addPatch('linux-2.6-scsi-cpqarray-set-master.patch')
        r.addPatch('linux-2.6-alsa-hda-probe-mask-quirks.patch')
        r.addPatch('linux-2.6.27-alsa-hda-workaround-for-buggy-dma-on-via.patch')
        r.addPatch('linux-2.6.27-alsa-hda-workaround-for-buggy-dma-on-ati.patch')
        r.addPatch('linux-2.6-squashfs.patch')
        r.addPatch('linux-2.6-net-silence-noisy-printks.patch')
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch')
        r.addPatch('linux-2.6.27-hwmon-applesmc-2.6.28.patch')
        r.addPatch('linux-2.6-input.git-i8042-add-xps-m1530-to-nomux.patch')
        r.addPatch('linux-2.6-input.git-i8042-add-vostro-1510-to-nomux.patch')
        r.addPatch('linux-2.6-serial-460800.patch')
        r.addPatch('linux-2.6-silence-noise.patch')
        r.addPatch('linux-2.6-silence-fbcon-logo.patch')
        r.addPatch('linux-2.6-selinux-mprotect-checks.patch')
        r.addPatch('linux-2.6-sparc-selinux-mprotect-checks.patch')
        r.addPatch('linux-2.6-selinux-recognise-addrlabel.patch')
        r.addPatch('linux-2.6-ata-quirk.patch')
        r.addPatch('linux-2.6-libata-pata-sch-notice-attached-slave-devices.patch')
        r.addPatch('linux-2.6-iwl3945-ibss-tsf-fix.patch')
        r.addPatch('linux-2.6-iwlwifi-remove-implicit-direct-scan.patch')
        r.addPatch('linux-2.6-wireless-ath9k-dma-fixes.patch')
        r.addPatch('linux-2.6-at76.patch')
        r.addPatch('linux-2.6.27-ath5k-ignore-the-return-value-of-ath5k_hw_noise_floor_calibration.patch')
        r.addPatch('linux-2.6-rtl8187b-tx-status-feedback.patch')
        r.addPatch('linux-2.6-mac80211-age-scan-results-on-resume.patch')
        r.addPatch('linux-2.6-ipw2x00-age-scan-results-on-resume.patch')
        r.addPatch('linux-2.6-nfs-client-mounts-hang.patch')
        r.addPatch('linux-2.6-uvc-hg.patch')
        r.addPatch('linux-2.6-uvc-spca525.patch')
        r.addPatch('linux-2.6-gspca-vc0321-fix-frame-overflow.patch')
        r.addPatch('linux-2.6-default-mmf_dump_elf_headers.patch')
        r.addPatch('linux-2.6.27-lirc.patch')
        r.addPatch('linux-2.6-hdpvr.patch')
        r.addPatch('linux-2.6-cdrom-door-status.patch')
        r.addPatch('linux-2.6-e1000-ich9.patch')
        r.addPatch('linux-2.6-e1000e-add-support-for-the-82567LM-4-device.patch')
        r.addPatch('linux-2.6-e1000e-add-support-for-82567LM-3-and-82567LF-3-ICH10D-parts.patch')
        r.addPatch('linux-2.6-e1000e-add-support-for-new-82574L-part.patch')
        r.addPatch('linux-2.6-e1000e-enable-ecc-on-82571.patch')
        r.addPatch('linux-2.6-e1000e-workaround-hw-errata.patch')
        r.addPatch('linux-2.6-netdev-r8169-2.6.28.patch')
        r.addPatch('linux-2.6-eeepc-laptop-update.patch')
        r.addPatch('linux-2.6-toshiba-acpi-update.patch')
        r.addPatch('linux-2.6-toshiba-acpi-close-race.patch')
        r.addPatch('linux-2.6-toshiba-acpi-only-register-rfkill-if-bt-enabled.patch')
        r.addPatch('linux-2.6-netdev-atl2.patch')
        r.addPatch('linux-2.6-net-tulip-interrupt.patch')
        r.addPatch('linux-2.6-net-qla-silence-debug-printks.patch')
        r.addPatch('linux-2.6-kvmclock-unsync-tsc-workaround.patch')
        r.addPatch('linux-2.6-olpc-touchpad.patch')
        r.addPatch('linux-2.6-quieter-mmc.patch')
        r.addPatch('nvidia-agp.patch')
        r.addPatch('drm-next.patch')
        r.addPatch('drm-modesetting-radeon.patch')
        r.addPatch('drm-nouveau.patch')
        r.addPatch('drm-intel-8xx-pae-no-gem.patch')
        r.addPatch('drm-fix-master-enable.patch')
        r.addPatch('drm-radeon-fix-upstream-suspend.patch')
        r.addPatch('drm-edid-revision-0-should-be-valid.patch')
        r.addPatch('linux-2.6-firewire-git-update.patch')
        r.addPatch('linux-2.6-firewire-git-pending.patch')
        r.addPatch('linux-2.6-merge-efifb-imacfb.patch')
        r.addPatch('linux-2.6-dmi-autoload.patch')
        r.addPatch('linux-2.6-piix3-silence-quirk.patch')
        r.addPatch('linux-2.6-quiet-iommu.patch')
        r.addPatch('linux-2.6-silence-acpi-blacklist.patch')
        r.addPatch('linux-2.6-amd64-yes-i-know-you-live.patch')
        r.addPatch('linux-2.6.27-pci-hush-allocation-failures.patch')
        r.addPatch('linux-2.6-pci-fix-pciehp-irq0.patch')
        r.addPatch('linux-2.6-pciehp-kill-annoying-messages.patch')
        r.addPatch('linux-2.6-selinux-empty-tty-files.patch')
        r.addPatch('disable-p4-cpufreq-ui.patch')
        r.addPatch('linux-2.6.27-fix-video_open.patch')

        #VMware support
        # FIXME: find upstream for this
        # see if it matters _outside_ ESX
        # r.addPatch('vmware_mptbase_workaround.patch')
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        r.addArchive('mirror://sourceforge/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(version)s')

        # r.addPatch('0001-superreadahead-patch.patch')

#     def configure(r):
#         if Arch.x86:
#             r.addSource('kernel-foresight-i686.config', dest = 'configs/')
#             r.macros.cfgver = '.smp.gcc4.1.x86.i686'
#             r.Copy('configs/kernel-foresight-i686.config', '.config')
#         elif Arch.x86_64:
#             r.addSource('kernel-foresight-x86_64.config', dest = 'configs/')
#             r.macros.cfgver = '.smp.gcc4.1.x86_64'
#             r.Copy('configs/kernel-foresight-x86_64.config', '.config')

#         r.Make( 'nonint_oldconfig 2>oc.err ||'
#                 ' { diff -u .config.old .config > config.changes;'
#                 '   cat config.changes ;'
#                 '   echo "missing config items:"; cat oc.err ;'
#                 '   exit 1; }')
#         # if we get here, this file is empty, remove it
#         r.Remove('oc.err')


    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmmemctl',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vmxnet3',
                  'drivers/scsi/pvscsi',
                      'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'
            r.Make('HEADER_DIR=%(builddir)s/include', dir=modsrc)
            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))
