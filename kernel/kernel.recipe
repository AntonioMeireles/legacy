#
# Copyright (c) 2005-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadInstalled('open-vm-tools=@fl:2-devel')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.29.1'

    def unpack(r):
        # r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R')

        r.addPatch("linux-2.6-makefile-after_link.patch")
        # r.addPatch("linux-2.6-compile-fixes.patch")
        r.addPatch("git-bluetooth.patch")
        r.addPatch("git-bluetooth2.patch")
        r.addPatch("linux-2.6-hotfixes.patch")
        r.addPatch("linux-2.6-tracehook.patch")
        r.addPatch("linux-2.6-utrace.patch")
        r.addPatch("linux-2.6-utrace-ftrace.patch")
        r.addPatch("linux-2.6-iommu-fixes.patch")
        r.addPatch("linux-2.6-sysrq-c.patch")
        r.addPatch("linux-2.6-e820-mark-esi-clobbered.patch")
        r.addPatch("linux-2.6-e820-save-restore-edi-ebp.patch")
        r.addPatch("linux-2.6-e820-acpi3-bios-workaround.patch")
        r.addPatch("linux-2.6-e820-guard-against-pre-acpi3.patch")
        r.addPatch("linux-2.6-ps3-storage-alias.patch")
        r.addPatch("linux-2.6-g5-therm-shutdown.patch")
        r.addPatch("linux-2.6-vio-modalias.patch")
        r.addPatch("linux-2.6-imac-transparent-bridge.patch")
        r.addPatch("linux-2.6.29-sparc-IOC_TYPECHECK.patch")
        r.addPatch("linux-2.6.29.1-sparc-regression.patch")
        # r.addPatch("linux-2.6-execshield.patch")
        r.addPatch("linux-2.6-ext4-flush-on-close.patch")
        r.addPatch("linux-2.6-ext4-really-print-warning-once.patch")
        r.addPatch("linux-2.6-btrfs-experimental-branch.patch")
        r.addPatch("linux-2.6-btrfs-fix-umount-hang.patch")
        r.addPatch("linux-2.6-relatime-by-default.patch")
        r.addPatch("linux-2.6-fiemap-header-install.patch")
        r.addPatch("linux-2.6-add-qcserial.patch")
        r.addPatch("linux-2.6-usb-cdc-acm-remove-low-latency-flag.patch")
        r.addPatch("linux-2.6-defaults-acpi-video.patch")
        r.addPatch("linux-2.6-acpi-video-dos.patch")
        r.addPatch("linux-2.6-acpi-strict-resources.patch")
        r.addPatch("linux-2.6-hwmon-atk0110.patch")
        r.addPatch("linux-2.6-acpi-video-didl-intel-outputs.patch")
        r.addPatch("linux-2.6-sony-laptop-rfkill.patch")
        r.addPatch("linux-2.6-acer-wmi-bail-on-aao.patch")
        r.addPatch("linux-2.6-debug-sizeof-structs.patch")
        r.addPatch("linux-2.6-debug-nmi-timeout.patch")
        r.addPatch("linux-2.6-debug-taint-vm.patch")
        r.addPatch("linux-2.6-debug-spinlock-taint.patch")
        r.addPatch("linux-2.6-debug-vm-would-have-oomkilled.patch")
        r.addPatch("linux-2.6-debug-always-inline-kzalloc.patch")
        r.addPatch("linux-2.6-defaults-pci_no_msi.patch")
        r.addPatch("linux-2.6-pci-sysfs-remove-id.patch")
        r.addPatch("linux-2.6-scsi-cpqarray-set-master.patch")
        r.addPatch("linux-2.6-defaults-alsa-hda-beep-off.patch")
        r.addPatch("linux-2.6.29-alsa-update-quirks.patch")
        r.addPatch("alsa-rewrite-hw_ptr-updaters.patch")
        r.addPatch("alsa-pcm-always-reset-invalid-position.patch")
        r.addPatch("alsa-pcm-fix-delta-calc-at-overlap.patch")
        r.addPatch("alsa-pcm-safer-boundary-checks.patch")
        r.addPatch("alsa-hda-dont-reset-BDL-unnecessarily.patch")
        r.addPatch("alsa-dont-reset-stream-at-each-prepare-callb.patch")
        r.addPatch("alsa-hda_intel-fix-unexpected-ring-buffer-positio.patch")
        r.addPatch("alsa-pcm-midlevel-add-more-strict-buffer-position.patch")
        r.addPatch("hda_intel-prealloc-4mb-dmabuffer.patch")
        r.addPatch("linux-2.6-input-kill-stupid-messages.patch")
        r.addPatch("linux-2.6-input-fix-toshiba-hotkeys.patch")
        r.addPatch("linux-2.6-input-hid-extra-gamepad.patch")
        r.addPatch("linux-2.6-input-wacom-bluetooth.patch")
        r.addPatch("linux-2.6-serial-460800.patch")
        r.addPatch("linux-2.6-serial-add-txen-test-param.patch")
        r.addPatch("increase-MAX_LOCKDEP_ENTRIES.patch")
        r.addPatch("linux-2.6-silence-noise.patch")
        r.addPatch("linux-2.6-shut-up-efifb.patch")
        r.addPatch("linux-2.6-silence-fbcon-logo.patch")
        r.addPatch("linux-2.6-selinux-mprotect-checks.patch")
        r.addPatch("linux-2.6-sparc-selinux-mprotect-checks.patch")
        r.addPatch("linux-2.6-ata-quirk.patch")
        r.addPatch("linux-2.6-rt2x00-asus-leds.patch")
        r.addPatch("linux-2.6-mac80211-age-scan-results-on-resume.patch")
        r.addPatch("linux-2.6-ipw2x00-age-scan-results-on-resume.patch")
        r.addPatch("linux-2.6-iwl3945-report-killswitch-changes-even-if-the-interface-is-down.patch")
        r.addPatch("linux-2.6-iwlagn-fix-hw-rfkill-while-the-interface-is-down.patch")
        r.addPatch("linux-2.6-mac80211-fix-beacon-loss-detection-after-scan.patch")
        r.addPatch("linux-2.6-dma-debug-fixes.patch")
        r.addPatch("linux-2.6-crash-driver.patch")
        r.addPatch("linux-2.6.29-lirc.patch")
        r.addPatch("linux-2.6-cdrom-door-status.patch")
        r.addPatch("linux-2.6-e1000-ich9.patch")
        r.addPatch("agp-set_memory_ucwb.patch")
        r.addPatch("drm-next.patch")
        r.addPatch("drm-modesetting-radeon.patch")
        r.addPatch("drm-nouveau.patch")
        r.addPatch("drm-no-gem-on-i8xx.patch")
        r.addPatch("drm-i915-resume-force-mode.patch")
        r.addPatch("drm-intel-big-hammer.patch")
        r.addPatch("drm-intel-lying-systems-without-lvds.patch")
        r.addPatch("drm-intel-gen3-fb-hack.patch")
        r.addPatch("drm-intel-tiled-front.patch")
        r.addPatch("drm-intel-hdmi-edid-fix.patch")
        r.addPatch("linux-2.6-firewire-git-update.patch")
        r.addPatch("linux-2.6-silence-acpi-blacklist.patch")
        r.addPatch("linux-2.6-v4l-dvb-fixes.patch")
        r.addPatch("linux-2.6-v4l-dvb-update.patch")
        r.addPatch("linux-2.6-v4l-dvb-experimental.patch")
        r.addPatch("linux-2.6-v4l-dvb-fix-uint16_t-audio-h.patch")
        r.addPatch("linux-2.6-revert-dvb-net-kabi-change.patch")
        r.addPatch("linux-2.6-md-raid1-dont-assume-new-bvecs-are-init.patch")
        r.addPatch("squashfs-broken-when-pagesize-greater-than-blocksize.patch")
        r.addPatch("linux-2.6-mm-define-unique-value-for-as_unevictable.patch")
        r.addPatch("linux-2.6-posix-timers-fix-clock-monotonicity.patch")
        r.addPatch("linux-2.6-posix-timers-fix-rlimit_cpu-fork.patch")
        r.addPatch("linux-2.6-posix-timers-fix-rlimit_cpu-fork-2.patch")
        r.addPatch("linux-2.6-posix-timers-fix-rlimit_cpu-setitimer.patch")
        r.addPatch("revert-fix-modules_install-via-nfs.patch")
        r.addPatch("cpufreq-add-atom-to-p4-clockmod.patch")
        r.addPatch("linux-2.6-dropwatch-protocol.patch")
        r.addPatch("linux-2.6-net-fix-another-gro-bug.patch")
        r.addPatch("linux-2.6-kvm-kconfig-irqchip.patch")
        r.addPatch("linux-2.6-kvm-mask-notifiers.patch")
        r.addPatch("linux-2.6-kvm-reset-pit-irq-on-unmask.patch")
        r.addPatch("linux-2.6-kvm-skip-pit-check.patch")
        r.addPatch("linux-2.6-xen-check-for-nx-support.patch")
        r.addPatch("pat-remove-page-granularity-tracking-for-vm_insert_pfn_maps.patch")

        #VMware support
        # FIXME: find upstream for this
        # see if it matters _outside_ ESX
        # r.addPatch('vmware_mptbase_workaround.patch')
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        r.addArchive('mirror://sourceforge/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(version)s')

        # r.addPatch('0001-superreadahead-patch.patch')

    def configure(r):
        if Arch.x86:
            r.addSource('kernel-foresight-i686.config', dest = 'configs/')
            r.macros.cfgver = '.smp.gcc4.1.x86.i686'
            r.Copy('configs/kernel-foresight-i686.config', '.config')
        elif Arch.x86_64:
            r.addSource('kernel-foresight-x86_64.config', dest = 'configs/')
            r.macros.cfgver = '.smp.gcc4.1.x86_64'
            r.Copy('configs/kernel-foresight-x86_64.config', '.config')

        r.Make( 'nonint_oldconfig 2>oc.err ||'
                ' { diff -u .config.old .config > config.changes;'
                '   cat config.changes ;'
                '   echo "missing config items:"; cat oc.err ;'
                '   exit 1; }')
        # if we get here, this file is empty, remove it
        r.Remove('oc.err')


    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmmemctl',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vmxnet3',
                  'drivers/net/vsock',
                  'drivers/scsi/pvscsi',
                  'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'
            r.Make('CC_OPTS=-DVMW_HAVE_EPOLL HEADER_DIR=%(builddir)s/include', dir=modsrc)
            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))
