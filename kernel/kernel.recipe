#
# Copyright (c) 2005-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.29.6'

    def unpack(r):
        # VMware support
        r.addPatch('vmware_mptbase_workaround.patch')
        r.macros.ovmtoolsver = '2009.07.22-179896'
        r.buildvmmodules = not Use.xen
        r.addArchive('mirror://sourceforge/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(archive_version)s',
                     use=r.buildvmmodules)
        # Security updates
        r.addPatch('CVE-2009-1895.patch')
        r.addPatch('no-delete-null-pointer-checks.patch')
        r.addPatch('CVE-2009-2962.patch')

    def build(r):
        # Build VMware kernel modules
        if r.buildvmmodules:
            r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
            for m in ('drivers/misc/vmci',
                      'drivers/misc/vmmemctl',
                      'drivers/misc/vmsync',
                      'drivers/net/vmxnet',
                      'drivers/net/vmxnet3',
                      'drivers/scsi/pvscsi',
                      'fs/vmblock',
                      'fs/vmhgfs'):
                module = os.path.basename(m)
                modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'
                r.Run('make -C %(builddir)s SUBDIRS=$PWD SRCROOT=$PWD/.'
                      ' MODULEBUILDDIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s/modules/linux'
                      ' OVT_SOURCE_DIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s',
                      ' VM_KBUILD=26'
                      ' modules',
                      dir=modsrc)
                kmod = module + '.ko'
                r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod,
                          package=':vmware')
