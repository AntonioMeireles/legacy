#
# Copyright (c) 2005-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadSuperClass('kernelpackage=@fl:2-devel-kernel')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.28.1'

    def unpack(r):
        # r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R')

        r.addPatch('linux-2.6-makefile-after_link.patch'),
        r.addPatch('linux-2.6-compile-fixes.patch'),
        r.addPatch('linux-2.6-hotfixes.patch'),
        r.addPatch('linux-2.6-utrace.patch'),
        r.addPatch('linux-2.6-sysrq-c.patch'),
        r.addPatch('linux-2.6-x86-mtrr-kill-bogus-warning.patch'),
        r.addPatch('linux-2.6-ps3-storage-alias.patch'),
        r.addPatch('linux-2.6-g5-therm-shutdown.patch'),
        r.addPatch('linux-2.6-vio-modalias.patch'),
        r.addPatch('linux-2.6-imac-transparent-bridge.patch'),
        r.addPatch('linux-2.6-execshield.patch'),
        r.addPatch('linux-2.6-squashfs.patch'),
        r.addPatch('linux-2.6-defaults-acpi-video.patch'),
        r.addPatch('linux-2.6-acpi-video-dos.patch'),
        r.addPatch('linux-2.6-debug-sizeof-structs.patch'),
        r.addPatch('linux-2.6-debug-nmi-timeout.patch'),
        r.addPatch('linux-2.6-debug-taint-vm.patch'),
        r.addPatch('linux-2.6-debug-spinlock-taint.patch'),
        r.addPatch('linux-2.6-debug-vm-would-have-oomkilled.patch'),
        r.addPatch('linux-2.6-debug-always-inline-kzalloc.patch'),
        r.addPatch('linux-2.6-crash-driver.patch'),
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch'),
        r.addPatch('linux-2.6-pciehp-update.patch'),
        r.addPatch('linux-2.6-defaults-pciehp.patch'),
        r.addPatch('linux-2.6-scsi-cpqarray-set-master.patch'),
        r.addPatch('linux-2.6-net-silence-noisy-printks.patch'),
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch'),
        r.addPatch('linux-2.6-serial-460800.patch'),
        r.addPatch('linux-2.6-silence-noise.patch'),
        r.addPatch('linux-2.6-silence-fbcon-logo.patch'),
        r.addPatch('linux-2.6-selinux-mprotect-checks.patch'),
        r.addPatch('linux-2.6-sparc-selinux-mprotect-checks.patch'),
        r.addPatch('linux-2.6-selinux-move-open-perms-check.patch'),
        r.addPatch('linux-2.6-defaults-alsa-hda-beep-off.patch'),
        r.addPatch('linux-2.6-ata-quirk.patch'),
        r.addPatch('iwlwifi-intel-bug-1822.patch'),
        r.addPatch('linux-2.6-rtl8187b-tx-status-feedback.patch'),
        r.addPatch('linux-2.6-rt2x00-asus-leds.patch'),
        r.addPatch('linux-2.6-at76.patch'),
        r.addPatch('linux-2.6-gspca-git.patch'),
        r.addPatch('linux-2.6-gspca-stv06xx-git.patch'),
        r.addPatch('linux-2.6.27-lirc.patch'),
        r.addPatch('linux-2.6-hdpvr.patch'),
        r.addPatch('linux-2.6-cdrom-door-status.patch'),
        r.addPatch('linux-2.6-e1000-ich9.patch'),
        r.addPatch('linux-2.6-netdev-atl2.patch'),
        r.addPatch('linux-2.6-net-tulip-interrupt.patch'),
        r.addPatch('linux-2.6-net-sctp-avoid-memory-overflow-while-FWD-TSN-chunk-is-r.patch'),
        r.addPatch('linux-2.6-olpc-speaker-out.patch'),
        r.addPatch('linux-2.6-serial.patch'),
        r.addPatch('drm-modesetting-radeon.patch'),
        r.addPatch('drm-nouveau.patch'),
        # r.addPatch('linux-2.6-firewire-git-pending.patch'),
        r.addPatch('linux-2.6-piix3-silence-quirk.patch'),
        r.addPatch('linux-2.6-silence-acpi-blacklist.patch'),
        r.addPatch('linux-2.6.27-pci-hush-allocation-failures.patch'),
        r.addPatch('disable-p4-cpufreq-ui.patch'),

        # r.addPatch('linux-2.6-open-vm-tools.patch')

        r.addPatch('0001-superreadahead-patch.patch')

    def configure(r):
        # r.extraSource(addConfigs(r))
        # very cheap hack
        r.macros.cfgver = '.smp.gcc4.1.'
        r.MakeDirs('configs/')
        if Arch.x86:
            r.addSource('kernel-%(version)s-i686.config', dest = 'configs/')
            r.macros.cfgver += 'x86.i686'
            r.Copy('configs/kernel-%(version)s-i686.config', '.config')
        elif Arch.x86_64:
            r.addSource('kernel-%(version)s-x86_64.config', dest = 'configs/')
            r.macros.cfgver += 'x86_64'
            r.Copy('configs/kernel-%(version)s-x86_64.config', '.config')

        r.Make('nonint_oldconfig 2>oc.err ||'
                      ' { cat oc.err; diff -u .config.old .config > config.changes;'
               '   echo "missing config items:"; cat config.changes ;'
               '   exit 1; }')
        # if we get here, this file is empty, remove it
        r.Remove('oc.err')

    def build(r):
        r.Remove('/lib/firmware', recursive=True)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))


