#
# Copyright (c) 2005-2009 rPath, Inc.
#               2008-2010 Foresight Linux Project
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadInstalled('open-vm-tools')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.33.6'

    def addNonInteractiveConfig(r):

        # avoid requests for interactive response
        r.addPatch('linux-2.6-build-nonintconfig.patch')

    def unpack(r):        
	# r.addPatch('git-linus.diff') 
        r.addPatch('linux-2.6-makefile-after_link.patch') 
        # r.addPatch('linux-2.6-compile-fixes.patch') 
        r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R') 
        r.addPatch('git-bluetooth.patch')
        # r.addPatch('linux-2.6-hotfixes.patch') 

        r.addPatch('linux-2.6-tracehook.patch')
        r.addPatch('linux-2.6-utrace.patch')
        r.addPatch('linux-2.6-utrace-ptrace.patch')
        r.addPatch('linux-2.6-dell-laptop-rfkill-fix.patch')
        r.addPatch('linux-2.6-x86-cfi_sections.patch')
        r.addPatch('linux-2.6-g5-therm-shutdown.patch')
        r.addPatch('linux-2.6-vio-modalias.patch')
        r.addPatch('linux-2.6.29-sparc-IOC_TYPECHECK.patch')
        # r.addPatch('linux-2.6-execshield.patch')
        r.addPatch('linux-2.6-btrfs-update.patch')
        r.addPatch('btrfs-prohibit-a-operation-of-changing-acls-mask-when-noacl-mount-option-is-used.patch')
        r.addPatch('linux-2.6-nfs4-callback-hidden.patch')
        r.addPatch('linux-2.6-cpufreq-locking.patch')
        r.addPatch('linux-2.6-driver-level-usb-autosuspend.diff')
        r.addPatch('linux-2.6-enable-btusb-autosuspend.patch')
        r.addPatch('linux-2.6-usb-uvc-autosuspend.diff')
        r.addPatch('linux-2.6-usb-wwan-update.patch')
        r.addPatch('linux-2.6-defaults-acpi-video.patch')
        r.addPatch('linux-2.6-acpi-video-dos.patch')
        r.addPatch('linux-2.6-acpi-video-export-edid.patch')
        r.addPatch('acpi-ec-add-delay-before-write.patch')
        r.addPatch('linux-2.6-debug-sizeof-structs.patch')
        r.addPatch('linux-2.6-debug-nmi-timeout.patch')
        r.addPatch('linux-2.6-debug-taint-vm.patch')
        r.addPatch('linux-2.6-debug-vm-would-have-oomkilled.patch')
        r.addPatch('linux-2.6-debug-always-inline-kzalloc.patch')
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch')
        r.addPatch('linux-2.6-defaults-aspm.patch')
        r.addPatch('linux-2.6-acpi-sleep-live-sci-live.patch')
        r.addPatch('linux-2.6-acpi-indirect_fan_control.patch')
        r.addPatch('hda_intel-prealloc-4mb-dmabuffer.patch')
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch')
        r.addPatch('die-floppy-die.patch')
        r.addPatch('linux-2.6.30-no-pcspkr-modalias.patch')
        r.addPatch('linux-2.6-input-hid-quirk-egalax.patch')
        r.addPatch('linux-2.6-input-clickpad-support.patch')
        r.addPatch('thinkpad-acpi-add-x100e.patch')
        r.addPatch('thinkpad-acpi-fix-backlight.patch')
        r.addPatch('ntrig-backport.patch')
        r.addPatch('linux-2.6-serial-460800.patch')
        r.addPatch('linux-2.6-silence-noise.patch')
        r.addPatch('linux-2.6.30-hush-rom-warning.patch')
        r.addPatch('linux-2.6-silence-fbcon-logo.patch')
        r.addPatch('linux-2.6-selinux-avtab-size.patch')
        r.addPatch('linux-2.6-ata-quirk.patch')
        r.addPatch('linux-2.6-crash-driver.patch')
        r.addPatch('lirc-2.6.33.patch')
        r.addPatch('hdpvr-ir-enable.patch')
        r.addPatch('crystalhd-2.6.34-staging.patch')
        r.addPatch('vhost_net-rollup.patch')
        r.addPatch('virt_console-rollup.patch')
        r.addPatch('virt_console-fix-race.patch')
        r.addPatch('virt_console-fix-fix-race.patch')
        r.addPatch('virt_console-rollup2.patch')
        r.addPatch('vhost_net-rollup2.patch')
        r.addPatch('fix_xen_guest_on_old_EC2.patch')
        r.addPatch('linux-2.6-x86-64-fbdev-primary.patch')
        r.addPatch('drm-core-next.patch')
        r.addPatch('drm-1024x768-85.patch')
        r.addPatch('drm-radeon-evergreen.patch')
        r.addPatch('drm-radeon-firemv-pciid.patch')
        r.addPatch('drm-radeon-kms-fix-dual-link-dvi.patch')
        r.addPatch('drm-radeon-fix-rs600-tlb.patch')
        r.addPatch('drm-radeon-ss-fix.patch')
        r.addPatch('drm-radeon-fix-shared-ddc-handling.patch')
        r.addPatch('drm-nouveau-abi16.patch')
        r.addPatch('drm-nouveau-updates.patch')
        r.addPatch('drm-nouveau-acpi-edid-fallback.patch')
        r.addPatch('drm-nouveau-drm-fixed-header.patch')
        r.addPatch('drm-intel-big-hammer.patch')
        r.addPatch('drm-intel-next.patch')
        r.addPatch('drm-intel-make-lvds-work.patch')
        r.addPatch('linux-2.6-intel-iommu-igfx.patch')
        r.addPatch('drm-intel-gen5-dither.patch')
        r.addPatch('drm-intel-sdvo-fix.patch')
        r.addPatch('drm-intel-sdvo-fix-2.patch')
        r.addPatch('drm-i915-use-pipe_control-instruction-on-ironlake-and-sandy-bridge.patch')
        r.addPatch('drm-i915-fix-non-ironlake-965-class-crashes.patch')
        r.addPatch('drm-i915-fix-edp-panels.patch')
        r.addPatch('drm-i915-fix-hibernate-memory-corruption.patch')
        r.addPatch('drm-i915-add-reclaimable-to-page-allocations.patch')
        r.addPatch('drm-i915-make-G4X-style-PLL-search-more-permissive.patch')
        r.addPatch('drm-intel-945gm-stability-fixes.patch')
        r.addPatch('linux-2.6-phylib-autoload.patch')
        r.addPatch('linux-2.6-silence-acpi-blacklist.patch')
        r.addPatch('linux-2.6-v4l-dvb-fixes.patch')
        r.addPatch('linux-2.6-v4l-dvb-update.patch')
        r.addPatch('linux-2.6-v4l-dvb-experimental.patch')
        r.addPatch('linux-2.6-v4l-dvb-rebase-gspca-to-latest.patch')
        r.addPatch('linux-2.6-v4l-dvb-gspca-fixes.patch')
        r.addPatch('linux-2.6-v4l-dvb-add-lgdt3304-support.patch')
        r.addPatch('linux-2.6-v4l-dvb-add-kworld-a340-support.patch')
        r.addPatch('linux-2.6-rfkill-all.patch')
        r.addPatch('add-appleir-driver.patch')
        r.addPatch('neuter_intel_microcode_load.patch')
        r.addPatch('linux-2.6-umh-refactor.patch')
        r.addPatch('alsa-usbmixer-add-possibility-to-remap-dB-values.patch')
        r.addPatch('ssb_check_for_sprom.patch')
        r.addPatch('linux-2.6-p54pci.patch')
        r.addPatch('iwlwifi_-add-function-to-reset_tune-radio-if-needed.patch')
        r.addPatch('iwlwifi_-Logic-to-control-how-frequent-radio-should-be-reset-if-needed.patch')
        r.addPatch('iwlwifi_-Tune-radio-to-prevent-unexpected-behavior.patch')
        r.addPatch('iwlwifi_-multiple-force-reset-mode.patch')
        r.addPatch('iwlwifi_-Adjusting-PLCP-error-threshold-for-1000-NIC.patch')
        r.addPatch('iwlwifi_-separated-time-check-for-different-type-of-force-reset.patch')
        r.addPatch('iwlwifi_-add-internal-short-scan-support-for-3945.patch')
        r.addPatch('iwlwifi_-Recover-TX-flow-stall-due-to-stuck-queue.patch')
        r.addPatch('iwlwifi_-move-plcp-check-to-separated-function.patch')
        r.addPatch('iwlwifi_-Recover-TX-flow-failure.patch')
        r.addPatch('iwlwifi_-code-cleanup-for-connectivity-recovery.patch')
        r.addPatch('iwlwifi_-iwl_good_ack_health-only-apply-to-AGN-device.patch')
        r.addPatch('ext4-issue-discard-operation-before-releasing-blocks.patch')
        r.addPatch('ibmvscsi-fix-DMA-API-misuse.patch')
        r.addPatch('disable-i8042-check-on-apple-mac.patch')
        r.addPatch('crypto-aesni-kill-module_alias.patch')
        r.addPatch('perf-mount-debugfs-automatically.patch')
        r.addPatch('iwlwifi-fix-scan-races.patch')
        r.addPatch('iwlwifi-fix-internal-scan-race.patch')
        r.addPatch('iwlwifi-recover_from_tx_stall.patch')
        r.addPatch('mac80211-explicitly-disable-enable-QoS.patch')
        r.addPatch('iwlwifi-manage-QoS-by-mac-stack.patch')
        r.addPatch('mac80211-do-not-wipe-out-old-supported-rates.patch')
        r.addPatch('mac80211-fix-supported-rates-IE-if-AP-doesnt-give-us-its-rates.patch')
        r.addPatch('rt2x00-rt2800-Make-rt30xx-and-rt35xx-chipsets-configurable.patch')
        r.addPatch('iwlwifi-cancel-scan-watchdog-in-iwl_bg_abort_scan.patch')
        r.addPatch('sched-fix-over-scheduling-bug.patch')
        r.addPatch('ethtool-fix-buffer-overflow.patch')
        r.addPatch('x86-debug-clear-reserved-bits-of-dr6.patch')
        r.addPatch('x86-debug-send-sigtrap-for-user-icebp.patch')
        r.addPatch('cifs-fix-malicious-redirect-problem-in-the-dns-lookup-code.patch')
        r.addPatch('inotify-fix-inotify-oneshot-support.patch')
        r.addPatch('inotify-send-IN_UNMOUNT-events.patch')
        r.addPatch('kvm-mmu-fix-conflict-access-permissions-in-direct-sp.patch')

        #VMware support
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        # sf mirror network unreliable:/ 
        #r.addArchive('mirror://sourceforge/open-vm-tools/'
        r.addArchive('http://downloads.sourceforge.net/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(version)s')

        # Add the cp437 version of the terminus font to the kernel and 
        # keep a backup of the original font for comparison purposes. 
        # -- /ermo
        r.addSource('terminus_font_8x16.c', dest = 'drivers/video/console/')
        r.Copy('drivers/video/console/font_8x16.c', 'drivers/video/console/font_8x16.c.org')
        # Comment out the line below to keep original VGA font.
        r.Copy('drivers/video/console/terminus_font_8x16.c', 'drivers/video/console/font_8x16.c')

    def configure(r):
        r.addSource('kernel-foresight-i686.config', dest = 'configs/', use=Arch.x86)
        r.addSource('kernel-foresight-x86_64.config', dest = 'configs/', use=Arch.x86_64)
            
        if Arch.x86:
            r.macros.cfgver = '.smp.gcc4.1.x86.i686'
            r.Copy('configs/kernel-foresight-i686.config', '.config')
        elif Arch.x86_64:
            r.macros.cfgver = '.smp.gcc4.1.x86_64'
            r.Copy('configs/kernel-foresight-x86_64.config', '.config')

        r.Make( 'nonint_oldconfig 2>oc.err ||'
                ' { diff -u .config.old .config > config.changes;'
                '   cat config.changes ;'
                '   echo "missing config items:"; cat oc.err ;'
                '   exit 1; }')
        # if we get here, this file is empty, remove it
        r.Remove('oc.err')


    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmmemctl',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vsock',
                  'drivers/scsi/pvscsi',
                  'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'

            r.Run('make -C %(builddir)s SUBDIRS=$PWD SRCROOT=$PWD/.'
                  ' MODULEBUILDDIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s/modules/linux'
                  ' OVT_SOURCE_DIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s',
                  ' VM_KBUILD=26'
                  ' modules',
                  dir=modsrc)

            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))

        # rm cruft
        r.Remove('/lib/modules/%(kver)s/source/open-vm-tools-%(ovmtoolsver)s/', recursive = True)

        # upstream *.3{2,3}.xx doesn't seem to ship all radeon firmware blobs
        # that our libdrm/Xorg can handle
        # solve that
        r.addArchive('2.6.32.xx_missingRadeonFirmware.tgz', dir = '/lib/firmware/radeon/')
