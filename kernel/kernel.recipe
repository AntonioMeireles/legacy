#
# Copyright (c) 2005-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadInstalled('open-vm-tools=@fl:2-devel')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.29.4'

    def unpack(r):
        r.addPatch("linux-2.6-makefile-after_link.patch")
        r.addPatch("linux-2.6-hotfixes.patch")
        r.addPatch("linux-2.6-tracehook.patch")
        r.addPatch("linux-2.6-utrace.patch")
        r.addPatch("linux-2.6-utrace-ftrace.patch")
        r.addPatch("linux-2.6-iommu-fixes.patch")
        r.addPatch("linux-2.6-sysrq-c.patch")
        r.addPatch("linux-2.6-defaults-saner-vm-settings.patch")
        r.addPatch("linux-2.6-mm-lru-evict-streaming-io-pages-first.patch")
        r.addPatch("linux-2.6-mm-lru-report-vm-flags-in-page-referenced.patch")
        r.addPatch("linux-2.6-mm-lru-dont-evict-mapped-executable-pages.patch")
        r.addPatch("linux-2.6-ps3-storage-alias.patch")
        r.addPatch("linux-2.6-g5-therm-shutdown.patch")
        r.addPatch("linux-2.6-vio-modalias.patch")
        r.addPatch("linux-2.6-imac-transparent-bridge.patch")
        # r.addPatch("linux-2.6-execshield.patch")
        r.addPatch("fs-relatime-add-strictatime-option.patch")
        r.addPatch("fs-relatime-update-once-per-day.patch")
        r.addPatch("linux-2.6-kjournald-use-rt-io-priority.patch")
        r.addPatch("linux-2.6-ext4-flush-on-close.patch")
        r.addPatch("linux-2.6-ext4-really-print-warning-once.patch")
        r.addPatch("linux-2.6-ext4-prealloc-fixes.patch")
        r.addPatch("linux-2.6-ext4-fake-delalloc-bno.patch")
        r.addPatch("linux-2.6-ext4-clear-unwritten-flag.patch")
        r.addPatch("linux-2.6-ext4-fix-i_cached_extent-race.patch")
        r.addPatch("linux-2.6-btrfs-unstable-update.patch")
        r.addPatch("linux-2.6-usb-cdc-acm-remove-low-latency-flag.patch")
        r.addPatch("linux-2.6-defaults-acpi-video.patch")
        r.addPatch("linux-2.6-acpi-video-dos.patch")
        r.addPatch("linux-2.6-debug-sizeof-structs.patch")
        r.addPatch("linux-2.6-debug-nmi-timeout.patch")
        r.addPatch("linux-2.6-debug-taint-vm.patch")
        r.addPatch("linux-2.6-debug-spinlock-taint.patch")
        r.addPatch("linux-2.6-debug-vm-would-have-oomkilled.patch")
        r.addPatch("linux-2.6-debug-always-inline-kzalloc.patch")
        r.addPatch("linux-2.6-crash-driver.patch")
        r.addPatch("linux-2.6-defaults-pci_no_msi.patch")
        r.addPatch("linux-2.6-defaults-fat-utf8.patch")
        r.addPatch("linux-2.6-scsi-cpqarray-set-master.patch")
        r.addPatch("alsa-rewrite-hw_ptr-updaters.patch")
        r.addPatch("alsa-pcm-always-reset-invalid-position.patch")
        r.addPatch("alsa-pcm-fix-delta-calc-at-overlap.patch")
        r.addPatch("alsa-pcm-safer-boundary-checks.patch")
        r.addPatch("alsa-hda-dont-reset-BDL-unnecessarily.patch")
        r.addPatch("alsa-dont-reset-stream-at-each-prepare-callb.patch")
        r.addPatch("alsa-hda_intel-fix-unexpected-ring-buffer-positio.patch")
        r.addPatch("alsa-hda_intel-prealloc-4mb-dmabuffer.patch")
        r.addPatch("alsa-add-subdevice_mask-to-quirk-entries.patch")
        r.addPatch("alsa-hda-update-quirks.patch")
        r.addPatch("alsa-hda-hp-tx25xx-quirk.patch")
        r.addPatch("net-revert-forcedeth-power-down-phy-when-interface-is.patch")
        r.addPatch("linux-2.6-input-kill-stupid-messages.patch")
        r.addPatch("linux-2.6-serial-460800.patch")
        r.addPatch("linux-2.6-silence-noise.patch")
        r.addPatch("linux-2.6-silence-fbcon-logo.patch")
        r.addPatch("linux-2.6-selinux-mprotect-checks.patch")
        r.addPatch("linux-2.6-sparc-selinux-mprotect-checks.patch")
        r.addPatch("linux-2.6-defaults-alsa-hda-beep-off.patch")
        r.addPatch("linux-2.6-ata-quirk.patch")
        r.addPatch("linux-2.6-rt2x00-asus-leds.patch")
        r.addPatch("linux-2.6-mac80211-age-scan-results-on-resume.patch")
        r.addPatch("linux-2.6-ipw2x00-age-scan-results-on-resume.patch")
        r.addPatch("linux-2.6-iwl3945-report-killswitch-changes-even-if-the-interface-is-down.patch")
        r.addPatch("linux-2.6-iwlagn-fix-hw-rfkill-while-the-interface-is-down.patch")
        r.addPatch("linux-2.6-iwl3945-use-cancel_delayed_work_sync-to-cancel-rfkill_poll.patch")
        r.addPatch("linux-2.6-mac80211-fix-beacon-loss-detection-after-scan.patch")
        r.addPatch("mac80211-don-t-drop-nullfunc-frames-during-software.patch")
        r.addPatch("linux-2.6.29-lirc.patch")
        r.addPatch("linux-2.6-hdpvr.patch")
        r.addPatch("linux-2.6-cdrom-door-status.patch")
        r.addPatch("linux-2.6-e1000-ich9.patch")
        r.addPatch("drm-next.patch")
        r.addPatch("drm-modesetting-radeon.patch")
        r.addPatch("drm-modesetting-radeon-fixes.patch")
        r.addPatch("drm-nouveau.patch")
        r.addPatch("drm-no-gem-on-i8xx.patch")
        r.addPatch("drm-f10-compat.patch")
        r.addPatch("drm-backport-f11-fixes-1.patch")
        r.addPatch("drm-edid-ignore-tiny-modes.patch")
        r.addPatch("drm-copyback-ioctl-data-to-userspace-regardless-of-retcode.patch")
        r.addPatch("drm-intel-big-hammer.patch")
        r.addPatch("drm-intel-lying-systems-without-lvds.patch")
        r.addPatch("drm-intel-gen3-fb-hack.patch")
        r.addPatch("drm-intel-tiling-transition.patch")
        r.addPatch("drm-intel-include-965gme-pci-id.patch")
        r.addPatch("drm-intel-gem-use-dma32-on-pae.patch")
        r.addPatch("drm-intel-i8xx-cursors.patch")
        r.addPatch("linux-2.6-firewire-git-update.patch")
        r.addPatch("linux-2.6-silence-acpi-blacklist.patch")
        r.addPatch("squashfs3.patch")
        r.addPatch("squashfs-fixups.patch")
        r.addPatch("linux-2.6-v4l-dvb-fix-uint16_t-audio-h.patch")
        r.addPatch("revert-fix-modules_install-via-nfs.patch")
        r.addPatch("linux-2.6-dropwatch-protocol.patch")
        r.addPatch("linux-2.6-kvm-skip-pit-check.patch")
        r.addPatch("linux-2.6-xen-check-for-nx-support.patch")
        r.addPatch("linux-2.6-crypto-aes-padlock-fix-autoload.patch")
        r.addPatch("linux-2.6-crypto-aes-padlock-fix-autoload-2.patch")
        r.addPatch("linux-2.6-x86-hpet-provide-separate-start-stop-fns.patch")
        r.addPatch("linux-2.6-x86-hpet-stop-counter-when-programming.patch")
        r.addPatch("linux-2.6-x86-hpet-fix-periodic-mode-on-amd-81xx.patch")
        r.addPatch("linux-2.6-bluetooth-submit-bulk-urbs-with-interrupt-urbs.patch")
        r.addPatch("linux-2.6-ftrace-memory-reduction.patch")


        #VMware support
        # FIXME: find upstream for this
        # see if it matters _outside_ ESX
        # r.addPatch('vmware_mptbase_workaround.patch')
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        r.addArchive('mirror://sourceforge/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(version)s')

        # r.addPatch('0001-superreadahead-patch.patch')

    def configure(r):
        if Arch.x86:
            r.addSource('kernel-foresight-i686.config', dest = 'configs/')
            r.macros.cfgver = '.smp.gcc4.1.x86.i686'
            r.Copy('configs/kernel-foresight-i686.config', '.config')
        elif Arch.x86_64:
            r.addSource('kernel-foresight-x86_64.config', dest = 'configs/')
            r.macros.cfgver = '.smp.gcc4.1.x86_64'
            r.Copy('configs/kernel-foresight-x86_64.config', '.config')

        r.Make( 'nonint_oldconfig 2>oc.err ||'
                ' { diff -u .config.old .config > config.changes;'
                '   cat config.changes ;'
                '   echo "missing config items:"; cat oc.err ;'
                '   exit 1; }')
        # if we get here, this file is empty, remove it
        r.Remove('oc.err')


    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmmemctl',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vmxnet3',
                  'drivers/net/vsock',
                  'drivers/scsi/pvscsi',
                  'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'
            r.Make('CC_OPTS=-DVMW_HAVE_EPOLL HEADER_DIR=%(builddir)s/include', dir=modsrc)
            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))
