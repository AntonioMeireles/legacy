#
# Copyright (c) 2005-2009 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
loadInstalled('open-vm-tools=@fl:2-devel')
loadSuperClass('kernelpackage')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.30.6'

    def unpack(r):
        r.addPatch('linux-2.6-makefile-after_link.patch') 
        r.addPatch('linux-2.6-hotfixes.patch') 
        r.addPatch('linux-2.6-tracehook.patch') 
        r.addPatch('linux-2.6-utrace.patch') 
        r.addPatch('linux-2.6-utrace-ftrace.patch') 
        r.addPatch('linux-2.6-defaults-saner-vm-settings.patch') 
        r.addPatch('linux-2.6-mm-lru-evict-streaming-io-pages-first.patch') 
        r.addPatch('linux-2.6-mm-lru-report-vm-flags-in-page-referenced.patch') 
        r.addPatch('linux-2.6-mm-lru-dont-evict-mapped-executable-pages.patch') 
        r.addPatch('linux-2.6-sysrq-c.patch') 
        r.addPatch('linux-2.6-cpufreq-enable-acpi-pstates-on-via.patch') 
        r.addPatch('via-hwmon-temp-sensor.patch') 
        r.addPatch('via-padlock-10-enable-64bit.patch') 
        r.addPatch('via-padlock-20-add-x86-dependency.patch') 
        r.addPatch('via-padlock-30-fix-might-sleep.patch') 
        r.addPatch('via-padlock-40-nano-ecb.patch') 
        r.addPatch('via-padlock-50-nano-cbc.patch') 
        r.addPatch('via-rng-enable-64bit.patch') 
        r.addPatch('via-sdmmc.patch') 
        r.addPatch('linux-2.6-x86-delay-tsc-barrier.patch') 
        r.addPatch('linux-2.6-xfrm-export-gc_thresh.patch') 
        r.addPatch('linux-2.6-ps3-storage-alias.patch') 
        r.addPatch('linux-2.6-g5-therm-shutdown.patch') 
        r.addPatch('linux-2.6-vio-modalias.patch') 
        r.addPatch('linux-2.6-imac-transparent-bridge.patch') 
        r.addPatch('linux-2.6-ppc64-vs-broadcom.patch') 
        r.addPatch('linux-2.6-ppc64-vs-broadcom-lmb-no-init-1.patch') 
        r.addPatch('linux-2.6-ppc64-vs-broadcom-lmb-no-init-2.patch') 
        r.addPatch('linux-2.6.29-sparc-IOC_TYPECHECK.patch') 
        r.addPatch('linux-2.6-execshield.patch') 
        r.addPatch('linux-2.6-fs-cifs-fix-port-numbers.patch') 
        r.addPatch('linux-2.6-defaults-acpi-video.patch') 
        r.addPatch('linux-2.6-acpi-video-dos.patch') 
        r.addPatch('linux-2.6-debug-sizeof-structs.patch') 
        r.addPatch('linux-2.6-debug-nmi-timeout.patch') 
        r.addPatch('linux-2.6-debug-taint-vm.patch') 
        r.addPatch('linux-2.6-debug-spinlock-taint.patch') 
        r.addPatch('linux-2.6-debug-vm-would-have-oomkilled.patch') 
        r.addPatch('linux-2.6-debug-always-inline-kzalloc.patch') 
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch') 
        r.addPatch('linux-2.6-defaults-alsa-hda-beep-off.patch') 
        r.addPatch('hda_intel-prealloc-4mb-dmabuffer.patch') 
        r.addPatch('linux-2.6-missing-rfc2465-stats.patch') 
        r.addPatch('linux-2.6-neigh_-fix-state-transition-INCOMPLETE-_FAILED-via-Netlink-request.patch') 
        r.addPatch('linux-2.6-e1000-ich9.patch') 
        r.addPatch('linux-2.6-xen-fix-brkpoints-hw-watchpoints.patch') 
        r.addPatch('linux-2.6-xen-clean-up-warnings.patch') 
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch') 
        r.addPatch('linux-2.6-defaults-die-floppy-die.patch') 
        r.addPatch('linux-2.6-input-fix-toshiba-hotkeys.patch') 
        r.addPatch('linux-2.6-input-wacom-bluetooth.patch') 
        r.addPatch('linux-2.6-serial-460800.patch') 
        r.addPatch('linux-2.6-drivers-char-low-latency-removal.patch') 
        r.addPatch('linux-2.6-serial-add-txen-test-param.patch') 
        r.addPatch('linux-2.6-silence-noise.patch') 
        r.addPatch('linux-2.6-silence-fbcon-logo.patch') 
        r.addPatch('linux-2.6-selinux-mprotect-checks.patch') 
        r.addPatch('linux-2.6-ata-quirk.patch') 
        r.addPatch('linux-2.6-iwlwifi_-fix-TX-queue-race.patch') 
        r.addPatch('linux-2.6-zd1211rw_-adding-083a_e503-as-a-ZD1211B-device.patch') 
        r.addPatch('linux-2.6-crash-driver.patch') 
        r.addPatch('lirc-2.6.31.patch') 
        r.addPatch('hid-ignore-all-recent-imon-devices.patch') 
        r.addPatch('hdpvr-ir-enable.patch') 
        r.addPatch('lirc-revert-2.6.31-i2c-changes.patch') 
        r.addPatch('agp-set_memory_ucwb.patch') 
        r.addPatch('drm-modesetting-radeon.patch') 
        r.addPatch('drm-nouveau.patch') 
        r.addPatch('drm-no-gem-on-i8xx.patch') 
        r.addPatch('drm-i915-resume-force-mode.patch') 
        r.addPatch('drm-intel-big-hammer.patch') 
        r.addPatch('drm-intel-gen3-fb-hack.patch') 
        r.addPatch('drm-intel-hdmi-edid-fix.patch') 
        r.addPatch('drm-modesetting-radeon-fixes.patch') 
        r.addPatch('drm-radeon-new-pciids.patch') 
        r.addPatch('drm-dont-frob-i2c.patch') 
        r.addPatch('drm-radeon-cs-oops-fix.patch') 
        r.addPatch('drm-pnp-add-resource-range-checker.patch') 
        r.addPatch('drm-i915-enable-mchbar.patch') 
        r.addPatch('linux-2.6-silence-acpi-blacklist.patch') 
        r.addPatch('v4l-dvb-fix-cx25840-firmware-load.patch') 
        r.addPatch('linux-2.6-kvm-skip-pit-check.patch') 
        r.addPatch('linux-2.6.29-xen-disable-gbpages.patch') 
        r.addPatch('linux-2.6-virtio_blk-dont-bounce-highmem-requests.patch') 
        r.addPatch('make-mmap_min_addr-suck-less.patch') 
        r.addPatch('hda-check-strcpy-length.patch') 
        r.addPatch('linux-2.6-v4l-dvb-af9015-fix-stack-corruption.patch') 
        r.addPatch('linux-2.6-x86-load-percpu-segment-no-stackprotector.patch') 
        r.addPatch('linux-2.6-xen-rearrange-to-fix-stackprotector.patch') 
        r.addPatch('linux-2.6-slub-fix-destroy-by-rcu.patch') 
		
        #VMware support
        # FIXME: find upstream for this
        # see if it matters _outside_ ESX
        # r.addPatch('vmware_mptbase_workaround.patch')
        r.macros.ovmtoolsver = OpenVmTools.version.replace('_', '-')
        r.addArchive('mirror://sourceforge/open-vm-tools/'
                     'open-vm-tools-%(ovmtoolsver)s.tar.gz',
                     dir='linux-%(version)s')

        # r.addPatch('0001-superreadahead-patch.patch')

    def configure(r):
        if Arch.x86:
            r.addSource('kernel-foresight-i686.config', dest = 'configs/')
            r.macros.cfgver = '.smp.gcc4.1.x86.i686'
            r.Copy('configs/kernel-foresight-i686.config', '.config')
        elif Arch.x86_64:
            r.addSource('kernel-foresight-x86_64.config', dest = 'configs/')
            r.macros.cfgver = '.smp.gcc4.1.x86_64'
            r.Copy('configs/kernel-foresight-x86_64.config', '.config')

        r.Make( 'nonint_oldconfig 2>oc.err ||'
                ' { diff -u .config.old .config > config.changes;'
                '   cat config.changes ;'
                '   echo "missing config items:"; cat oc.err ;'
                '   exit 1; }')
        # if we get here, this file is empty, remove it
        r.Remove('oc.err')


    def buildAtaModuleMap(r):
        pass

    def build(r):
        # Build VMware kernel modules
        r.macros.kmoddir = '/lib/modules/%(kver)s/kernel/'
        for m in ('drivers/misc/vmci',
                  'drivers/misc/vmmemctl',
                  'drivers/misc/vmsync',
                  'drivers/net/vmxnet',
                  'drivers/net/vmxnet3',
                  'drivers/net/vsock',
                  'drivers/scsi/pvscsi',
                  'fs/vmblock',
                  'fs/vmhgfs'):
            module = os.path.basename(m)
            modsrc = 'open-vm-tools-%(ovmtoolsver)s/modules/linux/' + module + '/'

            r.Run('make -C %(builddir)s SUBDIRS=$PWD SRCROOT=$PWD/.'
                  ' MODULEBUILDDIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s/modules/linux'
                  ' OVT_SOURCE_DIR=%(builddir)s/open-vm-tools-%(ovmtoolsver)s',
                  ' VM_KBUILD=26'
                  ' modules',
                  dir=modsrc)

            kmod = module + '.ko'
            r.Install(modsrc + kmod, '%(kmoddir)s' + m + '/' + kmod)

    def policy(r):
        # we don't want spurious deps on py24 in :build-tree as it will create odd
        # chroots when building external kmods with consequent assorted breackage
        r.macros.pyver = Python.majversion
        pybin = '%(bindir)s/python%(pyver)s'
        r.NormalizePythonInterpreterVersion(versionMap=(
                ('%(bindir)s/python2.4', pybin),
                ('%(bindir)s/python2.5', pybin),
                ('%(bindir)s/python', pybin),
                ))
