#
# Copyright (c) 2005-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('kernelpackage.recipe')
class Kernel(KernelPackageRecipe):

    name = 'kernel'
    version = '2.6.26.3'

    def unpack(r):
        r.addPatch('linux-2.6-upstream-reverts.patch', extraArgs='-R')
        r.addPatch('linux-2.6-sysrq-c.patch')
        r.addPatch('linux-2.6-x86-tune-generic.patch')
        r.addPatch('linux-2.6-x86-64-fix-overlap-of-modules-and-fixmap-areas.patch')
        r.addPatch('linux-2.6-x86-fdiv-bug-detection-fix.patch')
        r.addPatch('linux-2.6-x86-io-delay-add-hp-f700-quirk.patch')
        r.addPatch('linux-2.6-x86-fix-oprofile-and-hibernation-issues.patch')
        r.addPatch('linux-2.6-x86-32-amd-c1e-force-timer-broadcast-late.patch')
        r.addPatch('linux-2.6-x86-pat-proper-tracking-of-set_memory_uc.patch')
        r.addPatch('linux-2.6-usb-ehci-hcd-respect-nousb.patch')
        r.addPatch('linux-2.6-acpi-processor-use-signed-int.patch')
        r.addPatch('linux-2.6-cpuidle-1-do-not-use-poll_idle-unless-user-asks-for-it.patch')
        r.addPatch('linux-2.6-cpuidle-2-menu-governor-fix-wrong-usage-of-measured_us.patch')
        r.addPatch('linux-2.6-cpuidle-3-make-ladder-governor-honor-latency-requirements.patch')
        r.addPatch('linux-2.6-mm-dirty-page-tracking-race-fix.patch')
        r.addPatch('linux-2.6-crash-driver.patch')
        r.addPatch('linux-2.6-defaults-pci_no_msi.patch')
        r.addPatch('linux-2.6-scsi-cpqarray-set-master.patch')
        r.addPatch('linux-2.6-bio-fix-__bio_copy_iov-handling-of-bv_len.patch')
        r.addPatch('linux-2.6-bio-fix-bio_copy_kern-handling-of-bv_len.patch')
        r.addPatch('linux-2.6-block-submit_bh-discards-barrier-flag.patch')
        r.addPatch('linux-2.6-fs-cifs-turn-off-unicode-during-session-establishment.patch')
        r.addPatch('linux-2.6-squashfs.patch')
        r.addPatch('linux-2.6-net-silence-noisy-printks.patch')
        r.addPatch('linux-2.6-input-kill-stupid-messages.patch')
        r.addPatch('linux-2.6-input-fix_fn_key_on_macbookpro_4_1_and_mb_air.patch')
        r.addPatch('linux-2.6-hwmon-applesmc-remove-debugging-messages.patch')
        r.addPatch('linux-2.6-serial-460800.patch')
        r.addPatch('linux-2.6-silence-noise.patch')
        r.addPatch('linux-2.6-defaults-fat-utf8.patch')
        r.addPatch('linux-2.6-ata-quirk.patch')
        r.addPatch('linux-2.6-libata-pata_it821x-driver-updates-and-reworking.patch')
        r.addPatch('linux-2.6-sata-eeepc-faster.patch')
        r.addPatch('linux-2.6-wireless-pending.patch')
        r.addPatch('linux-2.6-wireless-stable-backports.patch')
        r.addPatch('linux-2.6-at76.patch')
        r.addPatch('linux-2.6-rt2500usb-fix.patch')
        r.addPatch('linux-2.6-smarter-relatime.patch')
        r.addPatch('linux-2.6-nfs-client-mounts-hang.patch')
        r.addPatch('linux-2.6-default-mmf_dump_elf_headers.patch')
        r.addPatch('linux-2.6-lirc.patch')
        r.addPatch('linux-2.6-e1000-ich9.patch')
        r.addPatch('linux-2.6-netdev-atl2.patch')
        r.addPatch('linux-2.6-netdev-atl1e.patch')
        r.addPatch('linux-2.6-netdev-atl1-disable-tso-by-default.patch')
        r.addPatch('linux-2.6-net-tulip-interrupt.patch')
        r.addPatch('drm-fedora9-rollup.patch')
        r.addPatch('linux-2.6-firewire-git-update.patch')
        r.addPatch('linux-2.6-merge-efifb-imacfb.patch')
        r.addPatch('linux-2.6.22-rndis_host-wm5.patch')
        # r.addPatch('linux-2.6-alsa-ice17xx_update.patch')
        r.addPatch('ftp://download.filesystems.org/pub/unionfs/unionfs-2.x/unionfs-2.4_for_2.6.26.diff.gz')
        r.addPatch('linux-2.6-open-vm-tools.patch')
        # r.addPatch('linux-2.6-export_flush_tlb_page.patch')

    def build(r):
        r.Run('for i in $(find %(destdir)s | grep drivers\/ata); '
              'do if [ $(nm $i |grep --count ata_pci_remove_one) -ne 0 ]; '
              'then basename `echo $i` ;fi ; done | grep -v sata | '
              'grep -v pdc_adma | sort >> modules.libata')
        r.Install('modules.libata', '/lib/modules/%(kver)s/modules.libata')
