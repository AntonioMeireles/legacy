#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#


class Dhcp(CPackageRecipe):
    buildRequires = [ 'groff:runtime' ]

    name = 'dhcp'
    version = '3.0.3'
    
    def setup(r):
	srpm = 'http://download.fedora.redhat.com/pub/fedora/linux/core/5/source/SRPMS/dhcp-3.0.3-26.src.rpm'

        r.addArchive('dhcp-%(version)s.tar.gz', rpm=srpm)

        r.addSource('dhcpd.conf.sample')
        r.addSource('dhcpd.init')
        r.addSource('dhcpd.sysconfig')
        r.addSource('dhcrelay.init')
        r.addSource('dhcrelay.sysconfig')
        r.addSource('dhcpd.leases')
        r.addSource('site.conf', macros=True)
        r.addSource('site.h', macros=True,
                    apply='cat site.h >> includes/site.h; rm site.h')
        r.addSource('findptrsize.c')

       
        r.addPatch('dhcp-3.0-jbuild.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc13-dhcpctlman.patch', rpm=srpm)
        r.addPatch('dhcp-3.0pl1-miscfixes.patch', rpm=srpm)
        r.addPatch('dhcp-3.0pl1-minires.patch', rpm=srpm)
        r.addPatch('dhcpd-manpage.patch', rpm=srpm)
        r.addPatch('dhcp-3.0pl2-selinux.patch', rpm=srpm)
        r.addPatch('dhcp-3.0pl2-initialize.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc12-RHscript.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc12-staticroutes.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc12-pie.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc12-inherit-leases.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc13-noexpr.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1rc14-noconfig.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-change_resolv_conf.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-default_gateway.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-restrict-unconfigured-IF.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-check-empty-new-routers.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-fix-ntp.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-release-mode-ifup.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-dhclient-script-big-fix.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2rc3-dhclient_routes.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-z-relro-now.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2rc3-dhclient-restorecon.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.1-dhclient-config.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-pid_file_excl.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-dhclient-no-restorecon-or-route.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-extended_option_environment.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-dhclient-no_isc_blurb.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-dhclient-script-restorecon.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-dhclient-script-dhcdbd.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-dhclient-script-fix-init-state-1.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.2-dhclient-script-dbus-fix-interface.patch', rpm=srpm)
 
        r.Replace('/var/spool/mail', '%(servicedir)s/spool/mail',
                  'includes/cf/linux.h')
        r.Replace('\/bin\/dbus-send', '%(bindir)s/dbus-send', 'client/scripts/linux')

        r.Make('findptrsize')
        r.ManualConfigure('--copts "%(cflags)s -DEXTENDED_NEW_OPTION_INFO'
            ' $([ $(./findptrsize) -ge 8 ] && echo -DPTRSIZE_64BIT)"')
        r.Make()
        r.MakeInstall()
        r.Install('dhcpd.init', '%(initdir)s/dhcpd', mode=0755)
        r.Install('dhcpd.leases', '%(localstatedir)s/lib/dhcp/')
        r.Install('dhcpd.sysconfig', '%(sysconfdir)s/sysconfig/dhcpd')
        r.Install('dhcrelay.init', '%(initdir)s/dhcrelay', mode=0755)
        r.Install('dhcrelay.sysconfig', '%(sysconfdir)s/sysconfig/dhcrelay')

        r.Run('mv client/dhclient.conf client/dhclient.conf.sample')
        r.Doc('client/dhclient.conf.sample', component='dhclient:')
        r.AutoDoc('RELNOTES')
        r.Doc('dhcpd.conf.sample')

        r.SetModes('%(essentialsbindir)s/dhclient-script', 0755)
        r.Requires('initscripts:runtime', '/sbin/dhclient-script')

        r.PackageSpec('dhclient', '%(localstatedir)s/lib/dhcp',
            '%(essentialsbindir)s/dhclient.*',
            '%(mandir)s/man.*/dhclient.*',
            '%(mandir)s/man5/dhcp-options.5.*')
        r.TagSpec('initscript', '%(initdir)s/')

        r.ExcludeDirectories(exceptions='/var/(lib|run)/dhcp')

