#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#


class Dhcp(CPackageRecipe):
    buildRequires = [ 'groff:runtime' ]

    name = 'dhcp'
    version = '3.0.4'
    
    def setup(r):
	srpm = 'http://download.fedora.redhat.com/pub/fedora/linux/core/development/source/SRPMS/dhcp-3.0.4-19.fc6.src.rpm'


	r.addArchive(srpm)
        r.addArchive('dhcp-%(version)s.tar.gz', rpm=srpm)

        r.addSource('dhcpd.conf.sample')
        r.addSource('dhcpd.init')
        r.addSource('dhcpd.sysconfig')
        r.addSource('dhcrelay.init')
        r.addSource('dhcrelay.sysconfig')
        r.addSource('dhcpd.leases')
        r.addSource('site.conf', macros=True)
        r.addSource('site.h', macros=True,
                    apply='cat site.h >> includes/site.h; rm site.h')
        r.addSource('findptrsize.c')


	patches = [
		'dhcp-3.0-alignment.patch',
	
		'dhcp-3.0-jbuild.patch', 
		'dhcp-3.0.1rc13-dhcpctlman.patch',
		'dhcp-3.0pl1-miscfixes.patch',
		'dhcp-3.0pl1-minires.patch',
		'dhcpd-manpage.patch',
		'dhcp-3.0pl2-selinux.patch',
		'dhcp-3.0pl2-initialize.patch',
		'dhcp-3.0.1rc12-RHscript.patch',
		'dhcp-3.0.1rc12-staticroutes.patch',
		'dhcp-3.0.1rc12-pie.patch',
		'dhcp-3.0.1rc12-inherit-leases.patch',
		'dhcp-3.0.1rc13-noexpr.patch',
		'dhcp-3.0.1rc14-noconfig.patch',
		'dhcp-3.0.1-change_resolv_conf.patch',
		'dhcp-3.0.1-default_gateway.patch',

		'dhcp-3.0.1-check-empty-new-routers.patch',
		'dhcp-3.0.1-fix-ntp.patch',
		'dhcp-3.0.1-release-mode-ifup.patch',
		'dhcp-3.0.1-dhclient-script-big-fix.patch',

		'dhcp-3.0.2rc3-dhclient_routes.patch',
		'dhcp-3.0.1-z-relro-now.patch',
		'dhcp-3.0.2rc3-dhclient-restorecon.patch',
		'dhcp-3.0.1-dhclient-config.patch',
		'dhcp-3.0.2-pid_file_excl.patch',
		'dhcp-3.0.2-dhclient-no-restorecon-or-route.patch',
		'dhcp-3.0.2-extended_option_environment.patch',
		'dhcp-3.0.2-dhclient-no_isc_blurb.patch',
		'dhcp-3.0.2-dhclient-script-restorecon.patch',
		'dhcp-3.0.2-dhclient-script-dhcdbd.patch',
		'dhcp-3.0.2-dhclient-script-fix-init-state-1.patch',
		'dhcp-3.0.2-dhclient-script-dbus-fix-interface.patch',
		'dhcp-3.0.2-dhclient_nodelay.patch',
		'dhcp-3.0.2-dhclient_decline_backoff.patch',

		'dhcp-3.0.2-dhclient_script_fast+arping.patch',

		'dhcp-3.0.3-fast_dhclient.patch',
		'dhcp-3.0.3-dhclient-script-ypbind-hup-ok.patch',

		'dhcp-3.0.4-version.patch',
		'dhcp-3.0.3-dhclient-script-up-down-hooks.patch',
		'dhcp-3.0.3-bz167273.patch',
		'dhcp-3.0.3-failover_ports.patch',

		'dhcp-3.0.3-static-routes.patch',
		'dhcp-3.0.3-dhclient_script_route_metrics.patch',
		'dhcp-3.0.3-dhclient-script-bz171312.patch',
		'dhcp-3.0.3-bz167028-ibm-unicast-bootp.patch',
		
		'dhcp-3.0.3-bz173619.patch',
		'dhcp-3.0.4-gcc4_warnings.patch',
		'dhcp-3.0.3-bz176270.patch',
		
		'dhcp-3.0.3-bz177845.patch',
		'dhcp-3.0.3-bz181482.patch',
		'dhcp-3.0.4-dhcient_ibmzSeries_broadcast.patch',
		'dhcp-3.0.4-dhclient_ibmzSeries_-I_option.patch',
		'dhcp-3.0.4-H_host-name_-F_fqdn_-T_timeout_options.patch',
		'dhcp-3.0.4-bz191470.patch',
		'dhcp-3.0.4-dhclient-R_option.patch',
		'dhcp-3.0.4-dhclient-script-METRIC.patch',
		'dhcp-3.0.4-dhclient-script-ntp-fudge-bz191461.patch',
		'dhcp-3.0.4-bz202911.patch',
		
		'dhcp-3.0.4-lib-makefile.patch',
		]

	for patch in patches:
	    r.addPatch(patch, rpm = srpm)
       
 
        r.Replace('/var/spool/mail', '%(servicedir)s/spool/mail',
                  'includes/cf/linux.h')

        r.Make('findptrsize')
        r.ManualConfigure('--copts "%(cflags)s -DEXTENDED_NEW_OPTION_INFO'
            ' $([ $(./findptrsize) -ge 8 ] && echo -DPTRSIZE_64BIT)"')
        r.Make()
        r.MakeInstall()
        r.Install('dhcpd.init', '%(initdir)s/dhcpd', mode=0755)
        r.Install('dhcpd.leases', '%(localstatedir)s/lib/dhcp/')
        r.Install('dhcpd.sysconfig', '%(sysconfdir)s/sysconfig/dhcpd')
        r.Install('dhcrelay.init', '%(initdir)s/dhcrelay', mode=0755)
        r.Install('dhcrelay.sysconfig', '%(sysconfdir)s/sysconfig/dhcrelay')

        r.Run('mv client/dhclient.conf client/dhclient.conf.sample')
        r.Doc('client/dhclient.conf.sample', component='dhclient:')
        r.AutoDoc('RELNOTES')
        r.Doc('dhcpd.conf.sample')

        r.SetModes('%(essentialsbindir)s/dhclient-script', 0755)
        r.Requires('initscripts:runtime', '/sbin/dhclient-script')

	r.MakeDirs('%(localstatedir)s/lib/dhclient') 
        r.PackageSpec('dhclient', '%(localstatedir)s/lib/dhcp', '%(localstatedir)s/lib/dhclient',
            '%(essentialsbindir)s/dhclient.*',
            '%(mandir)s/man.*/dhclient.*',
            '%(mandir)s/man5/dhcp-options.5.*')
        r.TagSpec('initscript', '%(initdir)s/')

        r.ExcludeDirectories(exceptions='/var/(lib|run)/dhcp')
        r.ExcludeDirectories(exceptions='/var/(lib|run)/dhclient')


