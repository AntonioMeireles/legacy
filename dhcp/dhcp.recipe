#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#


class Dhcp(CPackageRecipe):
    buildRequires = [ 'groff:runtime' ]

    name = 'dhcp'
    version = '3.0.5'
    
    def setup(r):
        srpm = 'ftp://download.fedora.redhat.com/pub/fedora/linux/releases/7/Fedora/source/SRPMS/dhcp-3.0.5-35.fc7.src.rpm'

        r.addArchive('dhcp-%(version)s.tar.gz', rpm=srpm)

        r.addSource('linux.dbus-example', rpm=srpm, dest='client/scripts/linux')
        r.addSource('Makefile.dist', rpm=srpm, dest='libdhcp4client')
        r.addSource('dhcpd.conf.sample')
        r.addSource('dhcpd.init')
        r.addSource('dhcpd.sysconfig')
        r.addSource('dhcrelay.init')
        r.addSource('dhcrelay.sysconfig')
        r.addSource('dhcpd.leases')
        r.addSource('site.conf', macros=True)
        r.addSource('site.h', macros=True,
                    apply='cat site.h >> includes/site.h; rm site.h')
        r.addSource('findptrsize.c')

        r.addPatch('dhcp-3.0.5-version.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-Makefile.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-warnings.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-extended-new-option-info.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-errwarn-message.patch', rpm=srpm)
        # We don't care for ldap and the patch doesn't apply :)
        #r.addPatch('dhcp-3.0.5-ldap-configuration.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-memory.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-options.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-release-by-ifup.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-dhclient-decline-backoff.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-enable-timeout-functions.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-inherit-leases.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-selinux.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-unicast-bootp.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-fast-timeout.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-failover-ports.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-dhclient-usage.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-default-requested-options.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-prototypes.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-manpages.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-libdhcp4client.patch', rpm=srpm)
        r.addPatch('dhcp-3.0.5-xen-checksum.patch', rpm=srpm)

        r.Replace('/var/spool/mail', '%(servicedir)s/spool/mail',
                  'includes/cf/linux.h')
        r.Replace('\/bin\/dbus-send', '%(bindir)s/dbus-send', 'client/scripts/linux')

        r.Make('findptrsize')
        r.ManualConfigure('--copts "%(cflags)s -DEXTENDED_NEW_OPTION_INFO'
            ' $([ $(./findptrsize) -ge 8 ] && echo -DPTRSIZE_64BIT)"')
        r.Replace('libdhcp4client', '', 'work.linux-2.2/Makefile')
        r.Make()
        r.MakeInstall()
        r.Install('dhcpd.init', '%(initdir)s/dhcpd', mode=0755)
        r.Install('dhcpd.leases', '%(localstatedir)s/lib/dhcp/')
        r.Install('dhcpd.sysconfig', '%(sysconfdir)s/sysconfig/dhcpd')
        r.Install('dhcrelay.init', '%(initdir)s/dhcrelay', mode=0755)
        r.Install('dhcrelay.sysconfig', '%(sysconfdir)s/sysconfig/dhcrelay')

        r.Run('mv client/dhclient.conf client/dhclient.conf.sample')
        r.Doc('client/dhclient.conf.sample', component='dhclient:')
        r.AutoDoc('RELNOTES')
        r.Doc('dhcpd.conf.sample')

        r.SetModes('%(essentialsbindir)s/dhclient-script', 0755)
        r.Requires('initscripts:runtime', '/sbin/dhclient-script')

        r.MakeDirs('%(localstatedir)s/lib/dhclient')
        r.PackageSpec('dhclient', '%(localstatedir)s/lib/dhcp',
            '%(localstatedir)s/lib/dhclient',
            '%(essentialsbindir)s/dhclient.*',
            '%(mandir)s/man.*/dhclient.*',
            '%(mandir)s/man5/dhcp-options.5.*')
        r.TagSpec('initscript', '%(initdir)s/')

        r.ExcludeDirectories(exceptions='/var/(lib|run)/(dhcp|dhclient)')
