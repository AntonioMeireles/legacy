#
# Copyright (c) 2004-2006 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Dump(CPackageRecipe):
    name = 'dump'
    version = '0.4b41'

    buildRequires = [ 'libtermcap:devel', 'e2fsprogs:devel', 'readline:devel',
        'zlib:devel', ]

    def setup(r):
        r.addArchive('mirror://sourceforge/dump/')

        r.Configure(
            '--enable-largefile --with-manmode=0644'
            ' --with-dumpdates="%(sysconfdir)s/dumpdates"'
            ' --enable-readline --enable-static --enable-rmt --enable-qfa'
        )
        r.Make('OPT="%(cflags)s"')
        r.MakeInstall(
            'SBINDIR=%(destdir)s/%(essentialsbindir)s'
            ' BINDIR=%(destdir)s/%(essentialsbindir)s'
            ' MANDIR=%(destdir)s/%(mandir)s/man8'
            ' BINOWNER=$(id -un) BINGRP=$(id -gn)'
            ' MANOWNER=$(id -un) MANGRP=$(id -gn)'
        )
        r.Run('touch dumpdates')
        r.Symlink('dump', '%(essentialsbindir)s/dump.static')
        r.Symlink('dump', '%(essentialsbindir)s/rdump')
        r.Symlink('dump', '%(essentialsbindir)s/rdump.static')
        r.Symlink('restore', '%(essentialsbindir)s/restore.static')
        r.Symlink('restore', '%(essentialsbindir)s/rrestore')
        r.Symlink('restore', '%(essentialsbindir)s/rrestore.static')
        r.Install('dumpdates', '%(sysconfdir)s/', mode=0664)
        r.Symlink('%(essentialsbindir)s/rmt', '%(sysconfdir)s/rmt')
        r.AutoDoc('KNOWNBUGS', 'MAINTAINERS', 'REPORTING-BUGS', 'dump.lsm',
                  'examples/.*')

        r.SetModes('%(essentialsbindir)s/rmt', 0755)
        r.Ownership('root', 'disk', '%(sysconfdir)s/dumpdates')

        r.PackageSpec('rmt',
            '%(essentialsbindir)s/rmt',
            '%(sysconfdir)s/rmt',
            '%(mandir)s/man8/rmt.*'
        )
