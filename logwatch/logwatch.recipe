#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html

class Logwatch(CPackageRecipe):
    name = 'logwatch'
    version = '7.3.4'
    buildRequires = [ 'perl-DateManip:perl', 'perl:lib', 'perl:runtime', ]

    def setup(r):
        r.addArchive('ftp://ftp.kaybee.org/pub/linux/')

        r.Replace('^my \$BaseDir = .*$',
                  'my $BaseDir = "%(sysconfdir)s/log.d";',
                  'scripts/logwatch.pl')

        r.MakeDirs('%(sysconfdir)s/log.d/lib',
                   '%(sysconfdir)s/log.d/conf/logfiles',
                   '%(sysconfdir)s/log.d/conf/services',
                   '%(sysconfdir)s/log.d/scripts/services',
                   '%(sysconfdir)s/log.d/scripts/shared')

        for dir in ('cron', 'samba', 'up2date', 'xferlog'):
            r.Install('scripts/logfiles/%s/*' % dir,
                      '%%(sysconfdir)s/log.d/scripts/logfiles/%s/' % dir,
                      mode=0755)

        r.Install('scripts/logwatch.pl',
                  '%(sysconfdir)s/log.d/scripts/',
                  mode=0755)
        r.Install('scripts/services/*',
                  '%(sysconfdir)s/log.d/scripts/services/',
                  mode=0755)
        r.Install('scripts/shared/*',
                  '%(sysconfdir)s/log.d/scripts/shared/',
                  mode=00755)
        r.Install('conf/logwatch.conf',
                  '%(sysconfdir)s/log.d/conf/logwatch.conf',
                  mode=0644)
        r.Install('conf/ignore.conf',
                  '%(sysconfdir)s/log.d/conf/ignore.conf',
                  mode=0644)
        r.Install('conf/logfiles/*',
                  '%(sysconfdir)s/log.d/conf/logfiles/',
                  mode=0644)
        r.Install('conf/services/*',
                  '%(sysconfdir)s/log.d/conf/services/',
                  mode=0644)
        r.Install('lib/Logwatch.pm',
                  '%(sysconfdir)s/log.d/lib/Logwatch.pm',
                  mode=0644)
        r.Install('logwatch.8', '%(mandir)s/man8/', mode=0644)
        r.Remove('%(sysconfdir)s/log.d/logwatch{,.conf}',
            '%(sysconfdir)s/cron.daily/00-logwatch',
            '%(sbindir)s/logwatch',
            '%(sysconfdir)s/log.d/scripts/services/zz-fortune*',
            '%(sysconfdir)s/log.d/conf/services/{fortune,zz-fortune}*')
        r.Symlink('conf/logwatch.conf',
                  '%(sysconfdir)s/log.d/logwatch.conf')
        r.Symlink('scripts/logwatch.pl',
                  '%(sysconfdir)s/log.d/logwatch')
        r.Symlink('%(sysconfdir)s/log.d/scripts/logwatch.pl',
                  '%(sysconfdir)s/cron.daily/00-logwatch')
        r.Symlink('%(sysconfdir)s/log.d/scripts/logwatch.pl',
                  '%(sbindir)s/logwatch')
        r.Symlink('%(sysconfdir)s/log.d', '%(sysconfdir)s/logwatch')
        r.Requires('crontabs:runtime', '/etc/cron.daily/.*')
        r.MakeDirs('%(cachedir)s/%(name)s')
        r.ExcludeDirectories(exceptions='%(cachedir)s/%(name)s')
