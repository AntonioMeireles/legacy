#
# Copyright (c) 2005-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

loadSuperClass('xorgpackage')
class XorgServer(XorgPackageRecipe):
    name = 'xorg-server'
    version = '1.3.0.0'
    component = 'xserver'

    # FIXME: ld dies trying to link xorgcfg without libXext, need to make sure
    # configure checks for it
    # perl:lib needed to satisfy "perl: File::Glob" for /usr/bin/getconfig.pl
    buildRequires = [ 'bison:runtime', 'flex:runtime', 'freetype:devel',
        'espgs:runtime', 'libICE:devel', 'libSM:devel', 'libXaw:devel',
        'libXext:devel', 'libXfixes:devel', 'libXfont:devel', 'libXmu:devel',
        'libXpm:devel', 'libXt:devel', 'libXxf86misc:devel', 'libXxf86vm:devel',
        'libfontenc:devel', 'liblbxutil:devellib', 'libxkbfile:devel',
        'libxkbui:devel', 'ncurses:devel', 'perl:lib', 'perl:runtime',
        'xorg-sgml-doctools:data', 'xtrans:devel', 'zlib:devel',
        # begin dri
        'Mesa:devel', 'glproto:devel', 'libdrm:devel', 'xf86driproto:devel',
        # end dri, begin dmx
        'libXi:devel', 'libXrender:devel', 'libXres:devel', 'libXtst:devellib',
        'libdmx:devel',
        # end dmx
        ]

    protoBuildRequires = [ 'bigreqsproto:devel', 'compositeproto:devel',
        'damageproto:devel', 'evieext:devel',  'fixesproto:devel',
        'fontsproto:devel', 'inputproto:devel', 'randrproto:devel',
        'recordproto:devel', 'renderproto:devel', 'resourceproto:devel',
        'scrnsaverproto:devel', 'trapproto:devel', 'videoproto:devel',
        'xcmiscproto:devel', 'xextproto:devel', 'xf86bigfontproto:devel',
        'xf86dgaproto:devel', 'xf86miscproto:devel', 'xf86vidmodeproto:devel',
        'xineramaproto:devel', 'xproto:devel' ]

    buildRequires.extend(protoBuildRequires)

    def unpack(r):

        r.macros.cflags += ' -fPIC'
        srpm = 'http://download.fedora.redhat.com/pub/fedora/linux/core/development/source/SRPMS/xorg-x11-server-1.2.99.905-5.fc7.src.rpm'
        r.macros.osname = "'Foresight Linux'"
        r.macros.vendor = "'Ant√≥nio Meireles aka doniphon'"

        r.extraConfig += ' --with-os-name=%(osname)s --with-vendor=%(vendor)s --enable-install-libxf86config'

        # Fonts
        r.extraConfig += (' --with-fontdir=%(datadir)s/X11/fonts'
                          ' --with-default-font-path=unix/:7100,built-ins')

        # Move xkb config to %(localstatedir)s so that X isn't trying to write
        # to /usr on startup and /usr is not writable in anaconda.
        r.extraConfig += ' --with-xkb-output=%(localstatedir)s/lib/xkb'

        XorgPackageRecipe.unpack(r)

        r.addSource('xserver.pamd',
                    dest='%(sysconfdir)s/pam.d/xserver', mode=00644)

        # according to http://xorg.freedesktop.org/wiki/ModularDevelopersGuide
        # we need the Mesa source to build GLX support
        r.macros.mesaVersion = '6.5.2'
        r.addArchive('mirror://sourceforge/mesa3d/MesaLib-%(mesaVersion)s.tar.bz2')

        rpmPatches = [
            # general bug fixes
            'xorg-x11-server-0.99.3-init-origins-fix.patch',
            'xorg-x11-server-libxf86config-dont-write-empty-sections.patch',
            'xorg-x11-server-1.1.1-builderstring.patch',
            'xorg-x11-server-1.1.1-xkb-in-xnest.patch',
            'xorg-x11-server-1.1.1-vbe-filter-less.patch',
            'xorg-x11-server-1.1.1-vt-activate-is-a-terrible-api.patch',
            'xorg-x11-server-1.1.1-graphics-expose.patch',
            'xorg-x11-server-1.1.1-automake-1.10-fixes.patch',
            'xorg-x11-server-1.1.1-glcore-visual-matching.patch',
            'xserver-1.3.0-xnest-exposures.patch',
            'xserver-1.3.0-x86emu-imul-int64.patch',
            # OpenGL compositing manager feature/optimization patches.
            'xorg-x11-server-1.1.0-no-move-damage.patch',
            'xorg-x11-server-1.1.0-dont-backfill-bg-none.patch',
            'xorg-x11-server-1.2.0-enable-composite.patch',
            'xorg-x11-server-1.1.1-no-composite-in-xnest.patch',
            'xorg-x11-server-1.1.1-offscreen-pixmaps.patch',
            'xserver-1.3.0-no-pseudocolor-composite.patch',
            # Red Hat specific tweaking, not intended for upstream
            # XXX move these to the end of the list
            'xorg-x11-server-Red-Hat-extramodes.patch',
            'xorg-x11-server-1.2.0-xephyr-only.patch',
            'xorg-x11-server-1.0.1-fpic-libxf86config.patch',
            'xorg-x11-server-1.1.1-builtin-fonts.patch',
            'xorg-x11-server-1.1.1-no-scanpci.patch',
            'xorg-x11-server-1.1.1-spurious-libxf1bpp-link.patch',
            'xorg-x11-server-1.2.0-xf86config-comment-less.patch',
            'xorg-x11-server-1.2.0-maxpixclock-option.patch',
            'xserver-1.2.0-geode-mmx.patch',
            'xserver-1.2.0-xephyr-keysym-madness.patch',
            'xserver-1.2.0-vfprintf.patch',
            'xserver-1.2.0-honor-displaysize.patch',
            'xserver-1.2.99.901-xephyr-crash-at-exit.patch',
            # assorted PCI layer shenanigans.  oh the pain.
            'xorg-x11-server-1.2.99-unbreak-domain.patch',
            'xserver-1.3.0-pci-bus-count.patch',
            'xserver-1.3.0-mmap-failure-check.patch',
            'xserver-1.3.0-rom-search.patch',
            'xserver-1.3.0-domain-obiwan.patch',
            'xserver-1.3.0-pci-device-enable.patch',]

        for p in rpmPatches:
            r.addPatch(p, rpm=srpm)

        # DRI
        r.extraConfig += ( ' --enable-dri'
                           ' --enable-glx-tls'
                           ' --with-mesa-source=%(builddir)s/../Mesa-%(mesaVersion)s'
                           ' --with-dri-driver-path=%(libdir)s/dri'
                           ' --enable-composite'
                           ' --enable-xtrap'
                           ' --enable-xcsecurity'
                           ' --enable-xevie')

    def policy(r):
        r.SetModes('%(bindir)s/Xorg', 04611)

        # FIXME: copied from xorg-x11 recipe; is this for consolehelper?
        r.Create('%(sysconfdir)s/security/console.apps/xserver')

        # make xorg.conf an InitialContents file so it's managed locally, but
        # removed when xorg-server is
        r.Create('%(sysconfdir)s/X11/xorg.conf')
        r.InitialContents('%(sysconfdir)s/X11/xorg.conf')

        # Install the vesamodes and extramodes files to let our install/config tools
        # be able to parse the same modelist as the X server uses (rhpxl).
        r.Install('hw/xfree86/common/vesamodes','%(datadir)s/xorg/vesamodes')
        r.Install('hw/xfree86/common/extramodes','%(datadir)s/xorg/extramodes')

        # contrary to ATI, only nVidia messes with files from xorg-server
        if Use.nvidia:
            r.Remove('%(libdir)s/xorg/modules/extensions/libglx.*')
