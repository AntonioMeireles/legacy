loadSuperClass('gnomepackage')
loadRecipe('ppp') # for proper pppd_plugin_dir
class NetworkManager(GnomePackageRecipe):

    name = "NetworkManager"
    version = '0.8.2'

    buildRequires = [
        'GConf:devel',
        'chkconfig:runtime',
        'dbus-glib:devellib',
        'dbus-glib:runtime',
        'dbus:devel',
        'desktop-file-utils:runtime',
        'e2fsprogs:devel',
        'gnome-keyring:devel',
        'hal:devel',
        'iproute:runtime',
        'iptables:runtime',
        'libgcrypt:devel',
        'libglade:devel',
        'libgpg-error:devel',
        'libnl:devel',
        'libnotify:devel',
        'nspr:devel',
        'nss:devel',
        'pango:devel',
        'polkit:devel',
        'polkit:runtime',
        'popt:devel',
        'ppp:devel',
        'udev:devel',
        'udev:lib',
        'util-linux:devel',
        'util-macros:devel',
        'wireless-tools:devel',
        ]

    extraConfig = (
        ' --disable-static'
        ' --with-distro=redhat'
        ' --with-dhclient=yes'
        ' --with-dhcpcd=no'
        ' --with-crypto=nss'
        ' --enable-more-warnings=no'
        ' --with-pppd-plugin-dir=%(libdir)s/pppd/' + Ppp.version
        )

    patches = [
        # include config.h for isblank()
        'fix-build.patch',
        # from fedora
        'explain-dns1-dns2.patch',
        ]

    def policy(r):
        r.addSource('NetworkManager.conf')

        # create a VPN directory
        r.MakeDirs('%(sysconfdir)s/NetworkManager/VPN')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/NetworkManager/VPN')

        # create a keyfile plugin system settings directory
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/%(name)s/system-connections')

        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/%(name)s')
 
        # not sure if these are needed
        r.MakeDirs('%(sysconfdir)s/NetworkManager/dispatcher.d')
        r.MakeDirs('%(datadir)s/gnome-vpn-properties')
        r.MakeDirs('%(localstatedir)s/lib/NetworkManager')

        r.Requires('libnl:lib', '%(sbindir)s/NetworkManager')
        r.Requires('wpa_supplicant:runtime', '%(sbindir)s/NetworkManager')
        r.Requires('ModemManager:runtime', '%(sbindir)s/NetworkManager')
        r.Requires('mobile-broadband-provider-info:data', '%(sbindir)s/NetworkManager')
 
        r.Install('NetworkManager.conf', '%(sysconfdir)s/%(name)s/')
 
        r.Install('test/.libs/nm-online', '%(bindir)s/', mode = 0755)
