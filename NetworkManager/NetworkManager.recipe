loadSuperClass('gnomepackage')
class NetworkManager(GnomePackageRecipe):
   buildRequires = ['GConf:devel', 'ORBit2:devel', 'chkconfig:runtime', 'dhcdbd:runtime', 'gnome-keyring:devel', 'gnome-vfs:devel', 'hal:devel', 'iproute:runtime', 'libart_lgpl:devel', 'libbonobo:devel', 'libbonoboui:devel', 'libgcrypt:devel', 'libglade:devel', 'libgnome:devel', 'libgnomecanvas:devel', 'libgnomeui:devel', 'libgpg-error:devel', 'libnl:devel', 'popt:devel', 'wireless-tools:devel', 'dbus:devel', 'dbus-glib:devellib', 'glib:devel', 'pango:devel']
        
   name = "NetworkManager"
   version = "0.6.5"

   extraConfig = ' --with-distro=redhat --enable-notification-icon --with-named=/usr/sbin/named --with-named-user=named --with-named-dir=%(localstatedir)s/named --with-wpa_supplicant=/usr/sbin/wpa_supplicant localstatedir=%(localstatedir)s'

   def unpack(r):
      GnomePackageRecipe.unpack(r)
      r.addPatch('http://archive.ubuntu.com/ubuntu/pool/main/n/network-manager/network-manager_0.6.5-0ubuntu5.diff.gz')
      for patch in [
         '01-supplicant_timeout.patch',
         '02-dbus_access_network_manager.patch',
         '04-if_fix.patch',
         '05-debian_backend.patch',
         '06-dispatch_more_events.patch',
         '11-man_page_sh_name.patch',
         '13-rml-wpa-workarounds.patch',
         '14-j-hostap-supplicant-driver.patch',
         '16_undefined_macros.patch',
         '17_avahi_autoipd.patch',
         '19_interfaces_can_have_more_than_one_instance.patch',
         '20_do_not_take_over_dhcpv4iface_when_v6_is_configured.patch',
         '21_manual_means_always_online.diff',
      ]:
         r.Run(""" patch -p1 < debian/patches/%s """ % patch)

      r.macros.foodir='initscript/RedHat'
      r.Replace('chkconfig: - 98 02','chkconfig: 5 98 02','%(foodir)s/NetworkManager', '%(foodir)s/NetworkManager.in','%(foodir)s/NetworkManagerDispatcher.in','%(foodir)s/NetworkManagerDispatcher')
      r.Replace(' -p \$pidfile','','%(foodir)s/NetworkManager','%(foodir)s/NetworkManager.in')
      r.addSource('ntpd.dispatch')

   def install(r):
      GnomePackageRecipe.install(r)
      r.MakeDirs('%(localstatedir)s/run/%(name)s')
      r.ExcludeDirectories(exceptions='%(localstatedir)s/run/%(name)s')
      r.Install('ntpd.dispatch', '%(sysconfdir)s/NetworkManager/dispatcher.d/ntpd')

   def policy(r):
      r.Requires('libnl:lib','%(sbindir)s/NetworkManager')
      r.Requires('wpa_supplicant:runtime','%(sbindir)s/NetworkManager')
