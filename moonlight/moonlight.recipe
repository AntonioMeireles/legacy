#
# Copyright (c) 2009 Foresight Linux
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Moonlight(AutoPackageRecipe):
    name = 'moonlight'
    version = '1.0'
 
    buildRequires = [ 'atk:devel', 'cairo:devel', 'expat:devel', 'fontconfig:devel', 'freetype:devel', 'glib:devel', 'gtk-doc:runtime', 'gtk:devel', 'libX11:devel', 'libXau:devel', 'libXdmcp:devel', 'libXrender:devel', 'libpng:devel', 'libstdc++:devel', 'libxcb:devel', 'pango:devel', 'perl:runtime', 'pixman:devel', 'pkgconfig:devel', 'xcb-util:devel', 'xulrunner:devel', 'zlib:devel', 'unzip:runtime', 'desktop-file-utils:runtime', 'autoconf:runtime','automake:runtime', 'libxml2:runtime',
                     'libtool:devel', 'libtool:runtime', 'util-macros:devel',  ]
 
    def unpack(r):
        r.addArchive('http://ftp.novell.com/pub/mono/sources/moon/moon-1.0.tar.bz2')
        # grabbed from opensuse srpm
        r.addArchive('moonlight-media-player-0.3.xpi', dir = 'foo')

    def configure(r): 
        r.Environment('MONO_CAIRO_LIBS',"-r:%(libdir)s/mono/1.0/Mono.Cairo.dll")
        r.Environment('MONO_SHARED_DIR', '/tmp')
        r.Run('autoreconf -fi')
        # FIXME get --managed=yes to build
        r.Configure('  --with-ffmpeg=no --with-managed=no  --with-cairo=system')

    def makeinstall(r):
        r.MakeInstall()
        r.Symlink('%(libdir)s/moon/plugin/libmoonloader.so', '%(libdir)s/mozilla/plugins/')

        firefox_app_id = "{ec8030f7-c20a-464f-9b0e-13a3a9e97384}//moon-media@mono-project.com/"
        dd = "%(libdir)s/mozilla/extensions/" + firefox_app_id
        r.Run("""mkdir -p ./%s"""  % dd , dir = '%(destdir)s' )

        r.Move('../foo/standalone/moonlight-media-player.desktop', '%(datadir)s/applications/')
        r.Move('../foo/standalone/hicolor', '%(datadir)s/icons/')

        r.Move('../foo/*', '%s' % dd)

        r.Create('%(bindir)s/moonlight-media-player', mode = 0755, contents = """
export MOZ_PLUGIN_PATH=%(libdir)s/moon/plugin/
xulrunner %(libdir)s/mozilla/extensions/{ec8030f7-c20a-464f-9b0e-13a3a9e97384}//moon-media@mono-project.com/standalone/application.ini "$@"
""" )

