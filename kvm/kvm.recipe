#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Kvm(AutoPackageRecipe):

    name = 'kvm'
    version = '0.12.3'

    buildRequires = [ 'SDL:devel', 'alsa-lib:devel', 'e2fsprogs:devel',
                      'zlib:devel', 'chkconfig:runtime', 'info-kvm:group',
                      'iasl:runtime', 'gnutls:devel', 'kernel:build-tree',
                      'dev86:runtime', 'pkgconfig:devel', 'ncurses:devel',
                      'python:devel', 'esound:devel', 'git:runtime', 'rsync:runtime',
                      'bluez:devel', 'curl:devel', 'cyrus-sasl:devel', 'libX11:devel',
                      'openssl:devel', 'pulseaudio:devel', 'texi2html:runtime',
                      'pciutils:devel', 'which:runtime', 'util-linux:devel' ]

    def unpack(r):
        r.addArchive('mirror://sourceforge/kvm/qemu-kvm-%(version)s.tar.gz')

        for p in [ '0001-block-avoid-creating-too-large-iovecs-in-multiwrite_.patch',
                   '0002-migration-Clear-fd-also-in-error-cases.patch',
                   '0003-raw-posix-Detect-CDROM-via-ioctl-on-linux.patch',
                   '0004-usb-linux-increase-buffer-for-USB-control-requests.patch',
                   '0005-net-remove-NICInfo.bootable-field.patch',
                   '0006-net-remove-broken-net_set_boot_mask-boot-device-vali.patch',
                   '0007-boot-remove-unused-boot_devices_bitmap-variable.patch', 
            
                   ]:
            r.addPatch(p)

        for src in [ 'kvm.modules',
                   # Creates /dev/kvm
                   '80-kvm.rules',
                   # KSM control scripts
                   'ksm.init',
                   'ksm.sysconfig',
                   'ksmtuned.init',
                   'ksmtuned',
                   'ksmtuned.conf',]:
            r.addSource(src)

    def configure(r):
        if Arch.x86:
            r.Environment('ARCH', 'i386')
        else:
            r.Environment('ARCH', 'x86_64')

        r.macros.securityflags = ''

        r.ManualConfigure( '--target-list=x86_64-softmmu '
                           ' --prefix=%(prefix)s'
                           ' --kerneldir=$(pwd)/kernel '
                           ' --audio-drv-list=sdl,oss,alsa,pa '
                           ' --disable-strip '
                           ' --disable-xen '
                           ' --extra-cflags="%(optflags)s" '
                          )


    def make(r):
        r.Make('V=1')
        r.ManualConfigure('--prefix=%(prefix)s --kerneldir=$(pwd)/../kernel/', dir = 'kvm/user')
        r.Make('kvmtrace', dir = 'kvm/user')


    def makeinstall(r):
        r.MakeInstall()
        # upstream Makefiles _features_ ...
        r.Install('kvm/scripts/qemu-ifup', '%(sysconfdir)s/qemu-ifup', mode = 0755)
        
        r.Install('kvm/user/kvmtrace', '%(bindir)s/', mode = 0755)
        r.Install('kvm/user/kvmtrace_format', '%(bindir)s/', mode = 0755)
        r.Install('kvm/kvm_stat', '%(bindir)s/', mode = 0755)


        r.Install('kvm.modules', '%(sysconfdir)s/sysconfig/modules/kvm.modules', mode = 0755)
        r.Install('80-kvm.rules', '%(sysconfdir)s/udev/rules.d/', mode = 0644)

        r.Install('ksm.init', '%(initdir)s/ksm', mode = 0755)
        r.Install('ksm.sysconfig', '%(sysconfdir)s/sysconfig/ksm', mode = 0644)

        r.Install('ksmtuned.init', '%(initdir)s/ksmtuned', mode = 0755)
        r.Install('ksmtuned', '%(sbindir)s/ksmtuned', mode = 0755)
        r.Install('ksmtuned.conf', '%(sysconfdir)s/ksmtuned.conf', mode = 0644)

        r.Install('qemu.sasl', '%(sysconfdir)s/sasl2/qemu.conf', mode = 0644)


        r.Remove('%(datadir)s/qemu/openbios-sparc32')
        r.Remove('%(datadir)s/qemu/openbios-sparc64')
        r.Remove('%(datadir)s/qemu/openbios-ppc')


        r.Symlink('%(mandir)s/man1/qemu.1', '%(mandir)s/man1/qemu-kvm.1')

        r.Symlink('%(bindir)s/qemu-system-x86_64', '%(bindir)s/qemu-kvm')

        r.Requires('info-kvm:group', '%(bindir)s/qemu-kvm')
