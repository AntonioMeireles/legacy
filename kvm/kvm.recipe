#
# Copyright (c) 2004-2011 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadSuperClass('rpmpackage')
class Kvm(RPMPackageRecipe,AutoPackageRecipe):

    name = 'kvm'
    version = '0.15.1'
    rpmRelease = '1.fc16'
    rpmName = 'qemu'
    tarballName = 'qemu-kvm-%(version)s.tar.gz'
    # tarballName = rpmName + '-' + name + '-' + version + '.tar.gz' 
    rpmSources = [ 'kvm.modules',
                   # Creates /dev/kvm
                   '80-kvm.rules',
                   # KSM control scripts
                   'ksm.sysconfig',
                   'ksmtuned',
                   'ksmtuned.conf',]
    rpmPatches = [ '0001-char-Split-out-tcp-socket-close-code-in-a-separate-f.patch',
                   '0002-char-Add-a-QemuChrHandlers-struct-to-initialise-char.patch',
                   '0003-iohandlers-Add-enable-disable_write_fd_handler-funct.patch',
                   '0004-char-Add-framework-for-a-write-unblocked-callback.patch',
                   '0005-char-Update-send_all-to-handle-nonblocking-chardev-w.patch',
                   '0006-char-Equip-the-unix-tcp-backend-to-handle-nonblockin.patch',
                   '0007-char-Throttle-when-host-connection-is-down.patch',
                   '0008-virtio-console-Enable-port-throttling-when-chardev-i.patch',
                   '0009-spice-qemu-char.c-add-throttling.patch',
                   '0010-spice-qemu-char.c-remove-intermediate-buffer.patch',
                   '0011-usb-redir-Add-flow-control-support.patch',
                   '0012-spice-add-worker-wrapper-functions.patch',
                   '0013-spice-add-qemu_spice_display_init_common.patch',
                   '0014-spice-qxl-move-worker-wrappers.patch',
                   '0015-qxl-fix-surface-tracking-locking.patch',
                   '0016-qxl-add-io_port_to_string.patch',
                   '0017-qxl-error-handling-fixes-and-cleanups.patch',
                   '0018-qxl-make-qxl_guest_bug-take-variable-arguments.patch',
                   '0019-qxl-only-disallow-specific-io-s-in-vga-mode.patch',
                   '0020-qxl-async-io-support-using-new-spice-api.patch',
                   '0021-qxl-add-QXL_IO_FLUSH_-SURFACES-RELEASE-for-guest-S3-.patch',
                   '0022-qxl-bump-pci-rev.patch',
                   '0023-virtio-serial-bus-replay-guest_open-on-migration.patch',
                   '0024-qemu-char-make-qemu_chr_event-public.patch',
                   '0025-spice-qemu-char-Generate-chardev-open-close-events.patch',
                   '0026-usb-redir-Call-qemu_chr_guest_open-close.patch',
                   '0027-usb-redir-Device-disconnect-re-connect-robustness-fi.patch',
                   '0028-usb-redir-Don-t-try-to-write-to-the-chardev-after-a-.patch',
                   'qemu-Allow-to-leave-type-on-default-in-machine.patch', ]

    buildRequires = [ 'SDL:devel', 'alsa-lib:devel', 'e2fsprogs:devel',
                      'zlib:devel', 'chkconfig:runtime', 'info-kvm:group',
                      'iasl:runtime', 'gnutls:devel', 'kernel:build-tree',
                      'dev86:runtime', 'pkgconfig:devel', 'ncurses:devel',
                      'python:devel', 'esound:devel', 'git:runtime', 'rsync:runtime',
                      'bluez:devel', 'curl:devel', 'cyrus-sasl:devel', 'libX11:devel',
                      'openssl:devel', 'pulseaudio:devel', 'texi2html:runtime',
                      'pciutils:devel', 'which:runtime', 'util-linux:devel',
                      'attr:devel', 'libjpeg:devel', 'libpng:devel',
                      'gpxe-roms-qemu:data', 'userspace-kernel-headers',
                      'vgabios:data', 'seabios:data', 
                      # for docs/man
                      'texinfo:runtime', 'perl:runtime']

    def unpack(r):
        RPMPackageRecipe.unpack(r)
        r.addSource('ksm.init')
        r.addSource('ksmtuned.init')
    
    def configure(r):
        r.disableParallelMake()

        if Arch.x86:
            r.Environment('ARCH', 'i386')
        else:
            r.Environment('ARCH', 'x86_64')

        r.macros.securityflags = ''


        cfg = ( ' --target-list=x86_64-softmmu '
                ' --prefix=%(prefix)s'
                ' --audio-drv-list=pa,sdl,oss,alsa '
                ' --disable-strip '
                ' --disable-xen '
                ' --extra-cflags="%(optflags)s " '
                ' --enable-sdl ' )
#        if Arch.x86_64:
#            cfg += ' --enable-spice '

        r.ManualConfigure( cfg )


    def make(r):
        r.Make('V=1')

    def makeinstall(r):
        r.MakeInstall('datadir=%(datadir)s/qemu '
                      'sharedir=%(datadir)s/qemu ')
        # upstream Makefiles _features_ ...
        r.Install('kvm/scripts/qemu-ifup', '%(sysconfdir)s/qemu-ifup', mode = 0755)
        
        r.Install('kvm/kvm_stat', '%(bindir)s/', mode = 0755)

        r.Install('kvm.modules', '%(sysconfdir)s/sysconfig/modules/kvm.modules', mode = 0755)
        r.Install('80-kvm.rules', '%(sysconfdir)s/udev/rules.d/', mode = 0644)

        r.Install('ksm.init', '%(initdir)s/ksm', mode = 0755)
        r.Install('ksm.sysconfig', '%(sysconfdir)s/sysconfig/ksm', mode = 0644)

        r.Install('ksmtuned.init', '%(initdir)s/ksmtuned', mode = 0755)
        r.Install('ksmtuned', '%(sbindir)s/ksmtuned', mode = 0755)
        r.Install('ksmtuned.conf', '%(sysconfdir)s/ksmtuned.conf', mode = 0644)

        r.Install('qemu.sasl', '%(sysconfdir)s/sasl2/qemu.conf', mode = 0644)

        
        r.Remove('%(datadir)s/qemu/pxe*bin', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/{,g}pxe*rom', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/vgabios*bin', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/bios.bin', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/openbios-ppc', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/openbios-sparc32', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/openbios-sparc64', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/petalogix-s3adsp1800.dtb', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/s390-zipl.rom', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/bamboo.dtb', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/slof.bin', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/ppc_rom.bin', allowNoMatch = True)
        r.Remove('%(datadir)s/qemu/spapr-rtas.bin', allowNoMatch = True)

        for a, b in [('e1000', '8086100e'),
                   ('ne2k_pci', 'rtl8029'),
                   ('pcnet', 'pcnet32'),
                   ('rtl8139', 'rtl8139'),
                   ('virtio', 'virtio-net')]: 
            r.Symlink('%(datadir)s/gpxe/' + b + '.rom', '%(datadir)s/qemu/pxe-'+a+'.rom')

        r.Symlink('../vgabios/VGABIOS-lgpl-latest.bin', '%(datadir)s/qemu/vgabios.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.cirrus.bin', '%(datadir)s/qemu/vgabios-cirrus.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.qxl.bin',  '%(datadir)s/qemu/vgabios-qxl.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.stdvga.bin', '%(datadir)s/qemu/vgabios-stdvga.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.vmware.bin', '%(datadir)s/qemu/vgabios-vmware.bin')
        r.Symlink('%(datadir)s/seabios/bios.bin', '%(datadir)s/qemu/bios.bin')
        
        r.Requires('seabios:data', '%(datadir)s/qemu/bios.bin')
        r.Requires('vgabios:data', '%(datadir)s/qemu/vgabios.*')        
        r.Requires('gpxe-roms-qemu:data', '%(datadir)s/qemu/pxe.*')        

        r.Symlink('%(mandir)s/man1/qemu.1', '%(mandir)s/man1/qemu-kvm.1')

        r.Symlink('%(bindir)s/qemu-system-x86_64', '%(bindir)s/qemu-kvm')

        r.Requires('info-kvm:group', '%(bindir)s/qemu-kvm')

        
