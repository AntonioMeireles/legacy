#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadSuperClass('rpmpackage')
class Kvm(RPMPackageRecipe,AutoPackageRecipe):

    name = 'kvm'
    version = '0.12.5'
    rpmRelease = '1.fc13'
    rpmName = 'qemu'
    tarballName = rpmName + '-' + name + '-' + version + '.tar.gz' 
    rpmSources = [ 'kvm.modules',
                   # Creates /dev/kvm
                   '80-kvm.rules',
                   # KSM control scripts
                   'ksm.init',
                   'ksm.sysconfig',
                   'ksmtuned.init',
                   'ksmtuned',
                   'ksmtuned.conf',]
    rpmPatches = [ 'qemu-virtio-Remove-duplicate-macro-definition-for-max.-v.patch',
                   'qemu-virtio-console-qdev-conversion-new-virtio-serial-b.patch',
                   'qemu-virtio-serial-bus-Maintain-guest-and-host-port-open.patch',
                   'qemu-virtio-serial-bus-Add-a-port-name-property-for-po.patch',
                   'qemu-virtio-serial-bus-Add-ability-to-hot-unplug-ports.patch',
                   'qemu-virtio-serial-Add-a-virtserialport-device-for-gen.patch',
                   'qemu-Move-virtio-serial-to-Makefile.objs.patch',
                   'qemu-virtio-serial-Use-MSI-vectors-for-port-virtqueues.patch',
                   'qemu-virtio-console-Rename-virtio-serial.c-back-to-virti.patch',
                   'qemu-net-add-API-to-disable-enable-polling.patch',
                   'qemu-virtio-rename-features-guest_features.patch',
                   'qemu-qdev-add-bit-property-type.patch',
                   'qemu-qdev-fix-thinko-leading-to-guest-crashes.patch',
                   'qemu-virtio-add-features-as-qdev-properties.patch',
                   'qemu-virtio-net-mac-property-is-mandatory.patch',
                   'qemu-exec-memory-notifiers.patch',
                   'qemu-kvm-add-API-to-set-ioeventfd.patch',
                   'qemu-notifier-event-notifier-implementation.patch',
                   'qemu-virtio-add-notifier-support.patch',
                   'qemu-virtio-add-APIs-for-queue-fields.patch',
                   'qemu-virtio-add-status-change-callback.patch',
                   'qemu-virtio-move-typedef-to-qemu-common.patch',
                   'qemu-virtio-pci-fill-in-notifier-support.patch',
                   'qemu-tap-add-interface-to-get-device-fd.patch',
                   'qemu-vhost-vhost-net-support.patch',
                   'qemu-tap-add-vhost-vhostfd-options.patch',
                   'qemu-tap-add-API-to-retrieve-vhost-net-header.patch',
                   'qemu-virtio-net-vhost-net-support.patch',
                   'qemu-kvm-add-vhost.h-header.patch',
                   'qemu-kvm-irqfd-support.patch',
                   'qemu-msix-add-mask-unmask-notifiers.patch',
                   'qemu-virtio-pci-irqfd-support.patch',
                   'qemu-virtio-avoid-crash-with-non-tap-backends.patch',
                   'qemu-virtio-serial-features-build-fix.patch',
                   'qemu-virtio-pci-irqfd-fix-nonkvm-build.patch',
                   'qemu-vhost-add-configure-check.patch',
                   '0038-msix-migration-fix.patch',
                   '0039-vhost-logging-thinko-fix.patch',
                   '0040-vhost-move-vhost_set_vq_addr.patch',
                   '0041-vhost-used-addr-migration-fix.patch',
                   '0042-vhost-fix-used-logging-size-math.patch',
                   '0043-vhost-logging-mistake-enable-not-disable-log.patch',
                   '0044-vhost-fix-log-base.patch',
                   '0045-pc-Add-a-Fedora-13-machine-type-that-contains-backpo.patch',
                   '0046-pc-Add-backward-compatibility-options-for-virtio-ser.patch',
                   '0047-virtio-serial-don-t-set-MULTIPORT-for-1-port-dev.patch',
                   '0048-virtio-serial-pci-Allow-MSI-to-be-disabled.patch',
                   '0049-migration-Clear-fd-also-in-error-cases.patch',
                   '0050-raw-posix-Detect-CDROM-via-ioctl-on-linux.patch',
                   '0051-usb-linux-increase-buffer-for-USB-control-requests.patch',
                   '0052-virtio-console-patches.patch',
                   '0055-boot-remove-unused-boot_devices_bitmap-variable.patch',
                   ]

    buildRequires = [ 'SDL:devel', 'alsa-lib:devel', 'e2fsprogs:devel',
                      'zlib:devel', 'chkconfig:runtime', 'info-kvm:group',
                      'iasl:runtime', 'gnutls:devel', 'kernel:build-tree',
                      'dev86:runtime', 'pkgconfig:devel', 'ncurses:devel',
                      'python:devel', 'esound:devel', 'git:runtime', 'rsync:runtime',
                      'bluez:devel', 'curl:devel', 'cyrus-sasl:devel', 'libX11:devel',
                      'openssl:devel', 'pulseaudio:devel', 'texi2html:runtime',
                      'pciutils:devel', 'which:runtime', 'util-linux:devel', 'gpxe-roms-qemu:data',
                      'vgabios:data', 'seabios:data']
    
    def configure(r):
        # https://bugs.launchpad.net/qemu/+bug/586175
        # http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=588739
        # https://bugzilla.redhat.com/show_bug.cgi?id=579348
        # handpicked from debian ... 
        for dp in [ 'add-support-for-GET-EVENT-STATUS-NOTIFICATION.diff',
                    'upstream-stable01-make-PIIX-and-ISA-IDE-init-functions-return-the-qdev.diff',
                    'revert-all-bdrv_write_sync-changes.diff',
                    'upstream-stable02-fix-CMOS-info-for-drives-defined-with--device.diff'
                    ]:
            r.addPatch(dp)

        if Arch.x86:
            r.Environment('ARCH', 'i386')
        else:
            r.Environment('ARCH', 'x86_64')

        r.macros.securityflags = ''

        r.ManualConfigure( '--target-list=x86_64-softmmu '
                           ' --prefix=%(prefix)s'
                           ' --kerneldir=$(pwd)/kernel '
                           ' --audio-drv-list=sdl,oss,alsa,pa '
                           ' --disable-strip '
                           ' --disable-xen '
                           ' --extra-cflags="%(optflags)s" '
                          )


    def make(r):
        r.Make('V=1')
        r.ManualConfigure('--prefix=%(prefix)s --kerneldir=$(pwd)/../kernel/', dir = 'kvm/user')
        r.Make('kvmtrace', dir = 'kvm/user')


    def makeinstall(r):
        r.MakeInstall('datadir=%(datadir)s/qemu '
                      'sharedir=%(datadir)s/qemu ')
        # upstream Makefiles _features_ ...
        r.Install('kvm/scripts/qemu-ifup', '%(sysconfdir)s/qemu-ifup', mode = 0755)
        
        r.Install('kvm/user/kvmtrace', '%(bindir)s/', mode = 0755)
        r.Install('kvm/user/kvmtrace_format', '%(bindir)s/', mode = 0755)
        r.Install('kvm/kvm_stat', '%(bindir)s/', mode = 0755)


        r.Install('kvm.modules', '%(sysconfdir)s/sysconfig/modules/kvm.modules', mode = 0755)
        r.Install('80-kvm.rules', '%(sysconfdir)s/udev/rules.d/', mode = 0644)

        r.Install('ksm.init', '%(initdir)s/ksm', mode = 0755)
        r.Install('ksm.sysconfig', '%(sysconfdir)s/sysconfig/ksm', mode = 0644)

        r.Install('ksmtuned.init', '%(initdir)s/ksmtuned', mode = 0755)
        r.Install('ksmtuned', '%(sbindir)s/ksmtuned', mode = 0755)
        r.Install('ksmtuned.conf', '%(sysconfdir)s/ksmtuned.conf', mode = 0644)

        r.Install('qemu.sasl', '%(sysconfdir)s/sasl2/qemu.conf', mode = 0644)

        
        r.Remove('%(datadir)s/qemu/pxe*bin')
#        r.Remove('%(datadir)s/qemu/gpxe*rom')
        r.Remove('%(datadir)s/qemu/vgabios*bin')
        r.Remove('%(datadir)s/qemu/bios.bin')
        r.Remove('%(datadir)s/qemu/openbios-ppc')
        r.Remove('%(datadir)s/qemu/openbios-sparc32')
        r.Remove('%(datadir)s/qemu/openbios-sparc64')
        r.Remove('%(datadir)s/qemu/petalogix-s3adsp1800.dtb')
        r.Remove('%(datadir)s/qemu/s390-zipl.rom')
        
        r.Remove('%(datadir)s/qemu/bamboo.dtb')
        r.Remove('%(datadir)s/qemu/ppc_rom.bin')
        r.Remove('%(datadir)s/qemu/video.x')

        for a, b in [('e1000', '8086100e'),
                   ('ne2k_pci', 'rtl8029'),
                   ('pcnet', 'pcnet32'),
                   ('rtl8139', 'rtl8139'),
                   ('virtio', 'virtio-net')]: 
            
            r.Symlink('../gpxe/' + b + '.rom', '%(datadir)s/qemu/pxe-'+a+'.bin')

        r.Symlink('../vgabios/VGABIOS-lgpl-latest.bin', '%(datadir)s/qemu/vgabios.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.cirrus.bin', '%(datadir)s/qemu/vgabios-cirrus.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.qxl.bin',  '%(datadir)s/qemu/vgabios-qxl.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.stdvga.bin', '%(datadir)s/qemu/vgabios-stdvga.bin')
        r.Symlink('../vgabios/VGABIOS-lgpl-latest.vmware.bin', '%(datadir)s/qemu/vgabios-vmware.bin')
        r.Symlink('%(datadir)s/seabios/bios.bin', '%(datadir)s/qemu/bios.bin')
        r.DanglingSymlinks(exceptions = '%(datadir)s/.*')
        
        # 
        r.Requires('seabios:data', '%(datadir)s/qemu/bios.bin')
        r.Requires('vgabios:data', '%(datadir)s/qemu/vgabios.*')        
        r.Requires('gpxe-roms-qemu:data', '%(datadir)s/qemu/pxe.*')        

        r.Symlink('%(mandir)s/man1/qemu.1', '%(mandir)s/man1/qemu-kvm.1')

        r.Symlink('%(bindir)s/qemu-system-x86_64', '%(bindir)s/qemu-kvm')

        r.Requires('info-kvm:group', '%(bindir)s/qemu-kvm')

        
