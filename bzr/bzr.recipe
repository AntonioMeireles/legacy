#
# Copyright (c) 2009-2010 Foresight Linux Project
# Copyright (c) 2006-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#
loadInstalled('python')
class Bzr(CPackageRecipe):
    name = 'bzr'
    version = '2.1.2'
    buildRequires = [ 
        'python-setuptools:python',
        #'elementtree:python',
        'cElementTree:python',
        'ConfigObj:python',
        'python:devel',
        'python-ctypes:python',
        'python-cssutils:python',
        #'pygobject:python', # for 2.2
        'zlib:devel', # for < 2.2
    ]

    def setup(r):
        # Let Conary guess the tarball name
        r.addArchive('http://launchpad.net/%(name)s/%(major_version)s/%(version)s/+download/')
        # Added in 1.10-1 by doniphon
        #r.Run("""
        #      sed -i '1{/#![[:space:]]*\/usr\/bin\/\(python\|env\)/d}' bzrlib/_patiencediff_py.py
        #      sed -i '1{/#![[:space:]]*\/usr\/bin\/\(python\|env\)/d}' bzrlib/weave.py 
        #      """)
        r.Run("CFLAGS=\"%(cflags)s\" python setup.py install --root=%(destdir)s build_ext --allow-python-fallback")

        # Bash completion stuff
        r.Install('contrib/bash/bzr',
                 '%(sysconfdir)s/bash_completion.d/bzr', mode = 0644)
        r.Install('contrib/bash/bzrbashprompt.sh',
                 '%(sysconfdir)s/bash_completion.d/bzrbashprompt.sh', mode = 0644)
        r.Config(exceptions='%(sysconfdir)s/bash_completion.d/')

        # Use independently packaged python-elementtree instead
        r.macros.pyver = Python.majversion
        r.Remove('%(libdir)s/python%(pyver)s/site-packages/bzrlib/util/elementtree/',
                 recursive = True)

        r.Move('/usr/man/*', '%(mandir)s/')
        r.Remove('/usr/man', recursive = True)

