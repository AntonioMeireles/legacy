#
# Copyright (c) 2005 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Modutils(CPackageRecipe):
    name = 'module-init-tools'
    version = '3.2'
    buildRequires = [ 'flex:runtime', 'bison:runtime', 'zlib:devel',
                      'docbook-utils:runtime',
                      # XXX the following are runtime requirements for
                      # docbook-utils promoted to build time requirements
                      # fix ASAP
                      'which:runtime', 'perl-SGMLS:runtime' ]

    def setup(r):
        r.disableParallelMake()
        r.addArchive('http://ftp.kernel.org/pub/linux/utils/kernel/module-init-tools/module-init-tools-%(version)s.tar.bz2', keyid='517D0F0E')
        r.addSource('modprobe.conf.dist')
        r.addPatch('module-init-tools-allconf.patch', level=1)
        r.addPatch('module-init-tools-noescape.patch', level=0)
        r.macros.cflags = ('-Os -DCONFIG_NO_BACKWARDS_COMPAT=1')
        r.Configure('--enable-zlib')
        r.Make('insmod.static')
        r.Run('cp insmod.static insmod-static')

        r.Make('distclean')
        r.Configure('--enable-zlib')
        r.MakeInstall('sbindir=%(essentialsbindir)s mandir=%(mandir)s')

        r.Install('insmod-static', '%(essentialsbindir)s/insmod.static', mode=0755)
        r.Install('modprobe.conf.dist', '%(sysconfdir)s/modprobe.conf.dist', mode=0644)
        r.Move('/usr/bin/lsmod', '/sbin/lsmod')
