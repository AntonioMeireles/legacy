#
# Copyright (c) 2004-2007 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Groff(CPackageRecipe):
    name = 'groff'
    version = '1.19.2'

    # Adding cups:.*, ghostscript:.*, or espgs:.* will create a build req loop
    buildRequires = [ 'zlib:devel', 'texinfo:runtime', 'install-info:runtime',
                      'gcc:devel', 'byacc:runtime',
                      'libstdc++:devel', 'netpbm:runtime',
                      'perl:lib', 'perl:runtime', 'psutils:runtime',
                      'libX11:devel', 'libXmu:devel', 'libXt:devel',
                      'imake:runtime', 'libXaw:devel', 'libSM:devel',
                      'libICE:devel', ]

    def setup(r):
        r.addArchive('mirror://gnu/%(name)s/', keyid='E707FDA5')
        r.addSource('hyphen.cs')
        r.addPatch('groff-1.18.1-no-color-segfault.patch')
        r.addPatch('groff-man-UTF-8.diff')

        r.Configure('--enable-multibyte')
        # do not use r.disableParallelMake; that specifies that no
        # parallelization is possible in this package
        mflags = r.macros.parallelmflags
        r.macros.parallelmflags = ''
        r.Make('PARALLELMFLAGS="%s"' %mflags)
        r.Replace(('@//', '/'), ('@setfilename groff', '@setfilename groff.info'),
                  'doc/groff.texinfo')
        r.Run('cd doc; makeinfo groff.texinfo')
        # groff doesn't make all necessary directories for make install
        r.MakeDirs('/usr')
        r.MakePathsInstall('manroot=%(destdir)s%(mandir)s appresdir=%(destdir)s%(datadir)s/X11/app-defaults')
        for g in ('s.tmac', 'mse.tmac', 'm.tmac'):
            r.Symlink(g, '%(datadir)s/groff/%(version)s/tmac/g'+g)
        for g in ('troff', 'tbl', 'pic', 'eqn', 'neqn', 'refer', 'lookbib',
                  'indxbib', 'soelim', 'nroff'):
            r.Symlink(g, '%(prefix)s/bin/g'+g)
            r.Symlink(g+'.1', '%%(mandir)s/man1/g%s.1' %g)
        r.Symlink('soelim', '%(prefix)s/bin/zsoelim')
        r.Symlink('soelim.1', '%(mandir)s/man1/zsoelim.1')
        r.Install('hyphen.cs', '%(datadir)s/groff/%(version)s/tmac/', mode=0644)
        r.Symlink('doc.tmac', '%(datadir)s/groff/%(version)s/tmac/docj.tmac')
        r.Move('%(docdir)s/groff/%(version)s', '%(docdir)s/groff-%(version)s')
        r.Remove('%(docdir)s/groff', recursive=True)

        # Anything with X11-related deps should go here:
        r.PackageSpec('groff-x11',
                      '%(bindir)s/gxditview',
                      '%(thisdocdir)s/src/devices/xditview/',
                      '%(mandir)s/man1/gxditview.1.gz',
                      '%(bindir)s/xtotroff',
                      '%(mandir)s/man1/xtotroff.1.gz',
                      '%(datadir)s/X11/app-defaults/GXditview',
                      )
